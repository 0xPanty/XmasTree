<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warplet NFT æ£€æµ‹æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #0a1a0a;
            color: #fff;
        }
        .container {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(212,175,55,0.3);
            border-radius: 12px;
            padding: 30px;
        }
        h1 {
            color: #d4af37;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #d4af37;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(212,175,55,0.3);
            border-radius: 6px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #d4af37, #ffd700);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        button:hover {
            opacity: 0.9;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .result {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }
        .result.success {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.3);
            display: block;
        }
        .result.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            display: block;
        }
        .result h3 {
            margin-top: 0;
            color: #d4af37;
        }
        .nft-preview {
            margin-top: 20px;
            text-align: center;
        }
        .nft-preview img {
            max-width: 200px;
            border-radius: 8px;
            border: 2px solid #d4af37;
        }
        pre {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
        .info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }
        .status.yes {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }
        .status.no {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ Warplet NFT æ£€æµ‹æµ‹è¯•</h1>
        
        <div class="info">
            <strong>â„¹ï¸ è¯´æ˜ï¼š</strong><br>
            è¾“å…¥Farcasterç”¨æˆ·åæˆ–FIDï¼Œæ£€æŸ¥æ˜¯å¦æŒæœ‰Warplet NFTï¼Œä»¥åŠNFTå›¾ç‰‡èƒ½å¦æ­£ç¡®è·å–ã€‚
        </div>

        <div class="input-group">
            <label for="username">Farcaster ç”¨æˆ·åï¼ˆä¸éœ€è¦@ï¼‰</label>
            <input type="text" id="username" placeholder="ä¾‹å¦‚: xqc" value="xqc">
        </div>

        <div class="input-group">
            <label for="fid">æˆ–è€…ç›´æ¥è¾“å…¥ FID</label>
            <input type="text" id="fid" placeholder="ä¾‹å¦‚: 275646">
        </div>

        <button onclick="testWarplet()">ğŸ” æ£€æµ‹ Warplet NFT</button>

        <div id="result" class="result"></div>
    </div>

    <script>
        async function testWarplet() {
            const resultDiv = document.getElementById('result');
            const button = document.querySelector('button');
            
            button.disabled = true;
            button.textContent = 'â³ æ£€æµ‹ä¸­...';
            resultDiv.innerHTML = '';
            resultDiv.className = 'result';
            resultDiv.style.display = 'none';

            try {
                const username = document.getElementById('username').value.trim().replace('@', '');
                let fid = document.getElementById('fid').value.trim();

                // Step 1: Get FID if username provided
                if (username && !fid) {
                    resultDiv.innerHTML = '<p>ğŸ“¡ æ­£åœ¨æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯...</p>';
                    resultDiv.style.display = 'block';
                    
                    const userRes = await fetch(`/api/neynar?action=search&q=${encodeURIComponent(username)}&limit=1`);
                    const userData = await userRes.json();
                    
                    if (!userData.result?.users?.[0]) {
                        throw new Error('æœªæ‰¾åˆ°è¯¥ç”¨æˆ·');
                    }
                    
                    const user = userData.result.users[0];
                    fid = user.fid;
                    
                    resultDiv.innerHTML += `<p>âœ… æ‰¾åˆ°ç”¨æˆ·: @${user.username} (FID: ${fid})</p>`;
                }

                if (!fid) {
                    throw new Error('è¯·è¾“å…¥ç”¨æˆ·åæˆ–FID');
                }

                // Step 2: Check Warplet NFT
                resultDiv.innerHTML += '<p>ğŸ¨ æ­£åœ¨æ£€æµ‹ Warplet NFT...</p>';
                
                const warpletRes = await fetch(`/api/warplet?fid=${fid}`);
                const warpletData = await warpletRes.json();

                console.log('Warplet API å“åº”:', warpletData);

                // Display result
                let html = '<h3>æ£€æµ‹ç»“æœ</h3>';
                
                if (warpletData.hasWarplet) {
                    html += '<div class="status yes">âœ… æŒæœ‰ Warplet NFT</div>';
                    html += `<p><strong>NFT åç§°ï¼š</strong> ${warpletData.name || 'Warplet'}</p>`;
                    html += `<p><strong>Token IDï¼š</strong> ${warpletData.tokenId || 'N/A'}</p>`;
                    html += `<p><strong>åˆçº¦åœ°å€ï¼š</strong> ${warpletData.contractAddress || 'N/A'}</p>`;
                    html += `<p><strong>æŒæœ‰åœ°å€ï¼š</strong> ${warpletData.address || 'N/A'}</p>`;
                    
                    if (warpletData.imageUrl) {
                        html += `<div class="nft-preview">
                            <p><strong>NFT å›¾ç‰‡ï¼š</strong></p>
                            <img src="${warpletData.imageUrl}" alt="Warplet NFT" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22><rect width=%22200%22 height=%22200%22 fill=%22%23333%22/><text x=%2250%25%22 y=%2250%25%22 fill=%22white%22 text-anchor=%22middle%22 dy=%22.3em%22>åŠ è½½å¤±è´¥</text></svg>'">
                            <p style="font-size: 12px; color: rgba(255,255,255,0.6); word-break: break-all;">${warpletData.imageUrl}</p>
                        </div>`;
                    } else {
                        html += '<p>âš ï¸ æœªè·å–åˆ°NFTå›¾ç‰‡URL</p>';
                    }
                    
                    html += '<hr style="margin: 20px 0; border: 1px solid rgba(212,175,55,0.2);">';
                    html += '<h4>ğŸ¨ AIç”Ÿæˆé¢„æœŸæ•ˆæœ</h4>';
                    html += '<p>âœ… è¿™ä¸ªNFTå›¾ç‰‡ä¼šè¢«ä¼ é€’ç»™Gemini AI</p>';
                    html += '<p>âœ… AIä¼šå°†ç”¨æˆ·å’ŒWarpletè§’è‰²ä¸€èµ·ç»˜åˆ¶åœ¨åœ£è¯åœºæ™¯ä¸­</p>';
                    html += '<p>âœ… ä¸¤è€…ä¼šæœ‰è‡ªç„¶äº’åŠ¨ï¼ˆæ‹¥æŠ±ã€å¹¶æ’ã€ä¸€èµ·æ´»åŠ¨ç­‰ï¼‰</p>';
                    
                    resultDiv.className = 'result success';
                } else {
                    html += '<div class="status no">âŒ æœªæŒæœ‰ Warplet NFT</div>';
                    html += `<p><strong>åŸå› ï¼š</strong> ${warpletData.message || 'æœªæ‰¾åˆ°NFT'}</p>`;
                    
                    if (warpletData.debug) {
                        html += '<details><summary>ğŸ” è°ƒè¯•ä¿¡æ¯</summary>';
                        html += `<pre>${JSON.stringify(warpletData.debug, null, 2)}</pre>`;
                        html += '</details>';
                    }
                    
                    html += '<hr style="margin: 20px 0; border: 1px solid rgba(212,175,55,0.2);">';
                    html += '<h4>ğŸ’¡ è§£å†³æ–¹æ¡ˆ</h4>';
                    html += '<ol style="text-align: left;">';
                    html += '<li>åœ¨Baseé“¾ä¸Šè´­ä¹°Warplet NFT<br><a href="https://opensea.io/collection/the-warplets-farcaster" target="_blank" style="color: #d4af37;">â†’ OpenSeaè´­ä¹°é“¾æ¥</a></li>';
                    html += '<li>ç¡®ä¿NFTåœ°å€å·²åœ¨Warpcastä¸­éªŒè¯</li>';
                    html += '<li>ç­‰å¾…å‡ åˆ†é’Ÿè®©åŒºå—é“¾æ•°æ®åŒæ­¥</li>';
                    html += '</ol>';
                    
                    resultDiv.className = 'result error';
                }

                // Show raw response
                html += '<details style="margin-top: 20px;"><summary>ğŸ“‹ å®Œæ•´APIå“åº”</summary>';
                html += `<pre>${JSON.stringify(warpletData, null, 2)}</pre>`;
                html += '</details>';

                resultDiv.innerHTML = html;

            } catch (error) {
                console.error('æ£€æµ‹å¤±è´¥:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h3>âŒ æ£€æµ‹å¤±è´¥</h3>
                    <p><strong>é”™è¯¯ï¼š</strong> ${error.message}</p>
                    <p>è¯·æ£€æŸ¥ï¼š</p>
                    <ul style="text-align: left;">
                        <li>ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸</li>
                        <li>è¾“å…¥çš„ç”¨æˆ·åæˆ–FIDæ˜¯å¦æ­£ç¡®</li>
                        <li>APIæœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</li>
                    </ul>
                `;
            } finally {
                button.disabled = false;
                button.textContent = 'ğŸ” æ£€æµ‹ Warplet NFT';
                resultDiv.style.display = 'block';
            }
        }
    </script>
</body>
</html>
