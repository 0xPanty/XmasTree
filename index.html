<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jingle Gift | Share the joy on Farcaster</title>
    
    <!-- Open Graph -->
    <meta property="og:title" content="Jingle Gift">
    <meta property="og:description" content="Interactive 3D Christmas Tree with Music">
    <meta property="og:image" content="https://xmas-tree-opal.vercel.app/preview.svg">
    
    <!-- Farcaster Mini App -->
    <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://xmas-tree-opal.vercel.app/preview.svg","button":{"title":"üéÅ Open","action":{"type":"launch_frame","name":"Jingle Gift","splashImageUrl":"https://xmas-tree-opal.vercel.app/icon.svg","splashBackgroundColor":"#0a1a0a"}}}' />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;1,400&display=swap');

        :root {
            --emerald-dark: #001a10;
            --emerald: #023020;
            --gold: #D4AF37;
            --gold-light: #F7E7CE;
            --glass: rgba(20, 20, 20, 0.4);
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            font-family: 'Playfair Display', serif;
            color: var(--gold-light);
            overscroll-behavior: none;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* UI Overlay */
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 40px;
            box-sizing: border-box;
            background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.8) 100%);
            transition: background 1s ease;
        }

        .ui-hidden {
            opacity: 0 !important;
            pointer-events: none;
            transform: translateY(-20px);
        }
        
        .immersive-mode {
            background: transparent !important;
        }

        header {
            text-align: center;
            margin-top: 20px;
            pointer-events: auto;
            transition: all 1.2s cubic-bezier(0.19, 1, 0.22, 1);
        }

        h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: var(--gold);
            margin: 0;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
            opacity: 0;
            animation: fadeDown 1.5s ease-out forwards 0.5s;
        }

        .subtitle {
            font-size: 0.9rem;
            letter-spacing: 0.2em;
            color: rgba(255,255,255,0.6);
            margin-top: 10px;
            text-transform: uppercase;
            opacity: 0;
            animation: fadeDown 1.5s ease-out forwards 0.8s;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 20px;
            pointer-events: auto;
            opacity: 0;
            animation: fadeUp 1.5s ease-out forwards 1.2s;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-group {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: all 1s ease;
        }
        
        .btn-small {
            padding: 8px 16px !important;
            font-size: 0.85rem !important;
            min-width: auto !important;
        }

        button, .file-btn {
            background: var(--glass);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 15px 40px;
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            white-space: nowrap;
            touch-action: manipulation; 
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.4), transparent);
            transition: 0.5s;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            background: rgba(212, 175, 55, 0.2);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.3);
            transform: translateY(-2px);
        }

        button.active {
            background: var(--gold);
            color: var(--emerald-dark);
            box-shadow: 0 0 40px rgba(212, 175, 55, 0.6);
        }

        input[type="file"] {
            display: none;
        }

        /* --- Modal Styles --- */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .custom-modal.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-box {
            background: rgba(2, 48, 32, 0.95);
            border: 1px solid var(--gold);
            padding: 40px 60px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: 0 0 60px rgba(212, 175, 55, 0.2);
            transform: translateY(20px);
            transition: transform 0.5s ease;
            text-align: center;
            max-width: 90%;
            box-sizing: border-box;
        }

        .custom-modal.visible .modal-box {
            transform: translateY(0);
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .modal-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(212, 175, 55, 0.5);
            color: var(--gold-light);
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            padding: 10px;
            width: 300px;
            max-width: 100%;
            text-align: center;
            outline: none;
            transition: border-color 0.3s;
        }

        .modal-input:focus {
            border-bottom-color: var(--gold);
        }

        .modal-actions {
            margin-top: 20px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--gold);
            font-family: 'Cinzel', serif;
            letter-spacing: 0.2em;
            font-size: 0.8rem;
            animation: pulse 2s infinite;
            text-align: center;
            width: 100%;
        }

        @keyframes fadeDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        @keyframes toastFade { 0% { opacity: 0; transform: translateX(-50%) translateY(-10px); } 10% { opacity: 1; transform: translateX(-50%) translateY(0); } 90% { opacity: 1; } 100% { opacity: 0; } }

        /* --- Gift System Styles --- */
        .gift-form { display: flex; flex-direction: column; gap: 12px; }
        .form-group { text-align: left; }
        .form-group label { display: block; color: var(--gold); font-size: 0.75rem; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.1em; }
        .form-group input, .form-group select { width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.3); color: var(--gold-light); font-family: inherit; font-size: 0.9rem; box-sizing: border-box; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--gold); }
        .form-row { display: flex; gap: 10px; }
        .form-row .form-group { flex: 1; }
        .mode-toggle { display: flex; gap: 8px; margin-bottom: 12px; }
        .mode-btn { flex: 1; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.3); color: var(--gold); cursor: pointer; font-size: 0.75rem; transition: all 0.3s; }
        .mode-btn.active { background: var(--gold); color: var(--emerald-dark); }
        .type-toggle { display: flex; gap: 8px; }
        .type-btn { flex: 1; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.3); color: var(--gold); cursor: pointer; font-size: 0.7rem; }
        .type-btn.active { background: rgba(212,175,55,0.3); border-color: var(--gold); }
        .btn-gift { width: 100%; padding: 12px; background: linear-gradient(135deg, #D4AF37, #B8960C); border: none; color: var(--emerald-dark); font-family: 'Cinzel', serif; font-size: 0.85rem; cursor: pointer; margin-top: 8px; }
        .gift-preview { background: rgba(0,0,0,0.3); padding: 12px; margin-top: 8px; text-align: center; border: 1px dashed rgba(212,175,55,0.3); }
        .preview-amount { font-size: 1.3rem; color: var(--gold); font-weight: bold; }
        .preview-info { font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 4px; }
        .mode-hint { font-size: 0.7rem; color: rgba(255,255,255,0.4); text-align: center; margin-bottom: 8px; }
        .user-search-results { position: absolute; top: 100%; left: 0; right: 0; background: rgba(2,48,32,0.98); border: 1px solid var(--gold); max-height: 150px; overflow-y: auto; z-index: 10; }
        .user-result { display: flex; align-items: center; gap: 10px; padding: 8px 12px; cursor: pointer; transition: background 0.2s; }
        .user-result:hover { background: rgba(212,175,55,0.2); }
        .user-result img { width: 32px; height: 32px; border-radius: 50%; }
        .user-result .info { text-align: left; }
        .user-result .name { color: var(--gold); font-size: 0.85rem; }
        .user-result .username { color: rgba(255,255,255,0.5); font-size: 0.75rem; }
        .selected-user-card { display: flex; align-items: center; gap: 8px; background: rgba(212,175,55,0.1); border: 1px solid rgba(212,175,55,0.3); padding: 8px 12px; margin-top: 8px; }
        .selected-user-card img { width: 24px; height: 24px; border-radius: 50%; }
        .selected-user-card .remove-btn { margin-left: auto; background: none; border: none; color: #ff6b6b; cursor: pointer; font-size: 1.2rem; padding: 0 4px; }
        .claim-info { text-align: center; margin-bottom: 16px; }
        .claim-message { font-size: 1.1rem; color: var(--gold-light); margin-bottom: 8px; }
        .claim-amount { font-size: 1.5rem; color: var(--gold); font-weight: bold; }
        .claim-shares { font-size: 0.8rem; color: rgba(255,255,255,0.5); }

        /* --- Gift Plaza Styles --- */
        #gift-plaza {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 5;
            perspective: 800px;
        }
        .plaza-gift {
            position: absolute;
            width: clamp(24px, 3vw, 40px);
            height: clamp(24px, 3vw, 40px);
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            animation: orbit3d var(--orbit-duration, 15s) linear infinite;
            animation-delay: var(--orbit-delay, 0s);
            transform-style: preserve-3d;
        }
        .plaza-gift:hover {
            z-index: 100;
        }
        .plaza-gift:hover img {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(212,175,55,1);
        }
        .plaza-gift img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--gold);
            box-shadow: 0 0 10px rgba(212,175,55,0.8);
            transition: all 0.3s;
        }
        .plaza-gift .santa-emoji {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: clamp(10px, 1.5vw, 14px);
        }
        @keyframes orbit3d {
            0% { transform: rotateY(0deg) translateX(var(--orbit-radius, 180px)) rotateY(0deg); opacity: 1; z-index: 10; }
            25% { transform: rotateY(-90deg) translateX(var(--orbit-radius, 180px)) rotateY(90deg); opacity: 1; z-index: 10; }
            50% { transform: rotateY(-180deg) translateX(var(--orbit-radius, 180px)) rotateY(180deg); opacity: 0.3; z-index: 1; }
            75% { transform: rotateY(-270deg) translateX(var(--orbit-radius, 180px)) rotateY(270deg); opacity: 1; z-index: 10; }
            100% { transform: rotateY(-360deg) translateX(var(--orbit-radius, 180px)) rotateY(360deg); opacity: 1; z-index: 10; }
        }
        
        /* Plaza mode - smaller title */
        .title.plaza-mode {
            font-size: clamp(20px, 4vw, 36px) !important;
            margin-top: 2% !important;
        }
        .subtitle.plaza-mode {
            font-size: clamp(8px, 1.2vw, 12px) !important;
        }
        
        /* Plaza snowfall */
        #snowfall-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            overflow: hidden;
            display: none;
        }
        #snowfall-container.active { display: block; }
        .snow {
            position: absolute;
            top: -50px;
            color: #fff;
            opacity: 0.8;
            animation: snowFall linear infinite;
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
        }
        @keyframes snowFall {
            0% { transform: translateY(-50px) rotate(0deg); opacity: 0.8; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0.2; }
        }
        
        /* Plaza transition - Camera follow star animation */
        .scene-rotating {
            animation: sceneRotate 3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        @keyframes sceneRotate {
            0% { transform: rotateY(0deg) scale(1); }
            50% { transform: rotateY(180deg) scale(1.05); }
            100% { transform: rotateY(360deg) scale(1); }
        }
        .plaza-transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }
        .comet-star {
            position: absolute;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #fff 0%, #ffd700 30%, transparent 70%);
            border-radius: 50%;
            box-shadow: 
                0 0 30px 15px rgba(255,215,0,0.9),
                0 0 60px 30px rgba(255,215,0,0.6),
                0 0 100px 50px rgba(255,215,0,0.3);
            filter: blur(0.5px);
        }
        .comet-star::before {
            content: '‚≠ê';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 28px;
            filter: drop-shadow(0 0 15px #ffd700) drop-shadow(0 0 30px #fff);
            animation: starPulse 0.3s ease-in-out infinite alternate;
        }
        @keyframes starPulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            100% { transform: translate(-50%, -50%) scale(1.2); }
        }
        .comet-tail {
            position: absolute;
            top: 50%;
            right: 100%;
            width: 120px;
            height: 8px;
            background: linear-gradient(to left, rgba(255,255,255,0.95), rgba(255,215,0,0.7), rgba(255,215,0,0.3), transparent);
            border-radius: 4px;
            transform: translateY(-50%);
            filter: blur(2px);
        }
        .comet-tail::before {
            content: '';
            position: absolute;
            top: -4px;
            left: 0;
            width: 100%;
            height: 16px;
            background: linear-gradient(to left, rgba(255,215,0,0.3), transparent);
            filter: blur(4px);
        }
        .transition-particle {
            position: absolute;
            background: radial-gradient(circle, #fff, #ffd700);
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 0 6px 2px rgba(255,215,0,0.8);
        }
        @keyframes particleDrift {
            0% { transform: scale(1) translate(0, 0); opacity: 1; }
            100% { transform: scale(0) translate(var(--dx), var(--dy)); opacity: 0; }
        }
        .final-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 20%, rgba(255,255,255,0.8), rgba(255,215,0,0.4) 30%, transparent 60%);
            animation: flashBurst 0.6s ease-out forwards;
            pointer-events: none;
            z-index: 999;
        }
        @keyframes flashBurst {
            0% { opacity: 0; transform: scale(0.8); }
            20% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.2); }
        }

        
        .requirement-row { display: flex; align-items: center; gap: 8px; padding: 8px 0; }
        .requirement-row label { flex: 1; color: rgba(255,255,255,0.7); font-size: 0.8rem; }
        .requirement-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--gold); }
        .requirement-row input[type="number"] { width: 60px; padding: 4px 8px; }
        
        /* Greeting Card Styles */
        .greeting-card {
            position: relative;
            background: linear-gradient(135deg, #1a472a 0%, #0d2818 50%, #1a472a 100%);
            border: 3px solid var(--gold);
            border-radius: 16px;
            padding: 32px 24px;
            max-width: 340px;
            text-align: center;
            box-shadow: 0 0 40px rgba(212,175,55,0.3), inset 0 0 60px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: cardAppear 0.5s ease-out;
        }
        @keyframes cardAppear { from { transform: scale(0.8) rotateY(-20deg); opacity: 0; } to { transform: scale(1) rotateY(0); opacity: 1; } }
        .card-sparkles {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.8), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(212,175,55,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.6), transparent),
                radial-gradient(2px 2px at 130px 80px, rgba(212,175,55,0.6), transparent),
                radial-gradient(2px 2px at 200px 50px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 250px 90px, rgba(212,175,55,0.6), transparent);
            animation: sparkle 2s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes sparkle { 0%,100% { opacity: 0.5; } 50% { opacity: 1; } }
        .card-header { margin-bottom: 16px; }
        .card-avatar {
            width: 64px; height: 64px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            margin-bottom: 8px;
            box-shadow: 0 0 15px rgba(212,175,55,0.5);
        }
        .card-from { color: rgba(255,255,255,0.7); font-size: 0.9rem; }
        .card-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(212,175,55,0.5);
            margin: 16px 0;
        }
        .card-message {
            color: #fff;
            font-size: 1rem;
            line-height: 1.6;
            padding: 16px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            border-left: 3px solid var(--gold);
            margin: 16px 0;
            font-style: italic;
        }
        .card-gift {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 16px;
        }
        .card-gift-icon {
            font-size: 2.5rem;
            animation: bounce 1s ease-in-out infinite;
        }
        @keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .card-amount {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--gold);
        }
        
        /* Tip amount buttons */
        .tip-amt-btn {
            flex: 1;
            padding: 8px;
            background: rgba(212,175,55,0.2);
            border: 1px solid var(--gold);
            color: var(--gold);
            cursor: pointer;
            transition: all 0.2s;
        }
        .tip-amt-btn:hover { background: rgba(212,175,55,0.4); }
        
        /* Mailbox button */
        .mailbox-btn {
            font-size: 1.8rem !important;
            padding: 8px 16px !important;
            background: rgba(212,175,55,0.1) !important;
        }
        .mailbox-btn.has-gift {
            animation: mailGlow 1.5s ease-in-out infinite;
        }
        @keyframes mailGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(212,175,55,0.5), 0 0 20px rgba(212,175,55,0.3); }
            50% { box-shadow: 0 0 20px rgba(212,175,55,0.8), 0 0 40px rgba(212,175,55,0.5), 0 0 60px rgba(212,175,55,0.3); }
        }
        
        

        /* --- MOBILE RESPONSIVE STYLES --- */
        @media (max-width: 768px) {
            #ui {
                padding: 20px;
                padding-bottom: 30px; 
            }

            h1 {
                font-size: 1.8rem;
                letter-spacing: 0.15em;
            }

            .subtitle {
                font-size: 0.75rem;
            }

            .controls {
                flex-direction: column;
                width: 100%;
                gap: 12px;
                align-items: stretch;
                padding-bottom: 20px;
            }

            .btn-group {
                width: 100%;
            }

            button {
                width: 100%;
                padding: 12px 0;
                font-size: 0.9rem;
            }

            .modal-box {
                padding: 30px 20px;
                width: 90%;
            }
            
            .modal-input {
                width: 100%;
                font-size: 1rem;
            }
        }
    </style>
    <!-- React & Three Imports -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
                "three": "https://esm.sh/three@0.160.0",
                "@react-three/fiber": "https://esm.sh/@react-three/fiber@8.15.12?external=react,react-dom,three",
                "@react-three/drei": "https://esm.sh/@react-three/drei@9.96.1?external=react,react-dom,three,@react-three/fiber",
                "@react-three/postprocessing": "https://esm.sh/@react-three/postprocessing@2.16.0?external=react,react-dom,three,@react-three/fiber",
                "uuid": "https://esm.sh/uuid@9.0.1"
            }
        }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Ethers.js for Web3 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
    <script>
        // Contract Configuration
        const CONTRACT_ADDRESS = '0x5307bFc2F5bB5efC858622aDcAeE60619C51b884';
        const BASE_CHAIN_ID = 8453;
        const CONTRACT_ABI = [
            "function createGiftETH(uint256 shares, bytes32 passwordHash, uint8 giftType, bool proOnly, string title, uint256 duration) payable returns (uint256)",
            "function createGiftToken(address token, uint256 amount, uint256 shares, bytes32 passwordHash, uint8 giftType, bool proOnly, string title, uint256 duration) returns (uint256)",
            "function claimGift(uint256 giftId, string password, bool isPro)",
            "function refundGift(uint256 giftId)",
            "function getGift(uint256 giftId) view returns (address creator, address token, uint256 totalAmount, uint256 remainingAmount, uint256 totalShares, uint256 claimedShares, uint8 giftType, bool proOnly, string title, uint256 expireTime, bool active)",
            "function hasUserClaimed(uint256 giftId, address user) view returns (bool)",
            "function getUserClaimedAmount(uint256 giftId, address user) view returns (uint256)",
            "function giftCount() view returns (uint256)",
            "event GiftCreated(uint256 indexed giftId, address indexed creator, address token, uint256 totalAmount, uint256 shares, uint8 giftType, string title)",
            "event GiftClaimed(uint256 indexed giftId, address indexed claimer, uint256 amount)"
        ];
        
        // ERC20 ABI for token approvals
        const ERC20_ABI = [
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function balanceOf(address account) view returns (uint256)",
            "function decimals() view returns (uint8)"
        ];

        // Web3 State
        let web3Provider = null;
        let web3Signer = null;
        let giftContract = null;
        let connectedAddress = null;

        // Connect Wallet
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    alert('Please install MetaMask or use a Web3 browser!');
                    return false;
                }
                
                web3Provider = new ethers.BrowserProvider(window.ethereum);
                await web3Provider.send("eth_requestAccounts", []);
                
                // Check network
                const network = await web3Provider.getNetwork();
                if (Number(network.chainId) !== BASE_CHAIN_ID) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x' + BASE_CHAIN_ID.toString(16) }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x' + BASE_CHAIN_ID.toString(16),
                                    chainName: 'Base',
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: ['https://mainnet.base.org'],
                                    blockExplorerUrls: ['https://basescan.org']
                                }]
                            });
                        }
                    }
                    web3Provider = new ethers.BrowserProvider(window.ethereum);
                }
                
                web3Signer = await web3Provider.getSigner();
                connectedAddress = await web3Signer.getAddress();
                giftContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, web3Signer);
                
                // Update UI
                const walletBtn = document.getElementById('wallet-btn');
                if (walletBtn) {
                    walletBtn.textContent = connectedAddress.slice(0, 6) + '...' + connectedAddress.slice(-4);
                    walletBtn.classList.add('connected');
                }
                
                console.log('Wallet connected:', connectedAddress);
                return true;
            } catch (error) {
                console.error('Wallet connection failed:', error);
                alert('Failed to connect wallet: ' + error.message);
                return false;
            }
        }

        // Hash password for contract
        function hashPassword(password) {
            return ethers.keccak256(ethers.toUtf8Bytes(password));
        }
    </script>
</head>
<body>
    <!-- Create Gift Modal -->
    <div id="gift-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 400px;">
            <div class="modal-title">üéÅ Send Christmas Gift</div>
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="selectGiftMode('direct')">üéØ Direct Gift</button>
                <button class="mode-btn" onclick="selectGiftMode('redpacket')">üßß Red Packet</button>
            </div>
            <div class="mode-hint" id="mode-hint">Send directly to specific Farcaster user(s)</div>
            <div class="gift-form">
                <div class="form-group">
                    <label>Gift Title</label>
                    <input type="text" id="gift-title" placeholder="Merry Christmas!" maxlength="50">
                </div>
                <div class="form-group" id="recipient-group" style="position:relative;">
                    <label>Recipient (max 10)</label>
                    <input type="text" id="gift-recipient" placeholder="Search Farcaster username..." oninput="searchUsers(this.value)">
                    <div id="user-results" class="user-search-results" style="display:none;"></div>
                    <div id="selected-user"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Token</label>
                        <select id="gift-token" onchange="togglePlazaCustomToken()">
                            <option value="USDC">USDC</option>
                            <option value="ETH">ETH</option>
                            <option value="CUSTOM">Custom Token</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="gift-amount" value="0.1" step="0.01" min="0.1" oninput="validatePlazaAmount(); updatePreview()">
                    </div>
                </div>
                <div class="form-group" id="plaza-custom-token-group" style="display:none;">
                    <label>Token Contract Address (Base)</label>
                    <input type="text" id="plaza-token-ca" placeholder="0x..." style="font-size:0.8rem;">
                </div>
                <div class="form-group" id="shares-group" style="display:none;">
                    <label>Number of Shares</label>
                    <input type="number" id="gift-shares" value="5" min="1" max="100" oninput="updatePreview()">
                </div>
                <div class="form-group" id="distribution-group" style="display:none;">
                    <label>Distribution Type</label>
                    <div class="type-toggle">
                        <button type="button" class="type-btn active" onclick="selectGiftType('equal')">Equal Split</button>
                        <button type="button" class="type-btn" onclick="selectGiftType('lucky')">Lucky Draw</button>
                    </div>
                </div>
                <div class="form-group" id="requirements-group">
                    <label>Claim Requirements</label>
                    <div class="requirement-row">
                        <label>Require Code</label>
                        <input type="checkbox" id="require-code" onchange="toggleCodeInput(); updatePreview();">
                    </div>
                    <div class="requirement-row" id="code-input-row" style="display:none;">
                        <label>Secret Code</label>
                        <input type="text" id="gift-code" placeholder="e.g. XMAS2024" maxlength="20" style="width:100px;">
                    </div>
                    <div class="requirement-row">
                        <label>Require Farcaster Pro</label>
                        <input type="checkbox" id="require-pro" onchange="updatePreview()">
                    </div>
                    <div class="requirement-row">
                        <label>Min Neynar Score</label>
                        <input type="number" id="min-score" placeholder="0" min="0" max="1" step="0.01" value="0" oninput="updatePreview()">
                    </div>
                </div>
                <div class="gift-preview">
                    <div class="preview-amount" id="preview-amount">0 ETH</div>
                    <div class="preview-info" id="preview-info">Select recipient(s) above</div>
                </div>
                <button class="btn-gift" onclick="createGift()">Create Gift</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeGiftModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Claim Gift Modal -->
    <div id="claim-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 350px;">
            <div class="modal-title">üéÅ Christmas Gift!</div>
            <div class="claim-info">
                <div class="claim-message" id="claim-message">Someone sent you a gift!</div>
                <div id="claim-recipient" style="margin-bottom:8px;"></div>
                <div class="claim-amount">üí∞ <span id="claim-remaining">0</span></div>
                <div class="claim-shares">Claimed: <span id="claim-shares">0/0</span></div>
            </div>
            <div class="gift-form">
                <div class="form-group">
                    <label>Enter Password</label>
                    <input type="text" id="claim-password" placeholder="Enter claim code">
                </div>
                <button class="btn-gift" onclick="claimGift()">Claim Gift</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeClaimModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Greeting Card Modal -->
    <div id="card-modal" class="custom-modal">
        <div class="greeting-card">
            <div class="card-sparkles"></div>
            <div class="card-header">
                <img id="card-sender-pfp" src="" class="card-avatar">
                <div class="card-from">From @<span id="card-sender-name">sender</span></div>
            </div>
            <div class="card-title" id="card-title">Merry Christmas!</div>
            <div class="card-message" id="card-message">Wishing you joy and happiness!</div>
            <div class="card-gift">
                <div class="card-gift-icon">üéÅ</div>
                <div class="card-amount" id="card-amount">0.01 ETH</div>
            </div>
            <button class="btn-gift" onclick="claimCardGift()" style="margin-top:16px;">Open Gift</button>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="custom-modal" style="background: rgba(0,0,0,0.3); backdrop-filter: none;">
        <div class="modal-box" style="max-width: 300px; text-align: center; background: rgba(0,0,0,0.7); border-color: var(--gold);">
            <div style="font-size: 3rem;">üéâ</div>
            <div class="modal-title">Gift Claimed!</div>
            <div style="color: var(--gold); font-size: 1.5rem; margin: 16px 0;" id="success-amount">0.01 ETH</div>
            <button class="btn-gift" onclick="closeSuccessModal()">Awesome!</button>
        </div>
        <button onclick="goHome()" style="position:fixed; bottom:40px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.6); border:2px solid var(--gold); color:var(--gold); width:60px; height:60px; border-radius:50%; font-size:2rem; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow: 0 0 20px rgba(212,175,55,0.3);">‚Ü©</button>
    </div>
    
    <!-- My Gifts Record Modal -->
    <div id="record-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 400px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-title">üìã My Gifts Record</div>
            <div id="record-list" style="margin-top:12px;"></div>
            <button class="btn-cancel" onclick="closeRecordModal()" style="margin-top:12px;">Close</button>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 250px; text-align: center;">
            <div style="font-size: 2rem; animation: pulse 1s infinite;">‚è≥</div>
            <div id="loading-text" style="color: var(--gold-light); margin-top: 12px;">Processing...</div>
        </div>
    </div>

    <!-- Tip Author Modal -->
    <div id="tip-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 340px;">
            <div class="modal-title">‚òï Tip the Author</div>
            <div style="text-align:center; margin-bottom:16px;">
                <img id="author-avatar" src="" style="width:64px; height:64px; border-radius:50%; border:2px solid var(--gold); margin-bottom:8px;">
                <div style="color:var(--gold); font-size:1rem; margin-bottom:4px;">@<span id="author-name">xqc</span></div>
                <div style="color:rgba(255,255,255,0.7); font-size:0.85rem;">Support the creator of this Christmas Tree!</div>
            </div>
            <div class="gift-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Token</label>
                        <input type="text" value="USDC" disabled style="opacity:0.8; background:rgba(0,0,0,0.3); border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; width:100%; text-align:center;">
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="tip-amount" value="1" min="0.1" step="0.1">
                    </div>
                </div>
                <div id="tip-amounts" style="display:flex; gap:8px; margin-bottom:12px;"></div>
                <button class="btn-gift" onclick="sendTip()">Send Tip ‚ù§Ô∏è</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeTipModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Direct Gift Modal (Send to Friends) -->
    <div id="direct-gift-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 400px;">
            <div class="modal-title">üéÅ Send to Friends</div>
            <div class="mode-hint">Search and select up to 10 Farcaster users</div>
            <div class="gift-form">
                <div class="form-group">
                    <label>Gift Title</label>
                    <input type="text" id="direct-gift-title" placeholder="Merry Christmas!" maxlength="50">
                </div>
                <div class="form-group">
                    <label>Message</label>
                    <textarea id="direct-gift-message" placeholder="Write your heartfelt message here..." maxlength="200" style="width:100%; height:60px; resize:none; background:rgba(0,0,0,0.3); border:1px solid rgba(212,175,55,0.3); color:#fff; padding:8px; font-family:inherit;"></textarea>
                </div>
                <div class="form-group" style="position:relative;">
                    <label>Recipients (max 10)</label>
                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                        <input type="text" id="user-search" placeholder="Search Farcaster username..." oninput="searchUsers(this.value)" style="flex:1;">
                        <button type="button" onclick="fetchTopFriends()" style="padding:8px 12px; background:rgba(212,175,55,0.2); border:1px solid var(--gold); color:var(--gold); cursor:pointer; white-space:nowrap; font-size:0.8rem;">üë• Friends</button>
                    </div>
                    <div id="user-results" class="user-search-results" style="display:none;"></div>
                    <div id="selected-users"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Token</label>
                        <select id="direct-gift-token" onchange="toggleCustomToken()">
                            <option value="ETH">ETH</option>
                            <option value="USDC">USDC</option>
                            <option value="CUSTOM">Custom Token</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount Each</label>
                        <input type="number" id="direct-gift-amount" value="0.5" step="0.1" min="0.1" oninput="validateDirectAmount(); updateDirectPreview()">
                    </div>
                </div>
                <div class="form-group" id="custom-token-group" style="display:none;">
                    <label>Token Contract Address (Base)</label>
                    <input type="text" id="custom-token-ca" placeholder="0x..." style="font-size:0.8rem;">
                </div>
                <div class="gift-preview">
                    <div class="preview-amount" id="direct-preview-amount">0 ETH</div>
                    <div class="preview-info" id="direct-preview-info">Select recipient(s) above</div>
                </div>
                <button class="btn-gift" onclick="createDirectGift()">Send Gift</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeDirectGiftModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Claim Input Modal -->
    <div id="claim-input-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 350px;">
            <div class="modal-title">üéÅ Claim Gift</div>
            <div class="gift-form">
                <div class="form-group">
                    <label>Enter Gift Code</label>
                    <input type="text" id="gift-code-input" placeholder="Paste gift link or code...">
                </div>
                <button class="btn-gift" onclick="claimByCode()">Claim</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeClaimInput()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="ui">
        <header id="main-header">
            <!-- TITLE UPDATED -->
            <h1 id="app-title">Jingle Gift</h1>
            <div id="app-subtitle" class="subtitle">Share the joy on Farcaster</div>
        </header>
        <div class="controls">
            <!-- Top row: Wallet + Mailbox + Record + Tip -->
            <div class="btn-row" id="top-btns">
                <button id="wallet-btn" onclick="connectWallet()" class="btn-small" style="font-size:1.5rem !important; padding:8px 16px !important;">üëõ</button>
                <button id="mailbox-button" onclick="openMyGifts()" class="btn-small" style="font-size:1.5rem !important; padding:8px 16px !important;">üì¨</button>
                <button onclick="openRecordModal()" class="btn-small" style="font-size:1.5rem !important; padding:8px 16px !important;">üìã</button>
                <button onclick="openTipModal()" class="btn-small" style="font-size:1.5rem !important; padding:8px 16px !important;">‚òï</button>
            </div>
            <!-- Plaza mode buttons -->
            <div class="btn-row" id="plaza-send-btn" style="display:none;">
                <button onclick="openGiftModal()" class="btn-small">üéÅ Gift</button>
                <button onclick="openRecordModal()" class="btn-small">üìã Record</button>
            </div>
            <!-- Bottom rows: Send + Plaza -->
            <div class="btn-row" id="main-btns">
                <button onclick="openDirectGiftModal()" class="btn-small">üéÅ Send to Friends</button>
            </div>
            <div class="btn-row">
                <button id="plaza-btn" onclick="togglePlazaMode()" class="btn-small">üéÑ Plaza Gift</button>
            </div>
        </div>
        
        <!-- Gift Plaza - Orbiting Avatars (hidden by default) -->
        <div id="gift-plaza" style="display:none;"></div>
        <div id="snowfall-container"></div>
    </div>
    
    <div id="canvas-container">
        <div class="loading">Initializing Luxury Asset Pipeline...</div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useMemo, useEffect, Suspense } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as THREE from 'three';
        import { Canvas, useFrame, useThree, extend } from '@react-three/fiber';
        import { OrbitControls, Environment, Float, Sparkles, PerspectiveCamera, Stars } from '@react-three/drei';
        import { EffectComposer, Bloom, Vignette, Noise, ToneMapping } from '@react-three/postprocessing';

        // --- Audio Infrastructure ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 256; 
        const dataArray = new Uint8Array(analyser.frequencyBinCount); // 128 bins
        
        let activeSourceNode = null; 
        
        const defaultAudioEl = new Audio('https://cdn.pixabay.com/audio/2025/05/26/audio_95504c3693.mp3');
        defaultAudioEl.crossOrigin = "anonymous";
        defaultAudioEl.loop = true;
        
        let defaultMediaElementSource = null;

        const useAudioData = () => {
            const frequency = useRef(0);
            useFrame(() => {
                analyser.getByteFrequencyData(dataArray);
                const avg = dataArray.reduce((a, b) => a + b) / dataArray.length;
                frequency.current = avg; 
            });
            return frequency;
        };

        // --- Custom Shaders ---

        const foliageVertexShader = `
            uniform float uTime;
            uniform float uProgress; // 0 = Scattered, 1 = Tree
            uniform float uAudio;
            attribute vec3 aScatterPos;
            attribute vec3 aTreePos;
            attribute float aRandom;
            varying float vVisible;
            varying vec2 vUv;
            varying float vRandom;
            varying float vHeight;
            void main() {
                vUv = uv;
                vRandom = aRandom;
                vec3 finalPos = mix(aScatterPos, aTreePos, uProgress);
                float breathe = sin(uTime * 2.0 + aRandom * 10.0) * 0.05;
                float beat = uAudio * 0.02 * uProgress; 
                finalPos += normal * (breathe + beat);
                if(uProgress < 0.5) {
                    finalPos.y += sin(uTime + aScatterPos.x) * 0.2 * (1.0 - uProgress);
                }
                vHeight = finalPos.y; 
                vec4 mvPosition = modelViewMatrix * vec4(finalPos, 1.0);
                gl_PointSize = (4.0 * (1.0 + uAudio * 0.1)) * (20.0 / -mvPosition.z);
                gl_Position = projectionMatrix * mvPosition;
            }
        `;

        const foliageFragmentShader = `
            uniform float uTime;
            uniform float uAudio; 
            varying float vRandom;
            varying float vHeight;
            varying vec2 vUv;
            void main() {
                vec2 center = gl_PointCoord - 0.5;
                float dist = length(center);
                if (dist > 0.5) discard;
                vec3 emerald = vec3(0.0, 0.25, 0.18);   
                vec3 ruby = vec3(0.3, 0.02, 0.05);      
                vec3 gold = vec3(1.0, 0.9, 0.4);        
                float timeCycle = sin(uTime * 0.4) * 0.5 + 0.5; 
                vec3 baseTone = mix(emerald, ruby, timeCycle * 0.2); 
                float heightFactor = smoothstep(-5.0, 8.0, vHeight);
                vec3 gradientBase = mix(baseTone * 0.5, baseTone * 1.8, heightFactor);
                float beatStrength = smoothstep(0.4, 0.9, uAudio); 
                vec3 rhythmicColor = mix(gradientBase, gold, beatStrength * 0.4);
                float sparkle = sin(uTime * 3.0 + vRandom * 100.0);
                float isTip = step(0.96, sin(vRandom * 30.0 + uTime + uAudio * 5.0)); 
                vec3 finalColor = mix(rhythmicColor, gold * 2.5, isTip * (sparkle * 0.5 + 0.5 + beatStrength));
                float alpha = 1.0 - smoothstep(0.4, 0.5, dist);
                gl_FragColor = vec4(finalColor, alpha * 0.9);
            }
        `;

        // --- Utils: Gift Texture Generator ---
        function createGiftTexture(type) {
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            
            if (type === 0) { // Red + Gold Ribbon
                ctx.fillStyle = '#8B0000'; ctx.fillRect(0,0,256,256);
                ctx.fillStyle = '#FFD700'; 
                ctx.fillRect(118, 0, 20, 256); // Vert
                ctx.fillRect(0, 118, 256, 20); // Horiz
            } else if (type === 1) { // Green + Gold Stripes
                ctx.fillStyle = '#023020'; ctx.fillRect(0,0,256,256);
                ctx.fillStyle = '#D4AF37';
                ctx.lineWidth = 15;
                for(let i=-256; i<512; i+=40) {
                    ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i+256, 256); ctx.stroke();
                }
            } else if (type === 2) { // Navy + Silver Dots
                ctx.fillStyle = '#000080'; ctx.fillRect(0,0,256,256);
                ctx.fillStyle = '#C0C0C0';
                for(let x=0; x<256; x+=40) {
                    for(let y=0; y<256; y+=40) {
                        ctx.beginPath(); ctx.arc(x, y, 6, 0, Math.PI*2); ctx.fill();
                    }
                }
            } else { // Gold + Red Ribbon
                ctx.fillStyle = '#D4AF37'; ctx.fillRect(0,0,256,256);
                ctx.fillStyle = '#8B0000';
                ctx.fillRect(118, 0, 20, 256);
                ctx.fillRect(0, 118, 256, 20);
            }
            
            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = THREE.RepeatWrapping;
            tex.wrapT = THREE.RepeatWrapping;
            return tex;
        }

        // --- Components ---

        const AudioSpectrumRing = ({ isTree }) => {
            const meshRef = useRef();
            const count = 128; 
            const dummy = useMemo(() => new THREE.Object3D(), []);
            const [color] = useState(() => new THREE.Color());

            useEffect(() => {
                if (meshRef.current) {
                    for (let i = 0; i < count; i++) {
                        color.setHSL(i / count, 1.0, 0.5); 
                        color.multiplyScalar(1.5); 
                        meshRef.current.setColorAt(i, color);
                    }
                    meshRef.current.instanceColor.needsUpdate = true;
                }
            }, []);

            const [scatterTargets] = useState(() => {
                const scatter = new Float32Array(count * 3);
                for(let i=0; i<count; i++) {
                    const r = 25 * Math.cbrt(Math.random()); 
                    const theta = Math.random() * 2 * Math.PI;
                    const phi = Math.acos(2 * Math.random() - 1);
                    scatter[i*3] = r * Math.sin(phi) * Math.cos(theta);
                    scatter[i*3+1] = r * Math.sin(phi) * Math.sin(theta);
                    scatter[i*3+2] = r * Math.cos(phi);
                }
                return scatter;
            });

            useFrame((state, delta) => {
                if(!meshRef.current) return;
                meshRef.current.userData.progress = THREE.MathUtils.lerp(
                    meshRef.current.userData.progress || 0,
                    isTree ? 1 : 0,
                    delta * 1.5
                );
                const p = meshRef.current.userData.progress;

                for(let i=0; i<count; i++) {
                    const val = dataArray[i] || 0;
                    const length = (0.5 + (val / 255.0) * 8.0) * 0.66;
                    const angle = (i / count) * Math.PI * 2;
                    const baseRadius = 6.0;
                    const dist = baseRadius + length / 2;
                    const treeX = dist * Math.cos(angle);
                    const treeY = -4.5; 
                    const treeZ = dist * Math.sin(angle);

                    const posX = THREE.MathUtils.lerp(scatterTargets[i*3], treeX, p);
                    const posY = THREE.MathUtils.lerp(scatterTargets[i*3+1], treeY, p);
                    const posZ = THREE.MathUtils.lerp(scatterTargets[i*3+2], treeZ, p);

                    dummy.position.set(posX, posY, posZ);

                    if (p > 0.5) {
                        dummy.lookAt(0, -4.5, 0); 
                        dummy.scale.set(0.15, 0.1, length);
                    } else {
                        dummy.rotation.set(state.clock.elapsedTime * 0.2 + i, i, 0);
                        const s = THREE.MathUtils.lerp(0.5, 0.15, p);
                        dummy.scale.set(s, 0.1, s); 
                    }
                    dummy.updateMatrix();
                    meshRef.current.setMatrixAt(i, dummy.matrix);
                }
                meshRef.current.instanceMatrix.needsUpdate = true;
            });

            return (
                <instancedMesh ref={meshRef} args={[null, null, count]}>
                    <boxGeometry args={[1, 1, 1]} />
                    <meshStandardMaterial 
                        toneMapped={false} 
                        roughness={0.1}
                        metalness={0.8}
                        emissive="#111111" 
                    />
                </instancedMesh>
            );
        };

        const Foliage = ({ isTree, count = 15000 }) => {
            const meshRef = useRef();
            const audioFreq = useAudioData();
            
            const uniforms = useMemo(() => ({
                uTime: { value: 0 },
                uProgress: { value: 0 },
                uAudio: { value: 0 }
            }), []);

            const [attributes] = useState(() => {
                const scatterPos = new Float32Array(count * 3);
                const treePos = new Float32Array(count * 3);
                const randoms = new Float32Array(count);
                const treeHeight = 12;
                const treeRadius = 4.5;

                for (let i = 0; i < count; i++) {
                    const i3 = i * 3;
                    const r = 15 * Math.cbrt(Math.random());
                    const theta = Math.random() * 2 * Math.PI;
                    const phi = Math.acos(2 * Math.random() - 1);
                    scatterPos[i3] = r * Math.sin(phi) * Math.cos(theta);
                    scatterPos[i3+1] = r * Math.sin(phi) * Math.sin(theta);
                    scatterPos[i3+2] = r * Math.cos(phi);

                    const y = Math.random() * treeHeight; 
                    const normalizedY = y / treeHeight; 
                    const currentRadius = (1.0 - normalizedY) * treeRadius;
                    const angle = i * 0.1; 
                    const noise = (Math.random() - 0.5) * 0.5;
                    
                    treePos[i3] = (currentRadius + noise) * Math.cos(angle);
                    treePos[i3+1] = y - 4; 
                    treePos[i3+2] = (currentRadius + noise) * Math.sin(angle);
                    randoms[i] = Math.random();
                }
                return { scatterPos, treePos, randoms };
            });

            useFrame((state, delta) => {
                if (meshRef.current) {
                    meshRef.current.material.uniforms.uTime.value += delta;
                    const targetProgress = isTree ? 1.0 : 0.0;
                    meshRef.current.material.uniforms.uProgress.value = THREE.MathUtils.lerp(
                        meshRef.current.material.uniforms.uProgress.value,
                        targetProgress,
                        delta * 1.5
                    );
                    const normalizedAudio = Math.min(audioFreq.current / 128.0, 1.0); 
                    meshRef.current.material.uniforms.uAudio.value = THREE.MathUtils.lerp(
                        meshRef.current.material.uniforms.uAudio.value,
                        normalizedAudio,
                        0.2 
                    );
                    meshRef.current.rotation.y += 0.001;
                }
            });

            return (
                <points ref={meshRef}>
                    <bufferGeometry>
                        <bufferAttribute attach="attributes-position" count={count} array={attributes.scatterPos} itemSize={3} />
                        <bufferAttribute attach="attributes-aScatterPos" count={count} array={attributes.scatterPos} itemSize={3} />
                        <bufferAttribute attach="attributes-aTreePos" count={count} array={attributes.treePos} itemSize={3} />
                        <bufferAttribute attach="attributes-aRandom" count={count} array={attributes.randoms} itemSize={1} />
                    </bufferGeometry>
                    <shaderMaterial
                        vertexShader={foliageVertexShader}
                        fragmentShader={foliageFragmentShader}
                        uniforms={uniforms}
                        transparent={true}
                        depthWrite={false}
                        blending={THREE.AdditiveBlending}
                    />
                </points>
            );
        };

        const Ornaments = ({ isTree, count = 200, type = "sphere", color = "#D4AF37", scale = 0.3, textureStyle }) => {
            const meshRef = useRef();
            const audioFreq = useAudioData();
            
            // Texture for Gifts
            const texture = useMemo(() => {
                if (textureStyle === undefined) return null;
                return createGiftTexture(textureStyle);
            }, [textureStyle]);

            const [data] = useState(() => {
                const arr = [];
                const treeHeight = 11;
                const treeRadius = 4;
                
                for (let i = 0; i < count; i++) {
                    const r = 12 * Math.cbrt(Math.random());
                    const theta = Math.random() * 2 * Math.PI;
                    const phi = Math.acos(2 * Math.random() - 1);
                    const sx = r * Math.sin(phi) * Math.cos(theta);
                    const sy = r * Math.sin(phi) * Math.sin(theta);
                    const sz = r * Math.cos(phi);

                    const y = Math.random() * treeHeight;
                    const nY = y / treeHeight;
                    const cR = (1.0 - nY) * treeRadius; 
                    const ang = Math.random() * Math.PI * 2;
                    
                    const tx = cR * Math.cos(ang);
                    const ty = y - 4;
                    const tz = cR * Math.sin(ang);

                    arr.push({ scatter: new THREE.Vector3(sx, sy, sz), tree: new THREE.Vector3(tx, ty, tz) });
                }
                return arr;
            });

            const dummy = useMemo(() => new THREE.Object3D(), []);

            useFrame((state, delta) => {
                if (!meshRef.current) return;

                const t = state.clock.elapsedTime;
                const target = isTree ? 1 : 0;
                
                meshRef.current.userData.progress = THREE.MathUtils.lerp(
                    meshRef.current.userData.progress || 0,
                    target,
                    delta * 1.2
                );
                
                const p = meshRef.current.userData.progress;
                const audioScale = 1 + (audioFreq.current / 255) * 0.3;

                data.forEach((item, i) => {
                    const { scatter, tree } = item;
                    dummy.position.lerpVectors(scatter, tree, p);
                    
                    dummy.position.y += Math.sin(t + i) * 0.02 * (1-p); 
                    
                    dummy.scale.setScalar(scale * (i % 2 === 0 ? audioScale : 1));
                    
                    dummy.rotation.x = t * 0.2 + i;
                    dummy.rotation.z = t * 0.1 + i;
                    
                    dummy.updateMatrix();
                    meshRef.current.setMatrixAt(i, dummy.matrix);
                });
                meshRef.current.instanceMatrix.needsUpdate = true;
            });

            const geometry = type === 'box' ? new THREE.BoxGeometry(1, 1, 1) : new THREE.SphereGeometry(1, 16, 16);

            return (
                <instancedMesh ref={meshRef} args={[geometry, null, count]}>
                    <meshStandardMaterial 
                        color={texture ? "white" : color} // White base if texture is present
                        map={texture}
                        roughness={texture ? 0.3 : 0.1} // Gifts are slightly less shiny than metal balls
                        metalness={texture ? 0.5 : 0.9} 
                        emissive={texture ? "#222" : color} // Subtle emissive for texture
                        emissiveIntensity={0.2}
                    />
                </instancedMesh>
            );
        };

        const StarTopper = ({ isTree }) => {
            const ref = useRef();

            const starGeometry = useMemo(() => {
                const shape = new THREE.Shape();
                const points = 5;
                const outerRadius = 0.8;
                const innerRadius = 0.4;
                const angleOffset = Math.PI / 2; 

                for (let i = 0; i < points * 2; i++) {
                    const angle = (i * Math.PI) / points + angleOffset;
                    const radius = i % 2 === 0 ? outerRadius : innerRadius;
                    const x = Math.cos(angle) * radius;
                    const y = Math.sin(angle) * radius;
                    if (i === 0) shape.moveTo(x, y);
                    else shape.lineTo(x, y);
                }
                shape.closePath();

                const extrudeSettings = {
                    depth: 0.2,
                    bevelEnabled: true,
                    bevelThickness: 0.1,
                    bevelSize: 0.05,
                    bevelSegments: 3
                };

                const geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
                geometry.computeBoundingBox();
                const zCenter = (geometry.boundingBox.max.z - geometry.boundingBox.min.z) / 2;
                geometry.translate(0, 0, -zCenter); 
                return geometry;
            }, []);
            
            useFrame((state, delta) => {
                if(ref.current) {
                    const targetY = isTree ? 9 : 15; 
                    const targetScale = isTree ? 1 : 0.1;
                    ref.current.position.y = THREE.MathUtils.lerp(ref.current.position.y, targetY, delta * 2);
                    ref.current.scale.setScalar(THREE.MathUtils.lerp(ref.current.scale.x, targetScale, delta * 2));
                    ref.current.rotation.y += delta;
                }
            });

            return (
                <group ref={ref} position={[0, 15, 0]}>
                    <mesh geometry={starGeometry}>
                        <meshStandardMaterial color="#FFD700" emissive="#FFD700" emissiveIntensity={2} toneMapped={false} />
                    </mesh>
                    <pointLight color="#FFD700" intensity={5} distance={10} decay={2} />
                </group>
            );
        };

        const ResponsiveCamera = () => {
            const { camera, size } = useThree();
            useEffect(() => {
                const isMobilePortrait = size.width < 768 && size.width < size.height;
                const targetZ = isMobilePortrait ? 35 : 20; 
                camera.position.z = targetZ;
                camera.updateProjectionMatrix();
            }, [size.width, size.height, camera]);
            return null;
        };

        const Scene = ({ isTree }) => {
            return (
                <>
                    <PerspectiveCamera makeDefault position={[0, 4, 20]} fov={50} />
                    <ResponsiveCamera /> 
                    <OrbitControls enablePan={false} minDistance={10} maxDistance={50} maxPolarAngle={Math.PI / 1.5} autoRotate={true} autoRotateSpeed={0.5} />
                    <Environment preset="city" blur={1} background={false} />
                    <ambientLight intensity={0.2} color="#002b16" />
                    <spotLight position={[10, 20, 10]} angle={0.3} penumbra={1} intensity={2} castShadow color="#F7E7CE" />
                    <spotLight position={[-10, 5, 10]} angle={0.5} penumbra={1} intensity={1} color="#023020" />
                    
                    <Foliage isTree={isTree} />
                    <AudioSpectrumRing isTree={isTree} />

                    {/* Heavy Ornaments - Textured Gifts Boxes */}
                    <Ornaments isTree={isTree} count={15} type="box" scale={0.5} textureStyle={0} />
                    <Ornaments isTree={isTree} count={15} type="box" scale={0.5} textureStyle={1} />
                    <Ornaments isTree={isTree} count={15} type="box" scale={0.5} textureStyle={2} />
                    <Ornaments isTree={isTree} count={15} type="box" scale={0.5} textureStyle={3} />
                    
                    {/* Light Ornaments (Balls) - Now Textured Spheres */}
                    <Ornaments isTree={isTree} count={40} type="sphere" scale={0.3} textureStyle={0} />
                    <Ornaments isTree={isTree} count={40} type="sphere" scale={0.3} textureStyle={1} />
                    <Ornaments isTree={isTree} count={40} type="sphere" scale={0.3} textureStyle={2} />
                    
                    {/* Tiny Lights - Warm White */}
                    <Ornaments isTree={isTree} count={300} type="sphere" color="#FFFDD0" scale={0.05} />

                    <StarTopper isTree={isTree} />
                    <Sparkles count={200} scale={12} size={2} speed={0.4} opacity={0.5} color="#F7E7CE" />
                </>
            );
        };

        const PostProcessingEffects = () => {
            return (
                <EffectComposer disableNormalPass>
                    <Bloom luminanceThreshold={0.8} mipmapBlur intensity={1.2} radius={0.6} />
                    <ToneMapping />
                    <Vignette eskil={false} offset={0.1} darkness={1.1} />
                    <Noise opacity={0.02} /> 
                </EffectComposer>
            );
        };

        const App = () => {
            const [isTree, setIsTree] = useState(false); // Start scattered (gift), then become tree
            const [audioReady, setAudioReady] = useState(false);

            useEffect(() => {
                // Gift ‚Üí Tree animation on load
                const timer = setTimeout(() => {
                    setIsTree(true);
                }, 1500); // Wait 1.5s then assemble tree
                
                const resumeContext = () => { if (audioContext.state === 'suspended') audioContext.resume(); };

                const startDefaultMusic = () => {
                    if (!defaultMediaElementSource) {
                        try {
                            defaultMediaElementSource = audioContext.createMediaElementSource(defaultAudioEl);
                            defaultMediaElementSource.connect(analyser);
                            analyser.connect(audioContext.destination);
                            activeSourceNode = defaultMediaElementSource;
                        } catch(e) { console.log("Audio node error", e); }
                    }
                    
                    defaultAudioEl.play().then(() => {
                        setAudioReady(true);
                    }).catch(e => {
                        const unlockAndPlay = () => {
                            resumeContext();
                            defaultAudioEl.play();
                            setAudioReady(true);
                            document.removeEventListener('click', unlockAndPlay);
                            document.removeEventListener('touchstart', unlockAndPlay);
                        };
                        document.addEventListener('click', unlockAndPlay);
                        document.addEventListener('touchstart', unlockAndPlay);
                    });
                };

                startDefaultMusic(); 
                
                // Expose tree control functions globally
                window.scatterTree = () => setIsTree(false);
                window.assembleTree = () => setIsTree(true);
                
                return () => clearTimeout(timer);
            }, []); 

            useEffect(() => {
                // Tree state changed
            }, [isTree]);

            return (
                <Canvas shadows dpr={[1, 2]} gl={{ antialias: false, toneMappingExposure: 1.5 }}>
                    <color attach="background" args={['#000500']} />
                    <Suspense fallback={null}>
                        <Scene isTree={isTree} />
                        <PostProcessingEffects />
                    </Suspense>
                </Canvas>
            );
        };

        const root = createRoot(document.getElementById('canvas-container'));
        root.render(<App />);
        
        // Farcaster Mini App SDK - signal ready after render
        setTimeout(() => {
            import('https://esm.sh/@farcaster/miniapp-sdk').then(({ sdk }) => {
                window.farcasterSDK = sdk;
                sdk.actions.ready();
                console.log('Farcaster Mini App ready');
            }).catch(err => console.log('SDK error:', err));
        }, 100);
    </script>

    <!-- Gift Plaza System -->
    <script>
        let giftType = 'equal';
        let currentUser = null; // Will be set by Farcaster SDK
        const NEYNAR_API_KEY = 'NEYNAR_API_DOCS';
        const MAX_PLAZA_GIFTS = 10;
        let plazaGifts = JSON.parse(localStorage.getItem('plaza_gifts') || '[]');
        let isPlazaMode = false;

        // Plaza transition animation
        function playPlazaTransition(callback) {
            const overlay = document.createElement('div');
            overlay.className = 'plaza-transition-overlay';
            
            // Create comet star
            const comet = document.createElement('div');
            comet.className = 'comet-star';
            comet.style.top = '18%';
            comet.style.left = '50%';
            comet.style.transform = 'translate(-50%, -50%)';
            
            // Create tail
            const tail = document.createElement('div');
            tail.className = 'comet-tail';
            comet.appendChild(tail);
            
            overlay.appendChild(comet);
            document.body.appendChild(overlay);
            
            // Tree stays still, only star moves
            
            // Animate comet in smooth orbit
            const duration = 3000;
            const startTime = performance.now();
            const centerX = window.innerWidth / 2;
            const startY = window.innerHeight * 0.03; // Tree top position
            const centerY = window.innerHeight * 0.45;
            const radiusX = window.innerWidth * 0.35;
            const radiusY = window.innerHeight * 0.28;
            
            function animateComet(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Smooth easing
                const eased = 1 - Math.pow(1 - progress, 3);
                const angle = eased * Math.PI * 2;
                
                // Elliptical orbit starting and ending at top
                const x = centerX + Math.sin(angle) * radiusX;
                const y = startY + (1 - Math.cos(angle)) * radiusY;
                
                // Scale based on depth (front = bigger)
                const scale = 1 + Math.sin(angle) * 0.3;
                
                // Tail rotation follows movement direction
                const dx = Math.cos(angle) * radiusX;
                const dy = Math.sin(angle) * radiusY;
                const tailAngle = Math.atan2(dy, dx) * 180 / Math.PI + 180;
                
                comet.style.left = x + 'px';
                comet.style.top = y + 'px';
                comet.style.transform = `translate(-50%, -50%) scale(${scale})`;
                tail.style.transform = `translateY(-50%) rotate(${tailAngle}deg)`;
                
                // Spawn particles
                if (Math.random() > 0.5) {
                    spawnParticle(overlay, x, y);
                }
                
                if (progress < 1) {
                    requestAnimationFrame(animateComet);
                } else {
                    // Final flash and cleanup
                    const flash = document.createElement('div');
                    flash.className = 'final-flash';
                    document.body.appendChild(flash);
                    
                    setTimeout(() => {
                        flash.remove();
                        overlay.remove();
                        if (callback) callback();
                    }, 600);
                }
            }
            
            requestAnimationFrame(animateComet);
        }
        
        function spawnParticle(container, x, y) {
            for (let i = 0; i < 2; i++) {
                const particle = document.createElement('div');
                particle.className = 'transition-particle';
                const size = 3 + Math.random() * 8;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                particle.style.left = (x + (Math.random() - 0.5) * 30) + 'px';
                particle.style.top = (y + (Math.random() - 0.5) * 30) + 'px';
                particle.style.setProperty('--dx', (Math.random() - 0.5) * 60 + 'px');
                particle.style.setProperty('--dy', (Math.random() * 40 + 20) + 'px');
                particle.style.animation = `particleDrift ${0.8 + Math.random() * 0.5}s ease-out forwards`;
                container.appendChild(particle);
                setTimeout(() => particle.remove(), 1300);
            }
        }
        
        // Toggle Plaza Mode
        function togglePlazaMode() {
            // If entering plaza, play transition first
            if (!isPlazaMode) {
                playPlazaTransition(() => {
                    activatePlazaMode(true);
                });
                return;
            }
            activatePlazaMode(false);
        }
        
        function activatePlazaMode(entering) {
            isPlazaMode = entering;
            const plazaBtn = document.getElementById('plaza-btn');
            const plaza = document.getElementById('gift-plaza');
            const plazaSendBtn = document.getElementById('plaza-send-btn');
            const mainBtns = document.getElementById('main-btns');
            const topBtns = document.getElementById('top-btns');
            const titleEl = document.getElementById('app-title');
            const subtitleEl = document.getElementById('app-subtitle');
            
            if (isPlazaMode) {
                plazaBtn.textContent = '‚Ü© Return';
                plaza.style.display = 'block';
                plazaSendBtn.style.display = 'flex';
                mainBtns.style.display = 'none';
                topBtns.style.display = 'none';
                // Hide title, show banner
                if (titleEl) titleEl.style.display = 'none';
                if (subtitleEl) subtitleEl.style.display = 'none';
                startSnowfall();
                // plaza-greeting removed
                renderPlaza();
            } else {
                plazaBtn.textContent = 'üéÑ Plaza Gift';
                plaza.style.display = 'none';
                plazaSendBtn.style.display = 'none';
                mainBtns.style.display = 'flex';
                topBtns.style.display = 'flex';
                // Show title
                if (titleEl) titleEl.style.display = 'block';
                if (subtitleEl) subtitleEl.style.display = 'block';
                stopSnowfall();
                // plaza-greeting removed
            }
        }

        // Modal functions
        function openGiftModal() { 
            document.getElementById('gift-modal').classList.add('visible');
            document.getElementById('gift-title').value = '';
            document.getElementById('gift-token').value = 'USDC';
            document.getElementById('gift-amount').value = '0.1';
            document.getElementById('gift-shares').value = '5';
            document.getElementById('plaza-custom-token-group').style.display = 'none';
            document.getElementById('plaza-token-ca').value = '';
            document.getElementById('require-code').checked = false;
            document.getElementById('gift-code').value = '';
            document.getElementById('code-input-row').style.display = 'none';
            document.getElementById('require-pro').checked = false;
            document.getElementById('min-score').value = '0';
            updatePreview();
        }
        function closeGiftModal() { document.getElementById('gift-modal').classList.remove('visible'); }
        function closeClaimModal() { document.getElementById('claim-modal').classList.remove('visible'); }
        function openClaimInput() { document.getElementById('claim-input-modal').classList.add('visible'); document.getElementById('gift-code-input').value = ''; }
        function closeClaimInput() { document.getElementById('claim-input-modal').classList.remove('visible'); }
        function showLoading(text) { document.getElementById('loading-text').textContent = text; document.getElementById('loading-modal').classList.add('visible'); }
        function hideLoading() { document.getElementById('loading-modal').classList.remove('visible'); }
        function closeSuccessModal() { document.getElementById('success-modal').querySelector('.modal-box').style.display = 'none'; }
        
        // Tip Author functions
        const AUTHOR_USERNAME = 'xqc';
        const AUTHOR_ADDRESS = '0x...'; // Replace with actual address
        const USDC_CA = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
        let authorInfo = null;
        
        async function fetchAuthorInfo() {
            if (authorInfo) return;
            try {
                const res = await fetch(`https://api.neynar.com/v2/farcaster/user/search?q=${AUTHOR_USERNAME}&limit=1`, {
                    headers: { 'accept': 'application/json', 'x-api-key': NEYNAR_API_KEY }
                });
                const data = await res.json();
                if (data.result?.users?.[0]) {
                    authorInfo = data.result.users[0];
                    document.getElementById('author-avatar').src = authorInfo.pfp_url || '';
                    document.getElementById('author-name').textContent = authorInfo.username;
                }
            } catch (e) { console.error('Failed to fetch author info:', e); }
        }
        
        function openTipModal() {
            document.getElementById('tip-modal').classList.add('visible');
            document.getElementById('tip-amount').value = '1';
            document.getElementById('tip-amounts').innerHTML = [1, 3, 5].map(amt => 
                `<button type="button" class="tip-amt-btn" onclick="setTipAmount(${amt})">${amt}</button>`
            ).join('');
            fetchAuthorInfo();
        }
        function closeTipModal() { document.getElementById('tip-modal').classList.remove('visible'); }
        function setTipAmount(amount) { document.getElementById('tip-amount').value = amount; }
        async function sendTip() {
            const token = document.getElementById('tip-token').value;
            const amount = document.getElementById('tip-amount').value;
            if (!amount || parseFloat(amount) <= 0) { alert('Enter valid amount'); return; }
            
            closeTipModal();
            showLoading('Sending tip...');
            
            // In production, integrate with wallet (ethers.js / wagmi)
            // For demo, just show success
            setTimeout(() => {
                hideLoading();
                alert(`Thank you for your tip! ‚ù§Ô∏è\n\n${amount} ${token} to author`);
            }, 1500);
        }
        
        // Gift Record feature - show gifts sent and claimed
        function openRecordModal() {
            const myUsername = currentUser?.username || 'santa';
            const myFid = currentUser?.fid;
            
            // Gifts I sent
            const sentGifts = plazaGifts.filter(g => g.sender?.username === myUsername);
            
            // Gifts I claimed
            const claimedGifts = plazaGifts.filter(g => 
                g.claimedBy?.some(c => c.username === myUsername || c.fid === myFid)
            );
            
            const recordList = document.getElementById('record-list');
            let html = '';
            
            // Sent gifts section
            html += '<div style="color:var(--gold); font-weight:bold; margin-bottom:8px;">üéÅ Gifts I Sent</div>';
            if (sentGifts.length === 0) {
                html += '<div style="text-align:center; color:rgba(255,255,255,0.5); padding:12px; font-size:0.85rem;">No gifts sent yet</div>';
            } else {
                html += sentGifts.map(gift => {
                    const claimers = gift.claimedBy || [];
                    return `
                        <div style="background:rgba(0,0,0,0.3); padding:12px; border-radius:8px; margin-bottom:10px; border:1px solid rgba(212,175,55,0.3);">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <span style="color:var(--gold); font-weight:bold;">${gift.title}</span>
                                <span style="color:rgba(255,255,255,0.6); font-size:0.8rem;">${gift.claimed}/${gift.shares} claimed</span>
                            </div>
                            <div style="font-size:0.85rem; color:rgba(255,255,255,0.7);">${gift.amount} ${gift.token}</div>
                            ${claimers.length > 0 ? `
                                <div style="margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1);">
                                    <div style="font-size:0.75rem; color:rgba(255,255,255,0.5); margin-bottom:4px;">Claimed by:</div>
                                    ${claimers.map(c => `
                                        <div style="display:flex; align-items:center; gap:8px; padding:4px 0;">
                                            <img src="${c.pfp || 'https://i.imgur.com/HeIi0wU.png'}" style="width:24px; height:24px; border-radius:50%; border:1px solid var(--gold);" onerror="this.src='https://i.imgur.com/HeIi0wU.png'">
                                            <span style="font-size:0.8rem; color:rgba(255,255,255,0.8);">@${c.username || c.fid || 'anonymous'}</span>
                                            <span style="font-size:0.8rem; color:var(--gold); margin-left:auto;">${c.amount || '?'} ${gift.token}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<div style="font-size:0.75rem; color:rgba(255,255,255,0.4); margin-top:8px;">No claims yet</div>'}
                        </div>
                    `;
                }).join('');
            }
            
            // Claimed gifts section
            html += '<div style="color:var(--gold); font-weight:bold; margin:16px 0 8px;">üì¨ Gifts I Claimed</div>';
            if (claimedGifts.length === 0) {
                html += '<div style="text-align:center; color:rgba(255,255,255,0.5); padding:12px; font-size:0.85rem;">No gifts claimed yet</div>';
            } else {
                html += claimedGifts.map(gift => {
                    const myClaim = gift.claimedBy?.find(c => c.username === myUsername || c.fid === myFid);
                    return `
                        <div style="background:rgba(0,0,0,0.3); padding:12px; border-radius:8px; margin-bottom:10px; border:1px solid rgba(212,175,55,0.3);">
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                                <img src="${gift.sender?.pfp || 'https://i.imgur.com/HeIi0wU.png'}" style="width:28px; height:28px; border-radius:50%; border:1px solid var(--gold);" onerror="this.src='https://i.imgur.com/HeIi0wU.png'">
                                <div>
                                    <div style="color:var(--gold); font-weight:bold;">${gift.title}</div>
                                    <div style="font-size:0.75rem; color:rgba(255,255,255,0.5);">From @${gift.sender?.username || 'anonymous'}</div>
                                </div>
                            </div>
                            <div style="font-size:0.85rem; color:var(--gold);">Received: ${myClaim?.amount || '?'} ${gift.token}</div>
                        </div>
                    `;
                }).join('');
            }
            
            recordList.innerHTML = html;
            document.getElementById('record-modal').classList.add('visible');
        }
        
        function closeRecordModal() {
            document.getElementById('record-modal').classList.remove('visible');
        }
        
        // Go back to home
        function goHome() {
            document.getElementById('success-modal').classList.remove('visible');
            document.getElementById('success-modal').querySelector('.modal-box').style.display = 'block';
            document.querySelector('.controls').style.display = 'flex';
            document.getElementById('gift-plaza').style.display = 'none';
            document.getElementById('plaza-btn').textContent = 'üéÑ Plaza Gift';
            document.getElementById('main-btns').style.display = 'flex';
            document.getElementById('top-btns').style.display = 'flex';
            document.getElementById('plaza-send-btn').style.display = 'none';
            isPlazaMode = false;
            // Tree stays scattered - reassembles after 3 seconds
            setTimeout(() => {
                if (window.assembleTree) window.assembleTree();
            }, 3000);
        }
        
        // Direct Gift (Send to Friends)
        let selectedRecipients = [];
        let searchTimeout = null;
        const MAX_RECIPIENTS = 10;
        
        function openDirectGiftModal() {
            document.getElementById('direct-gift-modal').classList.add('visible');
            selectedRecipients = [];
            document.getElementById('user-search').value = '';
            document.getElementById('selected-users').innerHTML = '';
            document.getElementById('user-results').style.display = 'none';
            document.getElementById('direct-gift-title').value = '';
            document.getElementById('direct-gift-message').value = '';
            document.getElementById('direct-gift-amount').value = '0.5';
            document.getElementById('direct-gift-token').value = 'USDC';
            document.getElementById('custom-token-group').style.display = 'none';
            document.getElementById('custom-token-ca').value = '';
            updateDirectPreview();
        }
        
        async function fetchTopFriends() {
            try {
                document.getElementById('selected-users').innerHTML = '<div style="color:rgba(255,255,255,0.5);font-size:0.8rem;">Loading friends...</div>';
                
                // Use current user's fid or default to a popular user for demo
                const fid = currentUser?.fid || 3; // dwr.eth as default
                const res = await fetch(`https://api.neynar.com/v2/farcaster/following?fid=${fid}&limit=5`, {
                    headers: { 'accept': 'application/json', 'x-api-key': NEYNAR_API_KEY }
                });
                const data = await res.json();
                if (data.users?.length > 0) {
                    selectedRecipients = data.users.slice(0, 5).map(u => ({
                        fid: u.fid,
                        username: u.username,
                        display_name: u.display_name,
                        pfp_url: u.pfp_url
                    }));
                    renderSelectedUsers();
                    updateDirectPreview();
                } else {
                    document.getElementById('selected-users').innerHTML = '';
                }
            } catch (e) { 
                console.error('Failed to fetch friends:', e);
                document.getElementById('selected-users').innerHTML = '';
            }
        }
        function closeDirectGiftModal() { document.getElementById('direct-gift-modal').classList.remove('visible'); }
        
        async function searchUsers(query) {
            if (searchTimeout) clearTimeout(searchTimeout);
            const resultsDiv = document.getElementById('user-results');
            if (!query || query.length < 2) { resultsDiv.style.display = 'none'; return; }
            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`https://api.neynar.com/v2/farcaster/user/search?q=${encodeURIComponent(query)}&limit=5`, {
                        headers: { 'accept': 'application/json', 'x-api-key': NEYNAR_API_KEY }
                    });
                    const data = await res.json();
                    if (data.result?.users?.length > 0) {
                        resultsDiv.innerHTML = data.result.users.map(u => `
                            <div class="user-result" onclick='selectUser(${JSON.stringify(u).replace(/'/g, "&#39;")})'>
                                <img src="${u.pfp_url || 'https://via.placeholder.com/32'}" onerror="this.src='https://via.placeholder.com/32'">
                                <div class="info"><div class="name">${u.display_name || u.username}</div><div class="username">@${u.username}</div></div>
                            </div>
                        `).join('');
                        resultsDiv.style.display = 'block';
                    } else { resultsDiv.style.display = 'none'; }
                } catch (e) { console.error(e); resultsDiv.style.display = 'none'; }
            }, 300);
        }
        
        function selectUser(user) {
            if (selectedRecipients.find(r => r.fid === user.fid)) { alert('Already selected'); return; }
            if (selectedRecipients.length >= MAX_RECIPIENTS) { alert('Max ' + MAX_RECIPIENTS + ' recipients'); return; }
            selectedRecipients.push(user);
            document.getElementById('user-search').value = '';
            document.getElementById('user-results').style.display = 'none';
            renderSelectedUsers();
            updateDirectPreview();
        }
        
        function renderSelectedUsers() {
            const div = document.getElementById('selected-users');
            if (selectedRecipients.length === 0) { div.innerHTML = ''; return; }
            div.innerHTML = `<div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;">${selectedRecipients.map((u, i) => `
                <div class="selected-user-card" style="flex:none; padding:6px 10px;">
                    <img src="${u.pfp_url || 'https://via.placeholder.com/24'}" style="width:24px; height:24px;" onerror="this.src='https://via.placeholder.com/24'">
                    <span style="color:var(--gold); font-size:0.8rem;">@${u.username}</span>
                    <button class="remove-btn" onclick="removeUser(${i})" style="font-size:1rem; padding:2px;">√ó</button>
                </div>
            `).join('')}</div><div style="font-size:0.7rem; color:rgba(255,255,255,0.4); margin-top:6px;">${selectedRecipients.length}/${MAX_RECIPIENTS}</div>`;
        }
        
        function removeUser(index) { selectedRecipients.splice(index, 1); renderSelectedUsers(); updateDirectPreview(); }
        
        function toggleCustomToken() {
            const token = document.getElementById('direct-gift-token').value;
            document.getElementById('custom-token-group').style.display = token === 'CUSTOM' ? 'block' : 'none';
            updateDirectPreview();
        }
        
        function validateDirectAmount() {
            const input = document.getElementById('direct-gift-amount');
            if (parseFloat(input.value) < 0.1) {
                input.value = '0.1';
            }
        }
        
        function updateDirectPreview() {
            const amount = document.getElementById('direct-gift-amount').value || '0';
            let token = document.getElementById('direct-gift-token').value;
            if (token === 'CUSTOM') token = 'TOKEN';
            document.getElementById('direct-preview-amount').textContent = amount + ' ' + token + ' each';
            document.getElementById('direct-preview-info').textContent = selectedRecipients.length > 0 
                ? '‚Üí ' + selectedRecipients.map(u => '@' + u.username).join(', ')
                : 'Select recipient(s) above';
        }
        
        async function createDirectGift() {
            const title = document.getElementById('direct-gift-title').value || 'Merry Christmas!';
            const message = document.getElementById('direct-gift-message').value || '';
            const token = document.getElementById('direct-gift-token').value;
            const amount = document.getElementById('direct-gift-amount').value;
            if (!amount || parseFloat(amount) <= 0) { alert('Enter valid amount'); return; }
            if (selectedRecipients.length === 0) { alert('Select at least one recipient'); return; }
            
            closeDirectGiftModal();
            showLoading('Creating gifts...');
            
            // Create a gift for each recipient
            const links = [];
            for (const r of selectedRecipients) {
                const giftId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                const giftData = {
                    id: giftId, title, message, token, amount,
                    shares: 1, type: 'equal', mode: 'direct',
                    requirePro: false, minScore: 0,
                    claimed: 0, claimedBy: [],
                    recipient: { fid: r.fid, username: r.username, pfp: r.pfp_url },
                    sender: currentUser || { fid: 0, username: 'anonymous', pfp: '' },
                    createdAt: Date.now()
                };
                plazaGifts.push(giftData);
                links.push({ username: r.username, url: location.origin + location.pathname + '?gift=' + giftId });
            }
            localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));
            
            // Create share text
            let shareText = links.length === 1 
                ? `üéÅ Gift for @${links[0].username}!\n\n${title}\nüí∞ ${amount} ${token}\n\nüîó ${links[0].url}`
                : `üéÅ Christmas Gifts!\n\n${title}\nüí∞ ${amount} ${token} each\n\n` + links.map(l => `‚Üí @${l.username}: ${l.url}`).join('\n');
            
            hideLoading();
            if (navigator.clipboard) {
                await navigator.clipboard.writeText(shareText);
                alert(`Gift(s) created for ${selectedRecipients.length} friend(s)!\nLink(s) copied to clipboard!`);
            } else { alert(shareText); }
        }
        
        // Claim by code/link
        let currentCardGift = null;
        
        function claimByCode() {
            const input = document.getElementById('gift-code-input').value.trim();
            if (!input) { alert('Please enter a gift code'); return; }
            
            // Extract gift ID from input (could be full URL or just ID)
            let giftId = input;
            if (input.includes('gift=')) {
                giftId = input.split('gift=')[1].split('&')[0];
            }
            
            // Check if gift exists in plaza
            const gift = plazaGifts.find(g => g.id === giftId);
            if (gift) {
                closeClaimInput();
                // Direct gift shows greeting card
                if (gift.mode === 'direct') {
                    showGreetingCard(gift);
                } else {
                    openClaimModal(giftId);
                }
            } else {
                alert('Gift not found!');
            }
        }
        
        // Check and show mailbox glow if there are gifts for user
        function checkMyGifts() {
            const myGifts = plazaGifts.filter(g => g.mode === 'direct' && g.claimed < g.shares);
            const mailboxBtn = document.getElementById('mailbox-button');
            if (myGifts.length > 0) {
                mailboxBtn.classList.add('has-gift');
            } else {
                mailboxBtn.classList.remove('has-gift');
            }
        }
        
        // Open first available gift
        function openMyGifts() {
            const myGifts = plazaGifts.filter(g => g.mode === 'direct' && g.claimed < g.shares);
            if (myGifts.length > 0) {
                showGreetingCard(myGifts[0]);
            } else {
                showToast('üì≠ No gifts yet');
            }
        }
        
        function showToast(message) {
            const existing = document.querySelector('.toast-msg');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast-msg';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20%;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.8);
                color: #fff;
                padding: 12px 24px;
                border-radius: 20px;
                font-size: 14px;
                z-index: 9999;
                animation: toastFade 2s ease forwards;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }
        
        function showGreetingCard(gift) {
            currentCardGift = gift;
            document.getElementById('card-sender-pfp').src = gift.sender.pfp || 'https://i.imgur.com/HeIi0wU.png';
            document.getElementById('card-sender-name').textContent = gift.sender.username;
            document.getElementById('card-title').textContent = gift.title;
            document.getElementById('card-message').textContent = gift.message || 'Wishing you a wonderful holiday season!';
            document.getElementById('card-amount').textContent = gift.amount + ' ' + gift.token;
            document.getElementById('card-modal').classList.add('visible');
        }
        
        function claimCardGift() {
            if (!currentCardGift) return;
            document.getElementById('card-modal').classList.remove('visible');
            
            // Process claim
            showLoading('Opening gift...');
            document.querySelector('.controls').style.display = 'none';
            
            // TODO: In production, call smart contract here
            // await contract.claimGift(giftId, password, isPro);
            
            currentCardGift.claimed = 1;
            currentCardGift.claimedBy.push(currentUser?.fid || 'guest');
            localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));
            
            setTimeout(() => {
                hideLoading();
                document.getElementById('success-amount').textContent = currentCardGift.amount + ' ' + currentCardGift.token;
                document.getElementById('success-modal').classList.add('visible');
                
                // Scatter tree AFTER claim for impact
                setTimeout(() => {
                    if (window.scatterTree) window.scatterTree();
                }, 300);
                
                // Update mailbox status
                checkMyGifts();
                currentCardGift = null;
            }, 800);
        }

        function toggleCodeInput() {
            const show = document.getElementById('require-code').checked;
            document.getElementById('code-input-row').style.display = show ? 'flex' : 'none';
            if (!show) document.getElementById('gift-code').value = '';
        }
        
        function togglePlazaCustomToken() {
            const token = document.getElementById('gift-token').value;
            document.getElementById('plaza-custom-token-group').style.display = token === 'CUSTOM' ? 'block' : 'none';
            updatePreview();
        }
        
        function validatePlazaAmount() {
            const input = document.getElementById('gift-amount');
            if (parseFloat(input.value) < 0.1) {
                input.value = '0.1';
            }
        }
        
        function selectGiftType(type) {
            giftType = type;
            document.querySelectorAll('.type-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (i === 0 && type === 'equal') || (i === 1 && type === 'lucky'));
            });
            updatePreview();
        }

        function updatePreview() {
            const amount = document.getElementById('gift-amount').value || '0';
            const token = document.getElementById('gift-token').value;
            const shares = document.getElementById('gift-shares').value || '1';
            document.getElementById('preview-amount').textContent = amount + ' ' + token;
            const perShare = shares > 0 ? (parseFloat(amount) / parseInt(shares)).toFixed(6) : '0';
            const requireCode = document.getElementById('require-code').checked;
            const requirePro = document.getElementById('require-pro').checked;
            const minScore = parseFloat(document.getElementById('min-score').value) || 0;
            let info = giftType === 'equal' ? `${shares} shares √ó ${perShare} ${token}` : `${shares} lucky shares`;
            if (requireCode || requirePro || minScore > 0) {
                info += ' | Requires:';
                if (requireCode) info += ' üîëCode';
                if (requirePro) info += ' FC Pro';
                if (minScore > 0) info += ` Score‚â•${minScore}`;
            }
            document.getElementById('preview-info').textContent = info;
        }

        // Create gift for plaza (with smart contract)
        async function createGift() {
            // Check if plaza is full
            const activeGifts = plazaGifts.filter(g => g.claimed < g.shares);
            if (activeGifts.length >= MAX_PLAZA_GIFTS) {
                alert('üéÑ Plaza Gift is full!\n\nMaximum 10 gifts can orbit the tree at once.\nPlease wait for some gifts to be claimed.');
                return;
            }
            
            const title = document.getElementById('gift-title').value || 'Merry Christmas!';
            const token = document.getElementById('gift-token').value;
            const amount = document.getElementById('gift-amount').value;
            const shares = document.getElementById('gift-shares').value || '5';
            const requireCode = document.getElementById('require-code').checked;
            const giftCode = document.getElementById('gift-code').value.trim() || 'XMAS2024';
            const requirePro = document.getElementById('require-pro').checked;
            const minScore = parseFloat(document.getElementById('min-score').value) || 0;

            if (!amount || parseFloat(amount) <= 0) { alert('Enter valid amount'); return; }
            if (!shares || parseInt(shares) < 1) { alert('Enter valid shares'); return; }

            // Connect wallet if not connected
            if (!connectedAddress) {
                const connected = await connectWallet();
                if (!connected) return;
            }

            closeGiftModal();
            showLoading('Creating gift on blockchain...');

            try {
                const passwordHash = hashPassword(giftCode);
                const giftTypeEnum = giftType === 'equal' ? 0 : 1; // 0 = EQUAL, 1 = LUCKY
                const duration = 7 * 24 * 60 * 60; // 7 days
                let tx, receipt, contractGiftId;

                if (token === 'ETH') {
                    // Create ETH gift
                    const amountWei = ethers.parseEther(amount);
                    tx = await giftContract.createGiftETH(
                        parseInt(shares),
                        passwordHash,
                        giftTypeEnum,
                        requirePro,
                        title,
                        duration,
                        { value: amountWei }
                    );
                } else {
                    // Create token gift (USDC)
                    const tokenAddress = USDC_CA;
                    const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, web3Signer);
                    const decimals = await tokenContract.decimals();
                    const amountUnits = ethers.parseUnits(amount, decimals);
                    
                    // Check and approve
                    const allowance = await tokenContract.allowance(connectedAddress, CONTRACT_ADDRESS);
                    if (allowance < amountUnits) {
                        showLoading('Approving tokens...');
                        const approveTx = await tokenContract.approve(CONTRACT_ADDRESS, amountUnits);
                        await approveTx.wait();
                    }
                    
                    showLoading('Creating gift...');
                    tx = await giftContract.createGiftToken(
                        tokenAddress,
                        amountUnits,
                        parseInt(shares),
                        passwordHash,
                        giftTypeEnum,
                        requirePro,
                        title,
                        duration
                    );
                }

                showLoading('Confirming transaction...');
                receipt = await tx.wait();
                
                // Get gift ID from event
                const event = receipt.logs.find(log => {
                    try {
                        const parsed = giftContract.interface.parseLog(log);
                        return parsed.name === 'GiftCreated';
                    } catch { return false; }
                });
                
                if (event) {
                    const parsed = giftContract.interface.parseLog(event);
                    contractGiftId = parsed.args[0].toString();
                }

                // For demo/UI, also store locally
                const sender = currentUser || {
                    fid: Date.now(),
                    username: connectedAddress.slice(0, 8),
                    pfp_url: 'https://i.imgur.com/HeIi0wU.png'
                };

                const giftData = {
                    id: contractGiftId || Date.now().toString(),
                    contractId: contractGiftId,
                    title,
                    token,
                    amount,
                    shares: parseInt(shares),
                    type: giftType,
                    requireCode,
                    giftCode: giftCode,
                    requirePro,
                    minScore,
                    claimed: 0,
                    claimedBy: [],
                    sender: {
                        fid: sender.fid,
                        username: sender.username,
                        pfp: sender.pfp_url,
                        address: connectedAddress
                    },
                    createdAt: Date.now(),
                    txHash: receipt.hash
                };

                plazaGifts.push(giftData);
                localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));

                hideLoading();
                renderPlaza();
                alert(`üéÅ Gift created on blockchain!\n\nGift ID: ${contractGiftId}\nTx: ${receipt.hash.slice(0, 10)}...\n\nShare the code "${giftCode}" with friends!`);
            } catch (error) {
                hideLoading();
                console.error('Create gift error:', error);
                alert('Failed to create gift: ' + (error.reason || error.message));
            }
        }

        // Render orbiting avatars around the tree
        function renderPlaza() {
            const plaza = document.getElementById('gift-plaza');
            const activeGifts = plazaGifts.filter(g => g.claimed < g.shares).slice(0, MAX_PLAZA_GIFTS);
            
            // Responsive orbit radius based on viewport - closer to tree
            const baseRadius = Math.min(window.innerWidth, window.innerHeight) * 0.12;
            const positions = [
                { duration: 18, delay: 0, y: -100, radius: baseRadius * 0.9 },
                { duration: 22, delay: -3, y: -70, radius: baseRadius * 1.1 },
                { duration: 15, delay: -7, y: -35, radius: baseRadius * 0.85 },
                { duration: 20, delay: -2, y: 0, radius: baseRadius },
                { duration: 25, delay: -5, y: 35, radius: baseRadius * 1.15 },
                { duration: 17, delay: -8, y: -85, radius: baseRadius * 0.95 },
                { duration: 23, delay: -1, y: -50, radius: baseRadius * 1.05 },
                { duration: 19, delay: -6, y: 18, radius: baseRadius * 0.92 },
                { duration: 21, delay: -4, y: -18, radius: baseRadius * 1.1 },
                { duration: 16, delay: -9, y: 50, radius: baseRadius * 0.98 }
            ];
            
            plaza.innerHTML = activeGifts.map((gift, index) => {
                const pos = positions[index];
                return `
                    <div class="plaza-gift" 
                         style="--orbit-duration: ${pos.duration}s; --orbit-delay: ${pos.delay}s; --orbit-radius: ${pos.radius}px; top: ${pos.y}px;"
                         onclick="openClaimModal('${gift.id}')"
                         title="Click to claim mystery gift from @${gift.sender.username}">
                        <img src="${gift.sender.pfp || 'https://i.imgur.com/HeIi0wU.png'}" 
                             onerror="this.src='https://i.imgur.com/HeIi0wU.png'"
                             alt="${gift.sender.username}">
                        <div class="santa-emoji">üéÖ</div>
                    </div>
                `;
            }).join('');
        }

        // Open claim modal for specific gift
        function openClaimModal(giftId) {
            const gift = plazaGifts.find(g => g.id === giftId);
            if (!gift) { alert('Gift not found'); return; }
            if (gift.claimed >= gift.shares) { alert('All shares claimed!'); return; }

            // Store current gift id for claiming
            document.getElementById('claim-modal').dataset.giftId = giftId;

            document.querySelector('#claim-modal .modal-title').textContent = 'üéÅ Mystery Gift';
            document.getElementById('claim-message').textContent = gift.title;
            document.getElementById('claim-remaining').textContent = '??? ' + gift.token;
            document.getElementById('claim-shares').textContent = gift.claimed + '/' + gift.shares + ' claimed';
            document.getElementById('claim-shares').parentElement.style.display = 'inline';

            // Show sender info
            const recipientDiv = document.getElementById('claim-recipient');
            recipientDiv.innerHTML = `
                <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:8px;">
                    <img src="${gift.sender.pfp || ''}" style="width:32px; height:32px; border-radius:50%; border:2px solid var(--gold);" onerror="this.style.display='none'">
                    <span style="color:var(--gold);">From @${gift.sender.username}</span>
                </div>
                ${gift.requirePro || gift.minScore > 0 ? `
                    <div style="font-size:0.75rem; color:rgba(255,255,255,0.5); margin-top:4px;">
                        Requirements: ${gift.requirePro ? '‚≠ê FC Pro ' : ''}${gift.minScore > 0 ? `Score‚â•${gift.minScore}` : ''}
                    </div>
                ` : ''}
            `;
            recipientDiv.style.display = 'block';

            // Show/hide code input based on gift requirements
            const codeGroup = document.querySelector('#claim-modal .form-group');
            if (gift.requireCode) {
                codeGroup.style.display = 'block';
                document.getElementById('claim-password').value = '';
            } else {
                codeGroup.style.display = 'none';
            }
            document.querySelector('#claim-modal .btn-gift').textContent = 'Claim Gift';

            document.getElementById('claim-modal').classList.add('visible');
        }

        // Claim gift (with smart contract)
        async function claimGift() {
            const giftId = document.getElementById('claim-modal').dataset.giftId;
            const gift = plazaGifts.find(g => g.id === giftId);
            
            if (!gift) { alert('Gift not found'); return; }
            if (gift.claimed >= gift.shares) { alert('All shares claimed!'); return; }

            // Get password
            const password = document.getElementById('claim-password').value.trim() || gift.giftCode || 'XMAS2024';

            // Verify code if required (for UI feedback)
            if (gift.requireCode && password !== gift.giftCode) {
                alert('Wrong code! Try again.');
                return;
            }

            // Connect wallet if not connected
            if (!connectedAddress) {
                const connected = await connectWallet();
                if (!connected) return;
            }

            // Check if already claimed on contract
            if (gift.contractId) {
                try {
                    const hasClaimed = await giftContract.hasUserClaimed(gift.contractId, connectedAddress);
                    if (hasClaimed) {
                        alert('You have already claimed this gift!');
                        return;
                    }
                } catch (e) {
                    console.log('Error checking claim status:', e);
                }
            }

            closeClaimModal();
            showLoading('Claiming gift...');
            
            // Hide plaza and controls
            document.getElementById('gift-plaza').style.display = 'none';
            document.querySelector('.controls').style.display = 'none';

            try {
                let claimAmount;
                
                // If gift has contract ID, claim from contract
                if (gift.contractId) {
                    const isPro = gift.requirePro ? true : false;
                    const tx = await giftContract.claimGift(gift.contractId, password, isPro);
                    showLoading('Confirming transaction...');
                    const receipt = await tx.wait();
                    
                    // Get claimed amount from event
                    const event = receipt.logs.find(log => {
                        try {
                            const parsed = giftContract.interface.parseLog(log);
                            return parsed.name === 'GiftClaimed';
                        } catch { return false; }
                    });
                    
                    if (event) {
                        const parsed = giftContract.interface.parseLog(event);
                        const amountWei = parsed.args[2];
                        if (gift.token === 'ETH') {
                            claimAmount = ethers.formatEther(amountWei);
                        } else {
                            claimAmount = ethers.formatUnits(amountWei, 6); // USDC has 6 decimals
                        }
                    } else {
                        claimAmount = (parseFloat(gift.amount) / gift.shares).toFixed(6);
                    }
                } else {
                    // Demo mode - calculate locally
                    if (gift.type === 'equal') {
                        claimAmount = (parseFloat(gift.amount) / gift.shares).toFixed(6);
                    } else {
                        const remaining = gift.shares - gift.claimed;
                        const remainingAmount = parseFloat(gift.amount) - gift.claimedBy.reduce((sum, c) => sum + parseFloat(c.amount || 0), 0);
                        const maxAmount = remaining > 1 ? (remainingAmount * 2 / remaining) : remainingAmount;
                        claimAmount = (Math.random() * maxAmount).toFixed(6);
                    }
                }

                // Update local gift data
                gift.claimed++;
                gift.claimedBy.push({
                    fid: currentUser?.fid || Date.now(),
                    username: currentUser?.username || connectedAddress?.slice(0, 8) || 'guest',
                    pfp: currentUser?.pfp || 'https://i.imgur.com/HeIi0wU.png',
                    address: connectedAddress,
                    amount: claimAmount,
                    at: Date.now()
                });
                localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));

                hideLoading();
                document.getElementById('success-amount').textContent = claimAmount + ' ' + gift.token;
                document.getElementById('success-modal').classList.add('visible');
                
                // Scatter tree AFTER claim for impact
                setTimeout(() => {
                    if (window.scatterTree) window.scatterTree();
                }, 300);
                
                renderPlaza();
            } catch (error) {
                hideLoading();
                document.querySelector('.controls').style.display = '';
                console.error('Claim error:', error);
                alert('Failed to claim: ' + (error.reason || error.message));
            }
        }

        function startSnowfall() {
            const container = document.getElementById('snowfall-container');
            if (!container) return;
            
            // Generate snowflakes
            let snowflakes = '';
            const symbols = ['‚ùÑ', '‚ùÖ', '‚ùÜ', '‚úª', '‚úº', '‚Ä¢'];
            for (let i = 0; i < 50; i++) {
                const left = Math.random() * 100;
                const delay = Math.random() * 10;
                const duration = 8 + Math.random() * 12;
                const size = 10 + Math.random() * 16;
                const symbol = symbols[Math.floor(Math.random() * symbols.length)];
                snowflakes += `<span class="snow" style="left:${left}%; animation-delay:${delay}s; animation-duration:${duration}s; font-size:${size}px;">${symbol}</span>`;
            }
            
            container.innerHTML = snowflakes;
            container.classList.add('active');
        }
        
        function stopSnowfall() {
            const container = document.getElementById('snowfall-container');
            if (container) {
                container.classList.remove('active');
                container.innerHTML = '';
            }
        }
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            // Hide unused form fields
            const recipientGroup = document.getElementById('recipient-group');
            const passwordGroup = document.getElementById('password-group');
            const modeToggle = document.querySelector('.mode-toggle');
            const modeHint = document.getElementById('mode-hint');
            if (recipientGroup) recipientGroup.style.display = 'none';
            if (passwordGroup) passwordGroup.style.display = 'none';
            if (modeToggle) modeToggle.style.display = 'none';
            if (modeHint) modeHint.textContent = 'Gift will appear in the plaza for anyone to claim';

            // Show shares and distribution
            document.getElementById('shares-group').style.display = 'block';
            document.getElementById('distribution-group').style.display = 'block';

            // Try to get Farcaster user
            import('https://esm.sh/@farcaster/miniapp-sdk').then(async ({ sdk }) => {
                try {
                    const context = await sdk.context;
                    if (context?.user) {
                        currentUser = context.user;
                        console.log('Farcaster user:', currentUser.username);
                    }
                } catch (e) { console.log('Not in Farcaster frame'); }
            }).catch(() => {});

            // Clear old demo data and load fresh
            const stored = localStorage.getItem('plaza_gifts');
            if (stored) {
                const parsed = JSON.parse(stored);
                // Filter out demo/test data
                plazaGifts = parsed.filter(g => !g.id.startsWith('demo') && !g.id.startsWith('test'));
                localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));
            }
            
            // Check if user has gifts
            checkMyGifts();
            
            // Check URL for gift parameter
            const urlParams = new URLSearchParams(window.location.search);
            const giftId = urlParams.get('gift');
            if (giftId) {
                setTimeout(() => {
                    const gift = plazaGifts.find(g => g.id === giftId);
                    if (gift && gift.mode === 'direct') {
                        showGreetingCard(gift);
                    } else if (gift) {
                        openClaimModal(giftId);
                    }
                }, 500);
            }
        });
    </script>
</body>
</html>