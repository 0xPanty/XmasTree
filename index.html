<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jingle Gift | Share the joy on Farcaster</title>
    
    <!-- Open Graph -->
    <meta property="og:title" content="Jingle Gift">
    <meta property="og:description" content="Interactive 3D Christmas Tree with Music">
    <meta property="og:image" content="https://xmas-tree-opal.vercel.app/preview.svg">
    
    <!-- Farcaster Mini App -->
    <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://xmas-tree-opal.vercel.app/preview.svg","button":{"title":"üéÅ Open","action":{"type":"launch_frame","name":"Jingle Gift","splashImageUrl":"https://xmas-tree-opal.vercel.app/icon.svg","splashBackgroundColor":"#0a1a0a"}}}' />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;1,400&family=Dancing+Script:wght@400;700&display=swap');

        :root {
            --emerald-dark: #001a10;
            --emerald: #023020;
            --gold: #D4AF37;
            --gold-light: #F7E7CE;
            --glass: rgba(20, 20, 20, 0.4);
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            font-family: 'Playfair Display', serif;
            color: var(--gold-light);
            overscroll-behavior: none;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* UI Overlay */
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 40px;
            box-sizing: border-box;
            background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.8) 100%);
            transition: background 1s ease;
        }

        .ui-hidden {
            opacity: 0 !important;
            pointer-events: none;
            transform: translateY(-20px);
        }
        
        .immersive-mode {
            background: transparent !important;
        }

        header {
            text-align: center;
            margin-top: 20px;
            pointer-events: auto;
            transition: all 1.2s cubic-bezier(0.19, 1, 0.22, 1);
        }

        h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: var(--gold);
            margin: 0;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
            opacity: 0;
            animation: fadeDown 1.5s ease-out forwards 0.5s;
        }

        .subtitle {
            font-size: 0.9rem;
            letter-spacing: 0.2em;
            color: rgba(255,255,255,0.6);
            margin-top: 10px;
            text-transform: uppercase;
            opacity: 0;
            animation: fadeDown 1.5s ease-out forwards 0.8s;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 20px;
            pointer-events: auto;
            opacity: 0;
            animation: fadeUp 1.5s ease-out forwards 1.2s;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-group {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: all 1s ease;
        }
        
        .btn-small {
            padding: 8px 16px !important;
            font-size: 0.85rem !important;
            min-width: auto !important;
        }

        button, .file-btn {
            background: var(--glass);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 15px 40px;
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            white-space: nowrap;
            touch-action: manipulation; 
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.4), transparent);
            transition: 0.5s;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            background: rgba(212, 175, 55, 0.2);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.3);
            transform: translateY(-2px);
        }

        button.active {
            background: var(--gold);
            color: var(--emerald-dark);
            box-shadow: 0 0 40px rgba(212, 175, 55, 0.6);
        }

        input[type="file"] {
            display: none;
        }

        /* --- Modal Styles --- */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .custom-modal.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-box {
            background: rgba(2, 48, 32, 0.95);
            border: 1px solid var(--gold);
            padding: 30px 40px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            box-shadow: 0 0 60px rgba(212, 175, 55, 0.2);
            transform: translateY(20px);
            transition: transform 0.5s ease;
            text-align: center;
            max-width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .custom-modal.visible .modal-box {
            transform: translateY(0);
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .modal-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(212, 175, 55, 0.5);
            color: var(--gold-light);
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            padding: 10px;
            width: 300px;
            max-width: 100%;
            text-align: center;
            outline: none;
            transition: border-color 0.3s;
        }

        .modal-input:focus {
            border-bottom-color: var(--gold);
        }

        .modal-actions {
            margin-top: 20px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--gold);
            font-family: 'Cinzel', serif;
            letter-spacing: 0.2em;
            font-size: 0.8rem;
            animation: pulse 2s infinite;
            text-align: center;
            width: 100%;
        }

        @keyframes fadeDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        @keyframes toastFade { 0% { opacity: 0; transform: translateX(-50%) translateY(-10px); } 10% { opacity: 1; transform: translateX(-50%) translateY(0); } 90% { opacity: 1; } 100% { opacity: 0; } }

        /* --- Gift System Styles --- */
        .gift-form { display: flex; flex-direction: column; gap: 12px; }
        .form-group { text-align: left; }
        .form-group label { display: block; color: var(--gold); font-size: 0.75rem; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.1em; }
        .form-group input, .form-group select { width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.3); color: var(--gold-light); font-family: inherit; font-size: 0.9rem; box-sizing: border-box; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--gold); }
        .form-row { display: flex; gap: 10px; }
        .form-row .form-group { flex: 1; }
        .mode-toggle { display: flex; gap: 8px; margin-bottom: 12px; }
        .mode-btn { flex: 1; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.3); color: var(--gold); cursor: pointer; font-size: 0.75rem; transition: all 0.3s; }
        .mode-btn.active { background: var(--gold); color: var(--emerald-dark); }
        .type-toggle { display: flex; gap: 8px; }
        .type-btn { flex: 1; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.3); color: var(--gold); cursor: pointer; font-size: 0.7rem; }
        .type-btn.active { background: rgba(212,175,55,0.3); border-color: var(--gold); }
        .btn-gift { width: 100%; padding: 12px; background: linear-gradient(135deg, #D4AF37, #B8960C); border: none; color: var(--emerald-dark); font-family: 'Cinzel', serif; font-size: 0.85rem; cursor: pointer; margin-top: 8px; }
        .gift-preview { background: rgba(0,0,0,0.3); padding: 12px; margin-top: 8px; text-align: center; border: 1px dashed rgba(212,175,55,0.3); }
        .preview-amount { font-size: 1.3rem; color: var(--gold); font-weight: bold; }
        .preview-info { font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 4px; }
        .mode-hint { font-size: 0.7rem; color: rgba(255,255,255,0.4); text-align: center; margin-bottom: 8px; }
        .user-search-results { position: absolute; top: 100%; left: 0; right: 0; background: rgba(2,48,32,0.98); border: 1px solid var(--gold); max-height: 150px; overflow-y: auto; z-index: 10; }
        .user-result { display: flex; align-items: center; gap: 10px; padding: 8px 12px; cursor: pointer; transition: background 0.2s; }
        .user-result:hover { background: rgba(212,175,55,0.2); }
        .user-result img { width: 32px; height: 32px; border-radius: 50%; }
        .user-result .info { text-align: left; }
        .user-result .name { color: var(--gold); font-size: 0.85rem; }
        .user-result .username { color: rgba(255,255,255,0.5); font-size: 0.75rem; }
        .selected-user-card { display: flex; align-items: center; gap: 8px; background: rgba(212,175,55,0.1); border: 1px solid rgba(212,175,55,0.3); padding: 8px 12px; margin-top: 8px; }
        .selected-user-card img { width: 24px; height: 24px; border-radius: 50%; }
        .selected-user-card .remove-btn { margin-left: auto; background: none; border: none; color: #ff6b6b; cursor: pointer; font-size: 1.2rem; padding: 0 4px; }
        .claim-info { text-align: center; margin-bottom: 16px; }
        .claim-message { font-size: 1.1rem; color: var(--gold-light); margin-bottom: 8px; }
        .claim-amount { font-size: 1.5rem; color: var(--gold); font-weight: bold; }
        .claim-shares { font-size: 0.8rem; color: rgba(255,255,255,0.5); }

        /* --- Gift Plaza Styles --- */
        #gift-plaza {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 5;
            perspective: 800px;
        }
        .plaza-gift {
            position: absolute;
            width: clamp(24px, 3vw, 40px);
            height: clamp(24px, 3vw, 40px);
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            animation: orbit3d var(--orbit-duration, 15s) linear infinite;
            animation-delay: var(--orbit-delay, 0s);
            transform-style: preserve-3d;
        }
        .plaza-gift:hover {
            z-index: 100;
        }
        .plaza-gift:hover img {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(212,175,55,1);
        }
        .plaza-gift img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--gold);
            box-shadow: 0 0 10px rgba(212,175,55,0.8);
            transition: all 0.3s;
        }
        .plaza-gift .santa-emoji {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: clamp(10px, 1.5vw, 14px);
        }
        @keyframes orbit3d {
            0% { transform: rotateY(0deg) translateX(var(--orbit-radius, 180px)) rotateY(0deg); opacity: 1; z-index: 10; }
            25% { transform: rotateY(-90deg) translateX(var(--orbit-radius, 180px)) rotateY(90deg); opacity: 1; z-index: 10; }
            50% { transform: rotateY(-180deg) translateX(var(--orbit-radius, 180px)) rotateY(180deg); opacity: 0.3; z-index: 1; }
            75% { transform: rotateY(-270deg) translateX(var(--orbit-radius, 180px)) rotateY(270deg); opacity: 1; z-index: 10; }
            100% { transform: rotateY(-360deg) translateX(var(--orbit-radius, 180px)) rotateY(360deg); opacity: 1; z-index: 10; }
        }
        
        /* Plaza mode - smaller title */
        .title.plaza-mode {
            font-size: clamp(20px, 4vw, 36px) !important;
            margin-top: 2% !important;
        }
        .subtitle.plaza-mode {
            font-size: clamp(8px, 1.2vw, 12px) !important;
        }
        
        /* Plaza snowfall */
        #snowfall-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            overflow: hidden;
            display: none;
        }
        #snowfall-container.active { display: block; }
        .snow {
            position: absolute;
            top: -50px;
            color: #fff;
            opacity: 0.8;
            animation: snowFall linear infinite;
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
        }
        @keyframes snowFall {
            0% { transform: translateY(-50px) rotate(0deg); opacity: 0.8; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0.2; }
        }

        /* Background Shooting Star Effect */
        .bg-meteor-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            overflow: hidden;
        }
        .bg-meteor {
            position: absolute;
            width: var(--size, 4px);
            height: var(--size, 4px);
            background: radial-gradient(circle, #fff 0%, rgba(255,250,220,0.9) 40%, rgba(255,215,0,0.4) 70%, transparent 100%);
            border-radius: 50%;
            opacity: 0;
            box-shadow: 0 0 6px 2px rgba(255,255,255,0.8), 0 0 12px 4px rgba(255,215,0,0.5);
            animation: meteorFly var(--duration, 1s) linear forwards, meteorTwinkle 0.1s ease-in-out infinite;
        }
        @keyframes meteorFly {
            0% { opacity: 0; transform: translate(0, 0) scale(1); }
            5% { opacity: 1; }
            85% { opacity: 0.9; }
            100% { opacity: 0; transform: translate(var(--travel-x, -120vw), var(--travel-y, 80vh)) scale(0.5); }
        }
        @keyframes meteorTwinkle {
            0%, 100% { box-shadow: 0 0 6px 2px rgba(255,255,255,0.8), 0 0 12px 4px rgba(255,215,0,0.5); }
            50% { box-shadow: 0 0 10px 4px rgba(255,255,255,1), 0 0 20px 8px rgba(255,215,0,0.8); }
        }

        
        .requirement-row { display: flex; align-items: center; gap: 8px; padding: 8px 0; }
        .requirement-row label { flex: 1; color: rgba(255,255,255,0.7); font-size: 0.8rem; }
        .requirement-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--gold); }
        .requirement-row input[type="number"] { width: 60px; padding: 4px 8px; }
        
        /* Gift Card Envelope (Cover) Styles */
        .gift-envelope {
            position: relative;
            width: 320px;
            max-width: 90vw;
            background: linear-gradient(145deg, #8B0000 0%, #5c0000 50%, #8B0000 100%);
            border: 4px solid #FFD700;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255,215,0,0.4), 0 10px 40px rgba(0,0,0,0.5), inset 0 0 60px rgba(0,0,0,0.3);
            animation: envelopeAppear 0.6s ease-out;
        }
        @keyframes envelopeAppear { 
            from { transform: scale(0.5) rotateY(-30deg); opacity: 0; } 
            to { transform: scale(1) rotateY(0); opacity: 1; } 
        }
        .envelope-inner {
            background: linear-gradient(145deg, #6B0000 0%, #4a0000 100%);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .envelope-tree {
            width: 120px;
            height: 120px;
            margin: 0 auto 12px;
            position: relative;
        }
        .envelope-tree svg {
            width: 100%;
            height: 100%;
            stroke: #FFD700;
            stroke-width: 1.5;
            fill: none;
        }
        .envelope-star {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            color: #FFD700;
            font-size: 20px;
            animation: starTwinkle 1.5s ease-in-out infinite;
        }
        @keyframes starTwinkle {
            0%, 100% { opacity: 0.7; transform: translateX(-50%) scale(1); }
            50% { opacity: 1; transform: translateX(-50%) scale(1.2); }
        }
        .envelope-sender {
            font-family: 'Great Vibes', 'Playfair Display', cursive, serif;
            font-size: 2rem;
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
            margin-bottom: 4px;
        }
        .envelope-gift-label {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            color: #FFD700;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            border-top: 1px solid rgba(255,215,0,0.3);
            padding-top: 8px;
            margin-top: 8px;
        }
        .envelope-open-btn {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.8);
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            letter-spacing: 0.15em;
            cursor: pointer;
            padding: 12px 24px;
            transition: all 0.3s;
        }
        .envelope-open-btn:hover {
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
        .envelope-dots {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #FFD700;
            border-radius: 50%;
            opacity: 0.6;
        }
        .envelope-dots.top-left { top: 12px; left: 12px; }
        .envelope-dots.top-right { top: 12px; right: 12px; }
        .envelope-dots.bottom-left { bottom: 12px; left: 12px; }
        .envelope-dots.bottom-right { bottom: 12px; right: 12px; }

        /* Card Cover Selector */
        .cover-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .cover-option {
            width: 52px;
            height: 70px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            overflow: hidden;
        }
        .cover-option.selected {
            border-color: var(--gold);
            box-shadow: 0 0 10px rgba(212,175,55,0.5);
        }
        .cover-preview {
            width: 100%;
            height: 100%;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        /* Cover 1: Red + Christmas Tree */
        .cover-1 {
            background: linear-gradient(180deg, #c41e3a 0%, #8b0000 100%);
        }
        .cover-1::before {
            content: '';
            position: absolute;
            bottom: 15px;
            width: 0; height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 20px solid #0d5c3f;
        }
        .cover-1::after {
            content: '‚òÖ';
            position: absolute;
            top: 12px;
            color: #ffd700;
            font-size: 10px;
        }
        /* Cover 2: Green + Gold Dots */
        .cover-2 {
            background: #0d5c3f;
            background-image: radial-gradient(#ffd700 2px, transparent 2px);
            background-size: 10px 10px;
        }
        /* Cover 3: Mint + Window Tree */
        .cover-3 {
            background: #a8e6cf;
        }
        .cover-3::before {
            content: '';
            position: absolute;
            width: 28px; height: 36px;
            background: #fff;
            border-radius: 14px 14px 0 0;
            top: 10px;
        }
        .cover-3::after {
            content: '';
            position: absolute;
            top: 18px;
            width: 0; height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 14px solid #0d5c3f;
        }
        /* Cover 4: Red + Gold Star */
        .cover-4 {
            background: linear-gradient(180deg, #c41e3a 0%, #a01530 100%);
        }
        .cover-4::before {
            content: '‚ú¶';
            font-size: 32px;
            color: #f5deb3;
        }
        /* Cover 5: Pink Stripes */
        .cover-5 {
            background: repeating-linear-gradient(90deg, #ff6b9d 0px, #ff6b9d 8px, #0d5c3f 8px, #0d5c3f 16px, #c41e3a 16px, #c41e3a 24px);
        }
        .cover-5::before {
            content: '';
            position: absolute;
            width: 12px; height: 12px;
            background: #ffd700;
            border-radius: 50%;
            top: 12px;
        }
        /* Cover 6: Red Green Diamond */
        .cover-6 {
            background: 
                linear-gradient(135deg, #c41e3a 25%, transparent 25%),
                linear-gradient(225deg, #c41e3a 25%, transparent 25%),
                linear-gradient(45deg, #c41e3a 25%, transparent 25%),
                linear-gradient(315deg, #c41e3a 25%, #0d5c3f 25%);
            background-size: 20px 20px;
            background-position: 10px 0, 10px 0, 0 0, 0 0;
        }

        /* Full Card Cover Display */
        .card-cover {
            width: 280px;
            height: 380px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        .card-cover:hover { transform: scale(1.02); }
        
        /* Full Cover - Postcard Front with AI Image */
        .card-cover-1, .card-cover-2, .card-cover-3, .card-cover-4, .card-cover-5, .card-cover-6 {
            background: #fff;
            padding: 0;
            position: relative;
            overflow: hidden;
        }
        
        .card-cover-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        /* Postcard Stamp Style */
        .postcard-stamp {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 50px;
            height: 60px;
            background: linear-gradient(135deg, #fff 0%, #f5f5f5 100%);
            border: 2px dashed rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transform: rotate(5deg);
        }
        
        .postcard-stamp::after {
            content: '‚öò';
            font-size: 0.7rem;
            color: #c41e3a;
            margin-top: 4px;
        }
        
        /* From Label on Front */
        .postcard-from-label {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: rgba(255,255,255,0.95);
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #333;
            font-family: 'Courier New', monospace;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border-left: 3px solid #c41e3a;
        }
        
        /* Full Cover 2: Green + Gold Dots */
        .card-cover-2 {
            background: #0d5c3f;
            color: #ffd700;
        }
        .card-cover-2::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: radial-gradient(#ffd700 4px, transparent 4px);
            background-size: 30px 30px;
            opacity: 0.8;
        }
        
        /* Full Cover 3: Mint + Arch Window */
        .card-cover-3 {
            background: #a8e6cf;
            color: #0d5c3f;
        }
        .card-cover-3 .cover-art {
            width: 140px; height: 180px;
            background: #fff;
            border-radius: 70px 70px 0 0;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }
        .card-cover-3 .cover-art::before {
            content: '';
            position: absolute;
            bottom: 20px;
            width: 0; height: 0;
            border-left: 40px solid transparent;
            border-right: 40px solid transparent;
            border-bottom: 70px solid #0d5c3f;
        }
        
        /* Full Cover 4: Red + Big Star */
        .card-cover-4 {
            background: linear-gradient(180deg, #c41e3a 0%, #a01530 100%);
            color: #f5deb3;
        }
        .card-cover-4 .cover-art {
            font-size: 120px;
            color: #f5deb3;
            text-shadow: 0 5px 20px rgba(0,0,0,0.3);
            line-height: 1;
        }
        
        /* Full Cover 5: Pink/Green Stripes */
        .card-cover-5 {
            background: repeating-linear-gradient(90deg, 
                #ff6b9d 0px, #ff6b9d 30px, 
                #0d5c3f 30px, #0d5c3f 60px, 
                #c41e3a 60px, #c41e3a 90px);
            color: #fff;
        }
        .card-cover-5::before {
            content: '';
            position: absolute;
            width: 40px; height: 40px;
            background: #ffd700;
            border-radius: 50%;
            top: 40px; right: 50px;
            box-shadow: -60px 80px 0 30px #ffd700, 40px 120px 0 20px #90EE90;
        }
        
        /* Full Cover 6: Diamond Pattern */
        .card-cover-6 {
            background-color: #c41e3a;
            background-image: 
                linear-gradient(135deg, #0d5c3f 25%, transparent 25%),
                linear-gradient(225deg, #0d5c3f 25%, transparent 25%),
                linear-gradient(45deg, #0d5c3f 25%, transparent 25%),
                linear-gradient(315deg, #0d5c3f 25%, transparent 25%);
            background-size: 60px 60px;
            background-position: 30px 0, 30px 0, 0 0, 0 0;
            color: #ffd700;
        }
        
        .card-cover-title {
            font-size: 1.6rem;
            font-weight: bold;
            margin: 16px 0 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
            font-family: 'Georgia', serif;
        }
        .card-cover-from {
            font-size: 0.95rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        .card-cover-tap {
            margin-top: 20px;
            font-size: 0.8rem;
            opacity: 0.7;
            animation: pulse 2s infinite;
            position: relative;
            z-index: 1;
        }

        /* Gift Card Container - 3D flip */
        .gift-card-container {
            width: 280px;
            height: 380px;
            position: relative;
            perspective: 1000px;
        }
        .gift-card-container .card-cover {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            backface-visibility: hidden;
            transition: transform 0.8s ease;
            transform-style: preserve-3d;
        }
        .gift-card-container .card-inside {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            backface-visibility: hidden;
            transform: rotateY(180deg);
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        .gift-card-container.opened .card-cover {
            transform: rotateY(-180deg);
        }
        .gift-card-container.opened .card-inside {
            transform: rotateY(0deg);
        }
        
        /* Card Inside - Postcard Back Style */
        .card-inside {
            background: linear-gradient(135deg, 
                #f9f6f0 0%, 
                #f5f0e8 50%, 
                #f0ead9 100%) !important;
            padding: 24px !important;
            position: relative;
        }
        
        /* Vintage Paper Texture */
        .card-inside::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.02) 2px, rgba(0,0,0,0.02) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,0.02) 2px, rgba(0,0,0,0.02) 4px);
            pointer-events: none;
            opacity: 0.5;
        }
        
        .card-inside-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            color: #8b4513;
        }
        
        /* Hide image on back, only show on front */
        .card-content-row {
            display: none !important;
        }
        
        /* Postcard Back Header */
        .postcard-header {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        /* Handwritten Style Message */
        .card-inside-greeting {
            font-family: 'Dancing Script', cursive, 'Georgia', serif;
            font-size: 1.1rem;
            line-height: 2;
            color: #2c2c2c;
            text-align: left;
            padding: 20px;
            background: transparent;
            border: none;
            margin-bottom: 24px;
            min-height: 120px;
            position: relative;
            z-index: 1;
        }
        
        /* Handwritten lines effect */
        .card-inside-greeting::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: repeating-linear-gradient(
                transparent,
                transparent 38px,
                rgba(200,180,150,0.3) 38px,
                rgba(200,180,150,0.3) 40px
            );
        }
        .card-inside-amount {
            color: #ffd700;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 12px;
        }
        .card-inside-claim {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
        }

        /* AI Generated Card Content Styles */
        .ai-card-content {
            position: relative;
            width: 340px;
            max-width: 90vw;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 0 40px rgba(255,215,0,0.3), 0 15px 50px rgba(0,0,0,0.5);
            animation: cardReveal 0.8s ease-out;
        }
        @keyframes cardReveal {
            from { transform: scale(0.8) rotateY(90deg); opacity: 0; }
            to { transform: scale(1) rotateY(0); opacity: 1; }
        }
        .ai-card-image {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .ai-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .ai-card-loading {
            color: #FFD700;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        .ai-card-loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,215,0,0.2);
            border-top-color: #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .ai-card-avatars {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .ai-card-avatars img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid #FFD700;
            box-shadow: 0 0 10px rgba(255,215,0,0.4);
        }
        .ai-card-greeting {
            color: #fff;
            font-size: 1rem;
            line-height: 1.6;
            font-style: italic;
            padding: 12px;
            background: rgba(255,215,0,0.1);
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .ai-card-amount {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            color: #FFD700;
            margin-bottom: 16px;
        }
        .ai-card-claim-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            border-radius: 8px;
            color: #1a1a2e;
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .ai-card-claim-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255,215,0,0.4);
        }

        /* Greeting Card Styles (legacy) */
        .greeting-card {
            position: relative;
            background: linear-gradient(135deg, #1a472a 0%, #0d2818 50%, #1a472a 100%);
            border: 3px solid var(--gold);
            border-radius: 16px;
            padding: 32px 24px;
            max-width: 340px;
            text-align: center;
            box-shadow: 0 0 40px rgba(212,175,55,0.3), inset 0 0 60px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: cardAppear 0.5s ease-out;
        }
        @keyframes cardAppear { from { transform: scale(0.8) rotateY(-20deg); opacity: 0; } to { transform: scale(1) rotateY(0); opacity: 1; } }
        @keyframes cardOpen { 
            0% { transform: perspective(1000px) rotateX(0); }
            50% { transform: perspective(1000px) rotateX(-90deg); }
            100% { transform: perspective(1000px) rotateX(-180deg) scale(0.8); opacity: 0; }
        }
        .greeting-card.opening { animation: cardOpen 1s ease-in-out forwards; }
        
        /* Christmas confetti burst */
        .confetti-container {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
            animation: confettiFall 3s ease-out forwards;
        }
        @keyframes confettiFall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .card-sparkles {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.8), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(212,175,55,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.6), transparent),
                radial-gradient(2px 2px at 130px 80px, rgba(212,175,55,0.6), transparent),
                radial-gradient(2px 2px at 200px 50px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 250px 90px, rgba(212,175,55,0.6), transparent);
            animation: sparkle 2s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes sparkle { 0%,100% { opacity: 0.5; } 50% { opacity: 1; } }
        .card-header { margin-bottom: 16px; }
        .card-avatar {
            width: 64px; height: 64px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            margin-bottom: 8px;
            box-shadow: 0 0 15px rgba(212,175,55,0.5);
        }
        .card-from { color: rgba(255,255,255,0.7); font-size: 0.9rem; }
        .card-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(212,175,55,0.5);
            margin: 16px 0;
        }
        .card-message {
            color: #fff;
            font-size: 1rem;
            line-height: 1.6;
            padding: 16px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            border-left: 3px solid var(--gold);
            margin: 16px 0;
            font-style: italic;
        }
        .card-gift {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 16px;
        }
        .card-gift-icon {
            font-size: 2.5rem;
            animation: bounce 1s ease-in-out infinite;
        }
        @keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .card-amount {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--gold);
        }
        
        /* Tip amount buttons */
        .tip-amt-btn {
            flex: 1;
            padding: 8px;
            background: rgba(212,175,55,0.2);
            border: 1px solid var(--gold);
            color: var(--gold);
            cursor: pointer;
            transition: all 0.2s;
        }
        .tip-amt-btn:hover { background: rgba(212,175,55,0.4); }
        
        /* Mailbox button */
        .mailbox-btn {
            font-size: 1.8rem !important;
            padding: 8px 16px !important;
            background: rgba(212,175,55,0.1) !important;
        }
        .mailbox-btn.has-gift {
            animation: mailGlow 1.5s ease-in-out infinite;
        }
        @keyframes mailGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(212,175,55,0.5), 0 0 20px rgba(212,175,55,0.3); }
            50% { box-shadow: 0 0 20px rgba(212,175,55,0.8), 0 0 40px rgba(212,175,55,0.5), 0 0 60px rgba(212,175,55,0.3); }
        }
        
        

        /* --- MOBILE RESPONSIVE STYLES --- */
        @media (max-width: 768px) {
            #ui {
                padding: 20px;
                padding-bottom: 30px; 
            }

            h1 {
                font-size: 1.8rem;
                letter-spacing: 0.15em;
            }

            .subtitle {
                font-size: 0.75rem;
            }

            .controls {
                flex-direction: column;
                width: 100%;
                gap: 12px;
                align-items: stretch;
                padding-bottom: 20px;
            }

            .btn-group {
                width: 100%;
            }

            button {
                width: 100%;
                padding: 12px 0;
                font-size: 0.9rem;
            }

            .modal-box {
                padding: 24px 16px;
                width: 92%;
                max-height: 80vh;
            }
            
            .modal-input {
                width: 100%;
                font-size: 1rem;
            }
        }
    </style>
    <!-- React & Three Imports -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
                "three": "https://esm.sh/three@0.160.0",
                "@react-three/fiber": "https://esm.sh/@react-three/fiber@8.15.12?external=react,react-dom,three",
                "@react-three/drei": "https://esm.sh/@react-three/drei@9.96.1?external=react,react-dom,three,@react-three/fiber",
                "@react-three/postprocessing": "https://esm.sh/@react-three/postprocessing@2.16.0?external=react,react-dom,three,@react-three/fiber",
                "uuid": "https://esm.sh/uuid@9.0.1"
            }
        }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Ethers.js for Web3 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
    <script>
        // Contract Configuration
        const CONTRACT_ADDRESS = '0x5307bFc2F5bB5efC858622aDcAeE60619C51b884';
        const BASE_CHAIN_ID = 8453;
        const CONTRACT_ABI = [
            "function createGiftETH(uint256 shares, bytes32 passwordHash, uint8 giftType, bool proOnly, string title, uint256 duration) payable returns (uint256)",
            "function createGiftToken(address token, uint256 amount, uint256 shares, bytes32 passwordHash, uint8 giftType, bool proOnly, string title, uint256 duration) returns (uint256)",
            "function claimGift(uint256 giftId, string password, bool isPro)",
            "function refundGift(uint256 giftId)",
            "function getGift(uint256 giftId) view returns (address creator, address token, uint256 totalAmount, uint256 remainingAmount, uint256 totalShares, uint256 claimedShares, uint8 giftType, bool proOnly, string title, uint256 expireTime, bool active)",
            "function hasUserClaimed(uint256 giftId, address user) view returns (bool)",
            "function getUserClaimedAmount(uint256 giftId, address user) view returns (uint256)",
            "function giftCount() view returns (uint256)",
            "event GiftCreated(uint256 indexed giftId, address indexed creator, address token, uint256 totalAmount, uint256 shares, uint8 giftType, string title)",
            "event GiftClaimed(uint256 indexed giftId, address indexed claimer, uint256 amount)"
        ];
        
        // ERC20 ABI for token approvals
        const ERC20_ABI = [
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function balanceOf(address account) view returns (uint256)",
            "function decimals() view returns (uint8)"
        ];

        // Web3 State
        let web3Provider = null;
        let web3Signer = null;
        let giftContract = null;
        let connectedAddress = null;

        // Connect Wallet
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    alert('Please install MetaMask or use a Web3 browser!');
                    return false;
                }
                
                web3Provider = new ethers.BrowserProvider(window.ethereum);
                await web3Provider.send("eth_requestAccounts", []);
                
                // Check network
                const network = await web3Provider.getNetwork();
                if (Number(network.chainId) !== BASE_CHAIN_ID) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x' + BASE_CHAIN_ID.toString(16) }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x' + BASE_CHAIN_ID.toString(16),
                                    chainName: 'Base',
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: ['https://mainnet.base.org'],
                                    blockExplorerUrls: ['https://basescan.org']
                                }]
                            });
                        }
                    }
                    web3Provider = new ethers.BrowserProvider(window.ethereum);
                }
                
                web3Signer = await web3Provider.getSigner();
                connectedAddress = await web3Signer.getAddress();
                giftContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, web3Signer);
                
                // Update UI
                const walletBtn = document.getElementById('wallet-btn');
                if (walletBtn) {
                    walletBtn.textContent = connectedAddress.slice(0, 6) + '...' + connectedAddress.slice(-4);
                    walletBtn.classList.add('connected');
                }
                
                console.log('Wallet connected:', connectedAddress);
                return true;
            } catch (error) {
                console.error('Wallet connection failed:', error);
                alert('Failed to connect wallet: ' + error.message);
                return false;
            }
        }

        // Hash password for contract
        function hashPassword(password) {
            return ethers.keccak256(ethers.toUtf8Bytes(password));
        }
    </script>
</head>
<body>
    <!-- Create Gift Modal -->
    <div id="gift-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 400px;">
            <div class="modal-title">üéÅ Send Christmas Gift</div>
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="selectGiftMode('direct')">üéØ Direct Gift</button>
                <button class="mode-btn" onclick="selectGiftMode('redpacket')">üßß Red Packet</button>
            </div>
            <div class="mode-hint" id="mode-hint">Send directly to specific Farcaster user(s)</div>
            <div class="gift-form">
                <div class="form-group">
                    <label>Gift Title</label>
                    <input type="text" id="gift-title" placeholder="Merry Christmas!" maxlength="50">
                </div>
                <div class="form-group" id="recipient-group" style="position:relative;">
                    <label>Recipient (max 10)</label>
                    <input type="text" id="gift-recipient" placeholder="Search Farcaster username..." oninput="searchUsersPlaza(this.value)">
                    <div id="plaza-user-results" class="user-search-results" style="display:none;"></div>
                    <div id="selected-user"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Token</label>
                        <select id="gift-token" onchange="togglePlazaCustomToken()">
                            <option value="USDC">USDC</option>
                            <option value="ETH">ETH</option>
                            <option value="CUSTOM">Custom Token</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="gift-amount" value="0.1" step="0.01" min="0.1" oninput="validatePlazaAmount(); updatePreview()">
                    </div>
                </div>
                <div class="form-group" id="plaza-custom-token-group" style="display:none;">
                    <label>Token Contract Address (Base)</label>
                    <input type="text" id="plaza-token-ca" placeholder="0x..." style="font-size:0.8rem;">
                </div>
                <div class="form-group" id="shares-group" style="display:none;">
                    <label>Number of Shares</label>
                    <input type="number" id="gift-shares" value="5" min="1" max="100" oninput="updatePreview()">
                </div>
                <div class="form-group" id="distribution-group" style="display:none;">
                    <label>Distribution Type</label>
                    <div class="type-toggle">
                        <button type="button" class="type-btn active" onclick="selectGiftType('equal')">Equal Split</button>
                        <button type="button" class="type-btn" onclick="selectGiftType('lucky')">Lucky Draw</button>
                    </div>
                </div>
                <div class="form-group" id="requirements-group">
                    <label>Claim Requirements</label>
                    <div class="requirement-row">
                        <label>Require Code</label>
                        <input type="checkbox" id="require-code" onchange="toggleCodeInput(); updatePreview();">
                    </div>
                    <div class="requirement-row" id="code-input-row" style="display:none;">
                        <label>Secret Code</label>
                        <input type="text" id="gift-code" placeholder="e.g. XMAS2024" maxlength="20" style="width:100px;">
                    </div>
                    <div class="requirement-row">
                        <label>Require Farcaster Pro</label>
                        <input type="checkbox" id="require-pro" onchange="updatePreview()">
                    </div>
                    <div class="requirement-row">
                        <label>Min Neynar Score</label>
                        <input type="number" id="min-score" placeholder="0" min="0" max="1" step="0.01" value="0" oninput="updatePreview()">
                    </div>
                </div>
                <div class="gift-preview">
                    <div class="preview-amount" id="preview-amount">0 ETH</div>
                    <div class="preview-info" id="preview-info">Select recipient(s) above</div>
                </div>
                <button class="btn-gift" onclick="createGift()">Create Gift</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeGiftModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Claim Gift Modal -->
    <div id="claim-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 350px;">
            <div class="modal-title">üéÅ Christmas Gift!</div>
            <div class="claim-info">
                <div class="claim-message" id="claim-message">Someone sent you a gift!</div>
                <div id="claim-recipient" style="margin-bottom:8px;"></div>
                <div class="claim-amount">üí∞ <span id="claim-remaining">0</span></div>
                <div class="claim-shares">Claimed: <span id="claim-shares">0/0</span></div>
            </div>
            <div class="gift-form">
                <div class="form-group">
                    <label>Enter Password</label>
                    <input type="text" id="claim-password" placeholder="Enter claim code">
                </div>
                <button class="btn-gift" onclick="claimGift()">Claim Gift</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeClaimModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Gift Card with Cover + Inside -->
    <div id="envelope-modal" class="custom-modal">
        <div class="gift-card-container" id="gift-card-container">
            <!-- Inside (Postcard Back) -->
            <div class="card-inside" id="card-inside">
                <div class="card-inside-loading" id="card-inside-loading">
                    <div class="spinner"></div>
                    <div>Creating your vintage postcard...</div>
                </div>
                <!-- Postcard Back Header -->
                <div class="postcard-header" id="postcard-header" style="display:none;">
                    <div>POSTCARD</div>
                    <div style="margin-top:4px;">To: <span id="card-recipient-name">You</span></div>
                </div>
                <!-- Hidden row (not used in postcard back) -->
                <div class="card-content-row" id="card-content-row" style="display:none;">
                    <img id="card-inside-image" src="" alt="AI Card">
                    <div class="card-inside-greeting-old" id="card-inside-greeting-old"></div>
                </div>
                <!-- Handwritten Message -->
                <div class="card-inside-greeting" id="card-inside-greeting"></div>
                <!-- Gift Amount -->
                <div class="card-inside-amount" id="card-inside-amount" style="background: linear-gradient(135deg, #c41e3a, #8b0000); color: #fff; padding: 16px; border-radius: 8px; text-align: center; font-size: 1.1rem; margin-bottom: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">üéÅ 0.5 USDC</div>
                <button class="card-inside-claim" onclick="claimAICardGift()" style="width:100%; padding: 14px; background: linear-gradient(135deg, #d4af37, #ffd700); border: none; border-radius: 8px; color: #2c2c2c; font-weight: bold; cursor: pointer; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.05em;">Open Gift</button>
                <button onclick="closeCardModal()" style="width:100%; padding:10px; margin-top:8px; background:transparent; border:1px solid rgba(139,69,19,0.3); color:#8b4513; border-radius:8px; cursor:pointer; font-family: 'Courier New', monospace;">Close</button>
            </div>
            <!-- Cover (Postcard Front with AI Image) -->
            <div id="card-cover-display" class="card-cover card-cover-1" onclick="openEnvelopeCard()">
                <!-- AI Generated Vintage Image -->
                <img id="card-cover-ai-image" class="card-cover-image" src="" alt="Vintage Christmas" style="display:none;">
                <!-- Loading state for cover -->
                <div id="card-cover-loading" style="display:flex; align-items:center; justify-content:center; height:100%; background: linear-gradient(135deg, #f5deb3, #daa520);">
                    <div style="text-align:center; color:#8b4513;">
                        <div style="font-size:3rem; margin-bottom:12px;">üéÑ</div>
                        <div style="font-family: 'Cinzel', serif; font-size:0.9rem;">Tap to open</div>
                    </div>
                </div>
                <!-- Postcard Stamp -->
                <div class="postcard-stamp">üéÑ</div>
                <!-- From Label -->
                <div class="postcard-from-label" id="postcard-from-label">From: @someone</div>
            </div>
        </div>
    </div>

    <!-- AI Generated Card Modal -->
    <div id="ai-card-modal" class="custom-modal">
        <div class="ai-card-content">
            <div class="ai-card-avatars">
                <img id="ai-card-sender-avatar" src="" alt="Sender">
                <img id="ai-card-recipient-avatar" src="" alt="Recipient">
            </div>
            <div class="ai-card-image" id="ai-card-image">
                <div class="ai-card-loading" id="ai-card-loading">
                    <div class="spinner"></div>
                    <div>Creating your magical Christmas card...</div>
                </div>
            </div>
            <div class="ai-card-greeting" id="ai-card-greeting">Loading greeting...</div>
            <div class="ai-card-amount" id="ai-card-amount">üéÅ 0.01 ETH</div>
            <button class="ai-card-claim-btn" onclick="claimAICardGift()">Claim Gift</button>
            <button style="background:transparent; border:1px solid rgba(255,215,0,0.3); color:#FFD700; padding:10px; margin-top:8px; cursor:pointer; width:100%; border-radius:8px;" onclick="closeAICardModal()">Close</button>
        </div>
    </div>



    <!-- Legacy Greeting Card Modal (for fallback) -->
    <div id="card-modal" class="custom-modal">
        <div class="greeting-card">
            <div class="card-sparkles"></div>
            <div class="card-header">
                <img id="card-sender-pfp" src="" class="card-avatar">
                <div class="card-from">From @<span id="card-sender-name">sender</span></div>
            </div>
            <div class="card-title" id="card-title">Merry Christmas!</div>
            <div class="card-message" id="card-message">Wishing you joy and happiness!</div>
            <div class="card-gift">
                <div class="card-gift-icon">üéÅ</div>
                <div class="card-amount" id="card-amount">0.01 ETH</div>
            </div>
            <button class="btn-gift" onclick="claimCardGift()" style="margin-top:16px;">Open Gift</button>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="custom-modal" style="background: rgba(0,0,0,0.3); backdrop-filter: none;">
        <div class="modal-box" style="max-width: 300px; text-align: center; background: rgba(0,0,0,0.7); border-color: var(--gold);">
            <div style="font-size: 3rem;">üéâ</div>
            <div class="modal-title">Gift Claimed!</div>
            <div style="color: var(--gold); font-size: 1.5rem; margin: 16px 0;" id="success-amount">0.01 ETH</div>
            <button class="btn-gift" onclick="closeSuccessModal()">Awesome!</button>
        </div>
        <button onclick="goHome()" style="position:fixed; bottom:40px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.6); border:2px solid var(--gold); color:var(--gold); width:60px; height:60px; border-radius:50%; font-size:2rem; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow: 0 0 20px rgba(212,175,55,0.3);">‚Ü©</button>
    </div>
    
    <!-- My Gifts Record Modal -->
    <div id="record-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 400px;">
            <div class="modal-title">üìã My Gifts Record</div>
            <div id="record-list" style="margin-top:12px; max-height:50vh; overflow-y:auto;"></div>
            <button class="btn-gift" onclick="closeRecordModal()" style="margin-top:16px; width:100%;">CLOSE</button>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 250px; text-align: center;">
            <div style="font-size: 2rem; animation: pulse 1s infinite;">‚è≥</div>
            <div id="loading-text" style="color: var(--gold-light); margin-top: 12px;">Processing...</div>
        </div>
    </div>

    <!-- Tip Author Modal -->
    <div id="tip-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 340px;">
            <div class="modal-title">‚òï Tip the Author</div>
            <div style="text-align:center; margin-bottom:16px;">
                <img id="author-avatar" src="" style="width:64px; height:64px; border-radius:50%; border:2px solid var(--gold); margin-bottom:8px;">
                <div style="color:var(--gold); font-size:1rem; margin-bottom:4px;">@<span id="author-name">xqc</span></div>
                <div style="color:rgba(255,255,255,0.7); font-size:0.85rem;">Support the creator of this Christmas Tree!</div>
            </div>
            <div class="gift-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Token</label>
                        <input type="text" value="USDC" disabled style="opacity:0.8; background:rgba(0,0,0,0.3); border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; width:100%; text-align:center;">
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="tip-amount" value="1" min="0.1" step="0.1">
                    </div>
                </div>
                <div id="tip-amounts" style="display:flex; gap:8px; margin-bottom:12px;"></div>
                <button class="btn-gift" onclick="sendTip()">Send Tip ‚ù§Ô∏è</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeTipModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Direct Gift Modal (Send to Friends) -->
    <div id="direct-gift-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 400px;">
            <div class="modal-title">üéÅ Send to Friends</div>
            <div class="mode-hint">Search and select up to 10 Farcaster users</div>
            <div class="gift-form">
                <div class="form-group">
                    <label>Gift Title</label>
                    <input type="text" id="direct-gift-title" placeholder="Merry Christmas!" maxlength="50">
                </div>
                <div class="form-group">
                    <label>Message</label>
                    <textarea id="direct-gift-message" placeholder="Write your heartfelt message here..." maxlength="200" style="width:100%; height:60px; resize:none; background:rgba(0,0,0,0.3); border:1px solid rgba(212,175,55,0.3); color:#fff; padding:8px; font-family:inherit;"></textarea>
                    <div style="font-size:0.7rem; color:rgba(255,255,255,0.4); margin-top:4px;">üí° Recipients will see an AI-generated vintage Christmas postcard with your message</div>
                </div>
                <div class="form-group">
                    <label>Card Cover</label>
                    <div class="cover-selector" id="cover-selector">
                        <div class="cover-option selected" data-cover="1" onclick="selectCover(1)">
                            <div class="cover-preview cover-1"></div>
                        </div>
                        <div class="cover-option" data-cover="2" onclick="selectCover(2)">
                            <div class="cover-preview cover-2"></div>
                        </div>
                        <div class="cover-option" data-cover="3" onclick="selectCover(3)">
                            <div class="cover-preview cover-3"></div>
                        </div>
                        <div class="cover-option" data-cover="4" onclick="selectCover(4)">
                            <div class="cover-preview cover-4"></div>
                        </div>
                        <div class="cover-option" data-cover="5" onclick="selectCover(5)">
                            <div class="cover-preview cover-5"></div>
                        </div>
                        <div class="cover-option" data-cover="6" onclick="selectCover(6)">
                            <div class="cover-preview cover-6"></div>
                        </div>
                    </div>
                </div>
                <div class="form-group" style="position:relative;">
                    <label>Recipients (max 10)</label>
                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                        <input type="text" id="user-search" placeholder="Search Farcaster username..." oninput="searchUsers(this.value)" style="flex:3; min-width:0;">
                        <button type="button" onclick="fetchTopFriends()" style="flex:1; padding:6px 8px; background:rgba(212,175,55,0.2); border:1px solid var(--gold); color:var(--gold); cursor:pointer; white-space:nowrap; font-size:0.7rem;">üë•</button>
                    </div>
                    <div id="user-results" class="user-search-results" style="display:none;"></div>
                    <div id="selected-users"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Token</label>
                        <select id="direct-gift-token" onchange="toggleCustomToken()">
                            <option value="ETH">ETH</option>
                            <option value="USDC">USDC</option>
                            <option value="CUSTOM">Custom Token</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount Each</label>
                        <input type="number" id="direct-gift-amount" value="0.5" step="0.1" min="0.1" oninput="validateDirectAmount(); updateDirectPreview()">
                    </div>
                </div>
                <div class="form-group" id="custom-token-group" style="display:none;">
                    <label>Token Contract Address (Base)</label>
                    <input type="text" id="custom-token-ca" placeholder="0x..." style="font-size:0.8rem;">
                </div>
                <div class="gift-preview">
                    <div class="preview-amount" id="direct-preview-amount">0 ETH</div>
                    <div class="preview-info" id="direct-preview-info">Select recipient(s) above</div>
                </div>
                <button class="btn-gift" onclick="createDirectGift()">Send Gift</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeDirectGiftModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Claim Input Modal -->
    <div id="claim-input-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 350px;">
            <div class="modal-title">üéÅ Claim Gift</div>
            <div class="gift-form">
                <div class="form-group">
                    <label>Enter Gift Code</label>
                    <input type="text" id="gift-code-input" placeholder="Paste gift link or code...">
                </div>
                <button class="btn-gift" onclick="claimByCode()">Claim</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeClaimInput()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="ui">
        <header id="main-header">
            <!-- TITLE UPDATED -->
            <h1 id="app-title">Jingle Gift</h1>
            <div id="app-subtitle" class="subtitle">Share the joy on Farcaster</div>
        </header>
        <div class="controls">
            <!-- Top row: Mailbox + Record + Tip -->
            <div class="btn-row" id="top-btns">
                <button id="mailbox-button" onclick="openMyGifts()" class="btn-small" style="font-size:1.5rem !important; padding:8px 16px !important;">üì¨</button>
                <button onclick="openRecordModal()" class="btn-small" style="font-size:1.5rem !important; padding:8px 16px !important;">üìã</button>
                <button onclick="openTipModal()" class="btn-small" style="font-size:1.5rem !important; padding:8px 16px !important;">‚òï</button>
            </div>
            <!-- Plaza mode buttons -->
            <div class="btn-row" id="plaza-send-btn" style="display:none;">
                <button onclick="openGiftModal()" class="btn-small">üéÅ Gift</button>
                <button onclick="openRecordModal()" class="btn-small">üìã Record</button>
            </div>
            <!-- Scatter mode home button -->
            <div id="scatter-home-btn" style="display:none; position:fixed; bottom:30px; left:50%; transform:translateX(-50%); z-index:100;">
                <button onclick="goHome()" style="background:rgba(0,0,0,0.7); border:2px solid rgba(255,215,0,0.5); color:#ffd700; padding:12px 32px; border-radius:25px; font-size:1rem; cursor:pointer; backdrop-filter:blur(10px);">üè† Back to Home</button>
            </div>
            <!-- Bottom rows: Send + Plaza -->
            <div class="btn-row" id="main-btns">
                <button onclick="openDirectGiftModal()" class="btn-small">üéÅ Send to Friends</button>
            </div>
            <div class="btn-row">
                <button id="plaza-btn" onclick="togglePlazaMode()" class="btn-small">üéÑ Plaza Gift</button>
            </div>
        </div>
        
        <!-- Gift Plaza - Orbiting Avatars (hidden by default) -->
        <div id="gift-plaza" style="display:none;"></div>
        <div id="snowfall-container"></div>
    </div>
    
    <div id="canvas-container">
        <div class="loading">Initializing Luxury Asset Pipeline...</div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useMemo, useEffect, Suspense } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as THREE from 'three';
        import { Canvas, useFrame, useThree, extend } from '@react-three/fiber';
        import { OrbitControls, Environment, Float, Sparkles, PerspectiveCamera, Stars } from '@react-three/drei';
        import { EffectComposer, Bloom, Vignette, Noise, ToneMapping } from '@react-three/postprocessing';

        // --- Audio Infrastructure ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 256; 
        const dataArray = new Uint8Array(analyser.frequencyBinCount); // 128 bins
        
        let activeSourceNode = null; 
        
        const defaultAudioEl = new Audio('https://cdn.pixabay.com/audio/2025/05/26/audio_95504c3693.mp3');
        defaultAudioEl.crossOrigin = "anonymous";
        defaultAudioEl.loop = true;
        
        let defaultMediaElementSource = null;

        const useAudioData = () => {
            const frequency = useRef(0);
            useFrame(() => {
                analyser.getByteFrequencyData(dataArray);
                const avg = dataArray.reduce((a, b) => a + b) / dataArray.length;
                frequency.current = avg; 
            });
            return frequency;
        };

        // --- Custom Shaders ---

        const foliageVertexShader = `
            uniform float uTime;
            uniform float uProgress; // 0 = Scattered, 1 = Tree
            uniform float uAudio;
            attribute vec3 aScatterPos;
            attribute vec3 aTreePos;
            attribute float aRandom;
            varying float vVisible;
            varying vec2 vUv;
            varying float vRandom;
            varying float vHeight;
            void main() {
                vUv = uv;
                vRandom = aRandom;
                vec3 finalPos = mix(aScatterPos, aTreePos, uProgress);
                float breathe = sin(uTime * 2.0 + aRandom * 10.0) * 0.05;
                float beat = uAudio * 0.02 * uProgress; 
                finalPos += normal * (breathe + beat);
                if(uProgress < 0.5) {
                    finalPos.y += sin(uTime + aScatterPos.x) * 0.2 * (1.0 - uProgress);
                }
                vHeight = finalPos.y; 
                vec4 mvPosition = modelViewMatrix * vec4(finalPos, 1.0);
                gl_PointSize = (4.0 * (1.0 + uAudio * 0.1)) * (20.0 / -mvPosition.z);
                gl_Position = projectionMatrix * mvPosition;
            }
        `;

        const foliageFragmentShader = `
            uniform float uTime;
            uniform float uAudio; 
            varying float vRandom;
            varying float vHeight;
            varying vec2 vUv;
            void main() {
                vec2 center = gl_PointCoord - 0.5;
                float dist = length(center);
                if (dist > 0.5) discard;
                vec3 emerald = vec3(0.0, 0.25, 0.18);   
                vec3 ruby = vec3(0.3, 0.02, 0.05);      
                vec3 gold = vec3(1.0, 0.9, 0.4);        
                float timeCycle = sin(uTime * 0.4) * 0.5 + 0.5; 
                vec3 baseTone = mix(emerald, ruby, timeCycle * 0.2); 
                float heightFactor = smoothstep(-5.0, 8.0, vHeight);
                vec3 gradientBase = mix(baseTone * 0.5, baseTone * 1.8, heightFactor);
                float beatStrength = smoothstep(0.4, 0.9, uAudio); 
                vec3 rhythmicColor = mix(gradientBase, gold, beatStrength * 0.4);
                float sparkle = sin(uTime * 3.0 + vRandom * 100.0);
                float isTip = step(0.96, sin(vRandom * 30.0 + uTime + uAudio * 5.0)); 
                vec3 finalColor = mix(rhythmicColor, gold * 2.5, isTip * (sparkle * 0.5 + 0.5 + beatStrength));
                float alpha = 1.0 - smoothstep(0.4, 0.5, dist);
                gl_FragColor = vec4(finalColor, alpha * 0.9);
            }
        `;

        // --- Utils: Gift Texture Generator ---
        function createGiftTexture(type) {
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            
            if (type === 0) { // Red + Gold Ribbon
                ctx.fillStyle = '#8B0000'; ctx.fillRect(0,0,256,256);
                ctx.fillStyle = '#FFD700'; 
                ctx.fillRect(118, 0, 20, 256); // Vert
                ctx.fillRect(0, 118, 256, 20); // Horiz
            } else if (type === 1) { // Green + Gold Stripes
                ctx.fillStyle = '#023020'; ctx.fillRect(0,0,256,256);
                ctx.fillStyle = '#D4AF37';
                ctx.lineWidth = 15;
                for(let i=-256; i<512; i+=40) {
                    ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i+256, 256); ctx.stroke();
                }
            } else if (type === 2) { // Navy + Silver Dots
                ctx.fillStyle = '#000080'; ctx.fillRect(0,0,256,256);
                ctx.fillStyle = '#C0C0C0';
                for(let x=0; x<256; x+=40) {
                    for(let y=0; y<256; y+=40) {
                        ctx.beginPath(); ctx.arc(x, y, 6, 0, Math.PI*2); ctx.fill();
                    }
                }
            } else { // Gold + Red Ribbon
                ctx.fillStyle = '#D4AF37'; ctx.fillRect(0,0,256,256);
                ctx.fillStyle = '#8B0000';
                ctx.fillRect(118, 0, 20, 256);
                ctx.fillRect(0, 118, 256, 20);
            }
            
            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = THREE.RepeatWrapping;
            tex.wrapT = THREE.RepeatWrapping;
            return tex;
        }

        // --- Components ---

        const AudioSpectrumRing = ({ isTree }) => {
            const meshRef = useRef();
            const count = 128; 
            const dummy = useMemo(() => new THREE.Object3D(), []);
            const [color] = useState(() => new THREE.Color());

            useEffect(() => {
                if (meshRef.current) {
                    for (let i = 0; i < count; i++) {
                        color.setHSL(i / count, 1.0, 0.5); 
                        color.multiplyScalar(1.5); 
                        meshRef.current.setColorAt(i, color);
                    }
                    meshRef.current.instanceColor.needsUpdate = true;
                }
            }, []);

            const [scatterTargets] = useState(() => {
                const scatter = new Float32Array(count * 3);
                for(let i=0; i<count; i++) {
                    const r = 25 * Math.cbrt(Math.random()); 
                    const theta = Math.random() * 2 * Math.PI;
                    const phi = Math.acos(2 * Math.random() - 1);
                    scatter[i*3] = r * Math.sin(phi) * Math.cos(theta);
                    scatter[i*3+1] = r * Math.sin(phi) * Math.sin(theta);
                    scatter[i*3+2] = r * Math.cos(phi);
                }
                return scatter;
            });

            useFrame((state, delta) => {
                if(!meshRef.current) return;
                meshRef.current.userData.progress = THREE.MathUtils.lerp(
                    meshRef.current.userData.progress || 0,
                    isTree ? 1 : 0,
                    delta * 1.5
                );
                const p = meshRef.current.userData.progress;

                for(let i=0; i<count; i++) {
                    const val = dataArray[i] || 0;
                    const length = (0.5 + (val / 255.0) * 8.0) * 0.66;
                    const angle = (i / count) * Math.PI * 2;
                    const baseRadius = 6.0;
                    const dist = baseRadius + length / 2;
                    const treeX = dist * Math.cos(angle);
                    const treeY = -4.5; 
                    const treeZ = dist * Math.sin(angle);

                    const posX = THREE.MathUtils.lerp(scatterTargets[i*3], treeX, p);
                    const posY = THREE.MathUtils.lerp(scatterTargets[i*3+1], treeY, p);
                    const posZ = THREE.MathUtils.lerp(scatterTargets[i*3+2], treeZ, p);

                    dummy.position.set(posX, posY, posZ);

                    if (p > 0.5) {
                        dummy.lookAt(0, -4.5, 0); 
                        dummy.scale.set(0.15, 0.1, length);
                    } else {
                        dummy.rotation.set(state.clock.elapsedTime * 0.2 + i, i, 0);
                        const s = THREE.MathUtils.lerp(0.5, 0.15, p);
                        dummy.scale.set(s, 0.1, s); 
                    }
                    dummy.updateMatrix();
                    meshRef.current.setMatrixAt(i, dummy.matrix);
                }
                meshRef.current.instanceMatrix.needsUpdate = true;
            });

            return (
                <instancedMesh ref={meshRef} args={[null, null, count]}>
                    <boxGeometry args={[1, 1, 1]} />
                    <meshStandardMaterial 
                        toneMapped={false} 
                        roughness={0.1}
                        metalness={0.8}
                        emissive="#111111" 
                    />
                </instancedMesh>
            );
        };

        const Foliage = ({ isTree, count = 15000 }) => {
            const meshRef = useRef();
            const audioFreq = useAudioData();
            
            const uniforms = useMemo(() => ({
                uTime: { value: 0 },
                uProgress: { value: 0 },
                uAudio: { value: 0 }
            }), []);

            const [attributes] = useState(() => {
                const scatterPos = new Float32Array(count * 3);
                const treePos = new Float32Array(count * 3);
                const randoms = new Float32Array(count);
                const treeHeight = 12;
                const treeRadius = 4.5;

                for (let i = 0; i < count; i++) {
                    const i3 = i * 3;
                    const r = 15 * Math.cbrt(Math.random());
                    const theta = Math.random() * 2 * Math.PI;
                    const phi = Math.acos(2 * Math.random() - 1);
                    scatterPos[i3] = r * Math.sin(phi) * Math.cos(theta);
                    scatterPos[i3+1] = r * Math.sin(phi) * Math.sin(theta);
                    scatterPos[i3+2] = r * Math.cos(phi);

                    const y = Math.random() * treeHeight; 
                    const normalizedY = y / treeHeight; 
                    const currentRadius = (1.0 - normalizedY) * treeRadius;
                    const angle = i * 0.1; 
                    const noise = (Math.random() - 0.5) * 0.5;
                    
                    treePos[i3] = (currentRadius + noise) * Math.cos(angle);
                    treePos[i3+1] = y - 4; 
                    treePos[i3+2] = (currentRadius + noise) * Math.sin(angle);
                    randoms[i] = Math.random();
                }
                return { scatterPos, treePos, randoms };
            });

            useFrame((state, delta) => {
                if (meshRef.current) {
                    meshRef.current.material.uniforms.uTime.value += delta;
                    const targetProgress = isTree ? 1.0 : 0.0;
                    meshRef.current.material.uniforms.uProgress.value = THREE.MathUtils.lerp(
                        meshRef.current.material.uniforms.uProgress.value,
                        targetProgress,
                        delta * 1.5
                    );
                    const normalizedAudio = Math.min(audioFreq.current / 128.0, 1.0); 
                    meshRef.current.material.uniforms.uAudio.value = THREE.MathUtils.lerp(
                        meshRef.current.material.uniforms.uAudio.value,
                        normalizedAudio,
                        0.2 
                    );
                    meshRef.current.rotation.y += 0.001;
                }
            });

            return (
                <points ref={meshRef}>
                    <bufferGeometry>
                        <bufferAttribute attach="attributes-position" count={count} array={attributes.scatterPos} itemSize={3} />
                        <bufferAttribute attach="attributes-aScatterPos" count={count} array={attributes.scatterPos} itemSize={3} />
                        <bufferAttribute attach="attributes-aTreePos" count={count} array={attributes.treePos} itemSize={3} />
                        <bufferAttribute attach="attributes-aRandom" count={count} array={attributes.randoms} itemSize={1} />
                    </bufferGeometry>
                    <shaderMaterial
                        vertexShader={foliageVertexShader}
                        fragmentShader={foliageFragmentShader}
                        uniforms={uniforms}
                        transparent={true}
                        depthWrite={false}
                        blending={THREE.AdditiveBlending}
                    />
                </points>
            );
        };

        const Ornaments = ({ isTree, count = 200, type = "sphere", color = "#D4AF37", scale = 0.3, textureStyle }) => {
            const meshRef = useRef();
            const audioFreq = useAudioData();
            
            // Texture for Gifts
            const texture = useMemo(() => {
                if (textureStyle === undefined) return null;
                return createGiftTexture(textureStyle);
            }, [textureStyle]);

            const [data] = useState(() => {
                const arr = [];
                const treeHeight = 11;
                const treeRadius = 4;
                
                for (let i = 0; i < count; i++) {
                    const r = 12 * Math.cbrt(Math.random());
                    const theta = Math.random() * 2 * Math.PI;
                    const phi = Math.acos(2 * Math.random() - 1);
                    const sx = r * Math.sin(phi) * Math.cos(theta);
                    const sy = r * Math.sin(phi) * Math.sin(theta);
                    const sz = r * Math.cos(phi);

                    const y = Math.random() * treeHeight;
                    const nY = y / treeHeight;
                    const cR = (1.0 - nY) * treeRadius; 
                    const ang = Math.random() * Math.PI * 2;
                    
                    const tx = cR * Math.cos(ang);
                    const ty = y - 4;
                    const tz = cR * Math.sin(ang);

                    arr.push({ scatter: new THREE.Vector3(sx, sy, sz), tree: new THREE.Vector3(tx, ty, tz) });
                }
                return arr;
            });

            const dummy = useMemo(() => new THREE.Object3D(), []);

            useFrame((state, delta) => {
                if (!meshRef.current) return;

                const t = state.clock.elapsedTime;
                const target = isTree ? 1 : 0;
                
                meshRef.current.userData.progress = THREE.MathUtils.lerp(
                    meshRef.current.userData.progress || 0,
                    target,
                    delta * 1.2
                );
                
                const p = meshRef.current.userData.progress;
                const audioScale = 1 + (audioFreq.current / 255) * 0.3;

                data.forEach((item, i) => {
                    const { scatter, tree } = item;
                    dummy.position.lerpVectors(scatter, tree, p);
                    
                    dummy.position.y += Math.sin(t + i) * 0.02 * (1-p); 
                    
                    dummy.scale.setScalar(scale * (i % 2 === 0 ? audioScale : 1));
                    
                    dummy.rotation.x = t * 0.2 + i;
                    dummy.rotation.z = t * 0.1 + i;
                    
                    dummy.updateMatrix();
                    meshRef.current.setMatrixAt(i, dummy.matrix);
                });
                meshRef.current.instanceMatrix.needsUpdate = true;
            });

            const geometry = type === 'box' ? new THREE.BoxGeometry(1, 1, 1) : new THREE.SphereGeometry(1, 16, 16);

            return (
                <instancedMesh ref={meshRef} args={[geometry, null, count]}>
                    <meshStandardMaterial 
                        color={texture ? "white" : color}
                        map={texture}
                        roughness={texture ? 0.3 : 0.1}
                        metalness={texture ? 0.5 : 0.9}
                        emissive={texture ? "#222" : color}
                        emissiveIntensity={0.2}
                    />
                </instancedMesh>
            );
        };

        const StarTopper = ({ isTree }) => {
            const ref = useRef();

            const starGeometry = useMemo(() => {
                const shape = new THREE.Shape();
                const points = 5;
                const outerRadius = 0.8;
                const innerRadius = 0.4;
                const angleOffset = Math.PI / 2; 

                for (let i = 0; i < points * 2; i++) {
                    const angle = (i * Math.PI) / points + angleOffset;
                    const radius = i % 2 === 0 ? outerRadius : innerRadius;
                    const x = Math.cos(angle) * radius;
                    const y = Math.sin(angle) * radius;
                    if (i === 0) shape.moveTo(x, y);
                    else shape.lineTo(x, y);
                }
                shape.closePath();

                const extrudeSettings = {
                    depth: 0.2,
                    bevelEnabled: true,
                    bevelThickness: 0.1,
                    bevelSize: 0.05,
                    bevelSegments: 3
                };

                const geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
                geometry.computeBoundingBox();
                const zCenter = (geometry.boundingBox.max.z - geometry.boundingBox.min.z) / 2;
                geometry.translate(0, 0, -zCenter); 
                return geometry;
            }, []);
            
            useFrame((state, delta) => {
                if(ref.current) {
                    const targetY = isTree ? 9 : 15; 
                    const targetScale = isTree ? 1 : 0.1;
                    ref.current.position.y = THREE.MathUtils.lerp(ref.current.position.y, targetY, delta * 2);
                    ref.current.scale.setScalar(THREE.MathUtils.lerp(ref.current.scale.x, targetScale, delta * 2));
                    ref.current.rotation.y += delta;
                }
            });

            return (
                <group ref={ref} position={[0, 15, 0]}>
                    <mesh geometry={starGeometry}>
                        <meshStandardMaterial color="#FFD700" emissive="#FFD700" emissiveIntensity={2} toneMapped={false} />
                    </mesh>
                    <pointLight color="#FFD700" intensity={5} distance={10} decay={2} />
                </group>
            );
        };

        const CameraController = ({ viewMode, freeMode }) => {
            const { camera, size } = useThree();
            
            useFrame(() => {
                // In free mode, don't force camera position
                if (freeMode) return;
                
                const isMobile = size.width < 768;
                // Top view: looking down at tree from above
                const topPos = { x: 0, y: 25, z: 0.1 };
                // Side view: original view
                const sidePos = { x: 0, y: 4, z: isMobile ? 35 : 20 };
                
                const target = viewMode === 'top' ? topPos : sidePos;
                
                camera.position.x += (target.x - camera.position.x) * 0.03;
                camera.position.y += (target.y - camera.position.y) * 0.03;
                camera.position.z += (target.z - camera.position.z) * 0.03;
            });
            
            return null;
        };

        const Scene = ({ isTree, viewMode }) => {
            return (
                <>
                    <PerspectiveCamera makeDefault position={[0, 25, 0.1]} fov={50} />
                    <CameraController viewMode={viewMode} freeMode={!isTree} />
                    <OrbitControls 
                        enablePan={false} 
                        minDistance={viewMode === 'side' ? 8 : 10} 
                        maxDistance={viewMode === 'side' ? 20 : 50} 
                        maxPolarAngle={Math.PI / 1.5} 
                        autoRotate={true} 
                        autoRotateSpeed={0.3} 
                    />
                    <Environment preset="city" blur={1} background={false} />
                    <ambientLight intensity={0.2} color="#002b16" />
                    <spotLight position={[10, 20, 10]} angle={0.3} penumbra={1} intensity={2} castShadow color="#F7E7CE" />
                    <spotLight position={[-10, 5, 10]} angle={0.5} penumbra={1} intensity={1} color="#023020" />
                    
                    <Foliage isTree={isTree} />
                    <AudioSpectrumRing isTree={isTree} />

                    {/* Heavy Ornaments - Textured Gifts Boxes */}
                    <Ornaments isTree={isTree} count={15} type="box" scale={0.5} textureStyle={0} />
                    <Ornaments isTree={isTree} count={15} type="box" scale={0.5} textureStyle={1} />
                    <Ornaments isTree={isTree} count={15} type="box" scale={0.5} textureStyle={2} />
                    <Ornaments isTree={isTree} count={15} type="box" scale={0.5} textureStyle={3} />
                    
                    {/* Light Ornaments (Balls) - Now Textured Spheres */}
                    <Ornaments isTree={isTree} count={40} type="sphere" scale={0.3} textureStyle={0} />
                    <Ornaments isTree={isTree} count={40} type="sphere" scale={0.3} textureStyle={1} />
                    <Ornaments isTree={isTree} count={40} type="sphere" scale={0.3} textureStyle={2} />
                    
                    {/* Tiny Lights - Warm White */}
                    <Ornaments isTree={isTree} count={300} type="sphere" color="#FFFDD0" scale={0.05} />

                    <StarTopper isTree={isTree} />
                    <Sparkles count={200} scale={12} size={2} speed={0.4} opacity={0.5} color="#F7E7CE" />
                </>
            );
        };

        const PostProcessingEffects = () => {
            return (
                <EffectComposer disableNormalPass>
                    <Bloom luminanceThreshold={0.8} mipmapBlur intensity={1.2} radius={0.6} />
                    <ToneMapping />
                    <Vignette eskil={false} offset={0.1} darkness={1.1} />
                    <Noise opacity={0.02} /> 
                </EffectComposer>
            );
        };

        const App = () => {
            const [isTree, setIsTree] = useState(true); // Start as tree (top-down view)
            const [viewMode, setViewMode] = useState('top'); // 'top' for homepage, 'side' for plaza
            const [audioReady, setAudioReady] = useState(false);

            useEffect(() => {
                // No auto animation - start with tree in top view
                
                const resumeContext = () => { if (audioContext.state === 'suspended') audioContext.resume(); };

                const startDefaultMusic = () => {
                    if (!defaultMediaElementSource) {
                        try {
                            defaultMediaElementSource = audioContext.createMediaElementSource(defaultAudioEl);
                            defaultMediaElementSource.connect(analyser);
                            analyser.connect(audioContext.destination);
                            activeSourceNode = defaultMediaElementSource;
                        } catch(e) { console.log("Audio node error", e); }
                    }
                    
                    defaultAudioEl.play().then(() => {
                        setAudioReady(true);
                    }).catch(e => {
                        const unlockAndPlay = () => {
                            resumeContext();
                            defaultAudioEl.play();
                            setAudioReady(true);
                            document.removeEventListener('click', unlockAndPlay);
                            document.removeEventListener('touchstart', unlockAndPlay);
                        };
                        document.addEventListener('click', unlockAndPlay);
                        document.addEventListener('touchstart', unlockAndPlay);
                    });
                };

                startDefaultMusic(); 
                
                // Expose tree and view control functions globally
                window.scatterTree = () => setIsTree(false);
                window.assembleTree = () => setIsTree(true);
                window.setTopView = () => setViewMode('top');
                window.setSideView = () => setViewMode('side');
                
                return () => {};
            }, []); 

            return (
                <Canvas shadows dpr={[1, 2]} gl={{ antialias: false, toneMappingExposure: 1.5 }}>
                    <color attach="background" args={['#000500']} />
                    <Suspense fallback={null}>
                        <Scene isTree={isTree} viewMode={viewMode} />
                        <PostProcessingEffects />
                    </Suspense>
                </Canvas>
            );
        };

        const root = createRoot(document.getElementById('canvas-container'));
        root.render(<App />);
        
        // Farcaster Mini App SDK - signal ready after render
        setTimeout(() => {
            import('https://esm.sh/@farcaster/miniapp-sdk').then(({ sdk }) => {
                window.farcasterSDK = sdk;
                sdk.actions.ready();
                console.log('Farcaster Mini App ready');
            }).catch(err => console.log('SDK error:', err));
        }, 100);
    </script>

    <!-- Gift Plaza System -->
    <script>
        let giftType = 'equal';
        let currentUser = null; // Will be set by Farcaster SDK
        // Neynar API calls go through /api/neynar to protect API key
        const MAX_PLAZA_GIFTS = 10;
        let plazaGifts = JSON.parse(localStorage.getItem('plaza_gifts') || '[]');
        let isPlazaMode = false;

        // Plaza transition animation (simplified)
        function playPlazaTransition(callback) {
            if (callback) callback();
        }
        
        // Background meteor effect - random shooting stars
        let meteorContainer = null;
        
        function initMeteorEffect() {
            if (meteorContainer) return;
            
            meteorContainer = document.createElement('div');
            meteorContainer.className = 'bg-meteor-container';
            document.body.appendChild(meteorContainer);
            
            // Start spawning meteors
            scheduleMeteor();
        }
        
        function scheduleMeteor() {
            // Random interval: 10-20 seconds
            const delay = 10000 + Math.random() * 10000;
            setTimeout(() => {
                spawnMeteor();
                scheduleMeteor();
            }, delay);
        }
        
        function spawnMeteor() {
            if (!meteorContainer) return;
            
            const meteor = document.createElement('div');
            meteor.className = 'bg-meteor';
            
            // Random start position (scattered across top-right)
            const startX = window.innerWidth * (0.3 + Math.random() * 0.8);
            const startY = -30 - Math.random() * 50;
            
            // Varied angle (30-50 degrees)
            const angle = 30 + Math.random() * 20;
            const radians = angle * Math.PI / 180;
            
            // Random size
            const size = 3 + Math.random() * 3;
            
            // Travel distance
            const travelDistance = window.innerWidth * 1.2 + Math.random() * 200;
            const travelX = -Math.cos(radians) * travelDistance;
            const travelY = Math.sin(radians) * travelDistance;
            
            // Duration based on distance (faster = more dramatic)
            const duration = 0.6 + Math.random() * 0.5;
            
            meteor.style.left = startX + 'px';
            meteor.style.top = startY + 'px';
            meteor.style.setProperty('--size', size + 'px');
            meteor.style.setProperty('--travel-x', travelX + 'px');
            meteor.style.setProperty('--travel-y', travelY + 'px');
            meteor.style.setProperty('--duration', duration + 's');
            
            meteorContainer.appendChild(meteor);
            
            // Remove after animation
            setTimeout(() => meteor.remove(), duration * 1000 + 100);
        }
        
        // Start meteor effect on page load
        setTimeout(initMeteorEffect, 3000);
        
        // Toggle Plaza Mode
        function togglePlazaMode() {
            if (!isPlazaMode) {
                // 1. Switch to side view + scatter tree
                if (window.setSideView) window.setSideView();
                if (window.scatterTree) window.scatterTree();
                
                // 2. After camera moves, assemble tree (original opening animation)
                setTimeout(() => {
                    if (window.assembleTree) window.assembleTree();
                    
                    // 3. After tree assembles, play comet animation
                    setTimeout(() => {
                        playPlazaTransition(() => {
                            // 4. Activate plaza with snowfall
                            activatePlazaMode(true);
                        });
                    }, 1500);
                }, 500);
                return;
            }
            // Return to top view
            if (window.setTopView) window.setTopView();
            activatePlazaMode(false);
        }
        
        function activatePlazaMode(entering) {
            isPlazaMode = entering;
            const plazaBtn = document.getElementById('plaza-btn');
            const plaza = document.getElementById('gift-plaza');
            const plazaSendBtn = document.getElementById('plaza-send-btn');
            const mainBtns = document.getElementById('main-btns');
            const topBtns = document.getElementById('top-btns');
            const titleEl = document.getElementById('app-title');
            const subtitleEl = document.getElementById('app-subtitle');
            
            if (isPlazaMode) {
                plazaBtn.textContent = '‚Ü© Return';
                plaza.style.display = 'block';
                plazaSendBtn.style.display = 'flex';
                mainBtns.style.display = 'none';
                topBtns.style.display = 'none';
                // Hide title, show banner
                if (titleEl) titleEl.style.display = 'none';
                if (subtitleEl) subtitleEl.style.display = 'none';
                startSnowfall();
                // plaza-greeting removed
                renderPlaza();
            } else {
                plazaBtn.textContent = 'üéÑ Plaza Gift';
                plaza.style.display = 'none';
                plazaSendBtn.style.display = 'none';
                mainBtns.style.display = 'flex';
                topBtns.style.display = 'flex';
                // Show title
                if (titleEl) titleEl.style.display = 'block';
                if (subtitleEl) subtitleEl.style.display = 'block';
                stopSnowfall();
                // plaza-greeting removed
            }
        }

        // Modal functions
        function openGiftModal() { 
            document.getElementById('gift-modal').classList.add('visible');
            document.getElementById('gift-title').value = '';
            document.getElementById('gift-token').value = 'USDC';
            document.getElementById('gift-amount').value = '0.1';
            document.getElementById('gift-shares').value = '5';
            document.getElementById('plaza-custom-token-group').style.display = 'none';
            document.getElementById('plaza-token-ca').value = '';
            document.getElementById('require-code').checked = false;
            document.getElementById('gift-code').value = '';
            document.getElementById('code-input-row').style.display = 'none';
            document.getElementById('require-pro').checked = false;
            document.getElementById('min-score').value = '0';
            updatePreview();
        }
        function closeGiftModal() { document.getElementById('gift-modal').classList.remove('visible'); }
        function closeClaimModal() { document.getElementById('claim-modal').classList.remove('visible'); }
        function openClaimInput() { document.getElementById('claim-input-modal').classList.add('visible'); document.getElementById('gift-code-input').value = ''; }
        function closeClaimInput() { document.getElementById('claim-input-modal').classList.remove('visible'); }
        function showLoading(text) { document.getElementById('loading-text').textContent = text; document.getElementById('loading-modal').classList.add('visible'); }
        function hideLoading() { document.getElementById('loading-modal').classList.remove('visible'); }
        function closeSuccessModal() { 
            document.getElementById('success-modal').querySelector('.modal-box').style.display = 'none';
            // Keep tree scattered - user can zoom in/out
            // Tree will reassemble when user clicks goHome button
            if (window.scatterTree) window.scatterTree();
        }
        
        // Tip Author functions
        const AUTHOR_USERNAME = 'xqc';
        const AUTHOR_ADDRESS = '0x...'; // Replace with actual address
        const USDC_CA = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
        let authorInfo = null;
        
        async function fetchAuthorInfo() {
            if (authorInfo) return;
            try {
                const res = await fetch(`/api/neynar?action=search&q=${AUTHOR_USERNAME}&limit=1`);
                const data = await res.json();
                if (data.result?.users?.[0]) {
                    authorInfo = data.result.users[0];
                    document.getElementById('author-avatar').src = authorInfo.pfp_url || '';
                    document.getElementById('author-name').textContent = authorInfo.username;
                }
            } catch (e) { console.error('Failed to fetch author info:', e); }
        }
        
        function openTipModal() {
            document.getElementById('tip-modal').classList.add('visible');
            document.getElementById('tip-amount').value = '1';
            document.getElementById('tip-amounts').innerHTML = [1, 3, 5].map(amt => 
                `<button type="button" class="tip-amt-btn" onclick="setTipAmount(${amt})">${amt}</button>`
            ).join('');
            fetchAuthorInfo();
        }
        function closeTipModal() { document.getElementById('tip-modal').classList.remove('visible'); }
        function setTipAmount(amount) { document.getElementById('tip-amount').value = amount; }
        async function sendTip() {
            const token = document.getElementById('tip-token').value;
            const amount = document.getElementById('tip-amount').value;
            if (!amount || parseFloat(amount) <= 0) { alert('Enter valid amount'); return; }
            
            closeTipModal();
            showLoading('Sending tip...');
            
            // In production, integrate with wallet (ethers.js / wagmi)
            // For demo, just show success
            setTimeout(() => {
                hideLoading();
                alert(`Thank you for your tip! ‚ù§Ô∏è\n\n${amount} ${token} to author`);
            }, 1500);
        }
        
        // Gift Record feature - show gifts sent and claimed (only on-chain transactions)
        function openRecordModal() {
            const myUsername = currentUser?.username || 'anonymous';
            const myFid = currentUser?.fid;
            const myAddress = window.connectedAddress?.toLowerCase();
            
            // Only show gifts with blockchain transactions (have txHash or contractGiftId)
            const onChainGifts = plazaGifts.filter(g => g.txHash || g.contractGiftId);
            
            // Gifts I sent (on-chain only)
            const sentGifts = onChainGifts.filter(g => 
                g.sender?.username === myUsername || 
                g.senderAddress?.toLowerCase() === myAddress
            );
            
            // Gifts I claimed (on-chain only)
            const claimedGifts = onChainGifts.filter(g => 
                g.claimedBy?.some(c => 
                    c.username === myUsername || 
                    c.fid === myFid ||
                    c.address?.toLowerCase() === myAddress
                )
            );
            
            const recordList = document.getElementById('record-list');
            let html = '';
            
            // If no records at all
            if (sentGifts.length === 0 && claimedGifts.length === 0) {
                html = '<div style="text-align:center; color:rgba(255,255,255,0.5); padding:24px; font-size:0.9rem;">No transaction records yet<br><span style="font-size:0.75rem; margin-top:8px; display:block;">Send or claim a gift to see records here</span></div>';
                recordList.innerHTML = html;
                document.getElementById('record-modal').classList.add('visible');
                return;
            }
            
            // Sent gifts section
            html += '<div style="color:var(--gold); font-weight:bold; margin-bottom:8px;">üéÅ Gifts I Sent</div>';
            if (sentGifts.length === 0) {
                html += '<div style="text-align:center; color:rgba(255,255,255,0.5); padding:12px; font-size:0.85rem;">No gifts sent yet</div>';
            } else {
                html += sentGifts.map(gift => {
                    const claimers = gift.claimedBy || [];
                    return `
                        <div style="background:rgba(0,0,0,0.3); padding:12px; border-radius:8px; margin-bottom:10px; border:1px solid rgba(212,175,55,0.3);">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <span style="color:var(--gold); font-weight:bold;">${gift.title}</span>
                                <span style="color:rgba(255,255,255,0.6); font-size:0.8rem;">${gift.claimed}/${gift.shares} claimed</span>
                            </div>
                            <div style="font-size:0.85rem; color:rgba(255,255,255,0.7);">${gift.amount} ${gift.token}</div>
                            ${claimers.length > 0 ? `
                                <div style="margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1);">
                                    <div style="font-size:0.75rem; color:rgba(255,255,255,0.5); margin-bottom:4px;">Claimed by:</div>
                                    ${claimers.map(c => `
                                        <div style="display:flex; align-items:center; gap:8px; padding:4px 0;">
                                            <img src="${c.pfp || 'https://i.imgur.com/HeIi0wU.png'}" style="width:24px; height:24px; border-radius:50%; border:1px solid var(--gold);" onerror="this.src='https://i.imgur.com/HeIi0wU.png'">
                                            <span style="font-size:0.8rem; color:rgba(255,255,255,0.8);">@${c.username || c.fid || 'anonymous'}</span>
                                            <span style="font-size:0.8rem; color:var(--gold); margin-left:auto;">${c.amount || '?'} ${gift.token}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<div style="font-size:0.75rem; color:rgba(255,255,255,0.4); margin-top:8px;">No claims yet</div>'}
                        </div>
                    `;
                }).join('');
            }
            
            // Claimed gifts section
            html += '<div style="color:var(--gold); font-weight:bold; margin:16px 0 8px;">üì¨ Gifts I Claimed</div>';
            if (claimedGifts.length === 0) {
                html += '<div style="text-align:center; color:rgba(255,255,255,0.5); padding:12px; font-size:0.85rem;">No gifts claimed yet</div>';
            } else {
                html += claimedGifts.map(gift => {
                    const myClaim = gift.claimedBy?.find(c => c.username === myUsername || c.fid === myFid);
                    return `
                        <div style="background:rgba(0,0,0,0.3); padding:12px; border-radius:8px; margin-bottom:10px; border:1px solid rgba(212,175,55,0.3);">
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                                <img src="${gift.sender?.pfp || 'https://i.imgur.com/HeIi0wU.png'}" style="width:28px; height:28px; border-radius:50%; border:1px solid var(--gold);" onerror="this.src='https://i.imgur.com/HeIi0wU.png'">
                                <div>
                                    <div style="color:var(--gold); font-weight:bold;">${gift.title}</div>
                                    <div style="font-size:0.75rem; color:rgba(255,255,255,0.5);">From @${gift.sender?.username || 'anonymous'}</div>
                                </div>
                            </div>
                            <div style="font-size:0.85rem; color:var(--gold);">Received: ${myClaim?.amount || '?'} ${gift.token}</div>
                        </div>
                    `;
                }).join('');
            }
            
            recordList.innerHTML = html;
            document.getElementById('record-modal').classList.add('visible');
        }
        
        function closeRecordModal() {
            document.getElementById('record-modal').classList.remove('visible');
        }
        
        // Show floating claim success message
        function showClaimSuccess(amount) {
            const msg = document.createElement('div');
            msg.style.cssText = `
                position: fixed;
                top: 50%; left: 50%;
                transform: translate(-50%, -50%) scale(0);
                background: rgba(0,0,0,0.8);
                border: 2px solid rgba(255,215,0,0.6);
                border-radius: 16px;
                padding: 24px 40px;
                text-align: center;
                z-index: 9999;
                animation: popIn 0.4s ease forwards, fadeOut 0.5s ease 2s forwards;
            `;
            msg.innerHTML = `
                <div style="font-size:3rem; margin-bottom:8px;">üéâ</div>
                <div style="color:#ffd700; font-size:1.2rem; font-weight:bold;">Gift Claimed!</div>
                <div style="color:#fff; font-size:1.5rem; margin-top:8px;">üí∞ ${amount}</div>
            `;
            document.body.appendChild(msg);
            
            // Add animation styles if not exist
            if (!document.getElementById('claim-success-anim')) {
                const style = document.createElement('style');
                style.id = 'claim-success-anim';
                style.textContent = `
                    @keyframes popIn { to { transform: translate(-50%, -50%) scale(1); } }
                    @keyframes fadeOut { to { opacity: 0; transform: translate(-50%, -50%) scale(0.8); } }
                `;
                document.head.appendChild(style);
            }
            
            setTimeout(() => msg.remove(), 2500);
        }
        
        // Go back to home
        function goHome() {
            document.getElementById('success-modal').classList.remove('visible');
            document.getElementById('success-modal').querySelector('.modal-box').style.display = 'block';
            document.querySelector('.controls').style.display = 'flex';
            document.getElementById('gift-plaza').style.display = 'none';
            document.getElementById('plaza-btn').textContent = 'üéÑ Plaza Gift';
            document.getElementById('main-btns').style.display = 'flex';
            document.getElementById('top-btns').style.display = 'flex';
            document.getElementById('plaza-send-btn').style.display = 'none';
            document.getElementById('scatter-home-btn').style.display = 'none';
            isPlazaMode = false;
            // Reassemble tree when returning home
            if (window.assembleTree) window.assembleTree();
            if (window.setTopView) window.setTopView();
        }
        
        // Direct Gift (Send to Friends)
        let selectedRecipients = [];
        let searchTimeout = null;
        const MAX_RECIPIENTS = 10;
        
        function openDirectGiftModal() {
            document.getElementById('direct-gift-modal').classList.add('visible');
            selectedRecipients = [];
            document.getElementById('user-search').value = '';
            document.getElementById('selected-users').innerHTML = '';
            document.getElementById('user-results').style.display = 'none';
            document.getElementById('direct-gift-title').value = '';
            document.getElementById('direct-gift-message').value = '';
            document.getElementById('direct-gift-amount').value = '0.5';
            document.getElementById('direct-gift-token').value = 'USDC';
            document.getElementById('custom-token-group').style.display = 'none';
            document.getElementById('custom-token-ca').value = '';
            updateDirectPreview();
        }
        
        async function fetchTopFriends() {
            try {
                document.getElementById('selected-users').innerHTML = '<div style="color:rgba(255,255,255,0.5);font-size:0.8rem;">Loading friends...</div>';
                
                // Use current user's fid or default to a popular user for demo
                const fid = currentUser?.fid || 3; // dwr.eth as default
                const res = await fetch(`/api/neynar?action=following&fid=${fid}&limit=5`);
                const data = await res.json();
                if (data.users?.length > 0) {
                    selectedRecipients = data.users.slice(0, 5).map(u => ({
                        fid: u.fid,
                        username: u.username,
                        display_name: u.display_name,
                        pfp_url: u.pfp_url
                    }));
                    renderSelectedUsers();
                    updateDirectPreview();
                } else {
                    document.getElementById('selected-users').innerHTML = '';
                }
            } catch (e) { 
                console.error('Failed to fetch friends:', e);
                document.getElementById('selected-users').innerHTML = '';
            }
        }
        function closeDirectGiftModal() { document.getElementById('direct-gift-modal').classList.remove('visible'); }
        
        async function searchUsers(query) {
            if (searchTimeout) clearTimeout(searchTimeout);
            const resultsDiv = document.getElementById('user-results');
            if (!query || query.length < 2) { resultsDiv.style.display = 'none'; return; }
            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`/api/neynar?action=search&q=${encodeURIComponent(query)}&limit=5`);
                    const data = await res.json();
                    if (data.result?.users?.length > 0) {
                        resultsDiv.innerHTML = data.result.users.map(u => `
                            <div class="user-result" onclick='selectUser(${JSON.stringify(u).replace(/'/g, "&#39;")})'>
                                <img src="${u.pfp_url || 'https://via.placeholder.com/32'}" onerror="this.src='https://via.placeholder.com/32'">
                                <div class="info"><div class="name">${u.display_name || u.username}</div><div class="username">@${u.username}</div></div>
                            </div>
                        `).join('');
                        resultsDiv.style.display = 'block';
                    } else { resultsDiv.style.display = 'none'; }
                } catch (e) { console.error(e); resultsDiv.style.display = 'none'; }
            }, 300);
        }

        async function searchUsersPlaza(query) {
            if (searchTimeout) clearTimeout(searchTimeout);
            const resultsDiv = document.getElementById('plaza-user-results');
            if (!query || query.length < 2) { resultsDiv.style.display = 'none'; return; }
            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`/api/neynar?action=search&q=${encodeURIComponent(query)}&limit=5`);
                    const data = await res.json();
                    if (data.result?.users?.length > 0) {
                        resultsDiv.innerHTML = data.result.users.map(u => `
                            <div class="user-result" onclick='selectUserPlaza(${JSON.stringify(u).replace(/'/g, "&#39;")})'>
                                <img src="${u.pfp_url || 'https://via.placeholder.com/32'}" onerror="this.src='https://via.placeholder.com/32'">
                                <div class="info"><div class="name">${u.display_name || u.username}</div><div class="username">@${u.username}</div></div>
                            </div>
                        `).join('');
                        resultsDiv.style.display = 'block';
                    } else { resultsDiv.style.display = 'none'; }
                } catch (e) { console.error(e); resultsDiv.style.display = 'none'; }
            }, 300);
        }

        function selectUserPlaza(user) {
            document.getElementById('gift-recipient').value = user.username;
            document.getElementById('plaza-user-results').style.display = 'none';
            document.getElementById('selected-user').innerHTML = `
                <div style="display:flex; align-items:center; gap:8px; margin-top:8px; padding:8px; background:rgba(212,175,55,0.1); border-radius:4px;">
                    <img src="${user.pfp_url || ''}" style="width:24px; height:24px; border-radius:50%;" onerror="this.src='https://via.placeholder.com/24'">
                    <span style="color:var(--gold);">@${user.username}</span>
                </div>
            `;
            window.selectedPlazaUser = user;
        }
        
        function selectUser(user) {
            if (selectedRecipients.find(r => r.fid === user.fid)) { alert('Already selected'); return; }
            if (selectedRecipients.length >= MAX_RECIPIENTS) { alert('Max ' + MAX_RECIPIENTS + ' recipients'); return; }
            selectedRecipients.push(user);
            document.getElementById('user-search').value = '';
            document.getElementById('user-results').style.display = 'none';
            renderSelectedUsers();
            updateDirectPreview();
        }
        
        function renderSelectedUsers() {
            const div = document.getElementById('selected-users');
            if (selectedRecipients.length === 0) { div.innerHTML = ''; return; }
            div.innerHTML = `<div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;">${selectedRecipients.map((u, i) => `
                <div class="selected-user-card" style="flex:none; padding:6px 10px;">
                    <img src="${u.pfp_url || 'https://via.placeholder.com/24'}" style="width:24px; height:24px;" onerror="this.src='https://via.placeholder.com/24'">
                    <span style="color:var(--gold); font-size:0.8rem;">@${u.username}</span>
                    <button class="remove-btn" onclick="removeUser(${i})" style="font-size:1rem; padding:2px;">√ó</button>
                </div>
            `).join('')}</div><div style="font-size:0.7rem; color:rgba(255,255,255,0.4); margin-top:6px;">${selectedRecipients.length}/${MAX_RECIPIENTS}</div>`;
        }
        
        function removeUser(index) { selectedRecipients.splice(index, 1); renderSelectedUsers(); updateDirectPreview(); }
        
        function toggleCustomToken() {
            const token = document.getElementById('direct-gift-token').value;
            document.getElementById('custom-token-group').style.display = token === 'CUSTOM' ? 'block' : 'none';
            updateDirectPreview();
        }
        
        function validateDirectAmount() {
            const input = document.getElementById('direct-gift-amount');
            if (parseFloat(input.value) < 0.1) {
                input.value = '0.1';
            }
        }
        
        function updateDirectPreview() {
            const amount = document.getElementById('direct-gift-amount').value || '0';
            let token = document.getElementById('direct-gift-token').value;
            if (token === 'CUSTOM') token = 'TOKEN';
            document.getElementById('direct-preview-amount').textContent = amount + ' ' + token + ' each';
            document.getElementById('direct-preview-info').textContent = selectedRecipients.length > 0 
                ? '‚Üí ' + selectedRecipients.map(u => '@' + u.username).join(', ')
                : 'Select recipient(s) above';
        }
        
        async function createDirectGift() {
            const title = document.getElementById('direct-gift-title').value || 'Merry Christmas!';
            const message = document.getElementById('direct-gift-message').value || '';
            const token = document.getElementById('direct-gift-token').value;
            const amount = document.getElementById('direct-gift-amount').value;
            if (!amount || parseFloat(amount) <= 0) { alert('Enter valid amount'); return; }
            if (selectedRecipients.length === 0) { alert('Select at least one recipient'); return; }
            
            closeDirectGiftModal();
            showLoading('Creating gifts...');
            
            // Create a gift for each recipient
            const links = [];
            for (const r of selectedRecipients) {
                const giftId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                const giftData = {
                    id: giftId, title, message, token, amount,
                    cover: selectedCover,
                    shares: 1, type: 'equal', mode: 'direct',
                    requirePro: false, minScore: 0,
                    claimed: 0, claimedBy: [],
                    recipient: { fid: r.fid, username: r.username, pfp: r.pfp_url },
                    sender: currentUser || { fid: 0, username: 'anonymous', pfp: '' },
                    createdAt: Date.now()
                };
                plazaGifts.push(giftData);
                links.push({ username: r.username, url: location.origin + location.pathname + '?gift=' + giftId });
            }
            localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));
            
            // Create share text
            let shareText = links.length === 1 
                ? `üéÅ Gift for @${links[0].username}!\n\n${title}\nüí∞ ${amount} ${token}\n\nüîó ${links[0].url}`
                : `üéÅ Christmas Gifts!\n\n${title}\nüí∞ ${amount} ${token} each\n\n` + links.map(l => `‚Üí @${l.username}: ${l.url}`).join('\n');
            
            hideLoading();
            if (navigator.clipboard) {
                await navigator.clipboard.writeText(shareText);
                alert(`Gift(s) created for ${selectedRecipients.length} friend(s)!\nLink(s) copied to clipboard!`);
            } else { alert(shareText); }
        }
        
        // Claim by code/link
        let currentCardGift = null;
        
        function claimByCode() {
            const input = document.getElementById('gift-code-input').value.trim();
            if (!input) { alert('Please enter a gift code'); return; }
            
            // Extract gift ID from input (could be full URL or just ID)
            let giftId = input;
            if (input.includes('gift=')) {
                giftId = input.split('gift=')[1].split('&')[0];
            }
            
            // Check if gift exists in plaza
            const gift = plazaGifts.find(g => g.id === giftId);
            if (gift) {
                closeClaimInput();
                // Direct gift shows greeting card
                if (gift.mode === 'direct') {
                    showGreetingCard(gift);
                } else {
                    openClaimModal(giftId);
                }
            } else {
                alert('Gift not found!');
            }
        }
        
        // Check and show mailbox glow if there are gifts for user
        function checkMyGifts() {
            const myGifts = plazaGifts.filter(g => g.mode === 'direct' && g.claimed < g.shares);
            const mailboxBtn = document.getElementById('mailbox-button');
            if (myGifts.length > 0) {
                mailboxBtn.classList.add('has-gift');
            } else {
                mailboxBtn.classList.remove('has-gift');
            }
        }
        
        // Open first available gift
        function openMyGifts() {
            const myGifts = plazaGifts.filter(g => g.mode === 'direct' && g.claimed < g.shares);
            if (myGifts.length > 0) {
                showGreetingCard(myGifts[0]);
            } else {
                showToast('üì≠ No gifts yet');
            }
        }
        
        function showToast(message) {
            const existing = document.querySelector('.toast-msg');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast-msg';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20%;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.8);
                color: #fff;
                padding: 12px 24px;
                border-radius: 20px;
                font-size: 14px;
                z-index: 9999;
                animation: toastFade 2s ease forwards;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }
        
        // Cover art content mapping
        const coverArt = { 1: '', 2: '', 3: '', 4: '‚ú¶', 5: '', 6: '' };
        let selectedCover = 1;
        
        function selectCover(num) {
            selectedCover = num;
            document.querySelectorAll('.cover-option').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-cover="${num}"]`).classList.add('selected');
        }
        
        // Show gift card cover
        function showGreetingCard(gift) {
            currentCardGift = gift;
            const senderName = gift.sender?.username || gift.sender?.displayName || 'Someone';
            const coverNum = gift.cover || 1;
            const coverEl = document.getElementById('card-cover-display');
            const container = document.getElementById('gift-card-container');
            
            // Reset state
            container.classList.remove('opened');
            document.getElementById('card-inside-loading').style.display = 'flex';
            document.getElementById('card-content-row').style.display = 'none';
            document.getElementById('card-inside-greeting').textContent = '';
            
            // Set cover style
            coverEl.className = `card-cover card-cover-${coverNum}`;
            document.getElementById('cover-art').textContent = coverArt[coverNum] || '';
            document.getElementById('cover-title').textContent = gift.title || 'Merry Christmas!';
            document.getElementById('cover-from').textContent = `From @${senderName}`;
            document.getElementById('card-inside-amount').textContent = 'üéÅ ' + gift.amount + ' ' + gift.token;
            
            document.getElementById('envelope-modal').classList.add('visible');
        }
        
        // Open card with flip animation and generate AI content
        async function openEnvelopeCard() {
            if (!currentCardGift) return;
            
            const container = document.getElementById('gift-card-container');
            
            // Flip the card open
            container.classList.add('opened');
            
            // Set amount
            document.getElementById('card-inside-amount').textContent = 'üéÅ ' + currentCardGift.amount + ' ' + currentCardGift.token;
            
            // Get avatars for AI generation
            const senderAvatar = currentCardGift.sender?.pfp || 'https://i.imgur.com/HeIi0wU.png';
            const recipientAvatar = currentUser?.pfp_url || 'https://i.imgur.com/HeIi0wU.png';
            
            // Generate AI card
            try {
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generateCard',
                        senderName: currentCardGift.sender?.username || 'Friend',
                        senderAvatar: senderAvatar,
                        recipientName: currentUser?.username || 'Friend',
                        recipientAvatar: recipientAvatar,
                        message: currentCardGift.message || 'Merry Christmas!'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Hide loading
                    document.getElementById('card-inside-loading').style.display = 'none';
                    
                    // Show content row with image and greeting
                    document.getElementById('card-content-row').style.display = 'flex';
                    
                    // Set generated image
                    const imgEl = document.getElementById('card-inside-image');
                    if (data.image) {
                        imgEl.src = `data:image/png;base64,${data.image}`;
                    } else {
                        // Fallback: hide image if generation failed
                        imgEl.style.display = 'none';
                    }
                    
                    // Show greeting
                    document.getElementById('card-inside-greeting').textContent = data.greeting || currentCardGift.message || 'Merry Christmas!';
                } else {
                    throw new Error(data.error || 'Generation failed');
                }
            } catch (error) {
                console.error('AI card generation error:', error);
                // Fallback - show message only without image
                document.getElementById('card-inside-loading').style.display = 'none';
                document.getElementById('card-content-row').style.display = 'flex';
                document.getElementById('card-inside-image').style.display = 'none';
                document.getElementById('card-inside-greeting').innerHTML = `
                    <div style="text-align:center;">
                        <div style="font-size:2rem; margin-bottom:12px;">üéÑüéÅ‚ùÑÔ∏è</div>
                        <div>${currentCardGift.message || 'Wishing you a wonderful holiday season!'}</div>
                    </div>
                `;
            }
        }
        
        function closeCardModal() {
            document.getElementById('envelope-modal').classList.remove('visible');
            document.getElementById('gift-card-container').classList.remove('opened');
            currentCardGift = null;
        }
        

        
        function claimAICardGift() {
            if (!currentCardGift) return;
            
            // Launch confetti
            launchConfetti();
            
            showLoading('Claiming gift...');
            document.querySelector('.controls').style.display = 'none';
            
            // Close AI card modal
            document.getElementById('ai-card-modal').classList.remove('visible');
            
            // TODO: In production, call smart contract here
            currentCardGift.claimed = 1;
            currentCardGift.claimedBy.push(currentUser?.fid || 'guest');
            localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));
            
            setTimeout(() => {
                hideLoading();
                
                // Tree scatter effect
                if (window.scatterTree) window.scatterTree();
                
                // Show floating success message
                showClaimSuccess(currentCardGift.amount + ' ' + currentCardGift.token);
                
                // Show home button
                document.getElementById('scatter-home-btn').style.display = 'block';
                
                checkMyGifts();
                currentCardGift = null;
            }, 800);
        }
        
        // Legacy claim function (for fallback)
        function claimCardGift() {
            if (!currentCardGift) return;
            
            // Step 1: Play card opening animation
            const card = document.querySelector('.greeting-card');
            card.classList.add('opening');
            
            // Step 2: Launch confetti burst
            launchConfetti();
            
            // Step 3: After animation, process claim
            setTimeout(() => {
                document.getElementById('card-modal').classList.remove('visible');
                card.classList.remove('opening');
                
                showLoading('Claiming gift...');
                document.querySelector('.controls').style.display = 'none';
                
                // TODO: In production, call smart contract here
                currentCardGift.claimed = 1;
                currentCardGift.claimedBy.push(currentUser?.fid || 'guest');
                localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));
                
                setTimeout(() => {
                    hideLoading();
                    document.getElementById('success-amount').textContent = currentCardGift.amount + ' ' + currentCardGift.token;
                    document.getElementById('success-modal').classList.add('visible');
                    
                    checkMyGifts();
                    currentCardGift = null;
                }, 800);
            }, 1000);
        }
        
        // Christmas confetti burst effect
        function launchConfetti() {
            const container = document.createElement('div');
            container.className = 'confetti-container';
            document.body.appendChild(container);
            
            const colors = ['#D4AF37', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#ff7675', '#74b9ff'];
            const shapes = ['üéÑ', '‚≠ê', '‚ùÑÔ∏è', 'üéÅ', 'üîî', '‚ú®'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-10px';
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                
                if (Math.random() > 0.5) {
                    confetti.textContent = shapes[Math.floor(Math.random() * shapes.length)];
                    confetti.style.fontSize = (12 + Math.random() * 12) + 'px';
                    confetti.style.width = 'auto';
                    confetti.style.height = 'auto';
                } else {
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                }
                
                container.appendChild(confetti);
            }
            
            setTimeout(() => container.remove(), 4000);
        }

        function toggleCodeInput() {
            const show = document.getElementById('require-code').checked;
            document.getElementById('code-input-row').style.display = show ? 'flex' : 'none';
            if (!show) document.getElementById('gift-code').value = '';
        }
        
        function togglePlazaCustomToken() {
            const token = document.getElementById('gift-token').value;
            document.getElementById('plaza-custom-token-group').style.display = token === 'CUSTOM' ? 'block' : 'none';
            updatePreview();
        }
        
        function validatePlazaAmount() {
            const input = document.getElementById('gift-amount');
            if (parseFloat(input.value) < 0.1) {
                input.value = '0.1';
            }
        }
        
        function selectGiftType(type) {
            giftType = type;
            document.querySelectorAll('.type-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (i === 0 && type === 'equal') || (i === 1 && type === 'lucky'));
            });
            updatePreview();
        }

        function updatePreview() {
            const amount = document.getElementById('gift-amount').value || '0';
            const token = document.getElementById('gift-token').value;
            const shares = document.getElementById('gift-shares').value || '1';
            document.getElementById('preview-amount').textContent = amount + ' ' + token;
            const perShare = shares > 0 ? (parseFloat(amount) / parseInt(shares)).toFixed(6) : '0';
            const requireCode = document.getElementById('require-code').checked;
            const requirePro = document.getElementById('require-pro').checked;
            const minScore = parseFloat(document.getElementById('min-score').value) || 0;
            let info = giftType === 'equal' ? `${shares} shares √ó ${perShare} ${token}` : `${shares} lucky shares`;
            if (requireCode || requirePro || minScore > 0) {
                info += ' | Requires:';
                if (requireCode) info += ' üîëCode';
                if (requirePro) info += ' FC Pro';
                if (minScore > 0) info += ` Score‚â•${minScore}`;
            }
            document.getElementById('preview-info').textContent = info;
        }

        // Create gift for plaza (with smart contract)
        async function createGift() {
            // Check if plaza is full
            const activeGifts = plazaGifts.filter(g => g.claimed < g.shares);
            if (activeGifts.length >= MAX_PLAZA_GIFTS) {
                alert('üéÑ Plaza Gift is full!\n\nMaximum 10 gifts can orbit the tree at once.\nPlease wait for some gifts to be claimed.');
                return;
            }
            
            const title = document.getElementById('gift-title').value || 'Merry Christmas!';
            const token = document.getElementById('gift-token').value;
            const amount = document.getElementById('gift-amount').value;
            const shares = document.getElementById('gift-shares').value || '5';
            const requireCode = document.getElementById('require-code').checked;
            const giftCode = document.getElementById('gift-code').value.trim() || 'XMAS2024';
            const requirePro = document.getElementById('require-pro').checked;
            const minScore = parseFloat(document.getElementById('min-score').value) || 0;

            if (!amount || parseFloat(amount) <= 0) { alert('Enter valid amount'); return; }
            if (!shares || parseInt(shares) < 1) { alert('Enter valid shares'); return; }

            // Connect wallet if not connected
            if (!connectedAddress) {
                const connected = await connectWallet();
                if (!connected) return;
            }

            closeGiftModal();
            showLoading('Creating gift on blockchain...');

            try {
                const passwordHash = hashPassword(giftCode);
                const giftTypeEnum = giftType === 'equal' ? 0 : 1; // 0 = EQUAL, 1 = LUCKY
                const duration = 7 * 24 * 60 * 60; // 7 days
                let tx, receipt, contractGiftId;

                if (token === 'ETH') {
                    // Create ETH gift
                    const amountWei = ethers.parseEther(amount);
                    tx = await giftContract.createGiftETH(
                        parseInt(shares),
                        passwordHash,
                        giftTypeEnum,
                        requirePro,
                        title,
                        duration,
                        { value: amountWei }
                    );
                } else {
                    // Create token gift (USDC)
                    const tokenAddress = USDC_CA;
                    const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, web3Signer);
                    const decimals = await tokenContract.decimals();
                    const amountUnits = ethers.parseUnits(amount, decimals);
                    
                    // Check and approve
                    const allowance = await tokenContract.allowance(connectedAddress, CONTRACT_ADDRESS);
                    if (allowance < amountUnits) {
                        showLoading('Approving tokens...');
                        const approveTx = await tokenContract.approve(CONTRACT_ADDRESS, amountUnits);
                        await approveTx.wait();
                    }
                    
                    showLoading('Creating gift...');
                    tx = await giftContract.createGiftToken(
                        tokenAddress,
                        amountUnits,
                        parseInt(shares),
                        passwordHash,
                        giftTypeEnum,
                        requirePro,
                        title,
                        duration
                    );
                }

                showLoading('Confirming transaction...');
                receipt = await tx.wait();
                
                // Get gift ID from event
                const event = receipt.logs.find(log => {
                    try {
                        const parsed = giftContract.interface.parseLog(log);
                        return parsed.name === 'GiftCreated';
                    } catch { return false; }
                });
                
                if (event) {
                    const parsed = giftContract.interface.parseLog(event);
                    contractGiftId = parsed.args[0].toString();
                }

                // For demo/UI, also store locally
                const sender = currentUser || {
                    fid: Date.now(),
                    username: connectedAddress.slice(0, 8),
                    pfp_url: 'https://i.imgur.com/HeIi0wU.png'
                };

                const giftData = {
                    id: contractGiftId || Date.now().toString(),
                    contractId: contractGiftId,
                    title,
                    token,
                    amount,
                    shares: parseInt(shares),
                    type: giftType,
                    requireCode,
                    giftCode: giftCode,
                    requirePro,
                    minScore,
                    claimed: 0,
                    claimedBy: [],
                    sender: {
                        fid: sender.fid,
                        username: sender.username,
                        pfp: sender.pfp_url,
                        address: connectedAddress
                    },
                    createdAt: Date.now(),
                    txHash: receipt.hash
                };

                plazaGifts.push(giftData);
                localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));

                hideLoading();
                renderPlaza();
                alert(`üéÅ Gift created on blockchain!\n\nGift ID: ${contractGiftId}\nTx: ${receipt.hash.slice(0, 10)}...\n\nShare the code "${giftCode}" with friends!`);
            } catch (error) {
                hideLoading();
                console.error('Create gift error:', error);
                alert('Failed to create gift: ' + (error.reason || error.message));
            }
        }

        // Render orbiting avatars around the tree
        function renderPlaza() {
            const plaza = document.getElementById('gift-plaza');
            // Only show plaza gifts, not direct gifts
            const activeGifts = plazaGifts.filter(g => g.claimed < g.shares && g.mode !== 'direct').slice(0, MAX_PLAZA_GIFTS);
            
            // Responsive orbit radius based on viewport - closer to tree
            const baseRadius = Math.min(window.innerWidth, window.innerHeight) * 0.12;
            const positions = [
                { duration: 18, delay: 0, y: -100, radius: baseRadius * 0.9 },
                { duration: 22, delay: -3, y: -70, radius: baseRadius * 1.1 },
                { duration: 15, delay: -7, y: -35, radius: baseRadius * 0.85 },
                { duration: 20, delay: -2, y: 0, radius: baseRadius },
                { duration: 25, delay: -5, y: 35, radius: baseRadius * 1.15 },
                { duration: 17, delay: -8, y: -85, radius: baseRadius * 0.95 },
                { duration: 23, delay: -1, y: -50, radius: baseRadius * 1.05 },
                { duration: 19, delay: -6, y: 18, radius: baseRadius * 0.92 },
                { duration: 21, delay: -4, y: -18, radius: baseRadius * 1.1 },
                { duration: 16, delay: -9, y: 50, radius: baseRadius * 0.98 }
            ];
            
            plaza.innerHTML = activeGifts.map((gift, index) => {
                const pos = positions[index];
                return `
                    <div class="plaza-gift" 
                         style="--orbit-duration: ${pos.duration}s; --orbit-delay: ${pos.delay}s; --orbit-radius: ${pos.radius}px; top: ${pos.y}px;"
                         onclick="openClaimModal('${gift.id}')"
                         title="Click to claim mystery gift from @${gift.sender.username}">
                        <img src="${gift.sender.pfp || 'https://i.imgur.com/HeIi0wU.png'}" 
                             onerror="this.src='https://i.imgur.com/HeIi0wU.png'"
                             alt="${gift.sender.username}">
                        <div class="santa-emoji">üéÖ</div>
                    </div>
                `;
            }).join('');
        }

        // Open claim modal for specific gift
        function openClaimModal(giftId) {
            const gift = plazaGifts.find(g => g.id === giftId);
            if (!gift) { alert('Gift not found'); return; }
            if (gift.claimed >= gift.shares) { alert('All shares claimed!'); return; }

            // Store current gift id for claiming
            document.getElementById('claim-modal').dataset.giftId = giftId;

            document.querySelector('#claim-modal .modal-title').textContent = 'üéÅ Mystery Gift';
            document.getElementById('claim-message').textContent = gift.title;
            document.getElementById('claim-remaining').textContent = '??? ' + gift.token;
            document.getElementById('claim-shares').textContent = gift.claimed + '/' + gift.shares + ' claimed';
            document.getElementById('claim-shares').parentElement.style.display = 'inline';

            // Show sender info
            const recipientDiv = document.getElementById('claim-recipient');
            recipientDiv.innerHTML = `
                <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:8px;">
                    <img src="${gift.sender.pfp || ''}" style="width:32px; height:32px; border-radius:50%; border:2px solid var(--gold);" onerror="this.style.display='none'">
                    <span style="color:var(--gold);">From @${gift.sender.username}</span>
                </div>
                ${gift.requirePro || gift.minScore > 0 ? `
                    <div style="font-size:0.75rem; color:rgba(255,255,255,0.5); margin-top:4px;">
                        Requirements: ${gift.requirePro ? '‚≠ê FC Pro ' : ''}${gift.minScore > 0 ? `Score‚â•${gift.minScore}` : ''}
                    </div>
                ` : ''}
            `;
            recipientDiv.style.display = 'block';

            // Show/hide code input based on gift requirements
            const codeGroup = document.querySelector('#claim-modal .form-group');
            if (gift.requireCode) {
                codeGroup.style.display = 'block';
                document.getElementById('claim-password').value = '';
            } else {
                codeGroup.style.display = 'none';
            }
            document.querySelector('#claim-modal .btn-gift').textContent = 'Claim Gift';

            document.getElementById('claim-modal').classList.add('visible');
        }

        // Claim gift (with smart contract)
        async function claimGift() {
            const giftId = document.getElementById('claim-modal').dataset.giftId;
            const gift = plazaGifts.find(g => g.id === giftId);
            
            if (!gift) { alert('Gift not found'); return; }
            if (gift.claimed >= gift.shares) { alert('All shares claimed!'); return; }

            // Get password
            const password = document.getElementById('claim-password').value.trim() || gift.giftCode || 'XMAS2024';

            // Verify code if required (for UI feedback)
            if (gift.requireCode && password !== gift.giftCode) {
                alert('Wrong code! Try again.');
                return;
            }

            // Connect wallet if not connected
            if (!connectedAddress) {
                const connected = await connectWallet();
                if (!connected) return;
            }

            // Check if already claimed on contract
            if (gift.contractId) {
                try {
                    const hasClaimed = await giftContract.hasUserClaimed(gift.contractId, connectedAddress);
                    if (hasClaimed) {
                        alert('You have already claimed this gift!');
                        return;
                    }
                } catch (e) {
                    console.log('Error checking claim status:', e);
                }
            }

            closeClaimModal();
            showLoading('Claiming gift...');
            
            // Hide plaza and controls
            document.getElementById('gift-plaza').style.display = 'none';
            document.querySelector('.controls').style.display = 'none';

            try {
                let claimAmount;
                
                // If gift has contract ID, claim from contract
                if (gift.contractId) {
                    const isPro = gift.requirePro ? true : false;
                    const tx = await giftContract.claimGift(gift.contractId, password, isPro);
                    showLoading('Confirming transaction...');
                    const receipt = await tx.wait();
                    
                    // Get claimed amount from event
                    const event = receipt.logs.find(log => {
                        try {
                            const parsed = giftContract.interface.parseLog(log);
                            return parsed.name === 'GiftClaimed';
                        } catch { return false; }
                    });
                    
                    if (event) {
                        const parsed = giftContract.interface.parseLog(event);
                        const amountWei = parsed.args[2];
                        if (gift.token === 'ETH') {
                            claimAmount = ethers.formatEther(amountWei);
                        } else {
                            claimAmount = ethers.formatUnits(amountWei, 6); // USDC has 6 decimals
                        }
                    } else {
                        claimAmount = (parseFloat(gift.amount) / gift.shares).toFixed(6);
                    }
                } else {
                    // Demo mode - calculate locally
                    if (gift.type === 'equal') {
                        claimAmount = (parseFloat(gift.amount) / gift.shares).toFixed(6);
                    } else {
                        const remaining = gift.shares - gift.claimed;
                        const remainingAmount = parseFloat(gift.amount) - gift.claimedBy.reduce((sum, c) => sum + parseFloat(c.amount || 0), 0);
                        const maxAmount = remaining > 1 ? (remainingAmount * 2 / remaining) : remainingAmount;
                        claimAmount = (Math.random() * maxAmount).toFixed(6);
                    }
                }

                // Update local gift data
                gift.claimed++;
                gift.claimedBy.push({
                    fid: currentUser?.fid || Date.now(),
                    username: currentUser?.username || connectedAddress?.slice(0, 8) || 'guest',
                    pfp: currentUser?.pfp || 'https://i.imgur.com/HeIi0wU.png',
                    address: connectedAddress,
                    amount: claimAmount,
                    at: Date.now()
                });
                localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));

                hideLoading();
                document.getElementById('success-amount').textContent = claimAmount + ' ' + gift.token;
                document.getElementById('success-modal').classList.add('visible');
                
                renderPlaza();
            } catch (error) {
                hideLoading();
                document.querySelector('.controls').style.display = '';
                console.error('Claim error:', error);
                alert('Failed to claim: ' + (error.reason || error.message));
            }
        }

        function startSnowfall() {
            const container = document.getElementById('snowfall-container');
            if (!container) return;
            
            // Generate snowflakes
            let snowflakes = '';
            const symbols = ['‚ùÑ', '‚ùÖ', '‚ùÜ', '‚úª', '‚úº', '‚Ä¢'];
            for (let i = 0; i < 50; i++) {
                const left = Math.random() * 100;
                const delay = Math.random() * 10;
                const duration = 8 + Math.random() * 12;
                const size = 10 + Math.random() * 16;
                const symbol = symbols[Math.floor(Math.random() * symbols.length)];
                snowflakes += `<span class="snow" style="left:${left}%; animation-delay:${delay}s; animation-duration:${duration}s; font-size:${size}px;">${symbol}</span>`;
            }
            
            container.innerHTML = snowflakes;
            container.classList.add('active');
        }
        
        function stopSnowfall() {
            const container = document.getElementById('snowfall-container');
            if (container) {
                container.classList.remove('active');
                container.innerHTML = '';
            }
        }
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            // Hide unused form fields
            const recipientGroup = document.getElementById('recipient-group');
            const passwordGroup = document.getElementById('password-group');
            const modeToggle = document.querySelector('.mode-toggle');
            const modeHint = document.getElementById('mode-hint');
            if (recipientGroup) recipientGroup.style.display = 'none';
            if (passwordGroup) passwordGroup.style.display = 'none';
            if (modeToggle) modeToggle.style.display = 'none';
            if (modeHint) modeHint.textContent = 'Gift will appear in the plaza for anyone to claim';

            // Show shares and distribution
            document.getElementById('shares-group').style.display = 'block';
            document.getElementById('distribution-group').style.display = 'block';

            // Try to get Farcaster user
            import('https://esm.sh/@farcaster/miniapp-sdk').then(async ({ sdk }) => {
                try {
                    const context = await sdk.context;
                    if (context?.user) {
                        currentUser = context.user;
                        console.log('Farcaster user:', currentUser.username);
                    }
                } catch (e) { console.log('Not in Farcaster frame'); }
            }).catch(() => {});

            // Clear old demo data and load fresh
            const stored = localStorage.getItem('plaza_gifts');
            if (stored) {
                const parsed = JSON.parse(stored);
                // Filter out demo/test data
                plazaGifts = parsed.filter(g => !g.id.startsWith('demo') && !g.id.startsWith('test'));
                localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));
            }
            
            // Check if user has gifts
            checkMyGifts();
            
            // Check URL for gift parameter
            const urlParams = new URLSearchParams(window.location.search);
            const giftId = urlParams.get('gift');
            if (giftId) {
                setTimeout(() => {
                    const gift = plazaGifts.find(g => g.id === giftId);
                    if (gift && gift.mode === 'direct') {
                        showGreetingCard(gift);
                    } else if (gift) {
                        openClaimModal(giftId);
                    }
                }, 500);
            }
        });
    </script>
</body>
</html>