<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Christmas Tree | The Gilded Emerald</title>
    
    <!-- Open Graph -->
    <meta property="og:title" content="Christmas Tree">
    <meta property="og:description" content="Interactive 3D Christmas Tree with Music">
    <meta property="og:image" content="https://0xpanty.github.io/XmasTree/preview.svg">
    
    <!-- Farcaster Mini App -->
    <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://0xpanty.github.io/XmasTree/preview.svg","button":{"title":"üéÑ Open Tree","action":{"type":"launch_frame","name":"Christmas Tree","url":"https://0xpanty.github.io/XmasTree/","splashImageUrl":"https://0xpanty.github.io/XmasTree/icon.svg","splashBackgroundColor":"#001a10"}}}' />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;1,400&display=swap');

        :root {
            --emerald-dark: #001a10;
            --emerald: #023020;
            --gold: #D4AF37;
            --gold-light: #F7E7CE;
            --glass: rgba(20, 20, 20, 0.4);
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            font-family: 'Playfair Display', serif;
            color: var(--gold-light);
            overscroll-behavior: none;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* UI Overlay */
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 40px;
            box-sizing: border-box;
            background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.8) 100%);
            transition: background 1s ease;
        }

        .ui-hidden {
            opacity: 0 !important;
            pointer-events: none;
            transform: translateY(-20px);
        }
        
        .immersive-mode {
            background: transparent !important;
        }

        header {
            text-align: center;
            margin-top: 20px;
            pointer-events: auto;
            transition: all 1.2s cubic-bezier(0.19, 1, 0.22, 1);
        }

        h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: var(--gold);
            margin: 0;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
            opacity: 0;
            animation: fadeDown 1.5s ease-out forwards 0.5s;
        }

        .subtitle {
            font-size: 0.9rem;
            letter-spacing: 0.2em;
            color: rgba(255,255,255,0.6);
            margin-top: 10px;
            text-transform: uppercase;
            opacity: 0;
            animation: fadeDown 1.5s ease-out forwards 0.8s;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 20px;
            pointer-events: auto;
            opacity: 0;
            animation: fadeUp 1.5s ease-out forwards 1.2s;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-group {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: all 1s ease;
        }
        
        .btn-small {
            padding: 8px 16px !important;
            font-size: 0.85rem !important;
            min-width: auto !important;
        }

        button, .file-btn {
            background: var(--glass);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 15px 40px;
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            white-space: nowrap;
            touch-action: manipulation; 
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.4), transparent);
            transition: 0.5s;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            background: rgba(212, 175, 55, 0.2);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.3);
            transform: translateY(-2px);
        }

        button.active {
            background: var(--gold);
            color: var(--emerald-dark);
            box-shadow: 0 0 40px rgba(212, 175, 55, 0.6);
        }

        input[type="file"] {
            display: none;
        }

        /* --- Modal Styles --- */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .custom-modal.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-box {
            background: rgba(2, 48, 32, 0.95);
            border: 1px solid var(--gold);
            padding: 40px 60px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: 0 0 60px rgba(212, 175, 55, 0.2);
            transform: translateY(20px);
            transition: transform 0.5s ease;
            text-align: center;
            max-width: 90%;
            box-sizing: border-box;
        }

        .custom-modal.visible .modal-box {
            transform: translateY(0);
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .modal-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(212, 175, 55, 0.5);
            color: var(--gold-light);
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            padding: 10px;
            width: 300px;
            max-width: 100%;
            text-align: center;
            outline: none;
            transition: border-color 0.3s;
        }

        .modal-input:focus {
            border-bottom-color: var(--gold);
        }

        .modal-actions {
            margin-top: 20px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--gold);
            font-family: 'Cinzel', serif;
            letter-spacing: 0.2em;
            font-size: 0.8rem;
            animation: pulse 2s infinite;
            text-align: center;
            width: 100%;
        }

        @keyframes fadeDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

        /* --- Gift System Styles --- */
        .gift-form { display: flex; flex-direction: column; gap: 12px; }
        .form-group { text-align: left; }
        .form-group label { display: block; color: var(--gold); font-size: 0.75rem; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.1em; }
        .form-group input, .form-group select { width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.3); color: var(--gold-light); font-family: inherit; font-size: 0.9rem; box-sizing: border-box; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--gold); }
        .form-row { display: flex; gap: 10px; }
        .form-row .form-group { flex: 1; }
        .mode-toggle { display: flex; gap: 8px; margin-bottom: 12px; }
        .mode-btn { flex: 1; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.3); color: var(--gold); cursor: pointer; font-size: 0.75rem; transition: all 0.3s; }
        .mode-btn.active { background: var(--gold); color: var(--emerald-dark); }
        .type-toggle { display: flex; gap: 8px; }
        .type-btn { flex: 1; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.3); color: var(--gold); cursor: pointer; font-size: 0.7rem; }
        .type-btn.active { background: rgba(212,175,55,0.3); border-color: var(--gold); }
        .btn-gift { width: 100%; padding: 12px; background: linear-gradient(135deg, #D4AF37, #B8960C); border: none; color: var(--emerald-dark); font-family: 'Cinzel', serif; font-size: 0.85rem; cursor: pointer; margin-top: 8px; }
        .gift-preview { background: rgba(0,0,0,0.3); padding: 12px; margin-top: 8px; text-align: center; border: 1px dashed rgba(212,175,55,0.3); }
        .preview-amount { font-size: 1.3rem; color: var(--gold); font-weight: bold; }
        .preview-info { font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 4px; }
        .mode-hint { font-size: 0.7rem; color: rgba(255,255,255,0.4); text-align: center; margin-bottom: 8px; }
        .user-search-results { position: absolute; top: 100%; left: 0; right: 0; background: rgba(2,48,32,0.98); border: 1px solid var(--gold); max-height: 150px; overflow-y: auto; z-index: 10; }
        .user-result { display: flex; align-items: center; gap: 10px; padding: 8px 12px; cursor: pointer; transition: background 0.2s; }
        .user-result:hover { background: rgba(212,175,55,0.2); }
        .user-result img { width: 32px; height: 32px; border-radius: 50%; }
        .user-result .info { text-align: left; }
        .user-result .name { color: var(--gold); font-size: 0.85rem; }
        .user-result .username { color: rgba(255,255,255,0.5); font-size: 0.75rem; }
        .selected-user-card { display: flex; align-items: center; gap: 8px; background: rgba(212,175,55,0.1); border: 1px solid rgba(212,175,55,0.3); padding: 8px 12px; margin-top: 8px; }
        .selected-user-card img { width: 24px; height: 24px; border-radius: 50%; }
        .selected-user-card .remove-btn { margin-left: auto; background: none; border: none; color: #ff6b6b; cursor: pointer; font-size: 1.2rem; padding: 0 4px; }
        .claim-info { text-align: center; margin-bottom: 16px; }
        .claim-message { font-size: 1.1rem; color: var(--gold-light); margin-bottom: 8px; }
        .claim-amount { font-size: 1.5rem; color: var(--gold); font-weight: bold; }
        .claim-shares { font-size: 0.8rem; color: rgba(255,255,255,0.5); }

        /* --- Gift Plaza Styles --- */
        #gift-plaza {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 5;
            perspective: 800px;
        }
        .plaza-gift {
            position: absolute;
            width: clamp(24px, 3vw, 40px);
            height: clamp(24px, 3vw, 40px);
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            animation: orbit3d var(--orbit-duration, 15s) linear infinite;
            animation-delay: var(--orbit-delay, 0s);
            transform-style: preserve-3d;
        }
        .plaza-gift:hover {
            z-index: 100;
        }
        .plaza-gift:hover img {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(212,175,55,1);
        }
        .plaza-gift img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--gold);
            box-shadow: 0 0 10px rgba(212,175,55,0.8);
            transition: all 0.3s;
        }
        .plaza-gift .santa-emoji {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: clamp(10px, 1.5vw, 14px);
        }
        @keyframes orbit3d {
            0% { transform: rotateY(0deg) translateX(var(--orbit-radius, 180px)) rotateY(0deg); opacity: 1; z-index: 10; }
            25% { transform: rotateY(-90deg) translateX(var(--orbit-radius, 180px)) rotateY(90deg); opacity: 1; z-index: 10; }
            50% { transform: rotateY(-180deg) translateX(var(--orbit-radius, 180px)) rotateY(180deg); opacity: 0.3; z-index: 1; }
            75% { transform: rotateY(-270deg) translateX(var(--orbit-radius, 180px)) rotateY(270deg); opacity: 1; z-index: 10; }
            100% { transform: rotateY(-360deg) translateX(var(--orbit-radius, 180px)) rotateY(360deg); opacity: 1; z-index: 10; }
        }
        
        /* Fancy Banner - Romantic Style */
        #banner-container {
            position: absolute;
            top: 12%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            text-align: center;
            display: none;
            pointer-events: none;
        }
        #banner-container.active { display: block; }
        .fancy-banner {
            position: relative;
        }
        .banner-text {
            font-size: clamp(36px, 8vw, 90px);
            font-weight: bold;
            font-family: 'Brush Script MT', 'Segoe Script', cursive;
            color: #fff;
            text-shadow: 
                0 0 10px rgba(255,255,255,0.8),
                0 0 20px rgba(255,255,255,0.6),
                0 0 40px rgba(255,255,255,0.4),
                0 0 80px rgba(200,220,255,0.3),
                2px 2px 4px rgba(0,0,0,0.3);
            animation: textGlow 3s ease-in-out infinite;
            letter-spacing: 2px;
            line-height: 1.2;
            max-width: 80vw;
        }
        .banner-text.two-lines {
            font-size: clamp(32px, 7vw, 80px);
        }
        @keyframes textGlow {
            0%, 100% { 
                text-shadow: 
                    0 0 10px rgba(255,255,255,0.8),
                    0 0 20px rgba(255,255,255,0.6),
                    0 0 40px rgba(255,255,255,0.4),
                    0 0 80px rgba(200,220,255,0.3),
                    2px 2px 4px rgba(0,0,0,0.3);
            }
            50% { 
                text-shadow: 
                    0 0 20px rgba(255,255,255,1),
                    0 0 40px rgba(255,255,255,0.8),
                    0 0 60px rgba(255,255,255,0.6),
                    0 0 100px rgba(200,220,255,0.5),
                    2px 2px 4px rgba(0,0,0,0.3);
            }
        }
        .banner-sender {
            font-size: clamp(14px, 2.5vw, 22px);
            color: rgba(255,255,255,0.7);
            margin-top: 12px;
            font-style: italic;
            font-family: 'Georgia', serif;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        /* Plaza mode - smaller title */
        .title.plaza-mode {
            font-size: clamp(20px, 4vw, 36px) !important;
            margin-top: 2% !important;
        }
        .subtitle.plaza-mode {
            font-size: clamp(8px, 1.2vw, 12px) !important;
        }
        
        /* Full screen snowfall */
        #snowfall-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 99;
            overflow: hidden;
            display: none;
        }
        #snowfall-container.active { display: block; }
        .snow {
            position: absolute;
            top: -50px;
            color: #fff;
            opacity: 0.9;
            animation: snowFalling linear infinite;
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
        }
        @keyframes snowFalling {
            0% { transform: translateY(-50px) rotate(0deg); opacity: 0.9; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0.3; }
        }
        
        /* Shooting star */
        .shooting-star {
            position: fixed;
            width: 4px;
            height: 4px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 6px 2px rgba(255,255,255,0.8), 0 0 12px 4px rgba(212,175,55,0.5);
            animation: shootingStar 1.5s linear forwards;
            pointer-events: none;
            z-index: 50;
        }
        .shooting-star::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 100%;
            width: 80px;
            height: 2px;
            background: linear-gradient(to left, rgba(255,255,255,0.8), transparent);
            transform: translateY(-50%);
        }
        @keyframes shootingStar {
            0% { 
                opacity: 1;
                transform: translate(0, 0) rotate(-35deg);
            }
            100% { 
                opacity: 0;
                transform: translate(-100vw, 70vh) rotate(-35deg);
            }
        }
        .requirement-row { display: flex; align-items: center; gap: 8px; padding: 8px 0; }
        .requirement-row label { flex: 1; color: rgba(255,255,255,0.7); font-size: 0.8rem; }
        .requirement-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--gold); }
        .requirement-row input[type="number"] { width: 60px; padding: 4px 8px; }
        
        /* Greeting Card Styles */
        .greeting-card {
            position: relative;
            background: linear-gradient(135deg, #1a472a 0%, #0d2818 50%, #1a472a 100%);
            border: 3px solid var(--gold);
            border-radius: 16px;
            padding: 32px 24px;
            max-width: 340px;
            text-align: center;
            box-shadow: 0 0 40px rgba(212,175,55,0.3), inset 0 0 60px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: cardAppear 0.5s ease-out;
        }
        @keyframes cardAppear { from { transform: scale(0.8) rotateY(-20deg); opacity: 0; } to { transform: scale(1) rotateY(0); opacity: 1; } }
        .card-sparkles {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.8), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(212,175,55,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.6), transparent),
                radial-gradient(2px 2px at 130px 80px, rgba(212,175,55,0.6), transparent),
                radial-gradient(2px 2px at 200px 50px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 250px 90px, rgba(212,175,55,0.6), transparent);
            animation: sparkle 2s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes sparkle { 0%,100% { opacity: 0.5; } 50% { opacity: 1; } }
        .card-header { margin-bottom: 16px; }
        .card-avatar {
            width: 64px; height: 64px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            margin-bottom: 8px;
            box-shadow: 0 0 15px rgba(212,175,55,0.5);
        }
        .card-from { color: rgba(255,255,255,0.7); font-size: 0.9rem; }
        .card-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(212,175,55,0.5);
            margin: 16px 0;
        }
        .card-message {
            color: #fff;
            font-size: 1rem;
            line-height: 1.6;
            padding: 16px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            border-left: 3px solid var(--gold);
            margin: 16px 0;
            font-style: italic;
        }
        .card-gift {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 16px;
        }
        .card-gift-icon {
            font-size: 2.5rem;
            animation: bounce 1s ease-in-out infinite;
        }
        @keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .card-amount {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--gold);
        }
        
        /* Tip amount buttons */
        .tip-amt-btn {
            flex: 1;
            padding: 8px;
            background: rgba(212,175,55,0.2);
            border: 1px solid var(--gold);
            color: var(--gold);
            cursor: pointer;
            transition: all 0.2s;
        }
        .tip-amt-btn:hover { background: rgba(212,175,55,0.4); }
        
        /* Mailbox button */
        .mailbox-btn {
            font-size: 1.8rem !important;
            padding: 8px 16px !important;
            background: rgba(212,175,55,0.1) !important;
        }
        .mailbox-btn.has-gift {
            animation: mailGlow 1.5s ease-in-out infinite;
        }
        @keyframes mailGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(212,175,55,0.5), 0 0 20px rgba(212,175,55,0.3); }
            50% { box-shadow: 0 0 20px rgba(212,175,55,0.8), 0 0 40px rgba(212,175,55,0.5), 0 0 60px rgba(212,175,55,0.3); }
        }
        
        

        /* --- MOBILE RESPONSIVE STYLES --- */
        @media (max-width: 768px) {
            #ui {
                padding: 20px;
                padding-bottom: 30px; 
            }

            h1 {
                font-size: 1.8rem;
                letter-spacing: 0.15em;
            }

            .subtitle {
                font-size: 0.75rem;
            }

            .controls {
                flex-direction: column;
                width: 100%;
                gap: 12px;
                align-items: stretch;
                padding-bottom: 20px;
            }

            .btn-group {
                width: 100%;
            }

            button {
                width: 100%;
                padding: 12px 0;
                font-size: 0.9rem;
            }

            .modal-box {
                padding: 30px 20px;
                width: 90%;
            }
            
            .modal-input {
                width: 100%;
                font-size: 1rem;
            }
        }
    </style>
    <!-- React & Three Imports -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
                "three": "https://esm.sh/three@0.160.0",
                "@react-three/fiber": "https://esm.sh/@react-three/fiber@8.15.12?external=react,react-dom,three",
                "@react-three/drei": "https://esm.sh/@react-three/drei@9.96.1?external=react,react-dom,three,@react-three/fiber",
                "@react-three/postprocessing": "https://esm.sh/@react-three/postprocessing@2.16.0?external=react,react-dom,three,@react-three/fiber",
                "uuid": "https://esm.sh/uuid@9.0.1"
            }
        }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <!-- Create Gift Modal -->
    <div id="gift-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 400px;">
            <div class="modal-title">üéÅ Send Christmas Gift</div>
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="selectGiftMode('direct')">üéØ Direct Gift</button>
                <button class="mode-btn" onclick="selectGiftMode('redpacket')">üßß Red Packet</button>
            </div>
            <div class="mode-hint" id="mode-hint">Send directly to specific Farcaster user(s)</div>
            <div class="gift-form">
                <div class="form-group">
                    <label>Gift Title</label>
                    <input type="text" id="gift-title" placeholder="Merry Christmas!" maxlength="50">
                </div>
                <div class="form-group" id="recipient-group" style="position:relative;">
                    <label>Recipient (max 10)</label>
                    <input type="text" id="gift-recipient" placeholder="Search Farcaster username..." oninput="searchUsers(this.value)">
                    <div id="user-results" class="user-search-results" style="display:none;"></div>
                    <div id="selected-user"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Token</label>
                        <select id="gift-token" onchange="togglePlazaCustomToken()">
                            <option value="USDC">USDC</option>
                            <option value="ETH">ETH</option>
                            <option value="CUSTOM">Custom Token</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="gift-amount" value="0.1" step="0.01" min="0.1" oninput="validatePlazaAmount(); updatePreview()">
                    </div>
                </div>
                <div class="form-group" id="plaza-custom-token-group" style="display:none;">
                    <label>Token Contract Address (Base)</label>
                    <input type="text" id="plaza-token-ca" placeholder="0x..." style="font-size:0.8rem;">
                </div>
                <div class="form-group" id="shares-group" style="display:none;">
                    <label>Number of Shares</label>
                    <input type="number" id="gift-shares" value="5" min="1" max="100" oninput="updatePreview()">
                </div>
                <div class="form-group" id="distribution-group" style="display:none;">
                    <label>Distribution Type</label>
                    <div class="type-toggle">
                        <button type="button" class="type-btn active" onclick="selectGiftType('equal')">Equal Split</button>
                        <button type="button" class="type-btn" onclick="selectGiftType('lucky')">Lucky Draw</button>
                    </div>
                </div>
                <div class="form-group" id="requirements-group">
                    <label>Claim Requirements</label>
                    <div class="requirement-row">
                        <label>Require Code</label>
                        <input type="checkbox" id="require-code" onchange="toggleCodeInput(); updatePreview();">
                    </div>
                    <div class="requirement-row" id="code-input-row" style="display:none;">
                        <label>Secret Code</label>
                        <input type="text" id="gift-code" placeholder="e.g. XMAS2024" maxlength="20" style="width:100px;">
                    </div>
                    <div class="requirement-row">
                        <label>Require Farcaster Pro</label>
                        <input type="checkbox" id="require-pro" onchange="updatePreview()">
                    </div>
                    <div class="requirement-row">
                        <label>Min Neynar Score</label>
                        <input type="number" id="min-score" placeholder="0" min="0" max="1" step="0.01" value="0" oninput="updatePreview()">
                    </div>
                </div>
                <div class="gift-preview">
                    <div class="preview-amount" id="preview-amount">0 ETH</div>
                    <div class="preview-info" id="preview-info">Select recipient(s) above</div>
                </div>
                <button class="btn-gift" onclick="createGift()">Create Gift</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeGiftModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Claim Gift Modal -->
    <div id="claim-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 350px;">
            <div class="modal-title">üéÅ Christmas Gift!</div>
            <div class="claim-info">
                <div class="claim-message" id="claim-message">Someone sent you a gift!</div>
                <div id="claim-recipient" style="margin-bottom:8px;"></div>
                <div class="claim-amount">üí∞ <span id="claim-remaining">0</span></div>
                <div class="claim-shares">Claimed: <span id="claim-shares">0/0</span></div>
            </div>
            <div class="gift-form">
                <div class="form-group">
                    <label>Enter Password</label>
                    <input type="text" id="claim-password" placeholder="Enter claim code">
                </div>
                <button class="btn-gift" onclick="claimGift()">Claim Gift</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeClaimModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Greeting Card Modal -->
    <div id="card-modal" class="custom-modal">
        <div class="greeting-card">
            <div class="card-sparkles"></div>
            <div class="card-header">
                <img id="card-sender-pfp" src="" class="card-avatar">
                <div class="card-from">From @<span id="card-sender-name">sender</span></div>
            </div>
            <div class="card-title" id="card-title">Merry Christmas!</div>
            <div class="card-message" id="card-message">Wishing you joy and happiness!</div>
            <div class="card-gift">
                <div class="card-gift-icon">üéÅ</div>
                <div class="card-amount" id="card-amount">0.01 ETH</div>
            </div>
            <button class="btn-gift" onclick="claimCardGift()" style="margin-top:16px;">Open Gift</button>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="custom-modal" style="background: rgba(0,0,0,0.3); backdrop-filter: none;">
        <div class="modal-box" style="max-width: 300px; text-align: center; background: rgba(0,0,0,0.7); border-color: var(--gold);">
            <div style="font-size: 3rem;">üéâ</div>
            <div class="modal-title">Gift Claimed!</div>
            <div style="color: var(--gold); font-size: 1.5rem; margin: 16px 0;" id="success-amount">0.01 ETH</div>
            <button class="btn-gift" onclick="closeSuccessModal()">Awesome!</button>
        </div>
        <button onclick="goHome()" style="position:fixed; bottom:40px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.6); border:2px solid var(--gold); color:var(--gold); width:60px; height:60px; border-radius:50%; font-size:2rem; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow: 0 0 20px rgba(212,175,55,0.3);">‚Ü©</button>
    </div>
    
    <!-- My Gifts Record Modal -->
    <div id="record-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 400px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-title">üìã My Gifts Record</div>
            <div id="record-list" style="margin-top:12px;"></div>
            <button class="btn-cancel" onclick="closeRecordModal()" style="margin-top:12px;">Close</button>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 250px; text-align: center;">
            <div style="font-size: 2rem; animation: pulse 1s infinite;">‚è≥</div>
            <div id="loading-text" style="color: var(--gold-light); margin-top: 12px;">Processing...</div>
        </div>
    </div>

    <!-- Banner Modal -->
    <div id="banner-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 380px;">
            <div class="modal-title">üîî Blessing Banner</div>
            <div style="color:rgba(255,255,255,0.6); font-size:0.8rem; margin-bottom:12px; text-align:center;">
                Your message will shine above the tree!
            </div>
            <div id="current-banner-info" style="display:none; background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; margin-bottom:12px; text-align:center;">
                <div style="color:rgba(255,255,255,0.5); font-size:0.75rem;">Current Banner Ends In</div>
                <div id="banner-countdown" style="color:var(--gold); font-size:1.2rem; font-weight:bold;">--:--:--</div>
            </div>
            <div class="form-group">
                <label>Your Blessing</label>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="banner-message" placeholder="Merry Christmas!üîî" maxlength="20" style="flex:1;">
                    <button type="button" onclick="toggleEmojiPicker()" style="padding:8px 12px; font-size:1.2rem;">üéÑ</button>
                </div>
                <div id="emoji-picker" style="display:none; flex-wrap:wrap; gap:8px; margin-top:8px; padding:8px; background:rgba(0,0,0,0.3); border-radius:8px;">
                    <span onclick="addEmoji('üéÑ')" style="cursor:pointer; font-size:1.5rem;">üéÑ</span>
                    <span onclick="addEmoji('üéÖ')" style="cursor:pointer; font-size:1.5rem;">üéÖ</span>
                    <span onclick="addEmoji('ü§∂')" style="cursor:pointer; font-size:1.5rem;">ü§∂</span>
                    <span onclick="addEmoji('ü¶å')" style="cursor:pointer; font-size:1.5rem;">ü¶å</span>
                    <span onclick="addEmoji('‚õÑ')" style="cursor:pointer; font-size:1.5rem;">‚õÑ</span>
                    <span onclick="addEmoji('‚ùÑÔ∏è')" style="cursor:pointer; font-size:1.5rem;">‚ùÑÔ∏è</span>
                    <span onclick="addEmoji('üéÅ')" style="cursor:pointer; font-size:1.5rem;">üéÅ</span>
                    <span onclick="addEmoji('üîî')" style="cursor:pointer; font-size:1.5rem;">üîî</span>
                    <span onclick="addEmoji('‚≠ê')" style="cursor:pointer; font-size:1.5rem;">‚≠ê</span>
                    <span onclick="addEmoji('‚ú®')" style="cursor:pointer; font-size:1.5rem;">‚ú®</span>
                    <span onclick="addEmoji('üéâ')" style="cursor:pointer; font-size:1.5rem;">üéâ</span>
                    <span onclick="addEmoji('üç™')" style="cursor:pointer; font-size:1.5rem;">üç™</span>
                </div>
                <div style="font-size:0.7rem; color:rgba(255,255,255,0.4); margin-top:4px;">Max 20 characters</div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Hours</label>
                    <input type="number" id="banner-hours" value="1" min="1" max="72" oninput="updateBannerTotal()">
                </div>
                <div class="form-group">
                    <label>Total (USDC)</label>
                    <input type="number" id="banner-price" value="1" readonly style="background:rgba(0,0,0,0.3);">
                </div>
            </div>
            <div style="font-size:0.75rem; color:rgba(255,255,255,0.5); margin-bottom:12px; text-align:center;">
                üí° 1 Hour = 1 USDC (Max 72 hours)
            </div>
            <button class="btn-gift" onclick="createBanner()">‚ú® Create Banner</button>
            <button class="btn-cancel" onclick="closeBannerModal()">Cancel</button>
        </div>
    </div>

    <!-- Tip Author Modal -->
    <div id="tip-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 340px;">
            <div class="modal-title">‚òï Tip the Author</div>
            <div style="text-align:center; margin-bottom:16px;">
                <img id="author-avatar" src="" style="width:64px; height:64px; border-radius:50%; border:2px solid var(--gold); margin-bottom:8px;">
                <div style="color:var(--gold); font-size:1rem; margin-bottom:4px;">@<span id="author-name">xqc</span></div>
                <div style="color:rgba(255,255,255,0.7); font-size:0.85rem;">Support the creator of this Christmas Tree!</div>
            </div>
            <div class="gift-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Token</label>
                        <input type="text" value="USDC" disabled style="opacity:0.8; background:rgba(0,0,0,0.3); border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; width:100%; text-align:center;">
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="tip-amount" value="1" min="0.1" step="0.1">
                    </div>
                </div>
                <div id="tip-amounts" style="display:flex; gap:8px; margin-bottom:12px;"></div>
                <button class="btn-gift" onclick="sendTip()">Send Tip ‚ù§Ô∏è</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeTipModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Direct Gift Modal (Send to Friends) -->
    <div id="direct-gift-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 400px;">
            <div class="modal-title">üéÅ Send to Friends</div>
            <div class="mode-hint">Search and select up to 10 Farcaster users</div>
            <div class="gift-form">
                <div class="form-group">
                    <label>Gift Title</label>
                    <input type="text" id="direct-gift-title" placeholder="Merry Christmas!" maxlength="50">
                </div>
                <div class="form-group">
                    <label>Message</label>
                    <textarea id="direct-gift-message" placeholder="Write your heartfelt message here..." maxlength="200" style="width:100%; height:60px; resize:none; background:rgba(0,0,0,0.3); border:1px solid rgba(212,175,55,0.3); color:#fff; padding:8px; font-family:inherit;"></textarea>
                </div>
                <div class="form-group" style="position:relative;">
                    <label>Recipients (max 10)</label>
                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                        <input type="text" id="user-search" placeholder="Search Farcaster username..." oninput="searchUsers(this.value)" style="flex:1;">
                        <button type="button" onclick="fetchTopFriends()" style="padding:8px 12px; background:rgba(212,175,55,0.2); border:1px solid var(--gold); color:var(--gold); cursor:pointer; white-space:nowrap; font-size:0.8rem;">üë• Friends</button>
                    </div>
                    <div id="user-results" class="user-search-results" style="display:none;"></div>
                    <div id="selected-users"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Token</label>
                        <select id="direct-gift-token" onchange="toggleCustomToken()">
                            <option value="ETH">ETH</option>
                            <option value="USDC">USDC</option>
                            <option value="CUSTOM">Custom Token</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount Each</label>
                        <input type="number" id="direct-gift-amount" value="0.5" step="0.1" min="0.1" oninput="validateDirectAmount(); updateDirectPreview()">
                    </div>
                </div>
                <div class="form-group" id="custom-token-group" style="display:none;">
                    <label>Token Contract Address (Base)</label>
                    <input type="text" id="custom-token-ca" placeholder="0x..." style="font-size:0.8rem;">
                </div>
                <div class="gift-preview">
                    <div class="preview-amount" id="direct-preview-amount">0 ETH</div>
                    <div class="preview-info" id="direct-preview-info">Select recipient(s) above</div>
                </div>
                <button class="btn-gift" onclick="createDirectGift()">Send Gift</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeDirectGiftModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Claim Input Modal -->
    <div id="claim-input-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 350px;">
            <div class="modal-title">üéÅ Claim Gift</div>
            <div class="gift-form">
                <div class="form-group">
                    <label>Enter Gift Code</label>
                    <input type="text" id="gift-code-input" placeholder="Paste gift link or code...">
                </div>
                <button class="btn-gift" onclick="claimByCode()">Claim</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeClaimInput()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="ui">
        <header id="main-header">
            <!-- TITLE UPDATED -->
            <h1 id="app-title">Christmas Tree</h1>
            <div id="app-subtitle" class="subtitle">The Gilded Emerald Edition</div>
        </header>
        <div class="controls">
            <!-- Top row: Mailbox + Record + Tip -->
            <div class="btn-row" id="top-btns">
                <button id="mailbox-button" onclick="openMyGifts()" class="mailbox-btn btn-small" style="display:flex; align-items:center; justify-content:center;">üì¨</button>
                <button onclick="openRecordModal()" class="btn-small">üìã</button>
                <button onclick="openTipModal()" class="btn-small">‚òï</button>
            </div>
            <!-- Plaza mode buttons -->
            <div class="btn-row" id="plaza-send-btn" style="display:none;">
                <button onclick="openGiftModal()" class="btn-small">üéÅ Gift</button>
                <button onclick="openBannerModal()" class="btn-small">üîî Banner</button>
            </div>
            <!-- Bottom rows: Send + Plaza -->
            <div class="btn-row" id="main-btns">
                <button onclick="openDirectGiftModal()" class="btn-small">üéÅ Send to Friends</button>
            </div>
            <div class="btn-row">
                <button id="plaza-btn" onclick="togglePlazaMode()" class="btn-small">üéÑ Plaza Gift</button>
            </div>
        </div>
        
        <!-- Gift Plaza - Orbiting Avatars (hidden by default) -->
        <div id="gift-plaza" style="display:none;"></div>
        <div id="banner-container"></div>
        <div id="snowfall-container"></div>
    </div>
    
    <div id="canvas-container">
        <div class="loading">Initializing Luxury Asset Pipeline...</div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useMemo, useEffect, Suspense } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as THREE from 'three';
        import { Canvas, useFrame, useThree, extend } from '@react-three/fiber';
        import { OrbitControls, Environment, Float, Sparkles, PerspectiveCamera, Stars } from '@react-three/drei';
        import { EffectComposer, Bloom, Vignette, Noise, ToneMapping } from '@react-three/postprocessing';

        // --- Audio Infrastructure ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 256; 
        const dataArray = new Uint8Array(analyser.frequencyBinCount); // 128 bins
        
        let activeSourceNode = null; 
        
        const defaultAudioEl = new Audio('https://cdn.pixabay.com/audio/2025/05/26/audio_95504c3693.mp3');
        defaultAudioEl.crossOrigin = "anonymous";
        defaultAudioEl.loop = true;
        
        let defaultMediaElementSource = null;

        const useAudioData = () => {
            const frequency = useRef(0);
            useFrame(() => {
                analyser.getByteFrequencyData(dataArray);
                const avg = dataArray.reduce((a, b) => a + b) / dataArray.length;
                frequency.current = avg; 
            });
            return frequency;
        };

        // --- Custom Shaders ---

        const foliageVertexShader = `
            uniform float uTime;
            uniform float uProgress; // 0 = Scattered, 1 = Tree
            uniform float uAudio;
            attribute vec3 aScatterPos;
            attribute vec3 aTreePos;
            attribute float aRandom;
            varying float vVisible;
            varying vec2 vUv;
            varying float vRandom;
            varying float vHeight;
            void main() {
                vUv = uv;
                vRandom = aRandom;
                vec3 finalPos = mix(aScatterPos, aTreePos, uProgress);
                float breathe = sin(uTime * 2.0 + aRandom * 10.0) * 0.05;
                float beat = uAudio * 0.02 * uProgress; 
                finalPos += normal * (breathe + beat);
                if(uProgress < 0.5) {
                    finalPos.y += sin(uTime + aScatterPos.x) * 0.2 * (1.0 - uProgress);
                }
                vHeight = finalPos.y; 
                vec4 mvPosition = modelViewMatrix * vec4(finalPos, 1.0);
                gl_PointSize = (4.0 * (1.0 + uAudio * 0.1)) * (20.0 / -mvPosition.z);
                gl_Position = projectionMatrix * mvPosition;
            }
        `;

        const foliageFragmentShader = `
            uniform float uTime;
            uniform float uAudio; 
            varying float vRandom;
            varying float vHeight;
            varying vec2 vUv;
            void main() {
                vec2 center = gl_PointCoord - 0.5;
                float dist = length(center);
                if (dist > 0.5) discard;
                vec3 emerald = vec3(0.0, 0.25, 0.18);   
                vec3 ruby = vec3(0.3, 0.02, 0.05);      
                vec3 gold = vec3(1.0, 0.9, 0.4);        
                float timeCycle = sin(uTime * 0.4) * 0.5 + 0.5; 
                vec3 baseTone = mix(emerald, ruby, timeCycle * 0.2); 
                float heightFactor = smoothstep(-5.0, 8.0, vHeight);
                vec3 gradientBase = mix(baseTone * 0.5, baseTone * 1.8, heightFactor);
                float beatStrength = smoothstep(0.4, 0.9, uAudio); 
                vec3 rhythmicColor = mix(gradientBase, gold, beatStrength * 0.4);
                float sparkle = sin(uTime * 3.0 + vRandom * 100.0);
                float isTip = step(0.96, sin(vRandom * 30.0 + uTime + uAudio * 5.0)); 
                vec3 finalColor = mix(rhythmicColor, gold * 2.5, isTip * (sparkle * 0.5 + 0.5 + beatStrength));
                float alpha = 1.0 - smoothstep(0.4, 0.5, dist);
                gl_FragColor = vec4(finalColor, alpha * 0.9);
            }
        `;

        // --- Utils: Gift Texture Generator ---
        function createGiftTexture(type) {
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            
            if (type === 0) { // Red + Gold Ribbon
                ctx.fillStyle = '#8B0000'; ctx.fillRect(0,0,256,256);
                ctx.fillStyle = '#FFD700'; 
                ctx.fillRect(118, 0, 20, 256); // Vert
                ctx.fillRect(0, 118, 256, 20); // Horiz
            } else if (type === 1) { // Green + Gold Stripes
                ctx.fillStyle = '#023020'; ctx.fillRect(0,0,256,256);
                ctx.fillStyle = '#D4AF37';
                ctx.lineWidth = 15;
                for(let i=-256; i<512; i+=40) {
                    ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i+256, 256); ctx.stroke();
                }
            } else if (type === 2) { // Navy + Silver Dots
                ctx.fillStyle = '#000080'; ctx.fillRect(0,0,256,256);
                ctx.fillStyle = '#C0C0C0';
                for(let x=0; x<256; x+=40) {
                    for(let y=0; y<256; y+=40) {
                        ctx.beginPath(); ctx.arc(x, y, 6, 0, Math.PI*2); ctx.fill();
                    }
                }
            } else { // Gold + Red Ribbon
                ctx.fillStyle = '#D4AF37'; ctx.fillRect(0,0,256,256);
                ctx.fillStyle = '#8B0000';
                ctx.fillRect(118, 0, 20, 256);
                ctx.fillRect(0, 118, 256, 20);
            }
            
            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = THREE.RepeatWrapping;
            tex.wrapT = THREE.RepeatWrapping;
            return tex;
        }

        // --- Components ---

        const AudioSpectrumRing = ({ isTree }) => {
            const meshRef = useRef();
            const count = 128; 
            const dummy = useMemo(() => new THREE.Object3D(), []);
            const [color] = useState(() => new THREE.Color());

            useEffect(() => {
                if (meshRef.current) {
                    for (let i = 0; i < count; i++) {
                        color.setHSL(i / count, 1.0, 0.5); 
                        color.multiplyScalar(1.5); 
                        meshRef.current.setColorAt(i, color);
                    }
                    meshRef.current.instanceColor.needsUpdate = true;
                }
            }, []);

            const [scatterTargets] = useState(() => {
                const scatter = new Float32Array(count * 3);
                for(let i=0; i<count; i++) {
                    const r = 25 * Math.cbrt(Math.random()); 
                    const theta = Math.random() * 2 * Math.PI;
                    const phi = Math.acos(2 * Math.random() - 1);
                    scatter[i*3] = r * Math.sin(phi) * Math.cos(theta);
                    scatter[i*3+1] = r * Math.sin(phi) * Math.sin(theta);
                    scatter[i*3+2] = r * Math.cos(phi);
                }
                return scatter;
            });

            useFrame((state, delta) => {
                if(!meshRef.current) return;
                meshRef.current.userData.progress = THREE.MathUtils.lerp(
                    meshRef.current.userData.progress || 0,
                    isTree ? 1 : 0,
                    delta * 1.5
                );
                const p = meshRef.current.userData.progress;

                for(let i=0; i<count; i++) {
                    const val = dataArray[i] || 0;
                    const length = (0.5 + (val / 255.0) * 8.0) * 0.66;
                    const angle = (i / count) * Math.PI * 2;
                    const baseRadius = 6.0;
                    const dist = baseRadius + length / 2;
                    const treeX = dist * Math.cos(angle);
                    const treeY = -4.5; 
                    const treeZ = dist * Math.sin(angle);

                    const posX = THREE.MathUtils.lerp(scatterTargets[i*3], treeX, p);
                    const posY = THREE.MathUtils.lerp(scatterTargets[i*3+1], treeY, p);
                    const posZ = THREE.MathUtils.lerp(scatterTargets[i*3+2], treeZ, p);

                    dummy.position.set(posX, posY, posZ);

                    if (p > 0.5) {
                        dummy.lookAt(0, -4.5, 0); 
                        dummy.scale.set(0.15, 0.1, length);
                    } else {
                        dummy.rotation.set(state.clock.elapsedTime * 0.2 + i, i, 0);
                        const s = THREE.MathUtils.lerp(0.5, 0.15, p);
                        dummy.scale.set(s, 0.1, s); 
                    }
                    dummy.updateMatrix();
                    meshRef.current.setMatrixAt(i, dummy.matrix);
                }
                meshRef.current.instanceMatrix.needsUpdate = true;
            });

            return (
                <instancedMesh ref={meshRef} args={[null, null, count]}>
                    <boxGeometry args={[1, 1, 1]} />
                    <meshStandardMaterial 
                        toneMapped={false} 
                        roughness={0.1}
                        metalness={0.8}
                        emissive="#111111" 
                    />
                </instancedMesh>
            );
        };

        const Foliage = ({ isTree, count = 15000 }) => {
            const meshRef = useRef();
            const audioFreq = useAudioData();
            
            const uniforms = useMemo(() => ({
                uTime: { value: 0 },
                uProgress: { value: 0 },
                uAudio: { value: 0 }
            }), []);

            const [attributes] = useState(() => {
                const scatterPos = new Float32Array(count * 3);
                const treePos = new Float32Array(count * 3);
                const randoms = new Float32Array(count);
                const treeHeight = 12;
                const treeRadius = 4.5;

                for (let i = 0; i < count; i++) {
                    const i3 = i * 3;
                    const r = 15 * Math.cbrt(Math.random());
                    const theta = Math.random() * 2 * Math.PI;
                    const phi = Math.acos(2 * Math.random() - 1);
                    scatterPos[i3] = r * Math.sin(phi) * Math.cos(theta);
                    scatterPos[i3+1] = r * Math.sin(phi) * Math.sin(theta);
                    scatterPos[i3+2] = r * Math.cos(phi);

                    const y = Math.random() * treeHeight; 
                    const normalizedY = y / treeHeight; 
                    const currentRadius = (1.0 - normalizedY) * treeRadius;
                    const angle = i * 0.1; 
                    const noise = (Math.random() - 0.5) * 0.5;
                    
                    treePos[i3] = (currentRadius + noise) * Math.cos(angle);
                    treePos[i3+1] = y - 4; 
                    treePos[i3+2] = (currentRadius + noise) * Math.sin(angle);
                    randoms[i] = Math.random();
                }
                return { scatterPos, treePos, randoms };
            });

            useFrame((state, delta) => {
                if (meshRef.current) {
                    meshRef.current.material.uniforms.uTime.value += delta;
                    const targetProgress = isTree ? 1.0 : 0.0;
                    meshRef.current.material.uniforms.uProgress.value = THREE.MathUtils.lerp(
                        meshRef.current.material.uniforms.uProgress.value,
                        targetProgress,
                        delta * 1.5
                    );
                    const normalizedAudio = Math.min(audioFreq.current / 128.0, 1.0); 
                    meshRef.current.material.uniforms.uAudio.value = THREE.MathUtils.lerp(
                        meshRef.current.material.uniforms.uAudio.value,
                        normalizedAudio,
                        0.2 
                    );
                    meshRef.current.rotation.y += 0.001;
                }
            });

            return (
                <points ref={meshRef}>
                    <bufferGeometry>
                        <bufferAttribute attach="attributes-position" count={count} array={attributes.scatterPos} itemSize={3} />
                        <bufferAttribute attach="attributes-aScatterPos" count={count} array={attributes.scatterPos} itemSize={3} />
                        <bufferAttribute attach="attributes-aTreePos" count={count} array={attributes.treePos} itemSize={3} />
                        <bufferAttribute attach="attributes-aRandom" count={count} array={attributes.randoms} itemSize={1} />
                    </bufferGeometry>
                    <shaderMaterial
                        vertexShader={foliageVertexShader}
                        fragmentShader={foliageFragmentShader}
                        uniforms={uniforms}
                        transparent={true}
                        depthWrite={false}
                        blending={THREE.AdditiveBlending}
                    />
                </points>
            );
        };

        const Ornaments = ({ isTree, count = 200, type = "sphere", color = "#D4AF37", scale = 0.3, textureStyle }) => {
            const meshRef = useRef();
            const audioFreq = useAudioData();
            
            // Texture for Gifts
            const texture = useMemo(() => {
                if (textureStyle === undefined) return null;
                return createGiftTexture(textureStyle);
            }, [textureStyle]);

            const [data] = useState(() => {
                const arr = [];
                const treeHeight = 11;
                const treeRadius = 4;
                
                for (let i = 0; i < count; i++) {
                    const r = 12 * Math.cbrt(Math.random());
                    const theta = Math.random() * 2 * Math.PI;
                    const phi = Math.acos(2 * Math.random() - 1);
                    const sx = r * Math.sin(phi) * Math.cos(theta);
                    const sy = r * Math.sin(phi) * Math.sin(theta);
                    const sz = r * Math.cos(phi);

                    const y = Math.random() * treeHeight;
                    const nY = y / treeHeight;
                    const cR = (1.0 - nY) * treeRadius; 
                    const ang = Math.random() * Math.PI * 2;
                    
                    const tx = cR * Math.cos(ang);
                    const ty = y - 4;
                    const tz = cR * Math.sin(ang);

                    arr.push({ scatter: new THREE.Vector3(sx, sy, sz), tree: new THREE.Vector3(tx, ty, tz) });
                }
                return arr;
            });

            const dummy = useMemo(() => new THREE.Object3D(), []);

            useFrame((state, delta) => {
                if (!meshRef.current) return;

                const t = state.clock.elapsedTime;
                const target = isTree ? 1 : 0;
                
                meshRef.current.userData.progress = THREE.MathUtils.lerp(
                    meshRef.current.userData.progress || 0,
                    target,
                    delta * 1.2
                );
                
                const p = meshRef.current.userData.progress;
                const audioScale = 1 + (audioFreq.current / 255) * 0.3;

                data.forEach((item, i) => {
                    const { scatter, tree } = item;
                    dummy.position.lerpVectors(scatter, tree, p);
                    
                    dummy.position.y += Math.sin(t + i) * 0.02 * (1-p); 
                    
                    dummy.scale.setScalar(scale * (i % 2 === 0 ? audioScale : 1));
                    
                    dummy.rotation.x = t * 0.2 + i;
                    dummy.rotation.z = t * 0.1 + i;
                    
                    dummy.updateMatrix();
                    meshRef.current.setMatrixAt(i, dummy.matrix);
                });
                meshRef.current.instanceMatrix.needsUpdate = true;
            });

            const geometry = type === 'box' ? new THREE.BoxGeometry(1, 1, 1) : new THREE.SphereGeometry(1, 16, 16);

            return (
                <instancedMesh ref={meshRef} args={[geometry, null, count]}>
                    <meshStandardMaterial 
                        color={texture ? "white" : color} // White base if texture is present
                        map={texture}
                        roughness={texture ? 0.3 : 0.1} // Gifts are slightly less shiny than metal balls
                        metalness={texture ? 0.5 : 0.9} 
                        emissive={texture ? "#222" : color} // Subtle emissive for texture
                        emissiveIntensity={0.2}
                    />
                </instancedMesh>
            );
        };

        const StarTopper = ({ isTree }) => {
            const ref = useRef();

            const starGeometry = useMemo(() => {
                const shape = new THREE.Shape();
                const points = 5;
                const outerRadius = 0.8;
                const innerRadius = 0.4;
                const angleOffset = Math.PI / 2; 

                for (let i = 0; i < points * 2; i++) {
                    const angle = (i * Math.PI) / points + angleOffset;
                    const radius = i % 2 === 0 ? outerRadius : innerRadius;
                    const x = Math.cos(angle) * radius;
                    const y = Math.sin(angle) * radius;
                    if (i === 0) shape.moveTo(x, y);
                    else shape.lineTo(x, y);
                }
                shape.closePath();

                const extrudeSettings = {
                    depth: 0.2,
                    bevelEnabled: true,
                    bevelThickness: 0.1,
                    bevelSize: 0.05,
                    bevelSegments: 3
                };

                const geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
                geometry.computeBoundingBox();
                const zCenter = (geometry.boundingBox.max.z - geometry.boundingBox.min.z) / 2;
                geometry.translate(0, 0, -zCenter); 
                return geometry;
            }, []);
            
            useFrame((state, delta) => {
                if(ref.current) {
                    const targetY = isTree ? 9 : 15; 
                    const targetScale = isTree ? 1 : 0.1;
                    ref.current.position.y = THREE.MathUtils.lerp(ref.current.position.y, targetY, delta * 2);
                    ref.current.scale.setScalar(THREE.MathUtils.lerp(ref.current.scale.x, targetScale, delta * 2));
                    ref.current.rotation.y += delta;
                }
            });

            return (
                <group ref={ref} position={[0, 15, 0]}>
                    <mesh geometry={starGeometry}>
                        <meshStandardMaterial color="#FFD700" emissive="#FFD700" emissiveIntensity={2} toneMapped={false} />
                    </mesh>
                    <pointLight color="#FFD700" intensity={5} distance={10} decay={2} />
                </group>
            );
        };

        const ResponsiveCamera = () => {
            const { camera, size } = useThree();
            useEffect(() => {
                const isMobilePortrait = size.width < 768 && size.width < size.height;
                const targetZ = isMobilePortrait ? 35 : 20; 
                camera.position.z = targetZ;
                camera.updateProjectionMatrix();
            }, [size.width, size.height, camera]);
            return null;
        };

        const Scene = ({ isTree }) => {
            return (
                <>
                    <PerspectiveCamera makeDefault position={[0, 4, 20]} fov={50} />
                    <ResponsiveCamera /> 
                    <OrbitControls enablePan={false} minDistance={10} maxDistance={50} maxPolarAngle={Math.PI / 1.5} autoRotate={true} autoRotateSpeed={0.5} />
                    <Environment preset="city" blur={1} background={false} />
                    <ambientLight intensity={0.2} color="#002b16" />
                    <spotLight position={[10, 20, 10]} angle={0.3} penumbra={1} intensity={2} castShadow color="#F7E7CE" />
                    <spotLight position={[-10, 5, 10]} angle={0.5} penumbra={1} intensity={1} color="#023020" />
                    
                    <Foliage isTree={isTree} />
                    <AudioSpectrumRing isTree={isTree} />

                    {/* Heavy Ornaments - Textured Gifts Boxes */}
                    <Ornaments isTree={isTree} count={15} type="box" scale={0.5} textureStyle={0} />
                    <Ornaments isTree={isTree} count={15} type="box" scale={0.5} textureStyle={1} />
                    <Ornaments isTree={isTree} count={15} type="box" scale={0.5} textureStyle={2} />
                    <Ornaments isTree={isTree} count={15} type="box" scale={0.5} textureStyle={3} />
                    
                    {/* Light Ornaments (Balls) - Now Textured Spheres */}
                    <Ornaments isTree={isTree} count={40} type="sphere" scale={0.3} textureStyle={0} />
                    <Ornaments isTree={isTree} count={40} type="sphere" scale={0.3} textureStyle={1} />
                    <Ornaments isTree={isTree} count={40} type="sphere" scale={0.3} textureStyle={2} />
                    
                    {/* Tiny Lights - Warm White */}
                    <Ornaments isTree={isTree} count={300} type="sphere" color="#FFFDD0" scale={0.05} />

                    <StarTopper isTree={isTree} />
                    <Sparkles count={200} scale={12} size={2} speed={0.4} opacity={0.5} color="#F7E7CE" />
                </>
            );
        };

        const PostProcessingEffects = () => {
            return (
                <EffectComposer disableNormalPass>
                    <Bloom luminanceThreshold={0.8} mipmapBlur intensity={1.2} radius={0.6} />
                    <ToneMapping />
                    <Vignette eskil={false} offset={0.1} darkness={1.1} />
                    <Noise opacity={0.02} /> 
                </EffectComposer>
            );
        };

        const App = () => {
            const [isTree, setIsTree] = useState(false); // Start scattered (gift), then become tree
            const [audioReady, setAudioReady] = useState(false);

            useEffect(() => {
                // Gift ‚Üí Tree animation on load
                const timer = setTimeout(() => {
                    setIsTree(true);
                }, 1500); // Wait 1.5s then assemble tree
                
                const resumeContext = () => { if (audioContext.state === 'suspended') audioContext.resume(); };

                const startDefaultMusic = () => {
                    if (!defaultMediaElementSource) {
                        try {
                            defaultMediaElementSource = audioContext.createMediaElementSource(defaultAudioEl);
                            defaultMediaElementSource.connect(analyser);
                            analyser.connect(audioContext.destination);
                            activeSourceNode = defaultMediaElementSource;
                        } catch(e) { console.log("Audio node error", e); }
                    }
                    
                    defaultAudioEl.play().then(() => {
                        setAudioReady(true);
                    }).catch(e => {
                        const unlockAndPlay = () => {
                            resumeContext();
                            defaultAudioEl.play();
                            setAudioReady(true);
                            document.removeEventListener('click', unlockAndPlay);
                            document.removeEventListener('touchstart', unlockAndPlay);
                        };
                        document.addEventListener('click', unlockAndPlay);
                        document.addEventListener('touchstart', unlockAndPlay);
                    });
                };

                startDefaultMusic(); 
                
                // Expose tree control functions globally
                window.scatterTree = () => setIsTree(false);
                window.assembleTree = () => setIsTree(true);
                
                return () => clearTimeout(timer);
            }, []); 

            useEffect(() => {
                // Tree state changed
            }, [isTree]);

            return (
                <Canvas shadows dpr={[1, 2]} gl={{ antialias: false, toneMappingExposure: 1.5 }}>
                    <color attach="background" args={['#000500']} />
                    <Suspense fallback={null}>
                        <Scene isTree={isTree} />
                        <PostProcessingEffects />
                    </Suspense>
                </Canvas>
            );
        };

        const root = createRoot(document.getElementById('canvas-container'));
        root.render(<App />);
        
        // Farcaster Mini App SDK - signal ready
        import('https://esm.sh/@farcaster/miniapp-sdk').then(({ sdk }) => {
            setTimeout(() => sdk.actions.ready(), 2000);
        }).catch(() => {});
    </script>

    <!-- Gift Plaza System -->
    <script>
        let giftType = 'equal';
        let currentUser = null; // Will be set by Farcaster SDK
        const NEYNAR_API_KEY = 'NEYNAR_API_DOCS';
        const MAX_PLAZA_GIFTS = 10;
        let plazaGifts = JSON.parse(localStorage.getItem('plaza_gifts') || '[]');
        let isPlazaMode = false;

        // Toggle Plaza Mode
        function togglePlazaMode() {
            isPlazaMode = !isPlazaMode;
            const plazaBtn = document.getElementById('plaza-btn');
            const plaza = document.getElementById('gift-plaza');
            const plazaSendBtn = document.getElementById('plaza-send-btn');
            const mainBtns = document.getElementById('main-btns');
            const topBtns = document.getElementById('top-btns');
            const titleEl = document.getElementById('app-title');
            const subtitleEl = document.getElementById('app-subtitle');
            const bannerContainer = document.getElementById('banner-container');
            
            if (isPlazaMode) {
                plazaBtn.textContent = '‚Ü© Return';
                plaza.style.display = 'block';
                plazaSendBtn.style.display = 'flex';
                mainBtns.style.display = 'none';
                topBtns.style.display = 'none';
                // Hide title, show banner
                if (titleEl) titleEl.style.display = 'none';
                if (subtitleEl) subtitleEl.style.display = 'none';
                stopShootingStars();
                renderBanner();
                renderPlaza();
            } else {
                plazaBtn.textContent = 'üéÑ Plaza Gift';
                plaza.style.display = 'none';
                plazaSendBtn.style.display = 'none';
                mainBtns.style.display = 'flex';
                topBtns.style.display = 'flex';
                // Show title, hide banner and snow
                if (titleEl) titleEl.style.display = 'block';
                if (subtitleEl) subtitleEl.style.display = 'block';
                bannerContainer.classList.remove('active');
                document.getElementById('snowfall-container').classList.remove('active');
                startShootingStars();
            }
        }

        // Modal functions
        function openGiftModal() { 
            document.getElementById('gift-modal').classList.add('visible');
            document.getElementById('gift-title').value = '';
            document.getElementById('gift-token').value = 'USDC';
            document.getElementById('gift-amount').value = '0.1';
            document.getElementById('gift-shares').value = '5';
            document.getElementById('plaza-custom-token-group').style.display = 'none';
            document.getElementById('plaza-token-ca').value = '';
            document.getElementById('require-code').checked = false;
            document.getElementById('gift-code').value = '';
            document.getElementById('code-input-row').style.display = 'none';
            document.getElementById('require-pro').checked = false;
            document.getElementById('min-score').value = '0';
            updatePreview();
        }
        function closeGiftModal() { document.getElementById('gift-modal').classList.remove('visible'); }
        function closeClaimModal() { document.getElementById('claim-modal').classList.remove('visible'); }
        function openClaimInput() { document.getElementById('claim-input-modal').classList.add('visible'); document.getElementById('gift-code-input').value = ''; }
        function closeClaimInput() { document.getElementById('claim-input-modal').classList.remove('visible'); }
        function showLoading(text) { document.getElementById('loading-text').textContent = text; document.getElementById('loading-modal').classList.add('visible'); }
        function hideLoading() { document.getElementById('loading-modal').classList.remove('visible'); }
        function closeSuccessModal() { document.getElementById('success-modal').querySelector('.modal-box').style.display = 'none'; }
        
        // Tip Author functions
        const AUTHOR_USERNAME = 'xqc';
        const AUTHOR_ADDRESS = '0x...'; // Replace with actual address
        const USDC_CA = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
        let authorInfo = null;
        
        async function fetchAuthorInfo() {
            if (authorInfo) return;
            try {
                const res = await fetch(`https://api.neynar.com/v2/farcaster/user/search?q=${AUTHOR_USERNAME}&limit=1`, {
                    headers: { 'accept': 'application/json', 'x-api-key': NEYNAR_API_KEY }
                });
                const data = await res.json();
                if (data.result?.users?.[0]) {
                    authorInfo = data.result.users[0];
                    document.getElementById('author-avatar').src = authorInfo.pfp_url || '';
                    document.getElementById('author-name').textContent = authorInfo.username;
                }
            } catch (e) { console.error('Failed to fetch author info:', e); }
        }
        
        function openTipModal() {
            document.getElementById('tip-modal').classList.add('visible');
            document.getElementById('tip-amount').value = '1';
            document.getElementById('tip-amounts').innerHTML = [1, 3, 5].map(amt => 
                `<button type="button" class="tip-amt-btn" onclick="setTipAmount(${amt})">${amt}</button>`
            ).join('');
            fetchAuthorInfo();
        }
        function closeTipModal() { document.getElementById('tip-modal').classList.remove('visible'); }
        function setTipAmount(amount) { document.getElementById('tip-amount').value = amount; }
        async function sendTip() {
            const token = document.getElementById('tip-token').value;
            const amount = document.getElementById('tip-amount').value;
            if (!amount || parseFloat(amount) <= 0) { alert('Enter valid amount'); return; }
            
            closeTipModal();
            showLoading('Sending tip...');
            
            // In production, integrate with wallet (ethers.js / wagmi)
            // For demo, just show success
            setTimeout(() => {
                hideLoading();
                alert(`Thank you for your tip! ‚ù§Ô∏è\n\n${amount} ${token} to author`);
            }, 1500);
        }
        
        // Gift Record feature - show gifts sent and claimed
        function openRecordModal() {
            const myUsername = currentUser?.username || 'santa';
            const myFid = currentUser?.fid;
            
            // Gifts I sent
            const sentGifts = plazaGifts.filter(g => g.sender?.username === myUsername);
            
            // Gifts I claimed
            const claimedGifts = plazaGifts.filter(g => 
                g.claimedBy?.some(c => c.username === myUsername || c.fid === myFid)
            );
            
            const recordList = document.getElementById('record-list');
            let html = '';
            
            // Sent gifts section
            html += '<div style="color:var(--gold); font-weight:bold; margin-bottom:8px;">üéÅ Gifts I Sent</div>';
            if (sentGifts.length === 0) {
                html += '<div style="text-align:center; color:rgba(255,255,255,0.5); padding:12px; font-size:0.85rem;">No gifts sent yet</div>';
            } else {
                html += sentGifts.map(gift => {
                    const claimers = gift.claimedBy || [];
                    return `
                        <div style="background:rgba(0,0,0,0.3); padding:12px; border-radius:8px; margin-bottom:10px; border:1px solid rgba(212,175,55,0.3);">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <span style="color:var(--gold); font-weight:bold;">${gift.title}</span>
                                <span style="color:rgba(255,255,255,0.6); font-size:0.8rem;">${gift.claimed}/${gift.shares} claimed</span>
                            </div>
                            <div style="font-size:0.85rem; color:rgba(255,255,255,0.7);">${gift.amount} ${gift.token}</div>
                            ${claimers.length > 0 ? `
                                <div style="margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1);">
                                    <div style="font-size:0.75rem; color:rgba(255,255,255,0.5); margin-bottom:4px;">Claimed by:</div>
                                    ${claimers.map(c => `
                                        <div style="display:flex; align-items:center; gap:8px; padding:4px 0;">
                                            <img src="${c.pfp || 'https://i.imgur.com/HeIi0wU.png'}" style="width:24px; height:24px; border-radius:50%; border:1px solid var(--gold);" onerror="this.src='https://i.imgur.com/HeIi0wU.png'">
                                            <span style="font-size:0.8rem; color:rgba(255,255,255,0.8);">@${c.username || c.fid || 'anonymous'}</span>
                                            <span style="font-size:0.8rem; color:var(--gold); margin-left:auto;">${c.amount || '?'} ${gift.token}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<div style="font-size:0.75rem; color:rgba(255,255,255,0.4); margin-top:8px;">No claims yet</div>'}
                        </div>
                    `;
                }).join('');
            }
            
            // Claimed gifts section
            html += '<div style="color:var(--gold); font-weight:bold; margin:16px 0 8px;">üì¨ Gifts I Claimed</div>';
            if (claimedGifts.length === 0) {
                html += '<div style="text-align:center; color:rgba(255,255,255,0.5); padding:12px; font-size:0.85rem;">No gifts claimed yet</div>';
            } else {
                html += claimedGifts.map(gift => {
                    const myClaim = gift.claimedBy?.find(c => c.username === myUsername || c.fid === myFid);
                    return `
                        <div style="background:rgba(0,0,0,0.3); padding:12px; border-radius:8px; margin-bottom:10px; border:1px solid rgba(212,175,55,0.3);">
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                                <img src="${gift.sender?.pfp || 'https://i.imgur.com/HeIi0wU.png'}" style="width:28px; height:28px; border-radius:50%; border:1px solid var(--gold);" onerror="this.src='https://i.imgur.com/HeIi0wU.png'">
                                <div>
                                    <div style="color:var(--gold); font-weight:bold;">${gift.title}</div>
                                    <div style="font-size:0.75rem; color:rgba(255,255,255,0.5);">From @${gift.sender?.username || 'anonymous'}</div>
                                </div>
                            </div>
                            <div style="font-size:0.85rem; color:var(--gold);">Received: ${myClaim?.amount || '?'} ${gift.token}</div>
                        </div>
                    `;
                }).join('');
            }
            
            recordList.innerHTML = html;
            document.getElementById('record-modal').classList.add('visible');
        }
        
        function closeRecordModal() {
            document.getElementById('record-modal').classList.remove('visible');
        }
        
        // Go back to home
        function goHome() {
            document.getElementById('success-modal').classList.remove('visible');
            document.getElementById('success-modal').querySelector('.modal-box').style.display = 'block';
            document.querySelector('.controls').style.display = 'flex';
            document.getElementById('gift-plaza').style.display = 'none';
            document.getElementById('plaza-btn').textContent = 'üéÑ Plaza Gift';
            document.getElementById('main-btns').style.display = 'flex';
            document.getElementById('top-btns').style.display = 'flex';
            document.getElementById('plaza-send-btn').style.display = 'none';
            isPlazaMode = false;
            // Tree stays scattered - reassembles after 3 seconds
            setTimeout(() => {
                if (window.assembleTree) window.assembleTree();
            }, 3000);
        }
        
        // Direct Gift (Send to Friends)
        let selectedRecipients = [];
        let searchTimeout = null;
        const MAX_RECIPIENTS = 10;
        
        function openDirectGiftModal() {
            document.getElementById('direct-gift-modal').classList.add('visible');
            selectedRecipients = [];
            document.getElementById('user-search').value = '';
            document.getElementById('selected-users').innerHTML = '';
            document.getElementById('user-results').style.display = 'none';
            document.getElementById('direct-gift-title').value = '';
            document.getElementById('direct-gift-message').value = '';
            document.getElementById('direct-gift-amount').value = '0.5';
            document.getElementById('direct-gift-token').value = 'USDC';
            document.getElementById('custom-token-group').style.display = 'none';
            document.getElementById('custom-token-ca').value = '';
            updateDirectPreview();
        }
        
        async function fetchTopFriends() {
            try {
                document.getElementById('selected-users').innerHTML = '<div style="color:rgba(255,255,255,0.5);font-size:0.8rem;">Loading friends...</div>';
                
                // Use current user's fid or default to a popular user for demo
                const fid = currentUser?.fid || 3; // dwr.eth as default
                const res = await fetch(`https://api.neynar.com/v2/farcaster/following?fid=${fid}&limit=5`, {
                    headers: { 'accept': 'application/json', 'x-api-key': NEYNAR_API_KEY }
                });
                const data = await res.json();
                if (data.users?.length > 0) {
                    selectedRecipients = data.users.slice(0, 5).map(u => ({
                        fid: u.fid,
                        username: u.username,
                        display_name: u.display_name,
                        pfp_url: u.pfp_url
                    }));
                    renderSelectedUsers();
                    updateDirectPreview();
                } else {
                    document.getElementById('selected-users').innerHTML = '';
                }
            } catch (e) { 
                console.error('Failed to fetch friends:', e);
                document.getElementById('selected-users').innerHTML = '';
            }
        }
        function closeDirectGiftModal() { document.getElementById('direct-gift-modal').classList.remove('visible'); }
        
        async function searchUsers(query) {
            if (searchTimeout) clearTimeout(searchTimeout);
            const resultsDiv = document.getElementById('user-results');
            if (!query || query.length < 2) { resultsDiv.style.display = 'none'; return; }
            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`https://api.neynar.com/v2/farcaster/user/search?q=${encodeURIComponent(query)}&limit=5`, {
                        headers: { 'accept': 'application/json', 'x-api-key': NEYNAR_API_KEY }
                    });
                    const data = await res.json();
                    if (data.result?.users?.length > 0) {
                        resultsDiv.innerHTML = data.result.users.map(u => `
                            <div class="user-result" onclick='selectUser(${JSON.stringify(u).replace(/'/g, "&#39;")})'>
                                <img src="${u.pfp_url || 'https://via.placeholder.com/32'}" onerror="this.src='https://via.placeholder.com/32'">
                                <div class="info"><div class="name">${u.display_name || u.username}</div><div class="username">@${u.username}</div></div>
                            </div>
                        `).join('');
                        resultsDiv.style.display = 'block';
                    } else { resultsDiv.style.display = 'none'; }
                } catch (e) { console.error(e); resultsDiv.style.display = 'none'; }
            }, 300);
        }
        
        function selectUser(user) {
            if (selectedRecipients.find(r => r.fid === user.fid)) { alert('Already selected'); return; }
            if (selectedRecipients.length >= MAX_RECIPIENTS) { alert('Max ' + MAX_RECIPIENTS + ' recipients'); return; }
            selectedRecipients.push(user);
            document.getElementById('user-search').value = '';
            document.getElementById('user-results').style.display = 'none';
            renderSelectedUsers();
            updateDirectPreview();
        }
        
        function renderSelectedUsers() {
            const div = document.getElementById('selected-users');
            if (selectedRecipients.length === 0) { div.innerHTML = ''; return; }
            div.innerHTML = `<div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;">${selectedRecipients.map((u, i) => `
                <div class="selected-user-card" style="flex:none; padding:6px 10px;">
                    <img src="${u.pfp_url || 'https://via.placeholder.com/24'}" style="width:24px; height:24px;" onerror="this.src='https://via.placeholder.com/24'">
                    <span style="color:var(--gold); font-size:0.8rem;">@${u.username}</span>
                    <button class="remove-btn" onclick="removeUser(${i})" style="font-size:1rem; padding:2px;">√ó</button>
                </div>
            `).join('')}</div><div style="font-size:0.7rem; color:rgba(255,255,255,0.4); margin-top:6px;">${selectedRecipients.length}/${MAX_RECIPIENTS}</div>`;
        }
        
        function removeUser(index) { selectedRecipients.splice(index, 1); renderSelectedUsers(); updateDirectPreview(); }
        
        function toggleCustomToken() {
            const token = document.getElementById('direct-gift-token').value;
            document.getElementById('custom-token-group').style.display = token === 'CUSTOM' ? 'block' : 'none';
            updateDirectPreview();
        }
        
        function validateDirectAmount() {
            const input = document.getElementById('direct-gift-amount');
            if (parseFloat(input.value) < 0.1) {
                input.value = '0.1';
            }
        }
        
        function updateDirectPreview() {
            const amount = document.getElementById('direct-gift-amount').value || '0';
            let token = document.getElementById('direct-gift-token').value;
            if (token === 'CUSTOM') token = 'TOKEN';
            document.getElementById('direct-preview-amount').textContent = amount + ' ' + token + ' each';
            document.getElementById('direct-preview-info').textContent = selectedRecipients.length > 0 
                ? '‚Üí ' + selectedRecipients.map(u => '@' + u.username).join(', ')
                : 'Select recipient(s) above';
        }
        
        async function createDirectGift() {
            const title = document.getElementById('direct-gift-title').value || 'Merry Christmas!';
            const message = document.getElementById('direct-gift-message').value || '';
            const token = document.getElementById('direct-gift-token').value;
            const amount = document.getElementById('direct-gift-amount').value;
            if (!amount || parseFloat(amount) <= 0) { alert('Enter valid amount'); return; }
            if (selectedRecipients.length === 0) { alert('Select at least one recipient'); return; }
            
            closeDirectGiftModal();
            showLoading('Creating gifts...');
            
            // Create a gift for each recipient
            const links = [];
            for (const r of selectedRecipients) {
                const giftId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                const giftData = {
                    id: giftId, title, message, token, amount,
                    shares: 1, type: 'equal', mode: 'direct',
                    requirePro: false, minScore: 0,
                    claimed: 0, claimedBy: [],
                    recipient: { fid: r.fid, username: r.username, pfp: r.pfp_url },
                    sender: currentUser || { fid: 0, username: 'anonymous', pfp: '' },
                    createdAt: Date.now()
                };
                plazaGifts.push(giftData);
                links.push({ username: r.username, url: location.origin + location.pathname + '?gift=' + giftId });
            }
            localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));
            
            // Create share text
            let shareText = links.length === 1 
                ? `üéÅ Gift for @${links[0].username}!\n\n${title}\nüí∞ ${amount} ${token}\n\nüîó ${links[0].url}`
                : `üéÅ Christmas Gifts!\n\n${title}\nüí∞ ${amount} ${token} each\n\n` + links.map(l => `‚Üí @${l.username}: ${l.url}`).join('\n');
            
            hideLoading();
            if (navigator.clipboard) {
                await navigator.clipboard.writeText(shareText);
                alert(`Gift(s) created for ${selectedRecipients.length} friend(s)!\nLink(s) copied to clipboard!`);
            } else { alert(shareText); }
        }
        
        // Claim by code/link
        let currentCardGift = null;
        
        function claimByCode() {
            const input = document.getElementById('gift-code-input').value.trim();
            if (!input) { alert('Please enter a gift code'); return; }
            
            // Extract gift ID from input (could be full URL or just ID)
            let giftId = input;
            if (input.includes('gift=')) {
                giftId = input.split('gift=')[1].split('&')[0];
            }
            
            // Check if gift exists in plaza
            const gift = plazaGifts.find(g => g.id === giftId);
            if (gift) {
                closeClaimInput();
                // Direct gift shows greeting card
                if (gift.mode === 'direct') {
                    showGreetingCard(gift);
                } else {
                    openClaimModal(giftId);
                }
            } else {
                alert('Gift not found!');
            }
        }
        
        // Check and show mailbox glow if there are gifts for user
        function checkMyGifts() {
            const myGifts = plazaGifts.filter(g => g.mode === 'direct' && g.claimed < g.shares);
            const mailboxBtn = document.getElementById('mailbox-button');
            if (myGifts.length > 0) {
                mailboxBtn.classList.add('has-gift');
            } else {
                mailboxBtn.classList.remove('has-gift');
            }
        }
        
        // Open first available gift
        function openMyGifts() {
            const myGifts = plazaGifts.filter(g => g.mode === 'direct' && g.claimed < g.shares);
            if (myGifts.length > 0) {
                showGreetingCard(myGifts[0]);
            } else {
                alert('No gifts available');
            }
        }
        
        function showGreetingCard(gift) {
            currentCardGift = gift;
            document.getElementById('card-sender-pfp').src = gift.sender.pfp || 'https://i.imgur.com/HeIi0wU.png';
            document.getElementById('card-sender-name').textContent = gift.sender.username;
            document.getElementById('card-title').textContent = gift.title;
            document.getElementById('card-message').textContent = gift.message || 'Wishing you a wonderful holiday season!';
            document.getElementById('card-amount').textContent = gift.amount + ' ' + gift.token;
            document.getElementById('card-modal').classList.add('visible');
        }
        
        function claimCardGift() {
            if (!currentCardGift) return;
            document.getElementById('card-modal').classList.remove('visible');
            
            // Process claim
            showLoading('Opening gift...');
            document.querySelector('.controls').style.display = 'none';
            
            // TODO: In production, call smart contract here
            // await contract.claimGift(giftId, password, isPro);
            
            currentCardGift.claimed = 1;
            currentCardGift.claimedBy.push(currentUser?.fid || 'guest');
            localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));
            
            setTimeout(() => {
                hideLoading();
                document.getElementById('success-amount').textContent = currentCardGift.amount + ' ' + currentCardGift.token;
                document.getElementById('success-modal').classList.add('visible');
                
                // Scatter tree AFTER claim for impact
                setTimeout(() => {
                    if (window.scatterTree) window.scatterTree();
                }, 300);
                
                // Update mailbox status
                checkMyGifts();
                currentCardGift = null;
            }, 800);
        }

        function toggleCodeInput() {
            const show = document.getElementById('require-code').checked;
            document.getElementById('code-input-row').style.display = show ? 'flex' : 'none';
            if (!show) document.getElementById('gift-code').value = '';
        }
        
        // Banner functions
        let activeBanners = JSON.parse(localStorage.getItem('blessing_banners') || '[]');
        
        let bannerCountdownInterval = null;
        
        function openBannerModal() {
            document.getElementById('banner-modal').classList.add('visible');
            document.getElementById('banner-message').value = '';
            document.getElementById('emoji-picker').style.display = 'none';
            document.getElementById('banner-hours').value = 1;
            document.getElementById('banner-price').value = 1;
            
            // Show countdown if there's an active banner
            const now = Date.now();
            const activeBanner = activeBanners.find(b => b.expiresAt > now);
            const infoDiv = document.getElementById('current-banner-info');
            
            if (activeBanner) {
                infoDiv.style.display = 'block';
                updateBannerCountdown(activeBanner.expiresAt);
                bannerCountdownInterval = setInterval(() => updateBannerCountdown(activeBanner.expiresAt), 1000);
            } else {
                infoDiv.style.display = 'none';
            }
        }
        
        function updateBannerCountdown(expiresAt) {
            const now = Date.now();
            const remaining = expiresAt - now;
            
            if (remaining <= 0) {
                document.getElementById('banner-countdown').textContent = 'Expired';
                if (bannerCountdownInterval) clearInterval(bannerCountdownInterval);
                return;
            }
            
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const mins = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const secs = Math.floor((remaining % (1000 * 60)) / 1000);
            
            document.getElementById('banner-countdown').textContent = 
                `${hours.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
        }
        
        function closeBannerModal() {
            document.getElementById('banner-modal').classList.remove('visible');
            if (bannerCountdownInterval) {
                clearInterval(bannerCountdownInterval);
                bannerCountdownInterval = null;
            }
        }
        
        function toggleEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            picker.style.display = picker.style.display === 'none' ? 'flex' : 'none';
        }
        
        function addEmoji(emoji) {
            const input = document.getElementById('banner-message');
            if (input.value.length < 20) {
                input.value += emoji;
            }
        }
        
        function updateBannerTotal() {
            let hours = parseInt(document.getElementById('banner-hours').value) || 1;
            if (hours < 1) hours = 1;
            if (hours > 72) hours = 72;
            document.getElementById('banner-hours').value = hours;
            document.getElementById('banner-price').value = hours;
        }
        
        function createBanner() {
            const message = document.getElementById('banner-message').value.trim();
            if (!message) { alert('Please enter a message'); return; }
            
            let hours = parseInt(document.getElementById('banner-hours').value) || 1;
            if (hours < 1) hours = 1;
            if (hours > 72) hours = 72;
            const duration = hours * 60; // convert to minutes
            
            // TODO: Process payment via smart contract
            
            const banner = {
                id: Date.now().toString(),
                message: message,
                sender: currentUser?.username || 'Anonymous',
                expiresAt: Date.now() + duration * 60 * 1000,
                createdAt: Date.now()
            };
            
            activeBanners.push(banner);
            localStorage.setItem('blessing_banners', JSON.stringify(activeBanners));
            
            closeBannerModal();
            renderBanner();
            
            alert('‚ú® Your banner is now shining!');
        }
        
        function renderBanner() {
            const container = document.getElementById('banner-container');
            const snowContainer = document.getElementById('snowfall-container');
            const now = Date.now();
            
            // Filter out expired banners
            activeBanners = activeBanners.filter(b => b.expiresAt > now);
            localStorage.setItem('blessing_banners', JSON.stringify(activeBanners));
            
            if (activeBanners.length === 0) {
                container.classList.remove('active');
                snowContainer.classList.remove('active');
                container.innerHTML = '';
                snowContainer.innerHTML = '';
                return;
            }
            
            // Show latest banner
            const banner = activeBanners[activeBanners.length - 1];
            
            // Generate big romantic snowflakes
            let snowflakes = '';
            const snowSymbols = ['‚ùÑ', '‚ùÖ', '‚ùÜ', '‚úª', '‚úº'];
            for (let i = 0; i < 40; i++) {
                const left = Math.random() * 100;
                const delay = Math.random() * 8;
                const duration = 6 + Math.random() * 8;
                const size = 16 + Math.random() * 24;
                const symbol = snowSymbols[Math.floor(Math.random() * snowSymbols.length)];
                snowflakes += `<span class="snow" style="left:${left}%; animation-delay:${delay}s; animation-duration:${duration}s; font-size:${size}px;">${symbol}</span>`;
            }
            
            container.classList.add('active');
            snowContainer.classList.add('active');
            
            // Auto format text - split into two lines if > 8 chars
            let displayText = banner.message;
            let twoLines = false;
            if (banner.message.length > 8) {
                twoLines = true;
                const mid = Math.ceil(banner.message.length / 2);
                const spaceIndex = banner.message.lastIndexOf(' ', mid);
                if (spaceIndex > 2) {
                    displayText = banner.message.substring(0, spaceIndex) + '<br>' + banner.message.substring(spaceIndex + 1);
                } else {
                    displayText = banner.message.substring(0, mid) + '<br>' + banner.message.substring(mid);
                }
            }
            
            container.innerHTML = `
                <div class="fancy-banner">
                    <div class="banner-text ${twoLines ? 'two-lines' : ''}">${displayText}</div>
                    <div class="banner-sender">@${banner.sender}</div>
                </div>
            `;
            
            snowContainer.innerHTML = snowflakes;
        }
        
        function togglePlazaCustomToken() {
            const token = document.getElementById('gift-token').value;
            document.getElementById('plaza-custom-token-group').style.display = token === 'CUSTOM' ? 'block' : 'none';
            updatePreview();
        }
        
        function validatePlazaAmount() {
            const input = document.getElementById('gift-amount');
            if (parseFloat(input.value) < 0.1) {
                input.value = '0.1';
            }
        }
        
        function selectGiftType(type) {
            giftType = type;
            document.querySelectorAll('.type-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (i === 0 && type === 'equal') || (i === 1 && type === 'lucky'));
            });
            updatePreview();
        }

        function updatePreview() {
            const amount = document.getElementById('gift-amount').value || '0';
            const token = document.getElementById('gift-token').value;
            const shares = document.getElementById('gift-shares').value || '1';
            document.getElementById('preview-amount').textContent = amount + ' ' + token;
            const perShare = shares > 0 ? (parseFloat(amount) / parseInt(shares)).toFixed(6) : '0';
            const requireCode = document.getElementById('require-code').checked;
            const requirePro = document.getElementById('require-pro').checked;
            const minScore = parseFloat(document.getElementById('min-score').value) || 0;
            let info = giftType === 'equal' ? `${shares} shares √ó ${perShare} ${token}` : `${shares} lucky shares`;
            if (requireCode || requirePro || minScore > 0) {
                info += ' | Requires:';
                if (requireCode) info += ' üîëCode';
                if (requirePro) info += ' FC Pro';
                if (minScore > 0) info += ` Score‚â•${minScore}`;
            }
            document.getElementById('preview-info').textContent = info;
        }

        // Create gift for plaza
        async function createGift() {
            // Check if plaza is full
            const activeGifts = plazaGifts.filter(g => g.claimed < g.shares);
            if (activeGifts.length >= MAX_PLAZA_GIFTS) {
                alert('üéÑ Plaza Gift is full!\n\nMaximum 10 gifts can orbit the tree at once.\nPlease wait for some gifts to be claimed.');
                return;
            }
            
            const title = document.getElementById('gift-title').value || 'Merry Christmas!';
            const token = document.getElementById('gift-token').value;
            const amount = document.getElementById('gift-amount').value;
            const shares = document.getElementById('gift-shares').value || '5';
            const requireCode = document.getElementById('require-code').checked;
            const giftCode = document.getElementById('gift-code').value.trim();
            const requirePro = document.getElementById('require-pro').checked;
            const minScore = parseFloat(document.getElementById('min-score').value) || 0;

            if (!amount || parseFloat(amount) <= 0) { alert('Enter valid amount'); return; }
            if (requireCode && !giftCode) { alert('Enter a secret code'); return; }
            if (!shares || parseInt(shares) < 1) { alert('Enter valid shares'); return; }

            closeGiftModal();
            showLoading('Creating plaza gift...');

            // For demo, use a placeholder sender (in production, get from Farcaster SDK)
            const sender = currentUser || {
                fid: Date.now(),
                username: 'anonymous',
                pfp_url: 'https://i.imgur.com/HeIi0wU.png'
            };

            const giftId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            const giftData = {
                id: giftId,
                title,
                token,
                amount,
                shares: parseInt(shares),
                type: giftType,
                requireCode,
                giftCode: requireCode ? giftCode : '',
                requirePro,
                minScore,
                claimed: 0,
                claimedBy: [],
                sender: {
                    fid: sender.fid,
                    username: sender.username,
                    pfp: sender.pfp_url
                },
                createdAt: Date.now()
            };

            // Add to plaza gifts
            plazaGifts.push(giftData);
            localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));

            hideLoading();
            renderPlaza();
            alert('üéÅ Gift added to plaza!\nYour avatar is now orbiting the tree.');
        }

        // Render orbiting avatars around the tree
        function renderPlaza() {
            const plaza = document.getElementById('gift-plaza');
            const activeGifts = plazaGifts.filter(g => g.claimed < g.shares).slice(0, MAX_PLAZA_GIFTS);
            
            // Responsive orbit radius based on viewport - closer to tree
            const baseRadius = Math.min(window.innerWidth, window.innerHeight) * 0.12;
            const positions = [
                { duration: 18, delay: 0, y: -100, radius: baseRadius * 0.9 },
                { duration: 22, delay: -3, y: -70, radius: baseRadius * 1.1 },
                { duration: 15, delay: -7, y: -35, radius: baseRadius * 0.85 },
                { duration: 20, delay: -2, y: 0, radius: baseRadius },
                { duration: 25, delay: -5, y: 35, radius: baseRadius * 1.15 },
                { duration: 17, delay: -8, y: -85, radius: baseRadius * 0.95 },
                { duration: 23, delay: -1, y: -50, radius: baseRadius * 1.05 },
                { duration: 19, delay: -6, y: 18, radius: baseRadius * 0.92 },
                { duration: 21, delay: -4, y: -18, radius: baseRadius * 1.1 },
                { duration: 16, delay: -9, y: 50, radius: baseRadius * 0.98 }
            ];
            
            plaza.innerHTML = activeGifts.map((gift, index) => {
                const pos = positions[index];
                return `
                    <div class="plaza-gift" 
                         style="--orbit-duration: ${pos.duration}s; --orbit-delay: ${pos.delay}s; --orbit-radius: ${pos.radius}px; top: ${pos.y}px;"
                         onclick="openClaimModal('${gift.id}')"
                         title="Click to claim mystery gift from @${gift.sender.username}">
                        <img src="${gift.sender.pfp || 'https://i.imgur.com/HeIi0wU.png'}" 
                             onerror="this.src='https://i.imgur.com/HeIi0wU.png'"
                             alt="${gift.sender.username}">
                        <div class="santa-emoji">üéÖ</div>
                    </div>
                `;
            }).join('');
        }

        // Open claim modal for specific gift
        function openClaimModal(giftId) {
            const gift = plazaGifts.find(g => g.id === giftId);
            if (!gift) { alert('Gift not found'); return; }
            if (gift.claimed >= gift.shares) { alert('All shares claimed!'); return; }

            // Store current gift id for claiming
            document.getElementById('claim-modal').dataset.giftId = giftId;

            document.querySelector('#claim-modal .modal-title').textContent = 'üéÅ Mystery Gift';
            document.getElementById('claim-message').textContent = gift.title;
            document.getElementById('claim-remaining').textContent = '??? ' + gift.token;
            document.getElementById('claim-shares').textContent = gift.claimed + '/' + gift.shares + ' claimed';
            document.getElementById('claim-shares').parentElement.style.display = 'inline';

            // Show sender info
            const recipientDiv = document.getElementById('claim-recipient');
            recipientDiv.innerHTML = `
                <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:8px;">
                    <img src="${gift.sender.pfp || ''}" style="width:32px; height:32px; border-radius:50%; border:2px solid var(--gold);" onerror="this.style.display='none'">
                    <span style="color:var(--gold);">From @${gift.sender.username}</span>
                </div>
                ${gift.requirePro || gift.minScore > 0 ? `
                    <div style="font-size:0.75rem; color:rgba(255,255,255,0.5); margin-top:4px;">
                        Requirements: ${gift.requirePro ? '‚≠ê FC Pro ' : ''}${gift.minScore > 0 ? `Score‚â•${gift.minScore}` : ''}
                    </div>
                ` : ''}
            `;
            recipientDiv.style.display = 'block';

            // Show/hide code input based on gift requirements
            const codeGroup = document.querySelector('#claim-modal .form-group');
            if (gift.requireCode) {
                codeGroup.style.display = 'block';
                document.getElementById('claim-password').value = '';
            } else {
                codeGroup.style.display = 'none';
            }
            document.querySelector('#claim-modal .btn-gift').textContent = 'Claim Gift';

            document.getElementById('claim-modal').classList.add('visible');
        }

        // Claim gift
        async function claimGift() {
            const giftId = document.getElementById('claim-modal').dataset.giftId;
            const gift = plazaGifts.find(g => g.id === giftId);
            
            if (!gift) { alert('Gift not found'); return; }
            if (gift.claimed >= gift.shares) { alert('All shares claimed!'); return; }

            // Verify code if required
            if (gift.requireCode) {
                const inputCode = document.getElementById('claim-password').value.trim();
                if (inputCode !== gift.giftCode) {
                    alert('Wrong code! Try again.');
                    return;
                }
            }

            // In production, verify user meets requirements via Farcaster SDK
            if (gift.requirePro) {
                console.log('FC Pro required - would verify via Farcaster');
            }
            if (gift.minScore > 0) {
                console.log('Min score required:', gift.minScore);
            }

            closeClaimModal();
            showLoading('Claiming...');
            
            // Hide plaza and controls
            document.getElementById('gift-plaza').style.display = 'none';
            document.querySelector('.controls').style.display = 'none';

            // TODO: In production, call smart contract here
            // const password = document.getElementById('claim-password').value;
            // await contract.claimGift(giftId, password, isPro);
            
            // Calculate claim amount (demo)
            let claimAmount;
            if (gift.type === 'equal') {
                claimAmount = (parseFloat(gift.amount) / gift.shares).toFixed(6);
            } else {
                const remaining = gift.shares - gift.claimed;
                const remainingAmount = parseFloat(gift.amount) - gift.claimedBy.reduce((sum, c) => sum + parseFloat(c.amount || 0), 0);
                const maxAmount = remaining > 1 ? (remainingAmount * 2 / remaining) : remainingAmount;
                claimAmount = (Math.random() * maxAmount).toFixed(6);
            }

            // Update gift (demo - in production this comes from contract event)
            gift.claimed++;
            gift.claimedBy.push({
                fid: currentUser?.fid || Date.now(),
                username: currentUser?.username || 'guest',
                pfp: currentUser?.pfp || 'https://i.imgur.com/HeIi0wU.png',
                amount: claimAmount,
                at: Date.now()
            });
            localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));

            setTimeout(() => {
                hideLoading();
                document.getElementById('success-amount').textContent = claimAmount + ' ' + gift.token;
                document.getElementById('success-modal').classList.add('visible');
                
                // Scatter tree AFTER claim for impact
                setTimeout(() => {
                    if (window.scatterTree) window.scatterTree();
                }, 300);
                
                renderPlaza(); // Update plaza display
            }, 800);
        }

        // Shooting star effect
        let shootingStarInterval = null;
        
        function createShootingStar() {
            if (plazaMode) return;
            
            const star = document.createElement('div');
            star.className = 'shooting-star';
            star.style.top = (5 + Math.random() * 20) + '%';
            star.style.right = (-5 + Math.random() * 10) + '%';
            document.body.appendChild(star);
            
            setTimeout(() => star.remove(), 1500);
        }
        
        function startShootingStars() {
            if (shootingStarInterval) return;
            function scheduleNext() {
                const delay = 3000 + Math.random() * 5000;
                shootingStarInterval = setTimeout(() => {
                    createShootingStar();
                    scheduleNext();
                }, delay);
            }
            scheduleNext();
        }
        
        function stopShootingStars() {
            if (shootingStarInterval) {
                clearTimeout(shootingStarInterval);
                shootingStarInterval = null;
            }
        }
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            // Hide unused form fields
            const recipientGroup = document.getElementById('recipient-group');
            const passwordGroup = document.getElementById('password-group');
            const modeToggle = document.querySelector('.mode-toggle');
            const modeHint = document.getElementById('mode-hint');
            if (recipientGroup) recipientGroup.style.display = 'none';
            if (passwordGroup) passwordGroup.style.display = 'none';
            if (modeToggle) modeToggle.style.display = 'none';
            if (modeHint) modeHint.textContent = 'Gift will appear in the plaza for anyone to claim';

            // Show shares and distribution
            document.getElementById('shares-group').style.display = 'block';
            document.getElementById('distribution-group').style.display = 'block';

            // Try to get Farcaster user
            import('https://esm.sh/@farcaster/miniapp-sdk').then(async ({ sdk }) => {
                try {
                    const context = await sdk.context;
                    if (context?.user) {
                        currentUser = context.user;
                        console.log('Farcaster user:', currentUser.username);
                    }
                } catch (e) { console.log('Not in Farcaster frame'); }
            }).catch(() => {});

            // TEST MODE: Always add demo gifts (remove in production)
            plazaGifts = [
                // Direct gift for testing greeting card
                { id: 'testcard', title: 'üéÑ Merry Christmas!', message: 'Wishing you joy, peace and happiness this holiday season! Thank you for being an amazing friend.', token: 'USDC', amount: '5', shares: 1, type: 'equal', mode: 'direct', requirePro: false, minScore: 0, claimed: 0, claimedBy: [], recipient: { fid: 999, username: 'you' }, sender: { fid: 1, username: 'santa', pfp: 'https://i.imgur.com/JQjIxbJ.png' }, createdAt: Date.now() },
                { id: 'demo1', title: 'Merry Christmas!', token: 'ETH', amount: '0.01', shares: 5, type: 'equal', requirePro: false, minScore: 0, claimed: 0, claimedBy: [], sender: { fid: 1, username: 'santa', pfp: 'https://i.imgur.com/JQjIxbJ.png' }, createdAt: Date.now() },
                { id: 'demo2', title: 'Happy Holidays!', token: 'USDC', amount: '10', shares: 3, type: 'lucky', requirePro: true, minScore: 0, claimed: 0, claimedBy: [], sender: { fid: 2, username: 'rudolph', pfp: 'https://i.imgur.com/YqZmGqN.png' }, createdAt: Date.now() },
                { id: 'demo3', title: 'Season Greetings!', token: 'USDC', amount: '100', shares: 10, type: 'equal', requirePro: false, minScore: 0.5, claimed: 0, claimedBy: [], sender: { fid: 3, username: 'elf', pfp: 'https://i.imgur.com/8Km9tLL.png' }, createdAt: Date.now() },
                { id: 'demo4', title: 'Ho Ho Ho!', token: 'ETH', amount: '0.005', shares: 8, type: 'lucky', requirePro: false, minScore: 0, claimed: 0, claimedBy: [], sender: { fid: 4, username: 'frosty', pfp: 'https://i.imgur.com/5TYwK9x.png' }, createdAt: Date.now() },
                { id: 'demo5', title: 'Jingle Bells!', token: 'USDC', amount: '5', shares: 5, type: 'equal', requirePro: false, minScore: 0, claimed: 0, claimedBy: [], sender: { fid: 5, username: 'grinch', pfp: 'https://i.imgur.com/6NfNpVy.png' }, createdAt: Date.now() },
                { id: 'demo6', title: 'Happy New Year!', token: 'ETH', amount: '0.02', shares: 4, type: 'equal', requirePro: true, minScore: 0, claimed: 0, claimedBy: [], sender: { fid: 6, username: 'snowman', pfp: 'https://i.imgur.com/QWoJbWP.png' }, createdAt: Date.now() },
                { id: 'demo7', title: 'Winter Magic!', token: 'USDC', amount: '15', shares: 6, type: 'lucky', requirePro: false, minScore: 0.3, claimed: 0, claimedBy: [], sender: { fid: 7, username: 'reindeer', pfp: 'https://i.imgur.com/mCHMpLT.png' }, createdAt: Date.now() },
                { id: 'demo8', title: 'Festive Joy!', token: 'ETH', amount: '0.008', shares: 10, type: 'equal', requirePro: false, minScore: 0, claimed: 0, claimedBy: [], sender: { fid: 8, username: 'angel', pfp: 'https://i.imgur.com/HeIi0wU.png' }, createdAt: Date.now() },
                { id: 'demo9', title: 'Xmas Surprise!', token: 'USDC', amount: '25', shares: 5, type: 'lucky', requirePro: false, minScore: 0, claimed: 0, claimedBy: [], sender: { fid: 9, username: 'nutcracker', pfp: 'https://i.imgur.com/tB42KmJ.png' }, createdAt: Date.now() },
                { id: 'demo10', title: 'Holiday Cheer!', token: 'ETH', amount: '0.015', shares: 7, type: 'equal', requirePro: false, minScore: 0.2, claimed: 0, claimedBy: [], sender: { fid: 10, username: 'mrs_claus', pfp: 'https://i.imgur.com/LxW7IOK.png' }, createdAt: Date.now() }
            ];
            localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));
            
            // Check if user has gifts
            checkMyGifts();
            
            // Start shooting stars effect
            startShootingStars();
            
            // TEST: Add demo banner
            if (activeBanners.length === 0) {
                activeBanners = [{
                    id: 'demo1',
                    message: 'Merry Christmas!üîî',
                    sender: 'Santa',
                    expiresAt: Date.now() + 24 * 60 * 60 * 1000,
                    createdAt: Date.now()
                }];
            }
            
            // Check URL for gift parameter
            const urlParams = new URLSearchParams(window.location.search);
            const giftId = urlParams.get('gift');
            if (giftId) {
                setTimeout(() => {
                    const gift = plazaGifts.find(g => g.id === giftId);
                    if (gift && gift.mode === 'direct') {
                        showGreetingCard(gift);
                    } else if (gift) {
                        openClaimModal(giftId);
                    }
                }, 500);
            }
        });
    </script>
</body>
</html>