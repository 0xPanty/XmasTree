<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jingle Gift | Share the joy on Farcaster</title>
    
    <!-- Open Graph -->
    <meta property="og:title" content="Jingle Gift">
    <meta property="og:description" content="Interactive 3D Christmas Tree with Music">
    <meta property="og:image" content="https://xmas-tree-opal.vercel.app/preview.svg">
    
    <!-- Farcaster Mini App -->
    <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://xmas-tree-opal.vercel.app/preview.svg","button":{"title":"ðŸŽ Open","action":{"type":"launch_frame","name":"Jingle Gift","splashImageUrl":"https://xmas-tree-opal.vercel.app/icon.svg","splashBackgroundColor":"#0a1a0a"}}}' />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;1,400&family=Dancing+Script:wght@400;700&display=swap');

        :root {
            --emerald-dark: #001a10;
            --emerald: #023020;
            --gold: #D4AF37;
            --gold-light: #F7E7CE;
            --glass: rgba(20, 20, 20, 0.4);
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            font-family: 'Playfair Display', serif;
            color: var(--gold-light);
            overscroll-behavior: none;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* UI Overlay */
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 40px;
            box-sizing: border-box;
            background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.8) 100%);
            transition: background 1s ease;
        }

        .ui-hidden {
            opacity: 0 !important;
            pointer-events: none;
            transform: translateY(-20px);
        }
        
        .immersive-mode {
            background: transparent !important;
        }

        header {
            text-align: center;
            margin-top: 20px;
            pointer-events: auto;
            transition: all 1.2s cubic-bezier(0.19, 1, 0.22, 1);
        }

        h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: var(--gold);
            margin: 0;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
            opacity: 0;
            animation: fadeDown 1.5s ease-out forwards 0.5s;
        }

        .subtitle {
            font-size: 0.9rem;
            letter-spacing: 0.2em;
            color: rgba(255,255,255,0.6);
            margin-top: 10px;
            text-transform: uppercase;
            opacity: 0;
            animation: fadeDown 1.5s ease-out forwards 0.8s;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 20px;
            pointer-events: auto;
            opacity: 0;
            animation: fadeUp 1.5s ease-out forwards 1.2s;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-group {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: all 1s ease;
        }
        
        .btn-small {
            padding: 8px 16px !important;
            font-size: 0.85rem !important;
            min-width: auto !important;
        }

        button, .file-btn {
            background: var(--glass);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 15px 40px;
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            white-space: nowrap;
            touch-action: manipulation; 
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.4), transparent);
            transition: 0.5s;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            background: rgba(212, 175, 55, 0.2);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.3);
            transform: translateY(-2px);
        }

        button.active {
            background: var(--gold);
            color: var(--emerald-dark);
            box-shadow: 0 0 40px rgba(212, 175, 55, 0.6);
        }

        input[type="file"] {
            display: none;
        }

        /* --- Modal Styles --- */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .custom-modal.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* Stamp Loading Spinner */
        .stamp-loading-spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto;
            border: 4px solid rgba(212, 175, 55, 0.2);
            border-top: 4px solid var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite, pulse 2s ease-in-out infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 20px rgba(212, 175, 55, 0.3); }
            50% { opacity: 0.7; box-shadow: 0 0 40px rgba(212, 175, 55, 0.6); }
        }

        /* Stamp Shop Grid */
        .stamp-shop-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .stamp-card {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            gap: 16px;
            align-items: center;
            transition: all 0.3s ease;
        }

        .stamp-card:hover {
            border-color: var(--gold);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }

        .stamp-card img {
            width: 80px;
            height: 100px;
            object-fit: contain;
            border-radius: 8px;
            padding: 8px;
        }
        
        /* Horizontal scroll for stamp grid */
        #stamp-grid::-webkit-scrollbar {
            height: 6px;
        }
        #stamp-grid::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }
        #stamp-grid::-webkit-scrollbar-thumb {
            background: var(--gold);
            border-radius: 3px;
        }
        #stamp-grid::-webkit-scrollbar-thumb:hover {
            background: #FFD700;
        }

        .stamp-card-info {
            flex: 1;
            text-align: left;
        }

        .stamp-card-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--gold);
            margin-bottom: 6px;
        }

        .stamp-card-status {
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .stamp-card-status.eligible {
            color: #4ade80;
        }

        .stamp-card-status.locked {
            color: rgba(255,255,255,0.5);
        }

        .stamp-card-reason {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.6);
            margin-bottom: 12px;
        }

        .stamp-card button {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .stamp-card button.claim {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
        }

        .stamp-card button.buy {
            background: linear-gradient(135deg, #d4af37, #ffd700);
            color: #2c2c2c;
        }

        .stamp-card button.owned {
            background: rgba(212, 175, 55, 0.2);
            color: var(--gold);
            cursor: default;
        }

        .modal-box {
            background: rgba(2, 48, 32, 0.95);
            border: 1px solid var(--gold);
            padding: 30px 40px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            box-shadow: 0 0 60px rgba(212, 175, 55, 0.2);
            transform: translateY(20px);
            transition: transform 0.5s ease;
            text-align: center;
            max-width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .custom-modal.visible .modal-box {
            transform: translateY(0);
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .modal-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(212, 175, 55, 0.5);
            color: var(--gold-light);
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            padding: 10px;
            width: 300px;
            max-width: 100%;
            text-align: center;
            outline: none;
            transition: border-color 0.3s;
        }

        .modal-input:focus {
            border-bottom-color: var(--gold);
        }

        .modal-actions {
            margin-top: 20px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--gold);
            font-family: 'Cinzel', serif;
            letter-spacing: 0.2em;
            font-size: 0.8rem;
            animation: pulse 2s infinite;
            text-align: center;
            width: 100%;
        }

        @keyframes fadeDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        @keyframes toastFade { 0% { opacity: 0; transform: translateX(-50%) translateY(-10px); } 10% { opacity: 1; transform: translateX(-50%) translateY(0); } 90% { opacity: 1; } 100% { opacity: 0; } }

        /* --- Gift System Styles --- */
        .gift-form { display: flex; flex-direction: column; gap: 12px; }
        .form-group { text-align: left; }
        .form-group label { display: block; color: var(--gold); font-size: 0.75rem; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.1em; }
        .form-group input, .form-group select { width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.3); color: var(--gold-light); font-family: inherit; font-size: 0.9rem; box-sizing: border-box; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--gold); }
        .form-row { display: flex; gap: 10px; }
        .form-row .form-group { flex: 1; }
        .mode-toggle { display: flex; gap: 8px; margin-bottom: 12px; }
        .mode-btn { flex: 1; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.3); color: var(--gold); cursor: pointer; font-size: 0.75rem; transition: all 0.3s; }
        .mode-btn.active { background: var(--gold); color: var(--emerald-dark); }
        .type-toggle { display: flex; gap: 8px; }
        .type-btn { flex: 1; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.3); color: var(--gold); cursor: pointer; font-size: 0.7rem; }
        .type-btn.active { background: rgba(212,175,55,0.3); border-color: var(--gold); }
        .btn-gift { width: 100%; padding: 12px; background: linear-gradient(135deg, #D4AF37, #B8960C); border: none; color: var(--emerald-dark); font-family: 'Cinzel', serif; font-size: 0.85rem; cursor: pointer; margin-top: 8px; }
        .gift-preview { background: rgba(0,0,0,0.3); padding: 12px; margin-top: 8px; text-align: center; border: 1px dashed rgba(212,175,55,0.3); }
        .preview-amount { font-size: 1.3rem; color: var(--gold); font-weight: bold; }
        .preview-info { font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 4px; }
        .mode-hint { font-size: 0.7rem; color: rgba(255,255,255,0.4); text-align: center; margin-bottom: 8px; }
        .user-search-results { position: absolute; top: 100%; left: 0; right: 0; background: rgba(2,48,32,0.98); border: 1px solid var(--gold); max-height: 150px; overflow-y: auto; z-index: 10; }
        .user-result { display: flex; align-items: center; gap: 10px; padding: 8px 12px; cursor: pointer; transition: background 0.2s; }
        .user-result:hover { background: rgba(212,175,55,0.2); }
        .user-result img { width: 32px; height: 32px; border-radius: 50%; }
        .user-result .info { text-align: left; }
        .user-result .name { color: var(--gold); font-size: 0.85rem; }
        .user-result .username { color: rgba(255,255,255,0.5); font-size: 0.75rem; }
        .selected-user-card { display: flex; align-items: center; gap: 8px; background: rgba(212,175,55,0.1); border: 1px solid rgba(212,175,55,0.3); padding: 8px 12px; margin-top: 8px; }
        .selected-user-card img { width: 24px; height: 24px; border-radius: 50%; }
        .selected-user-card .remove-btn { margin-left: auto; background: none; border: none; color: #ff6b6b; cursor: pointer; font-size: 1.2rem; padding: 0 4px; }
        .claim-info { text-align: center; margin-bottom: 16px; }
        .claim-message { font-size: 1.1rem; color: var(--gold-light); margin-bottom: 8px; }
        .claim-amount { font-size: 1.5rem; color: var(--gold); font-weight: bold; }
        .claim-shares { font-size: 0.8rem; color: rgba(255,255,255,0.5); }

        /* --- Gift Plaza Styles --- */
        #gift-plaza {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 5;
            perspective: 800px;
        }
        .plaza-gift {
            position: absolute;
            width: clamp(24px, 3vw, 40px);
            height: clamp(24px, 3vw, 40px);
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            animation: orbit3d var(--orbit-duration, 15s) linear infinite;
            animation-delay: var(--orbit-delay, 0s);
            transform-style: preserve-3d;
            will-change: transform, opacity;
            backface-visibility: hidden;
        }
        .plaza-gift:hover {
            z-index: 100;
        }
        .plaza-gift:hover img {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(212,175,55,1);
        }
        .plaza-gift img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--gold);
            box-shadow: 0 0 10px rgba(212,175,55,0.8);
            transition: all 0.3s;
        }
        .plaza-gift .santa-emoji {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: clamp(10px, 1.5vw, 14px);
        }
        @keyframes orbit3d {
            0% { transform: rotateY(0deg) translateX(var(--orbit-radius, 180px)) rotateY(0deg); opacity: 1; z-index: 10; }
            25% { transform: rotateY(-90deg) translateX(var(--orbit-radius, 180px)) rotateY(90deg); opacity: 1; z-index: 10; }
            50% { transform: rotateY(-180deg) translateX(var(--orbit-radius, 180px)) rotateY(180deg); opacity: 0.3; z-index: 1; }
            75% { transform: rotateY(-270deg) translateX(var(--orbit-radius, 180px)) rotateY(270deg); opacity: 1; z-index: 10; }
            100% { transform: rotateY(-360deg) translateX(var(--orbit-radius, 180px)) rotateY(360deg); opacity: 1; z-index: 10; }
        }
        
        /* Plaza mode - smaller title */
        .title.plaza-mode {
            font-size: clamp(20px, 4vw, 36px) !important;
            margin-top: 2% !important;
        }
        .subtitle.plaza-mode {
            font-size: clamp(8px, 1.2vw, 12px) !important;
        }
        
        /* Plaza snowfall */
        #snowfall-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            overflow: hidden;
            display: none;
        }
        #snowfall-container.active { display: block; }
        .snow {
            position: absolute;
            top: -50px;
            color: #fff;
            opacity: 0.8;
            animation: snowFall linear infinite;
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
            will-change: transform;
            backface-visibility: hidden;
        }
        @keyframes snowFall {
            0% { transform: translate3d(0, -50px, 0) rotate(0deg); opacity: 0.8; }
            100% { transform: translate3d(0, 100vh, 0) rotate(360deg); opacity: 0.2; }
        }

        /* Background Shooting Star Effect */
        .bg-meteor-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            overflow: hidden;
        }
        .bg-meteor {
            position: absolute;
            width: var(--size, 4px);
            height: var(--size, 4px);
            background: radial-gradient(circle, #fff 0%, rgba(255,250,220,0.9) 40%, rgba(255,215,0,0.4) 70%, transparent 100%);
            border-radius: 50%;
            opacity: 0;
            box-shadow: 0 0 6px 2px rgba(255,255,255,0.8), 0 0 12px 4px rgba(255,215,0,0.5);
            animation: meteorFly var(--duration, 1s) linear forwards, meteorTwinkle 0.1s ease-in-out infinite;
            will-change: transform, opacity;
            backface-visibility: hidden;
        }
        @keyframes meteorFly {
            0% { opacity: 0; transform: translate3d(0, 0, 0) scale(1); }
            5% { opacity: 1; }
            85% { opacity: 0.9; }
            100% { opacity: 0; transform: translate3d(var(--travel-x, -120vw), var(--travel-y, 80vh), 0) scale(0.5); }
        }
        @keyframes meteorTwinkle {
            0%, 100% { box-shadow: 0 0 6px 2px rgba(255,255,255,0.8), 0 0 12px 4px rgba(255,215,0,0.5); }
            50% { box-shadow: 0 0 10px 4px rgba(255,255,255,1), 0 0 20px 8px rgba(255,215,0,0.8); }
        }

        
        .requirement-row { display: flex; align-items: center; gap: 8px; padding: 8px 0; }
        .requirement-row label { flex: 1; color: rgba(255,255,255,0.7); font-size: 0.8rem; }
        .requirement-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--gold); }
        .requirement-row input[type="number"] { width: 60px; padding: 4px 8px; }
        
        /* Gift Card Envelope (Cover) Styles */
        .gift-envelope {
            position: relative;
            width: 320px;
            max-width: 90vw;
            background: linear-gradient(145deg, #8B0000 0%, #5c0000 50%, #8B0000 100%);
            border: 4px solid #FFD700;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255,215,0,0.4), 0 10px 40px rgba(0,0,0,0.5), inset 0 0 60px rgba(0,0,0,0.3);
            animation: envelopeAppear 0.6s ease-out;
        }
        @keyframes envelopeAppear { 
            from { transform: scale(0.5) rotateY(-30deg); opacity: 0; } 
            to { transform: scale(1) rotateY(0); opacity: 1; } 
        }
        .envelope-inner {
            background: linear-gradient(145deg, #6B0000 0%, #4a0000 100%);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .envelope-tree {
            width: 120px;
            height: 120px;
            margin: 0 auto 12px;
            position: relative;
        }
        .envelope-tree svg {
            width: 100%;
            height: 100%;
            stroke: #FFD700;
            stroke-width: 1.5;
            fill: none;
        }
        .envelope-star {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            color: #FFD700;
            font-size: 20px;
            animation: starTwinkle 1.5s ease-in-out infinite;
        }
        @keyframes starTwinkle {
            0%, 100% { opacity: 0.7; transform: translateX(-50%) scale(1); }
            50% { opacity: 1; transform: translateX(-50%) scale(1.2); }
        }
        .envelope-sender {
            font-family: 'Great Vibes', 'Playfair Display', cursive, serif;
            font-size: 2rem;
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
            margin-bottom: 4px;
        }
        .envelope-gift-label {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            color: #FFD700;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            border-top: 1px solid rgba(255,215,0,0.3);
            padding-top: 8px;
            margin-top: 8px;
        }
        .envelope-open-btn {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.8);
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            letter-spacing: 0.15em;
            cursor: pointer;
            padding: 12px 24px;
            transition: all 0.3s;
        }
        .envelope-open-btn:hover {
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
        .envelope-dots {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #FFD700;
            border-radius: 50%;
            opacity: 0.6;
        }
        .envelope-dots.top-left { top: 12px; left: 12px; }
        .envelope-dots.top-right { top: 12px; right: 12px; }
        .envelope-dots.bottom-left { bottom: 12px; left: 12px; }
        .envelope-dots.bottom-right { bottom: 12px; right: 12px; }

        /* Card Cover Selector */
        .cover-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .cover-option {
            width: 52px;
            height: 70px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            overflow: hidden;
        }
        .cover-option.selected {
            border-color: var(--gold);
            box-shadow: 0 0 10px rgba(212,175,55,0.5);
        }
        .cover-preview {
            width: 100%;
            height: 100%;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        /* Cover 1: Red + Christmas Tree */
        .cover-1 {
            background: linear-gradient(180deg, #c41e3a 0%, #8b0000 100%);
        }
        .cover-1::before {
            content: '';
            position: absolute;
            bottom: 15px;
            width: 0; height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 20px solid #0d5c3f;
        }
        .cover-1::after {
            content: 'â˜…';
            position: absolute;
            top: 12px;
            color: #ffd700;
            font-size: 10px;
        }
        /* Cover 2: Green + Gold Dots */
        .cover-2 {
            background: #0d5c3f;
            background-image: radial-gradient(#ffd700 2px, transparent 2px);
            background-size: 10px 10px;
        }
        /* Cover 3: Mint + Window Tree */
        .cover-3 {
            background: #a8e6cf;
        }
        .cover-3::before {
            content: '';
            position: absolute;
            width: 28px; height: 36px;
            background: #fff;
            border-radius: 14px 14px 0 0;
            top: 10px;
        }
        .cover-3::after {
            content: '';
            position: absolute;
            top: 18px;
            width: 0; height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 14px solid #0d5c3f;
        }
        /* Cover 4: Red + Gold Star */
        .cover-4 {
            background: linear-gradient(180deg, #c41e3a 0%, #a01530 100%);
        }
        .cover-4::before {
            content: 'âœ¦';
            font-size: 32px;
            color: #f5deb3;
        }
        /* Cover 5: Pink Stripes */
        .cover-5 {
            background: repeating-linear-gradient(90deg, #ff6b9d 0px, #ff6b9d 8px, #0d5c3f 8px, #0d5c3f 16px, #c41e3a 16px, #c41e3a 24px);
        }
        .cover-5::before {
            content: '';
            position: absolute;
            width: 12px; height: 12px;
            background: #ffd700;
            border-radius: 50%;
            top: 12px;
        }
        /* Cover 6: Red Green Diamond */
        .cover-6 {
            background: 
                linear-gradient(135deg, #c41e3a 25%, transparent 25%),
                linear-gradient(225deg, #c41e3a 25%, transparent 25%),
                linear-gradient(45deg, #c41e3a 25%, transparent 25%),
                linear-gradient(315deg, #c41e3a 25%, #0d5c3f 25%);
            background-size: 20px 20px;
            background-position: 10px 0, 10px 0, 0 0, 0 0;
        }

        /* Full Card Cover Display */
        .card-cover {
            width: 280px;
            height: 380px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        .card-cover:hover { transform: scale(1.02); }
        
        /* Full Cover - Postcard Front with AI Image */
        .card-cover-1, .card-cover-2, .card-cover-3, .card-cover-4, .card-cover-5, .card-cover-6 {
            background: #fff;
            padding: 0;
            position: relative;
            overflow: hidden;
        }
        
        .card-cover-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        /* Postcard Stamp Style */
        .postcard-stamp {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 50px;
            height: 60px;
            background: linear-gradient(135deg, #fff 0%, #f5f5f5 100%);
            border: 2px dashed rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transform: rotate(5deg);
        }
        
        .postcard-stamp::after {
            content: 'âš˜';
            font-size: 0.7rem;
            color: #c41e3a;
            margin-top: 4px;
        }
        
        /* Farcaster Stamp for Preview - Vintage Style */
        .postcard-stamp-preview {
            position: absolute !important;
            top: 12px !important;
            right: 12px !important;
            width: 56px !important;
            height: 62px !important;
            background: linear-gradient(145deg, #7952b3 0%, #6940a8 50%, #5b3596 100%) !important;
            border: 3px solid #f5f5dc !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: space-between !important;
            padding: 6px 4px !important;
            box-shadow: 
                0 4px 12px rgba(0,0,0,0.4),
                inset 0 0 20px rgba(0,0,0,0.2) !important;
            transform: rotate(5deg) !important;
            z-index: 10 !important;
            pointer-events: none !important;
            /* Vintage stamp perforated edges */
            -webkit-mask: 
                radial-gradient(circle at 0% 0%, transparent 1.5px, black 1.5px) 0 0 / 6px 6px,
                radial-gradient(circle at 100% 0%, transparent 1.5px, black 1.5px) 100% 0 / 6px 6px,
                radial-gradient(circle at 0% 100%, transparent 1.5px, black 1.5px) 0 100% / 6px 6px,
                radial-gradient(circle at 100% 100%, transparent 1.5px, black 1.5px) 100% 100% / 6px 6px;
            mask: 
                radial-gradient(circle at 0% 0%, transparent 1.5px, black 1.5px) 0 0 / 6px 6px,
                radial-gradient(circle at 100% 0%, transparent 1.5px, black 1.5px) 100% 0 / 6px 6px,
                radial-gradient(circle at 0% 100%, transparent 1.5px, black 1.5px) 0 100% / 6px 6px,
                radial-gradient(circle at 100% 100%, transparent 1.5px, black 1.5px) 100% 100% / 6px 6px;
            color: #fff !important;
            font-weight: bold !important;
            text-align: center !important;
            font-family: 'Cinzel', serif;
            letter-spacing: 0.5px;
        }
        
        /* From Label on Front */
        .postcard-from-label {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: rgba(255,255,255,0.95);
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #333;
            font-family: 'Courier New', monospace;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border-left: 3px solid #c41e3a;
        }
        
        /* Full Cover 2: Green + Gold Dots */
        .card-cover-2 {
            background: #0d5c3f;
            color: #ffd700;
        }
        .card-cover-2::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: radial-gradient(#ffd700 4px, transparent 4px);
            background-size: 30px 30px;
            opacity: 0.8;
        }
        
        /* Full Cover 3: Mint + Arch Window */
        .card-cover-3 {
            background: #a8e6cf;
            color: #0d5c3f;
        }
        .card-cover-3 .cover-art {
            width: 140px; height: 180px;
            background: #fff;
            border-radius: 70px 70px 0 0;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }
        .card-cover-3 .cover-art::before {
            content: '';
            position: absolute;
            bottom: 20px;
            width: 0; height: 0;
            border-left: 40px solid transparent;
            border-right: 40px solid transparent;
            border-bottom: 70px solid #0d5c3f;
        }
        
        /* Full Cover 4: Red + Big Star */
        .card-cover-4 {
            background: linear-gradient(180deg, #c41e3a 0%, #a01530 100%);
            color: #f5deb3;
        }
        .card-cover-4 .cover-art {
            font-size: 120px;
            color: #f5deb3;
            text-shadow: 0 5px 20px rgba(0,0,0,0.3);
            line-height: 1;
        }
        
        /* Full Cover 5: Pink/Green Stripes */
        .card-cover-5 {
            background: repeating-linear-gradient(90deg, 
                #ff6b9d 0px, #ff6b9d 30px, 
                #0d5c3f 30px, #0d5c3f 60px, 
                #c41e3a 60px, #c41e3a 90px);
            color: #fff;
        }
        .card-cover-5::before {
            content: '';
            position: absolute;
            width: 40px; height: 40px;
            background: #ffd700;
            border-radius: 50%;
            top: 40px; right: 50px;
            box-shadow: -60px 80px 0 30px #ffd700, 40px 120px 0 20px #90EE90;
        }
        
        /* Full Cover 6: Diamond Pattern */
        .card-cover-6 {
            background-color: #c41e3a;
            background-image: 
                linear-gradient(135deg, #0d5c3f 25%, transparent 25%),
                linear-gradient(225deg, #0d5c3f 25%, transparent 25%),
                linear-gradient(45deg, #0d5c3f 25%, transparent 25%),
                linear-gradient(315deg, #0d5c3f 25%, transparent 25%);
            background-size: 60px 60px;
            background-position: 30px 0, 30px 0, 0 0, 0 0;
            color: #ffd700;
        }
        
        .card-cover-title {
            font-size: 1.6rem;
            font-weight: bold;
            margin: 16px 0 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
            font-family: 'Georgia', serif;
        }
        .card-cover-from {
            font-size: 0.95rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        .card-cover-tap {
            margin-top: 20px;
            font-size: 0.8rem;
            opacity: 0.7;
            animation: pulse 2s infinite;
            position: relative;
            z-index: 1;
        }

        /* Gift Card Container - 3D flip */
        .gift-card-container {
            width: 280px;
            height: 380px;
            position: relative;
            perspective: 1000px;
        }
        .gift-card-container .card-cover {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            backface-visibility: hidden;
            transition: transform 0.8s ease;
            transform-style: preserve-3d;
        }
        .gift-card-container .card-inside {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            backface-visibility: hidden;
            transform: rotateY(180deg);
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        .gift-card-container.opened .card-cover {
            transform: rotateY(-180deg);
        }
        .gift-card-container.opened .card-inside {
            transform: rotateY(0deg);
        }
        
        /* Card Inside - Postcard Back Style */
        .card-inside {
            background: linear-gradient(135deg, 
                #f9f6f0 0%, 
                #f5f0e8 50%, 
                #f0ead9 100%) !important;
            padding: 24px !important;
            position: relative;
        }
        
        /* Vintage Paper Texture */
        .card-inside::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.02) 2px, rgba(0,0,0,0.02) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,0.02) 2px, rgba(0,0,0,0.02) 4px);
            pointer-events: none;
            opacity: 0.5;
        }
        
        .card-inside-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            color: #8b4513;
        }
        
        /* Hide image on back, only show on front */
        .card-content-row {
            display: none !important;
        }
        
        /* Postcard Back Header */
        .postcard-header {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        /* Handwritten Style Message */
        .card-inside-greeting {
            font-family: 'Dancing Script', cursive, 'Georgia', serif;
            font-size: 1.1rem;
            line-height: 2;
            color: #2c2c2c;
            text-align: left;
            padding: 20px;
            background: transparent;
            border: none;
            margin-bottom: 24px;
            min-height: 120px;
            position: relative;
            z-index: 1;
        }
        
        /* Handwritten lines effect */
        .card-inside-greeting::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: repeating-linear-gradient(
                transparent,
                transparent 38px,
                rgba(200,180,150,0.3) 38px,
                rgba(200,180,150,0.3) 40px
            );
        }
        .card-inside-amount {
            color: #ffd700;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 12px;
        }
        .card-inside-claim {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
        }

        /* AI Generated Card Content Styles */
        .ai-card-content {
            position: relative;
            width: 340px;
            max-width: 90vw;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 0 40px rgba(255,215,0,0.3), 0 15px 50px rgba(0,0,0,0.5);
            animation: cardReveal 0.8s ease-out;
        }
        @keyframes cardReveal {
            from { transform: scale(0.8) rotateY(90deg); opacity: 0; }
            to { transform: scale(1) rotateY(0); opacity: 1; }
        }
        .ai-card-image {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .ai-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .ai-card-loading {
            color: #FFD700;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        .ai-card-loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,215,0,0.2);
            border-top-color: #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .ai-card-avatars {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .ai-card-avatars img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid #FFD700;
            box-shadow: 0 0 10px rgba(255,215,0,0.4);
        }
        .ai-card-greeting {
            color: #fff;
            font-size: 1rem;
            line-height: 1.6;
            font-style: italic;
            padding: 12px;
            background: rgba(255,215,0,0.1);
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .ai-card-amount {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            color: #FFD700;
            margin-bottom: 16px;
        }
        .ai-card-claim-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            border-radius: 8px;
            color: #1a1a2e;
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .ai-card-claim-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255,215,0,0.4);
        }

        /* Greeting Card Styles (legacy) */
        .greeting-card {
            position: relative;
            background: linear-gradient(135deg, #1a472a 0%, #0d2818 50%, #1a472a 100%);
            border: 3px solid var(--gold);
            border-radius: 16px;
            padding: 32px 24px;
            max-width: 340px;
            text-align: center;
            box-shadow: 0 0 40px rgba(212,175,55,0.3), inset 0 0 60px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: cardAppear 0.5s ease-out;
        }
        @keyframes cardAppear { from { transform: scale(0.8) rotateY(-20deg); opacity: 0; } to { transform: scale(1) rotateY(0); opacity: 1; } }
        @keyframes cardOpen { 
            0% { transform: perspective(1000px) rotateX(0); }
            50% { transform: perspective(1000px) rotateX(-90deg); }
            100% { transform: perspective(1000px) rotateX(-180deg) scale(0.8); opacity: 0; }
        }
        .greeting-card.opening { animation: cardOpen 1s ease-in-out forwards; }
        
        /* Christmas confetti burst */
        .confetti-container {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
            animation: confettiFall 3s ease-out forwards;
        }
        @keyframes confettiFall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .card-sparkles {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.8), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(212,175,55,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.6), transparent),
                radial-gradient(2px 2px at 130px 80px, rgba(212,175,55,0.6), transparent),
                radial-gradient(2px 2px at 200px 50px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 250px 90px, rgba(212,175,55,0.6), transparent);
            animation: sparkle 2s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes sparkle { 0%,100% { opacity: 0.5; } 50% { opacity: 1; } }
        .card-header { margin-bottom: 16px; }
        .card-avatar {
            width: 64px; height: 64px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            margin-bottom: 8px;
            box-shadow: 0 0 15px rgba(212,175,55,0.5);
        }
        .card-from { color: rgba(255,255,255,0.7); font-size: 0.9rem; }
        .card-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(212,175,55,0.5);
            margin: 16px 0;
        }
        .card-message {
            color: #fff;
            font-size: 1rem;
            line-height: 1.6;
            padding: 16px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            border-left: 3px solid var(--gold);
            margin: 16px 0;
            font-style: italic;
        }
        .card-gift {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 16px;
        }
        .card-gift-icon {
            font-size: 2.5rem;
            animation: bounce 1s ease-in-out infinite;
        }
        @keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .card-amount {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--gold);
        }
        
        /* Tip amount buttons */
        .tip-amt-btn {
            flex: 1;
            padding: 8px;
            background: rgba(212,175,55,0.2);
            border: 1px solid var(--gold);
            color: var(--gold);
            cursor: pointer;
            transition: all 0.2s;
        }
        .tip-amt-btn:hover { background: rgba(212,175,55,0.4); }
        
        /* Mailbox button */
        .mailbox-btn {
            font-size: 1.8rem !important;
            padding: 8px 16px !important;
            background: rgba(212,175,55,0.1) !important;
        }
        .mailbox-btn.has-gift {
            animation: mailGlow 1.5s ease-in-out infinite;
        }
        @keyframes mailGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(212,175,55,0.5), 0 0 20px rgba(212,175,55,0.3); }
            50% { box-shadow: 0 0 20px rgba(212,175,55,0.8), 0 0 40px rgba(212,175,55,0.5), 0 0 60px rgba(212,175,55,0.3); }
        }
        
        

        /* --- MOBILE RESPONSIVE STYLES --- */
        @media (max-width: 768px) {
            #ui {
                padding: 20px;
                padding-bottom: 30px; 
            }

            h1 {
                font-size: 1.8rem;
                letter-spacing: 0.15em;
            }

            .subtitle {
                font-size: 0.75rem;
            }

            .controls {
                flex-direction: column;
                width: 100%;
                gap: 12px;
                align-items: stretch;
                padding-bottom: 20px;
            }

            .btn-group {
                width: 100%;
            }

            button {
                width: 100%;
                padding: 12px 0;
                font-size: 0.9rem;
            }

            .modal-box {
                padding: 24px 16px;
                width: 92%;
                max-height: 80vh;
            }
            
            .modal-input {
                width: 100%;
                font-size: 1rem;
            }
        }
    </style>
    <!-- React & Three Imports -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
                "three": "https://esm.sh/three@0.160.0",
                "@react-three/fiber": "https://esm.sh/@react-three/fiber@8.15.12?external=react,react-dom,three",
                "@react-three/drei": "https://esm.sh/@react-three/drei@9.96.1?external=react,react-dom,three,@react-three/fiber",
                "@react-three/postprocessing": "https://esm.sh/@react-three/postprocessing@2.16.0?external=react,react-dom,three,@react-three/fiber",
                "uuid": "https://esm.sh/uuid@9.0.1"
            }
        }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Ethers.js for Web3 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
    <!-- thirdweb SDK -->
    <script src="https://cdn.jsdelivr.net/npm/thirdweb@5/dist/thirdweb.umd.js"></script>
    <script>
        // Contract Configuration
        const CONTRACT_ADDRESS = '0x5307bFc2F5bB5efC858622aDcAeE60619C51b884';
        const BASE_CHAIN_ID = 8453;
        const CONTRACT_ABI = [
            "function createGiftETH(uint256 shares, bytes32 passwordHash, uint8 giftType, bool proOnly, string title, uint256 duration) payable returns (uint256)",
            "function createGiftToken(address token, uint256 amount, uint256 shares, bytes32 passwordHash, uint8 giftType, bool proOnly, string title, uint256 duration) returns (uint256)",
            "function claimGift(uint256 giftId, string password, bool isPro)",
            "function refundGift(uint256 giftId)",
            "function getGift(uint256 giftId) view returns (address creator, address token, uint256 totalAmount, uint256 remainingAmount, uint256 totalShares, uint256 claimedShares, uint8 giftType, bool proOnly, string title, uint256 expireTime, bool active)",
            "function hasUserClaimed(uint256 giftId, address user) view returns (bool)",
            "function getUserClaimedAmount(uint256 giftId, address user) view returns (uint256)",
            "function giftCount() view returns (uint256)",
            "event GiftCreated(uint256 indexed giftId, address indexed creator, address token, uint256 totalAmount, uint256 shares, uint8 giftType, string title)",
            "event GiftClaimed(uint256 indexed giftId, address indexed claimer, uint256 amount)"
        ];
        
        // ERC20 ABI for token approvals
        const ERC20_ABI = [
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function balanceOf(address account) view returns (uint256)",
            "function decimals() view returns (uint8)"
        ];

        // Web3 State
        let web3Provider = null;
        let web3Signer = null;
        let giftContract = null;
        let connectedAddress = null;

        // Connect Wallet (using Farcaster SDK)
        async function connectWallet() {
            try {
                // Get Farcaster SDK
                const sdk = window.farcasterSDK;
                if (!sdk) {
                    alert('ðŸ” Farcaster SDK not available\n\nPlease open this app in the Farcaster mobile app.');
                    return false;
                }
                
                console.log('ðŸ”— Getting Ethereum provider from Farcaster SDK...');
                
                // Get Ethereum provider from Farcaster
                const provider = await sdk.wallet.getEthereumProvider();
                if (!provider) {
                    alert('âŒ Wallet not available\n\nPlease try again or check your Farcaster app settings.');
                    return false;
                }
                
                // Create ethers provider
                web3Provider = new ethers.BrowserProvider(provider);
                
                // Request accounts
                const accounts = await provider.request({ method: 'eth_requestAccounts' });
                if (!accounts || accounts.length === 0) {
                    alert('âŒ No accounts found\n\nPlease make sure your wallet is connected in Farcaster.');
                    return false;
                }
                
                console.log('âœ… Wallet connected:', accounts[0]);
                
                // Check network
                const network = await web3Provider.getNetwork();
                if (Number(network.chainId) !== BASE_CHAIN_ID) {
                    try {
                        await provider.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x' + BASE_CHAIN_ID.toString(16) }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            // Chain not added, try to add it
                            await provider.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x' + BASE_CHAIN_ID.toString(16),
                                    chainName: 'Base',
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: ['https://mainnet.base.org'],
                                    blockExplorerUrls: ['https://basescan.org']
                                }]
                            });
                        } else {
                            throw switchError;
                        }
                    }
                    // Recreate provider after network switch
                    web3Provider = new ethers.BrowserProvider(provider);
                }
                
                web3Signer = await web3Provider.getSigner();
                connectedAddress = await web3Signer.getAddress();
                giftContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, web3Signer);
                
                // Update UI
                const walletBtn = document.getElementById('wallet-btn');
                if (walletBtn) {
                    walletBtn.textContent = connectedAddress.slice(0, 6) + '...' + connectedAddress.slice(-4);
                    walletBtn.classList.add('connected');
                }
                
                console.log('âœ… Wallet setup complete:', connectedAddress);
                return true;
            } catch (error) {
                console.error('âŒ Wallet connection failed:', error);
                alert('Failed to connect wallet: ' + error.message);
                return false;
            }
        }

        // Hash password for contract
        function hashPassword(password) {
            return ethers.keccak256(ethers.toUtf8Bytes(password));
        }
    </script>
</head>
<body>
    <!-- Create Gift Modal -->
    <div id="gift-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 400px;">
            <div class="modal-title">ðŸŽ Send Christmas Gift</div>
            
            <!-- Plaza Gift Explanation -->
            <div id="plaza-explanation" style="background: rgba(212,175,55,0.1); border: 1px solid rgba(212,175,55,0.3); border-radius: 8px; padding: 12px; margin-bottom: 16px; display: none;">
                <div style="display: flex; align-items: start; gap: 10px;">
                    <span style="font-size: 1.5rem; line-height: 1;">ðŸŽ„</span>
                    <div style="flex: 1;">
                        <div style="color: var(--gold); font-weight: bold; font-size: 0.85rem; margin-bottom: 6px;">
                            How Plaza Gifts Work
                        </div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 0.75rem; line-height: 1.5;">
                            â€¢ Your gift will appear as a <strong style="color: var(--gold);">glowing ornament</strong> on the Christmas tree<br>
                            â€¢ Anyone in the Farcaster community can discover and claim it<br>
                            â€¢ Gifts are distributed based on your chosen method (equal split or lucky draw)<br>
                            â€¢ Spread joy and surprise to the community! ðŸŽâœ¨
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="selectGiftMode('direct')">ðŸŽ¯ Direct Gift</button>
                <button class="mode-btn" onclick="selectGiftMode('redpacket')">ðŸ§§ Red Packet</button>
            </div>
            <div class="mode-hint" id="mode-hint">Send directly to specific Farcaster user(s)</div>
            <div class="gift-form">
                <div class="form-group" id="recipient-group" style="position:relative;">
                    <label>Recipient (max 10)</label>
                    <input type="text" id="gift-recipient" placeholder="Search Farcaster username..." oninput="searchUsersPlaza(this.value)">
                    <div id="plaza-user-results" class="user-search-results" style="display:none;"></div>
                    <div id="selected-user"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Token</label>
                        <select id="gift-token" onchange="togglePlazaCustomToken()">
                            <option value="USDC">USDC</option>
                            <option value="ETH">ETH</option>
                            <option value="CUSTOM">Custom Token</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="gift-amount" value="0.1" step="0.01" min="0.1" oninput="validatePlazaAmount(); updatePreview()">
                    </div>
                </div>
                <div class="form-group" id="plaza-custom-token-group" style="display:none;">
                    <label>Token Contract Address (Base)</label>
                    <input type="text" id="plaza-token-ca" placeholder="0x..." style="font-size:0.8rem;">
                </div>
                <div class="form-group" id="shares-group" style="display:none;">
                    <label>Number of Shares</label>
                    <input type="number" id="gift-shares" value="5" min="1" max="100" oninput="updatePreview()">
                </div>
                <div class="form-group" id="distribution-group" style="display:none;">
                    <label>Distribution Type</label>
                    <div class="type-toggle">
                        <button type="button" class="type-btn active" onclick="selectGiftType('equal')">Equal Split</button>
                        <button type="button" class="type-btn" onclick="selectGiftType('lucky')">Lucky Draw</button>
                    </div>
                </div>
                <div class="form-group" id="requirements-group">
                    <label>Claim Requirements</label>
                    <div class="requirement-row">
                        <label>Require Code</label>
                        <input type="checkbox" id="require-code" onchange="toggleCodeInput(); updatePreview();">
                    </div>
                    <div class="requirement-row" id="code-input-row" style="display:none;">
                        <label>Secret Code</label>
                        <input type="text" id="gift-code" placeholder="e.g. XMAS2024" maxlength="20" style="width:100px;">
                    </div>
                    <div class="requirement-row">
                        <label>Require Farcaster Pro</label>
                        <input type="checkbox" id="require-pro" onchange="updatePreview()">
                    </div>
                    <div class="requirement-row">
                        <label>Min Neynar Score</label>
                        <input type="number" id="min-score" placeholder="0" min="0" max="1" step="0.01" value="0" oninput="updatePreview()">
                    </div>
                </div>
                <div class="gift-preview">
                    <div class="preview-amount" id="preview-amount">0 ETH</div>
                    <div class="preview-info" id="preview-info">Select recipient(s) above</div>
                </div>
                <button class="btn-gift" onclick="createGift()">Create Gift</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeGiftModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Claim Gift Modal -->
    <div id="claim-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 350px;">
            <div class="modal-title">ðŸŽ Christmas Gift!</div>
            <div class="claim-info">
                <div class="claim-message" id="claim-message">Someone sent you a gift!</div>
                <div id="claim-recipient" style="margin-bottom:8px;"></div>
                <div class="claim-amount">ðŸ’° <span id="claim-remaining">0</span></div>
                <div class="claim-shares">Claimed: <span id="claim-shares">0/0</span></div>
            </div>
            <div class="gift-form">
                <div class="form-group">
                    <label>Enter Password</label>
                    <input type="text" id="claim-password" placeholder="Enter claim code">
                </div>
                <button class="btn-gift" onclick="claimGift()">Claim Gift</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeClaimModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Gift Card with Cover + Inside -->
    <div id="envelope-modal" class="custom-modal">
        <div class="gift-card-container" id="gift-card-container">
            <!-- Inside (Postcard Back) -->
            <div class="card-inside" id="card-inside">
                <div class="card-inside-loading" id="card-inside-loading">
                    <div class="spinner"></div>
                    <div>Creating your vintage postcard...</div>
                </div>
                <!-- Postcard Back Header -->
                <div class="postcard-header" id="postcard-header" style="display:none;">
                    <div>POSTCARD</div>
                    <div style="margin-top:4px;">To: <span id="card-recipient-name">You</span></div>
                </div>
                <!-- Hidden row (not used in postcard back) -->
                <div class="card-content-row" id="card-content-row" style="display:none;">
                    <img id="card-inside-image" src="" alt="AI Card">
                    <div class="card-inside-greeting-old" id="card-inside-greeting-old"></div>
                </div>
                <!-- Handwritten Message -->
                <div class="card-inside-greeting" id="card-inside-greeting"></div>
                
                <!-- Double-sided Postcard Preview (for personalized gifts) -->
                <div id="card-postcard-preview" style="display:none; margin:20px 0;">
                    <div style="perspective:1500px; cursor:pointer;" onclick="flipCardPostcard()">
                        <div id="card-postcard-flipper" style="position:relative; width:100%; height:400px; transition:transform 0.8s; transform-style:preserve-3d;">
                            <!-- Picture Side (Front - Shows First) -->
                            <img id="card-postcard-front" src="" style="position:absolute; width:100%; height:100%; object-fit:contain; backface-visibility:hidden; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
                            <!-- Letter Content Side (Back - Flip to See) -->
                            <img id="card-postcard-back" src="" style="position:absolute; width:100%; height:100%; object-fit:contain; backface-visibility:hidden; transform:rotateY(180deg); border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
                        </div>
                    </div>
                    <div id="card-flip-hint" style="text-align:center; margin-top:12px; font-size:0.9rem; color:#8b4513;">
                        ðŸ‘‰ Click to see the message inside
                    </div>
                </div>
                
                <!-- Gift Icon (clickable to reveal amount) -->
                <div id="gift-icon-wrapper" style="display:none; text-align:center; padding:24px 0; cursor:pointer;" onclick="revealGift()">
                    <div style="font-size:4rem; animation:pulse 2s infinite;">ðŸŽ</div>
                    <div style="font-size:0.9rem; color:#8b4513; margin-top:8px;">Tap to see your gift</div>
                </div>
                
                <!-- Gift Details (hidden initially) -->
                <div id="gift-details-wrapper" style="display:none;">
                    <div class="card-inside-amount" id="card-inside-amount" style="background: linear-gradient(135deg, #c41e3a, #8b0000); color: #fff; padding: 16px; border-radius: 8px; text-align: center; font-size: 1.1rem; margin-bottom: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">ðŸŽ 0.5 USDC</div>
                    <button class="card-inside-claim" onclick="claimAICardGift()" style="width:100%; padding: 14px; background: linear-gradient(135deg, #d4af37, #ffd700); border: none; border-radius: 8px; color: #2c2c2c; font-weight: bold; cursor: pointer; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.05em;">Open Gift</button>
                </div>
                
                <!-- Reply Button -->
                <button id="reply-card-btn" onclick="openReplyModal()" style="width:100%; padding:12px; margin-top:8px; background:linear-gradient(135deg, #8b4513, #a0522d); border:none; color:#fff; border-radius:8px; cursor:pointer; font-weight:bold; display:none;">
                    ðŸ’Œ Reply Card
                </button>
                
                <button onclick="closeCardModal()" style="width:100%; padding:10px; margin-top:8px; background:transparent; border:1px solid rgba(139,69,19,0.3); color:#8b4513; border-radius:8px; cursor:pointer; font-family: 'Courier New', monospace;">Close</button>
            </div>
            <!-- Cover (Postcard Front with AI Image) -->
            <div id="card-cover-display" class="card-cover card-cover-1" onclick="openEnvelopeCard()">
                <!-- AI Generated Vintage Image -->
                <img id="card-cover-ai-image" class="card-cover-image" src="" alt="Vintage Christmas" style="display:none;">
                <!-- Loading state for cover -->
                <div id="card-cover-loading" style="display:flex; align-items:center; justify-content:center; height:100%; background: linear-gradient(135deg, #f5deb3, #daa520);">
                    <div style="text-align:center; color:#8b4513;">
                        <div style="font-size:3rem; margin-bottom:12px;">ðŸŽ„</div>
                        <div style="font-family: 'Cinzel', serif; font-size:0.9rem;">Tap to open</div>
                    </div>
                </div>
                <!-- Postcard Stamp -->
                <div class="postcard-stamp">ðŸŽ„</div>
                <!-- From Label -->
                <div class="postcard-from-label" id="postcard-from-label">From: @someone</div>
            </div>
        </div>
    </div>

    <!-- AI Generated Card Modal -->
    <div id="ai-card-modal" class="custom-modal">
        <div class="ai-card-content">
            <div class="ai-card-avatars">
                <img id="ai-card-sender-avatar" src="" alt="Sender">
                <img id="ai-card-recipient-avatar" src="" alt="Recipient">
            </div>
            <div class="ai-card-image" id="ai-card-image">
                <div class="ai-card-loading" id="ai-card-loading">
                    <div class="spinner"></div>
                    <div>Creating your magical Christmas card...</div>
                </div>
            </div>
            <div class="ai-card-greeting" id="ai-card-greeting">Loading greeting...</div>
            <div class="ai-card-amount" id="ai-card-amount">ðŸŽ 0.01 ETH</div>
            <button class="ai-card-claim-btn" onclick="claimAICardGift()">Claim Gift</button>
            <button style="background:transparent; border:1px solid rgba(255,215,0,0.3); color:#FFD700; padding:10px; margin-top:8px; cursor:pointer; width:100%; border-radius:8px;" onclick="closeAICardModal()">Close</button>
        </div>
    </div>



    <!-- Legacy Greeting Card Modal (for fallback) -->
    <div id="card-modal" class="custom-modal">
        <div class="greeting-card">
            <div class="card-sparkles"></div>
            <div class="card-header">
                <img id="card-sender-pfp" src="" class="card-avatar">
                <div class="card-from">From @<span id="card-sender-name">sender</span></div>
            </div>
            <div class="card-title" id="card-title">Merry Christmas!</div>
            <div class="card-message" id="card-message">Wishing you joy and happiness!</div>
            <div class="card-gift">
                <div class="card-gift-icon">ðŸŽ</div>
                <div class="card-amount" id="card-amount">0.01 ETH</div>
            </div>
            <button class="btn-gift" onclick="claimCardGift()" style="margin-top:16px;">Open Gift</button>
        </div>
    </div>

    <!-- Confirmation Modal (AI Preview before sending) -->
    <div id="confirm-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 380px; background: rgba(0,26,10,0.95);">
            <div class="modal-title" style="color: var(--gold); margin-bottom: 16px;">ðŸ“® ç¡®è®¤å‘é€ä½ çš„åœ£è¯žè´ºå¡</div>
            
            <!-- AI Generated Image Preview -->
            <div style="width: 100%; aspect-ratio: 9/16; border-radius: 12px; overflow: hidden; margin-bottom: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.4);">
                <img id="confirm-ai-image" src="" alt="Vintage Postcard" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            
            <!-- Gift Info -->
            <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.2); border-radius: 8px; padding: 16px; margin-bottom: 16px; text-align: left;">
                <div style="font-size: 1.1rem; color: var(--gold); margin-bottom: 8px;" id="confirm-title">Merry Christmas!</div>
                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 12px; font-style: italic;" id="confirm-message">Your message...</div>
                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.5); margin-bottom: 8px;">
                    <strong style="color: var(--gold);">å°†å‘é€ç»™:</strong> <span id="confirm-recipients">@alice, @bob</span>
                </div>
                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.5);">
                    <strong style="color: var(--gold);">å…±<span id="confirm-count">2</span>äººï¼Œæ¯äºº:</strong> <span id="confirm-amount">0.5 USDC</span>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px;">
                <button onclick="regeneratePostcard()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: #fff; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    ðŸ”„ é‡æ–°ç”Ÿæˆ
                </button>
                <button onclick="confirmSendGift()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #d4af37, #ffd700); border: none; color: #2c2c2c; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    âœ… ç¡®è®¤å‘é€
                </button>
            </div>
            <button onclick="closeConfirmModal()" style="width: 100%; padding: 10px; margin-top: 12px; background: transparent; border: 1px solid rgba(255,215,0,0.3); color: var(--gold); border-radius: 8px; cursor: pointer;">
                å–æ¶ˆ
            </button>
        </div>
    </div>

    <!-- Reply Modal -->
    <div id="reply-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 420px; background: rgba(0,26,10,0.95);">
            <div class="modal-title" style="color: var(--gold); margin-bottom: 16px;">ðŸ’Œ Reply to <span id="reply-to-name">@sender</span></div>
            
            <!-- Original Message Context -->
            <div style="background: rgba(0,0,0,0.3); border-left: 3px solid var(--gold); padding: 12px; margin-bottom: 16px; border-radius: 4px;">
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-bottom: 6px;">Original message:</div>
                <div id="reply-original-message" style="font-size: 0.85rem; color: rgba(255,255,255,0.8); font-style: italic;"></div>
            </div>
            
            <!-- AI Generated Reply Preview -->
            <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.2); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 8px;">ðŸ’¬ AI Generated Reply:</div>
                <div id="reply-generated-text" style="font-family:'Dancing Script', cursive; font-size: 1rem; color:#ffd700; line-height: 1.8; min-height: 80px;">
                    Generating your reply...
                </div>
            </div>
            
            <!-- Gift Money Option for Reply -->
            <div class="form-group">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                    <input type="checkbox" id="reply-include-gift" style="width:18px; height:18px; cursor:pointer;">
                    <span>Include Return Gift</span>
                </label>
            </div>
            
            <!-- Reply Gift Amount (conditional) -->
            <div id="reply-gift-section" style="display:none; margin-bottom: 16px;">
                <div style="display:flex; gap:12px;">
                    <div class="form-group" style="flex:1;">
                        <label>Token</label>
                        <select id="reply-gift-token" style="width:100%;">
                            <option value="USDC">USDC</option>
                            <option value="ETH">ETH</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>Amount</label>
                        <input type="number" id="reply-gift-amount" value="0.5" min="0.1" step="0.1" style="width:100%;">
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px;">
                <button onclick="regenerateReply()" style="flex: 1; padding: 12px; background: rgba(102,126,234,0.2); border: 1px solid #667eea; color: #667eea; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    ðŸ”„ Regenerate
                </button>
                <button onclick="confirmSendReply()" style="flex: 2; padding: 12px; background: linear-gradient(135deg, #d4af37, #ffd700); border: none; color: #2c2c2c; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    âœ… Send Reply (FREE)
                </button>
            </div>
            <button onclick="closeReplyModal()" style="width: 100%; padding: 10px; margin-top: 12px; background: transparent; border: 1px solid rgba(255,215,0,0.3); color: var(--gold); border-radius: 8px; cursor: pointer;">
                Cancel
            </button>
        </div>
    </div>

    <!-- Stamp Preview Modal -->
    <div id="stamp-preview-modal" class="custom-modal" style="background: rgba(0, 26, 16, 0.98);">
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; text-align: center;">
            <!-- Close button -->
            <button onclick="closeStampPreview()" style="position: absolute; top: -50px; right: 0; background: transparent; border: 2px solid var(--gold); color: var(--gold); width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center;">Ã—</button>
            
            <!-- Stamp large image -->
            <div style="background: #001a10; border-radius: 16px; padding: 30px; margin-bottom: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
                <img id="stamp-preview-image" src="" alt="Stamp Preview" style="width: 100%; max-width: 300px; height: auto; object-fit: contain; margin: 0 auto; display: block;">
            </div>
            
            <!-- Stamp info -->
            <div style="background: rgba(0,0,0,0.5); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                <div id="stamp-preview-name" style="font-size: 1.5rem; font-weight: bold; color: var(--gold); margin-bottom: 12px;">Neynar Stamp</div>
                <div id="stamp-preview-reason" style="font-size: 0.95rem; color: rgba(255,255,255,0.8); line-height: 1.6;">Loading...</div>
            </div>
            
            <!-- Action button -->
            <div id="stamp-preview-action"></div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="custom-modal" style="background: rgba(0,0,0,0.3); backdrop-filter: none;">
        <div class="modal-box" style="max-width: 300px; text-align: center; background: rgba(0,0,0,0.7); border-color: var(--gold);">
            <div style="font-size: 3rem;">ðŸŽ‰</div>
            <div class="modal-title">Gift Claimed!</div>
            <div style="color: var(--gold); font-size: 1.5rem; margin: 16px 0;" id="success-amount">0.01 ETH</div>
            <button class="btn-gift" onclick="closeSuccessModal()">Awesome!</button>
        </div>
        <button onclick="goHome()" style="position:fixed; bottom:40px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.6); border:2px solid var(--gold); color:var(--gold); width:60px; height:60px; border-radius:50%; font-size:2rem; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow: 0 0 20px rgba(212,175,55,0.3);">â†©</button>
    </div>
    
    <!-- My Gifts Record Modal -->
    <div id="record-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 400px;">
            <div class="modal-title">ðŸ“‹ My Gifts Record</div>
            <div id="record-list" style="margin-top:12px; max-height:50vh; overflow-y:auto;"></div>
            <button class="btn-gift" onclick="closeRecordModal()" style="margin-top:16px; width:100%;">CLOSE</button>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 250px; text-align: center;">
            <div style="font-size: 2rem; animation: pulse 1s infinite;">â³</div>
            <div id="loading-text" style="color: var(--gold-light); margin-top: 12px;">Processing...</div>
        </div>
    </div>

    <!-- Tip Author Modal -->
    <div id="tip-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 340px;">
            <div class="modal-title">â˜• Tip the Author</div>
            <div style="text-align:center; margin-bottom:16px;">
                <img id="author-avatar" src="" style="width:64px; height:64px; border-radius:50%; border:2px solid var(--gold); margin-bottom:8px;">
                <div style="color:var(--gold); font-size:1rem; margin-bottom:4px;">@<span id="author-name">xqc</span></div>
                <div style="color:rgba(255,255,255,0.7); font-size:0.85rem;">Support the creator of this Christmas Tree!</div>
            </div>
            <div class="gift-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Token</label>
                        <input type="text" value="USDC" disabled style="opacity:0.8; background:rgba(0,0,0,0.3); border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; width:100%; text-align:center;">
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="tip-amount" value="1" min="0.1" step="0.1">
                    </div>
                </div>
                <div id="tip-amounts" style="display:flex; gap:8px; margin-bottom:12px;"></div>
                <button class="btn-gift" onclick="sendTip()">Send Tip â¤ï¸</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeTipModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Direct Gift Modal (Send to Friends) -->
    <div id="direct-gift-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 500px;">
            <div class="modal-title">ðŸŽ Send to Friends</div>
            
            <!-- Stamp Selection Section (at top) -->
            <div id="stamp-section" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px; --stamp-bg: rgba(0,0,0,0.3);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <div style="font-weight: bold; color: var(--gold); font-size: 0.95rem;">ðŸ“® Choose Your Stamp</div>
                    <div id="stamp-status-indicator" style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">Loading...</div>
                </div>
                
                <!-- Loading State -->
                <div id="stamp-loading-inline" style="display: none; padding: 16px;">
                    <div style="position: relative; width: 100%; height: 40px; background: rgba(0,0,0,0.4); border-radius: 20px; overflow: hidden; border: 1px solid var(--gold);">
                        <!-- Progress bar track -->
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, rgba(212,175,55,0.2) 0%, rgba(212,175,55,0.5) 50%, rgba(212,175,55,0.2) 100%); background-size: 200% 100%; animation: shimmer 2s infinite;"></div>
                        <!-- Stamp icon bouncing -->
                        <div id="stamp-loader" style="position: absolute; top: 50%; transform: translateY(-50%); font-size: 1.5rem; animation: stampBounce 1.5s ease-in-out infinite;">ðŸŽ«</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.75rem; color: var(--gold); text-align: center;" id="stamp-loading-inline-text">Checking eligibility...</div>
                </div>
                
                <style>
                    @keyframes stampBounce {
                        0%, 100% { left: 0%; }
                        50% { left: calc(100% - 30px); }
                    }
                    @keyframes shimmer {
                        0% { background-position: -200% 0; }
                        100% { background-position: 200% 0; }
                    }
                </style>
                
                <!-- Stamp Grid (2x2) -->
                <div id="stamp-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;"></div>
                
                <!-- How It Works - Collapsible -->
                <div style="margin-top: 12px;">
                    <!-- Compact Summary (always visible) -->
                    <div onclick="document.getElementById('stamp-help-detail').style.display = document.getElementById('stamp-help-detail').style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = document.getElementById('stamp-help-detail').style.display === 'none' ? 'â–¶' : 'â–¼';" 
                         style="padding: 8px 12px; background: linear-gradient(135deg, rgba(212,175,55,0.12), rgba(212,175,55,0.08)); border: 1px solid rgba(212,175,55,0.35); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.2);"
                         onmouseover="this.style.background='linear-gradient(135deg, rgba(212,175,55,0.18), rgba(212,175,55,0.12))'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 3px 8px rgba(0,0,0,0.3)';"
                         onmouseout="this.style.background='linear-gradient(135deg, rgba(212,175,55,0.12), rgba(212,175,55,0.08))'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.2)';">
                        <div style="font-size: 1.3rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">ðŸ’¡</div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.78rem; font-weight: bold; color: #ffd700; margin-bottom: 3px; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">
                                1 Stamp ðŸŽ« = 1 Friend
                            </div>
                            <div style="font-size: 0.62rem; color: rgba(255,255,255,0.7);">
                                Get free or buy â€¢ Click for details
                            </div>
                        </div>
                        <div class="toggle-icon" style="font-size: 0.9rem; color: var(--gold); font-weight: bold;">â–¶</div>
                    </div>
                    
                    <!-- Detailed Info (collapsible) -->
                    <div id="stamp-help-detail" style="display: none; margin-top: 8px; padding: 12px; background: rgba(0,0,0,0.4); border: 1px solid rgba(212,175,55,0.3); border-radius: 6px; animation: slideDown 0.3s ease;">
                        <!-- Stamp table -->
                        <table style="width: 100%; font-size: 0.65rem; color: rgba(255,255,255,0.85); border-collapse: collapse; margin-bottom: 10px;">
                            <thead>
                                <tr style="border-bottom: 1px solid rgba(212,175,55,0.2);">
                                    <th style="text-align: left; padding: 6px 4px; color: var(--gold); font-size: 0.7rem;">Stamp</th>
                                    <th style="text-align: center; padding: 6px 4px; color: #4ade80; font-size: 0.7rem;">Free</th>
                                    <th style="text-align: center; padding: 6px 4px; color: #ffd700; font-size: 0.7rem;">Buy</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <td style="padding: 6px 4px; font-weight: bold;">ðŸŸ£ Neynar</td>
                                    <td style="text-align: center; padding: 6px 4px; color: #4ade80;">3<br><span style="font-size: 0.6rem; color: rgba(255,255,255,0.5);">Scoreâ‰¥0.6</span></td>
                                    <td style="text-align: center; padding: 6px 4px; color: #ffd700;">0.1$<br><span style="font-size: 0.6rem; color: rgba(255,255,255,0.5);">â†’ 3</span></td>
                                </tr>
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <td style="padding: 6px 4px; font-weight: bold;">ðŸŸª Farcaster</td>
                                    <td style="text-align: center; padding: 6px 4px; color: #4ade80;">10<br><span style="font-size: 0.6rem; color: rgba(255,255,255,0.5);">Badge</span></td>
                                    <td style="text-align: center; padding: 6px 4px; color: #ffd700;">0.37$<br><span style="font-size: 0.6rem; color: rgba(255,255,255,0.5);">â†’ 10</span></td>
                                </tr>
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <td style="padding: 6px 4px; font-weight: bold;">ðŸŽ¨ Warplet</td>
                                    <td style="text-align: center; padding: 6px 4px; color: #4ade80;">5<br><span style="font-size: 0.6rem; color: rgba(255,255,255,0.5);">NFT</span></td>
                                    <td style="text-align: center; padding: 6px 4px; color: #ff6b6b;">-<br><span style="font-size: 0.6rem; color: rgba(255,255,255,0.5);">NFT Only</span></td>
                                </tr>
                                <tr>
                                    <td style="padding: 6px 4px; font-weight: bold;">ðŸŒŸ Based</td>
                                    <td style="text-align: center; padding: 6px 4px; color: rgba(255,255,255,0.4);">-<br><span style="font-size: 0.6rem; color: rgba(255,255,255,0.5);">Need 3â†‘</span></td>
                                    <td style="text-align: center; padding: 6px 4px; color: #4ade80;">FREE<br><span style="font-size: 0.6rem; color: rgba(255,255,255,0.5);">Mintâ†’â™¾ï¸</span></td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <!-- Based special note -->
                        <div style="padding: 6px 8px; background: rgba(74,222,128,0.05); border-left: 3px solid #4ade80; border-radius: 3px; margin-bottom: 8px;">
                            <div style="font-size: 0.6rem; color: rgba(255,255,255,0.7); line-height: 1.4;">
                                <b style="color: #4ade80;">ðŸŽ Based NFT:</b> Collect all 3 â†’ <b style="color: #4ade80;">FREE Mint</b> â†’ Unlimited â™¾ï¸
                            </div>
                        </div>
                        
                        <!-- Usage flow -->
                        <div style="padding: 6px 8px; background: rgba(212,175,55,0.05); border-radius: 3px;">
                            <div style="font-size: 0.6rem; color: rgba(255,255,255,0.7); line-height: 1.4; text-align: center;">
                                Select Stamp â†’ Generate Card â†’ Add Friends â†’ Send (Max 5)
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                    @keyframes slideDown {
                        from {
                            opacity: 0;
                            transform: translateY(-10px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                </style>
                
                <!-- No Stamp Warning -->
                <div id="no-stamp-warning" style="display: none; color: #ff6b6b; font-size: 0.8rem; margin-top: 8px; text-align: center;">
                    âš ï¸ You need at least one stamp to generate cards
                </div>
            </div>
            
            <div class="gift-form">
                <div class="form-group">
                    <label>AI Postcard Preview (Required)</label>
                    <div style="font-size:0.75rem; color:rgba(255,255,255,0.5); margin-bottom:12px;">âœ¨ AI will analyze your profile and create a personalized vintage postcard with a heartfelt greeting</div>
                    
                    <!-- Generate Button -->
                    <div id="ai-generate-section">
                        <button type="button" id="generate-ai-btn" onclick="generateAIPostcard()" disabled style="width:100%; padding:14px 20px; background:rgba(100,100,100,0.3); border:none; color:rgba(255,255,255,0.5); border-radius:8px; cursor:not-allowed; font-weight:bold; font-size:1rem; display:flex; align-items:center; justify-content:center; gap:8px;">
                            <span style="font-size:1.2rem;">ðŸŽ¨</span>
                            <span>Generate AI Postcard</span>
                        </button>
                        <div style="font-size:0.7rem; color:rgba(255,255,255,0.4); margin-top:6px; text-align:center;">Select a stamp first</div>
                    </div>
                    
                    <!-- AI Generated Preview -->
                    <div id="ai-preview-section" style="display:none; margin-top:12px;">
                        <!-- 3D Flip Container -->
                        <div style="perspective:1200px; margin:0 auto 16px; max-width:500px;">
                            <div id="postcard-flipper" style="position:relative; width:100%; aspect-ratio:9/16; transform-style:preserve-3d; transition:transform 0.8s;">
                                <!-- Picture Side (Front) - Shows First (AI Illustration) -->
                                <div style="position:absolute; width:100%; height:100%; backface-visibility:hidden;">
                                    <img id="ai-preview-front" src="" style="width:100%; height:100%; object-fit:cover; cursor:pointer;" onclick="flipPostcard()">
                                </div>
                                <!-- Content Side (Back) - Hidden Until Flip (Letter content) -->
                                <div style="position:absolute; width:100%; height:100%; backface-visibility:hidden; transform:rotateY(180deg);">
                                    <img id="ai-preview-back" src="" style="width:100%; height:100%; object-fit:cover; cursor:pointer;" onclick="flipPostcard()">
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align:center; margin-bottom:12px;">
                            <div style="font-size:0.8rem; color:rgba(255,215,0,0.8); margin-top:8px;">
                                ðŸ’¡ Click the card to flip and see the message
                            </div>
                        </div>
                        
                        <button type="button" id="regenerate-ai-btn" onclick="regenerateAIPostcard()" style="width:100%; padding:12px; background:linear-gradient(135deg, #f093fb, #f5576c); border:none; color:#fff; border-radius:8px; cursor:pointer; font-weight:bold; pointer-events:auto !important; position:relative; z-index:999;">
                            ðŸ”„ REGENERATE (0.1 USDC)
                        </button>
                    </div>
                </div>
                <!-- Gift Money Option -->
                <div class="form-group">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                        <input type="checkbox" id="include-gift-money" onchange="toggleGiftMoney()" checked style="width:18px; height:18px; cursor:pointer;">
                        <span>Include Gift Money</span>
                    </label>
                </div>
                
                <!-- Token and Amount (conditional) -->
                <div id="gift-money-section">
                    <div style="display:flex; gap:12px;">
                        <div class="form-group" style="flex:1;">
                            <label>Token</label>
                            <select id="direct-gift-token" onchange="toggleCustomToken(); updateDirectPreview();" style="width:100%;">
                                <option value="USDC">USDC</option>
                                <option value="ETH">ETH</option>
                                <option value="CUSTOM">Custom</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label>Amount Each</label>
                            <input type="number" id="direct-gift-amount" value="0.5" min="0.1" step="0.1" oninput="validateDirectAmount(); updateDirectPreview();">
                        </div>
                    </div>
                    <div id="custom-token-group" class="form-group" style="display:none;">
                        <label>Custom Token Address</label>
                        <input type="text" id="custom-token-address" placeholder="0x...">
                    </div>
                </div>
                
                <!-- Removed Card Cover selection - AI image is the cover -->
                <div class="form-group" style="display:none;">
                    <label>Card Cover</label>
                    <div class="cover-selector" id="cover-selector">
                        <div class="cover-option selected" data-cover="1" onclick="selectCover(1)">
                            <div class="cover-preview cover-1"></div>
                        </div>
                        <div class="cover-option" data-cover="2" onclick="selectCover(2)">
                            <div class="cover-preview cover-2"></div>
                        </div>
                        <div class="cover-option" data-cover="3" onclick="selectCover(3)">
                            <div class="cover-preview cover-3"></div>
                        </div>
                        <div class="cover-option" data-cover="4" onclick="selectCover(4)">
                            <div class="cover-preview cover-4"></div>
                        </div>
                        <div class="cover-option" data-cover="5" onclick="selectCover(5)">
                            <div class="cover-preview cover-5"></div>
                        </div>
                        <div class="cover-option" data-cover="6" onclick="selectCover(6)">
                            <div class="cover-preview cover-6"></div>
                        </div>
                    </div>
                </div>
                <div class="form-group" style="position:relative;">
                    <label>Recipients (max 5)</label>
                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                        <input type="text" id="user-search" placeholder="Search Farcaster username..." oninput="searchUsers(this.value)" style="flex:3; min-width:0;">
                        <button type="button" onclick="fetchTopFriends()" style="flex:1; padding:6px 8px; background:rgba(212,175,55,0.2); border:1px solid var(--gold); color:var(--gold); cursor:pointer; white-space:nowrap; font-size:0.7rem;">ðŸ‘¥</button>
                    </div>
                    <div id="user-results" class="user-search-results" style="display:none;"></div>
                    <div id="selected-users"></div>
                </div>
                <div class="gift-preview">
                    <div class="preview-amount" id="direct-preview-amount">0 ETH</div>
                    <div class="preview-info" id="direct-preview-info">Select recipient(s) above</div>
                </div>
                <button id="send-gift-btn" class="btn-gift" onclick="createDirectGift()" disabled style="opacity: 0.5; cursor: not-allowed;">
                    <span>ðŸŽ Send Gift</span>
                    <div style="font-size: 0.7rem; margin-top: 4px; color: rgba(255,255,255,0.7);">Generate AI postcard first</div>
                </button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeDirectGiftModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Claim Input Modal -->
    <div id="claim-input-modal" class="custom-modal">
        <div class="modal-box" style="max-width: 350px;">
            <div class="modal-title">ðŸŽ Claim Gift</div>
            <div class="gift-form">
                <div class="form-group">
                    <label>Enter Gift Code</label>
                    <input type="text" id="gift-code-input" placeholder="Paste gift link or code...">
                </div>
                <button class="btn-gift" onclick="claimByCode()">Claim</button>
                <button style="background:transparent; border:1px solid rgba(212,175,55,0.3); color:var(--gold); padding:8px; margin-top:4px; cursor:pointer; width:100%;" onclick="closeClaimInput()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="ui">
        <header id="main-header">
            <!-- TITLE UPDATED -->
            <h1 id="app-title">Jingle Gift</h1>
            <div id="app-subtitle" class="subtitle">Share the joy on Farcaster</div>
        </header>
        <div class="controls">
            <!-- Top row: Mailbox + Record + Tip -->
            <div class="btn-row" id="top-btns">
                <button id="mailbox-button" onclick="openMyGifts()" class="btn-small" style="font-size:1.5rem !important; padding:8px 16px !important;">ðŸ“¬</button>
                <button onclick="openRecordModal()" class="btn-small" style="font-size:1.5rem !important; padding:8px 16px !important;">ðŸ“‹</button>
                <button onclick="openTipModal()" class="btn-small" style="font-size:1.5rem !important; padding:8px 16px !important;">â˜•</button>
            </div>
            <!-- Plaza mode buttons -->
            <div class="btn-row" id="plaza-send-btn" style="display:none;">
                <button onclick="openGiftModal()" class="btn-small">ðŸŽ Gift</button>
                <button onclick="openRecordModal()" class="btn-small">ðŸ“‹ Record</button>
            </div>
            <!-- Scatter mode home button -->
            <div id="scatter-home-btn" style="display:none; position:fixed; bottom:30px; left:50%; transform:translateX(-50%); z-index:100;">
                <button onclick="goHome()" style="background:rgba(0,0,0,0.7); border:2px solid rgba(255,215,0,0.5); color:#ffd700; padding:12px 32px; border-radius:25px; font-size:1rem; cursor:pointer; backdrop-filter:blur(10px);">ðŸ  Back to Home</button>
            </div>
            <!-- Bottom rows: Send + Plaza -->
            <div class="btn-row" id="main-btns">
                <button onclick="openDirectGiftModal()" class="btn-small">ðŸŽ Send to Friends</button>
            </div>
            <div class="btn-row">
                <button id="plaza-btn" onclick="togglePlazaMode()" class="btn-small">ðŸŽ„ Plaza Gift</button>
            </div>
        </div>
        
        <!-- Gift Plaza - Orbiting Avatars (hidden by default) -->
        <div id="gift-plaza" style="display:none;"></div>
        <div id="snowfall-container"></div>
    </div>
    
    <div id="canvas-container">
        <div class="loading">Initializing Luxury Asset Pipeline...</div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useMemo, useEffect, Suspense } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as THREE from 'three';
        import { Canvas, useFrame, useThree, extend } from '@react-three/fiber';
        import { OrbitControls, Environment, Float, Sparkles, PerspectiveCamera, Stars } from '@react-three/drei';
        import { EffectComposer, Bloom, Vignette, Noise, ToneMapping } from '@react-three/postprocessing';

        // --- Audio Infrastructure ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 256; 
        const dataArray = new Uint8Array(analyser.frequencyBinCount); // 128 bins
        
        let activeSourceNode = null; 
        
        const defaultAudioEl = new Audio('https://cdn.pixabay.com/audio/2025/05/26/audio_95504c3693.mp3');
        defaultAudioEl.crossOrigin = "anonymous";
        defaultAudioEl.loop = true;
        
        let defaultMediaElementSource = null;

        const useAudioData = () => {
            const frequency = useRef(0);
            useFrame(() => {
                analyser.getByteFrequencyData(dataArray);
                const avg = dataArray.reduce((a, b) => a + b) / dataArray.length;
                frequency.current = avg; 
            });
            return frequency;
        };

        // --- Custom Shaders ---

        const foliageVertexShader = `
            uniform float uTime;
            uniform float uProgress; // 0 = Scattered, 1 = Tree
            uniform float uAudio;
            attribute vec3 aScatterPos;
            attribute vec3 aTreePos;
            attribute float aRandom;
            varying float vVisible;
            varying vec2 vUv;
            varying float vRandom;
            varying float vHeight;
            void main() {
                vUv = uv;
                vRandom = aRandom;
                vec3 finalPos = mix(aScatterPos, aTreePos, uProgress);
                float breathe = sin(uTime * 2.0 + aRandom * 10.0) * 0.05;
                float beat = uAudio * 0.02 * uProgress; 
                finalPos += normal * (breathe + beat);
                if(uProgress < 0.5) {
                    finalPos.y += sin(uTime + aScatterPos.x) * 0.2 * (1.0 - uProgress);
                }
                vHeight = finalPos.y; 
                vec4 mvPosition = modelViewMatrix * vec4(finalPos, 1.0);
                gl_PointSize = (4.0 * (1.0 + uAudio * 0.1)) * (20.0 / -mvPosition.z);
                gl_Position = projectionMatrix * mvPosition;
            }
        `;

        const foliageFragmentShader = `
            uniform float uTime;
            uniform float uAudio; 
            varying float vRandom;
            varying float vHeight;
            varying vec2 vUv;
            void main() {
                vec2 center = gl_PointCoord - 0.5;
                float dist = length(center);
                if (dist > 0.5) discard;
                vec3 emerald = vec3(0.0, 0.25, 0.18);   
                vec3 ruby = vec3(0.3, 0.02, 0.05);      
                vec3 gold = vec3(1.0, 0.9, 0.4);        
                float timeCycle = sin(uTime * 0.4) * 0.5 + 0.5; 
                vec3 baseTone = mix(emerald, ruby, timeCycle * 0.2); 
                float heightFactor = smoothstep(-5.0, 8.0, vHeight);
                vec3 gradientBase = mix(baseTone * 0.5, baseTone * 1.8, heightFactor);
                float beatStrength = smoothstep(0.4, 0.9, uAudio); 
                vec3 rhythmicColor = mix(gradientBase, gold, beatStrength * 0.4);
                float sparkle = sin(uTime * 3.0 + vRandom * 100.0);
                float isTip = step(0.96, sin(vRandom * 30.0 + uTime + uAudio * 5.0)); 
                vec3 finalColor = mix(rhythmicColor, gold * 2.5, isTip * (sparkle * 0.5 + 0.5 + beatStrength));
                float alpha = 1.0 - smoothstep(0.4, 0.5, dist);
                gl_FragColor = vec4(finalColor, alpha * 0.9);
            }
        `;

        // --- Utils: Gift Texture Generator ---
        function createGiftTexture(type) {
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            
            if (type === 0) { // Red + Gold Ribbon
                ctx.fillStyle = '#8B0000'; ctx.fillRect(0,0,256,256);
                ctx.fillStyle = '#FFD700'; 
                ctx.fillRect(118, 0, 20, 256); // Vert
                ctx.fillRect(0, 118, 256, 20); // Horiz
            } else if (type === 1) { // Green + Gold Stripes
                ctx.fillStyle = '#023020'; ctx.fillRect(0,0,256,256);
                ctx.fillStyle = '#D4AF37';
                ctx.lineWidth = 15;
                for(let i=-256; i<512; i+=40) {
                    ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i+256, 256); ctx.stroke();
                }
            } else if (type === 2) { // Navy + Silver Dots
                ctx.fillStyle = '#000080'; ctx.fillRect(0,0,256,256);
                ctx.fillStyle = '#C0C0C0';
                for(let x=0; x<256; x+=40) {
                    for(let y=0; y<256; y+=40) {
                        ctx.beginPath(); ctx.arc(x, y, 6, 0, Math.PI*2); ctx.fill();
                    }
                }
            } else { // Gold + Red Ribbon
                ctx.fillStyle = '#D4AF37'; ctx.fillRect(0,0,256,256);
                ctx.fillStyle = '#8B0000';
                ctx.fillRect(118, 0, 20, 256);
                ctx.fillRect(0, 118, 256, 20);
            }
            
            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = THREE.RepeatWrapping;
            tex.wrapT = THREE.RepeatWrapping;
            return tex;
        }

        // --- Components ---

        const AudioSpectrumRing = ({ isTree }) => {
            const meshRef = useRef();
            const count = 128; 
            const dummy = useMemo(() => new THREE.Object3D(), []);
            const [color] = useState(() => new THREE.Color());

            useEffect(() => {
                if (meshRef.current) {
                    for (let i = 0; i < count; i++) {
                        color.setHSL(i / count, 1.0, 0.5); 
                        color.multiplyScalar(1.5); 
                        meshRef.current.setColorAt(i, color);
                    }
                    meshRef.current.instanceColor.needsUpdate = true;
                }
            }, []);

            const [scatterTargets] = useState(() => {
                const scatter = new Float32Array(count * 3);
                for(let i=0; i<count; i++) {
                    const r = 25 * Math.cbrt(Math.random()); 
                    const theta = Math.random() * 2 * Math.PI;
                    const phi = Math.acos(2 * Math.random() - 1);
                    scatter[i*3] = r * Math.sin(phi) * Math.cos(theta);
                    scatter[i*3+1] = r * Math.sin(phi) * Math.sin(theta);
                    scatter[i*3+2] = r * Math.cos(phi);
                }
                return scatter;
            });

            useFrame((state, delta) => {
                if(!meshRef.current) return;
                meshRef.current.userData.progress = THREE.MathUtils.lerp(
                    meshRef.current.userData.progress || 0,
                    isTree ? 1 : 0,
                    delta * 0.6
                );
                const p = meshRef.current.userData.progress;

                for(let i=0; i<count; i++) {
                    const val = dataArray[i] || 0;
                    const length = (0.5 + (val / 255.0) * 8.0) * 0.66;
                    const angle = (i / count) * Math.PI * 2;
                    const baseRadius = 6.0;
                    const dist = baseRadius + length / 2;
                    const treeX = dist * Math.cos(angle);
                    const treeY = -4.5; 
                    const treeZ = dist * Math.sin(angle);

                    const posX = THREE.MathUtils.lerp(scatterTargets[i*3], treeX, p);
                    const posY = THREE.MathUtils.lerp(scatterTargets[i*3+1], treeY, p);
                    const posZ = THREE.MathUtils.lerp(scatterTargets[i*3+2], treeZ, p);

                    dummy.position.set(posX, posY, posZ);

                    if (p > 0.5) {
                        dummy.lookAt(0, -4.5, 0); 
                        dummy.scale.set(0.15, 0.1, length);
                    } else {
                        dummy.rotation.set(state.clock.elapsedTime * 0.2 + i, i, 0);
                        const s = THREE.MathUtils.lerp(0.5, 0.15, p);
                        dummy.scale.set(s, 0.1, s); 
                    }
                    dummy.updateMatrix();
                    meshRef.current.setMatrixAt(i, dummy.matrix);
                }
                meshRef.current.instanceMatrix.needsUpdate = true;
            });

            return (
                <instancedMesh ref={meshRef} args={[null, null, count]}>
                    <boxGeometry args={[1, 1, 1]} />
                    <meshStandardMaterial 
                        toneMapped={false} 
                        roughness={0.1}
                        metalness={0.8}
                        emissive="#111111" 
                    />
                </instancedMesh>
            );
        };

        const Foliage = ({ isTree, count = 15000 }) => {
            const meshRef = useRef();
            const audioFreq = useAudioData();
            
            const uniforms = useMemo(() => ({
                uTime: { value: 0 },
                uProgress: { value: 0 },
                uAudio: { value: 0 }
            }), []);

            const [attributes] = useState(() => {
                const scatterPos = new Float32Array(count * 3);
                const treePos = new Float32Array(count * 3);
                const randoms = new Float32Array(count);
                const treeHeight = 12;
                const treeRadius = 4.5;

                for (let i = 0; i < count; i++) {
                    const i3 = i * 3;
                    const r = 15 * Math.cbrt(Math.random());
                    const theta = Math.random() * 2 * Math.PI;
                    const phi = Math.acos(2 * Math.random() - 1);
                    scatterPos[i3] = r * Math.sin(phi) * Math.cos(theta);
                    scatterPos[i3+1] = r * Math.sin(phi) * Math.sin(theta);
                    scatterPos[i3+2] = r * Math.cos(phi);

                    const y = Math.random() * treeHeight; 
                    const normalizedY = y / treeHeight; 
                    const currentRadius = (1.0 - normalizedY) * treeRadius;
                    const angle = i * 0.1; 
                    const noise = (Math.random() - 0.5) * 0.5;
                    
                    treePos[i3] = (currentRadius + noise) * Math.cos(angle);
                    treePos[i3+1] = y - 4; 
                    treePos[i3+2] = (currentRadius + noise) * Math.sin(angle);
                    randoms[i] = Math.random();
                }
                return { scatterPos, treePos, randoms };
            });

            useFrame((state, delta) => {
                if (meshRef.current) {
                    meshRef.current.material.uniforms.uTime.value += delta;
                    const targetProgress = isTree ? 1.0 : 0.0;
                    meshRef.current.material.uniforms.uProgress.value = THREE.MathUtils.lerp(
                        meshRef.current.material.uniforms.uProgress.value,
                        targetProgress,
                        delta * 0.6
                    );
                    const normalizedAudio = Math.min(audioFreq.current / 128.0, 1.0); 
                    meshRef.current.material.uniforms.uAudio.value = THREE.MathUtils.lerp(
                        meshRef.current.material.uniforms.uAudio.value,
                        normalizedAudio,
                        0.2 
                    );
                    meshRef.current.rotation.y += 0.001;
                }
            });

            return (
                <points ref={meshRef}>
                    <bufferGeometry>
                        <bufferAttribute attach="attributes-position" count={count} array={attributes.scatterPos} itemSize={3} />
                        <bufferAttribute attach="attributes-aScatterPos" count={count} array={attributes.scatterPos} itemSize={3} />
                        <bufferAttribute attach="attributes-aTreePos" count={count} array={attributes.treePos} itemSize={3} />
                        <bufferAttribute attach="attributes-aRandom" count={count} array={attributes.randoms} itemSize={1} />
                    </bufferGeometry>
                    <shaderMaterial
                        vertexShader={foliageVertexShader}
                        fragmentShader={foliageFragmentShader}
                        uniforms={uniforms}
                        transparent={true}
                        depthWrite={false}
                        blending={THREE.AdditiveBlending}
                    />
                </points>
            );
        };

        const Ornaments = ({ isTree, count = 200, type = "sphere", color = "#D4AF37", scale = 0.3, textureStyle }) => {
            const meshRef = useRef();
            const audioFreq = useAudioData();
            
            // Texture for Gifts
            const texture = useMemo(() => {
                if (textureStyle === undefined) return null;
                return createGiftTexture(textureStyle);
            }, [textureStyle]);

            const [data] = useState(() => {
                const arr = [];
                const treeHeight = 11;
                const treeRadius = 4;
                
                for (let i = 0; i < count; i++) {
                    const r = 12 * Math.cbrt(Math.random());
                    const theta = Math.random() * 2 * Math.PI;
                    const phi = Math.acos(2 * Math.random() - 1);
                    const sx = r * Math.sin(phi) * Math.cos(theta);
                    const sy = r * Math.sin(phi) * Math.sin(theta);
                    const sz = r * Math.cos(phi);

                    const y = Math.random() * treeHeight;
                    const nY = y / treeHeight;
                    const cR = (1.0 - nY) * treeRadius; 
                    const ang = Math.random() * Math.PI * 2;
                    
                    const tx = cR * Math.cos(ang);
                    const ty = y - 4;
                    const tz = cR * Math.sin(ang);

                    arr.push({ scatter: new THREE.Vector3(sx, sy, sz), tree: new THREE.Vector3(tx, ty, tz) });
                }
                return arr;
            });

            const dummy = useMemo(() => new THREE.Object3D(), []);

            useFrame((state, delta) => {
                if (!meshRef.current) return;

                const t = state.clock.elapsedTime;
                const target = isTree ? 1 : 0;
                
                meshRef.current.userData.progress = THREE.MathUtils.lerp(
                    meshRef.current.userData.progress || 0,
                    target,
                    delta * 0.5
                );
                
                const p = meshRef.current.userData.progress;
                const audioScale = 1 + (audioFreq.current / 255) * 0.3;

                data.forEach((item, i) => {
                    const { scatter, tree } = item;
                    dummy.position.lerpVectors(scatter, tree, p);
                    
                    dummy.position.y += Math.sin(t + i) * 0.02 * (1-p); 
                    
                    dummy.scale.setScalar(scale * (i % 2 === 0 ? audioScale : 1));
                    
                    dummy.rotation.x = t * 0.2 + i;
                    dummy.rotation.z = t * 0.1 + i;
                    
                    dummy.updateMatrix();
                    meshRef.current.setMatrixAt(i, dummy.matrix);
                });
                meshRef.current.instanceMatrix.needsUpdate = true;
            });

            const geometry = type === 'box' ? new THREE.BoxGeometry(1, 1, 1) : new THREE.SphereGeometry(1, 16, 16);

            return (
                <instancedMesh ref={meshRef} args={[geometry, null, count]}>
                    <meshStandardMaterial 
                        color={texture ? "white" : color}
                        map={texture}
                        roughness={texture ? 0.3 : 0.1}
                        metalness={texture ? 0.5 : 0.9}
                        emissive={texture ? "#222" : color}
                        emissiveIntensity={0.2}
                    />
                </instancedMesh>
            );
        };

        const StarTopper = ({ isTree }) => {
            const ref = useRef();

            const starGeometry = useMemo(() => {
                const shape = new THREE.Shape();
                const points = 5;
                const outerRadius = 0.8;
                const innerRadius = 0.4;
                const angleOffset = Math.PI / 2; 

                for (let i = 0; i < points * 2; i++) {
                    const angle = (i * Math.PI) / points + angleOffset;
                    const radius = i % 2 === 0 ? outerRadius : innerRadius;
                    const x = Math.cos(angle) * radius;
                    const y = Math.sin(angle) * radius;
                    if (i === 0) shape.moveTo(x, y);
                    else shape.lineTo(x, y);
                }
                shape.closePath();

                const extrudeSettings = {
                    depth: 0.2,
                    bevelEnabled: true,
                    bevelThickness: 0.1,
                    bevelSize: 0.05,
                    bevelSegments: 3
                };

                const geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
                geometry.computeBoundingBox();
                const zCenter = (geometry.boundingBox.max.z - geometry.boundingBox.min.z) / 2;
                geometry.translate(0, 0, -zCenter); 
                return geometry;
            }, []);
            
            useFrame((state, delta) => {
                if(ref.current) {
                    const targetY = isTree ? 9 : 15; 
                    const targetScale = isTree ? 1 : 0.1;
                    ref.current.position.y = THREE.MathUtils.lerp(ref.current.position.y, targetY, delta * 0.8);
                    ref.current.scale.setScalar(THREE.MathUtils.lerp(ref.current.scale.x, targetScale, delta * 0.8));
                    ref.current.rotation.y += delta * 0.5;
                }
            });

            return (
                <group ref={ref} position={[0, 15, 0]}>
                    <mesh geometry={starGeometry}>
                        <meshStandardMaterial color="#FFD700" emissive="#FFD700" emissiveIntensity={2} toneMapped={false} />
                    </mesh>
                    <pointLight color="#FFD700" intensity={5} distance={10} decay={2} />
                </group>
            );
        };

        const CameraController = ({ viewMode, freeMode }) => {
            const { camera, size } = useThree();
            
            useFrame(() => {
                // In free mode, don't force camera position
                if (freeMode) return;
                
                const isMobile = size.width < 768;
                // Top view: looking down at tree from above
                const topPos = { x: 0, y: 25, z: 0.1 };
                // Side view: original view
                const sidePos = { x: 0, y: 4, z: isMobile ? 35 : 20 };
                
                const target = viewMode === 'top' ? topPos : sidePos;
                
                camera.position.x += (target.x - camera.position.x) * 0.03;
                camera.position.y += (target.y - camera.position.y) * 0.03;
                camera.position.z += (target.z - camera.position.z) * 0.03;
            });
            
            return null;
        };

        const Scene = ({ isTree, viewMode }) => {
            return (
                <>
                    <PerspectiveCamera makeDefault position={[0, 25, 0.1]} fov={50} />
                    <CameraController viewMode={viewMode} freeMode={!isTree} />
                    <OrbitControls 
                        enablePan={false} 
                        minDistance={viewMode === 'side' ? 8 : 10} 
                        maxDistance={viewMode === 'side' ? 20 : 50} 
                        maxPolarAngle={Math.PI / 1.5} 
                        autoRotate={true} 
                        autoRotateSpeed={0.3} 
                    />
                    <Environment preset="city" blur={1} background={false} />
                    <ambientLight intensity={0.2} color="#002b16" />
                    <spotLight position={[10, 20, 10]} angle={0.3} penumbra={1} intensity={2} castShadow color="#F7E7CE" />
                    <spotLight position={[-10, 5, 10]} angle={0.5} penumbra={1} intensity={1} color="#023020" />
                    
                    <Foliage isTree={isTree} />
                    <AudioSpectrumRing isTree={isTree} />

                    {/* Heavy Ornaments - Textured Gifts Boxes */}
                    <Ornaments isTree={isTree} count={15} type="box" scale={0.5} textureStyle={0} />
                    <Ornaments isTree={isTree} count={15} type="box" scale={0.5} textureStyle={1} />
                    <Ornaments isTree={isTree} count={15} type="box" scale={0.5} textureStyle={2} />
                    <Ornaments isTree={isTree} count={15} type="box" scale={0.5} textureStyle={3} />
                    
                    {/* Light Ornaments (Balls) - Now Textured Spheres */}
                    <Ornaments isTree={isTree} count={40} type="sphere" scale={0.3} textureStyle={0} />
                    <Ornaments isTree={isTree} count={40} type="sphere" scale={0.3} textureStyle={1} />
                    <Ornaments isTree={isTree} count={40} type="sphere" scale={0.3} textureStyle={2} />
                    
                    {/* Tiny Lights - Warm White */}
                    <Ornaments isTree={isTree} count={300} type="sphere" color="#FFFDD0" scale={0.05} />

                    <StarTopper isTree={isTree} />
                    <Sparkles count={200} scale={12} size={2} speed={0.4} opacity={0.5} color="#F7E7CE" />
                </>
            );
        };

        const PostProcessingEffects = () => {
            return (
                <EffectComposer disableNormalPass>
                    <Bloom luminanceThreshold={0.8} mipmapBlur intensity={1.2} radius={0.6} />
                    <ToneMapping />
                    <Vignette eskil={false} offset={0.1} darkness={1.1} />
                    <Noise opacity={0.02} /> 
                </EffectComposer>
            );
        };

        const App = () => {
            const [isTree, setIsTree] = useState(true); // Start as tree (top-down view)
            const [viewMode, setViewMode] = useState('top'); // 'top' for homepage, 'side' for plaza
            const [audioReady, setAudioReady] = useState(false);

            useEffect(() => {
                // No auto animation - start with tree in top view
                
                const resumeContext = () => { if (audioContext.state === 'suspended') audioContext.resume(); };

                const startDefaultMusic = () => {
                    if (!defaultMediaElementSource) {
                        try {
                            defaultMediaElementSource = audioContext.createMediaElementSource(defaultAudioEl);
                            defaultMediaElementSource.connect(analyser);
                            analyser.connect(audioContext.destination);
                            activeSourceNode = defaultMediaElementSource;
                        } catch(e) { console.log("Audio node error", e); }
                    }
                    
                    defaultAudioEl.play().then(() => {
                        setAudioReady(true);
                    }).catch(e => {
                        const unlockAndPlay = () => {
                            resumeContext();
                            defaultAudioEl.play();
                            setAudioReady(true);
                            document.removeEventListener('click', unlockAndPlay);
                            document.removeEventListener('touchstart', unlockAndPlay);
                        };
                        document.addEventListener('click', unlockAndPlay);
                        document.addEventListener('touchstart', unlockAndPlay);
                    });
                };

                startDefaultMusic(); 
                
                // Expose tree and view control functions globally
                window.scatterTree = () => setIsTree(false);
                window.assembleTree = () => setIsTree(true);
                window.setTopView = () => setViewMode('top');
                window.setSideView = () => setViewMode('side');
                
                return () => {};
            }, []); 

            return (
                <Canvas shadows dpr={[1, 2]} gl={{ antialias: false, toneMappingExposure: 1.5 }}>
                    <color attach="background" args={['#000500']} />
                    <Suspense fallback={null}>
                        <Scene isTree={isTree} viewMode={viewMode} />
                        <PostProcessingEffects />
                    </Suspense>
                </Canvas>
            );
        };

        const root = createRoot(document.getElementById('canvas-container'));
        root.render(<App />);
        
        // Farcaster Mini App SDK - Initialize properly according to docs
        (async function initializeFarcasterSDK() {
            try {
                console.log('ðŸš€ Initializing Farcaster Mini App SDK...');
                const { sdk } = await import('https://esm.sh/@farcaster/miniapp-sdk');
                window.farcasterSDK = sdk;
                
                // Signal ready to Farcaster client
                sdk.actions.ready();
                console.log('âœ… SDK ready signal sent');
                
                // Get user context from SDK
                const context = await sdk.context;
                console.log('ðŸ“± SDK context received:', context);
                
                if (context?.user?.fid) {
                    window.currentUser = {
                        fid: Number(context.user.fid),
                        username: context.user.username || 'unknown',
                        displayName: context.user.displayName || 'Unknown User',
                        pfp_url: context.user.pfpUrl || 'https://i.imgur.com/HeIi0wU.png'
                    };
                    console.log('âœ… User authenticated:', window.currentUser);
                } else {
                    console.warn('âš ï¸ Not running in Farcaster context or user not available');
                    window.currentUser = null;
                }
            } catch (err) {
                console.error('âŒ SDK initialization failed:', err);
                window.currentUser = null;
            }
        })();
    </script>

    <!-- Gift Plaza System -->
    <script>
        let giftType = 'equal';
        let currentUser = null; // Will be set by Farcaster SDK
        const TEST_MODE = false; // Production mode - use real wallet
        
        // Utility: Check if user is authenticated
        function requireAuth(actionName = 'this action') {
            if (!window.currentUser?.fid) {
                alert(`ðŸ” Authentication Required\n\nPlease open this app in the Farcaster mobile app to ${actionName}.\n\nYou need to be signed in with your Farcaster account.`);
                return false;
            }
            return true;
        }
        
        // Utility: Get current user FID (throws if not authenticated)
        function getUserFid() {
            if (!window.currentUser?.fid) {
                throw new Error('User not authenticated');
            }
            return window.currentUser.fid;
        }
        // Neynar API calls go through /api/neynar to protect API key
        const MAX_PLAZA_GIFTS = 10;
        let plazaGifts = JSON.parse(localStorage.getItem('plaza_gifts') || '[]');
        let isPlazaMode = false;
        
        // Production: Load plaza gifts from localStorage only

        // Plaza transition animation (simplified)
        function playPlazaTransition(callback) {
            if (callback) callback();
        }
        
        // Background meteor effect - random shooting stars
        let meteorContainer = null;
        
        function initMeteorEffect() {
            if (meteorContainer) return;
            
            meteorContainer = document.createElement('div');
            meteorContainer.className = 'bg-meteor-container';
            document.body.appendChild(meteorContainer);
            
            // Start spawning meteors
            scheduleMeteor();
        }
        
        function scheduleMeteor() {
            // Random interval: 10-20 seconds
            const delay = 10000 + Math.random() * 10000;
            setTimeout(() => {
                spawnMeteor();
                scheduleMeteor();
            }, delay);
        }
        
        function spawnMeteor() {
            if (!meteorContainer) return;
            
            const meteor = document.createElement('div');
            meteor.className = 'bg-meteor';
            
            // Random start position (scattered across top-right)
            const startX = window.innerWidth * (0.3 + Math.random() * 0.8);
            const startY = -30 - Math.random() * 50;
            
            // Varied angle (30-50 degrees)
            const angle = 30 + Math.random() * 20;
            const radians = angle * Math.PI / 180;
            
            // Random size
            const size = 3 + Math.random() * 3;
            
            // Travel distance
            const travelDistance = window.innerWidth * 1.2 + Math.random() * 200;
            const travelX = -Math.cos(radians) * travelDistance;
            const travelY = Math.sin(radians) * travelDistance;
            
            // Duration based on distance (faster = more dramatic)
            const duration = 0.6 + Math.random() * 0.5;
            
            meteor.style.left = startX + 'px';
            meteor.style.top = startY + 'px';
            meteor.style.setProperty('--size', size + 'px');
            meteor.style.setProperty('--travel-x', travelX + 'px');
            meteor.style.setProperty('--travel-y', travelY + 'px');
            meteor.style.setProperty('--duration', duration + 's');
            
            meteorContainer.appendChild(meteor);
            
            // Remove after animation
            setTimeout(() => meteor.remove(), duration * 1000 + 100);
        }
        
        // Start meteor effect on page load
        setTimeout(initMeteorEffect, 3000);
        
        // Toggle Plaza Mode
        function togglePlazaMode() {
            if (!isPlazaMode) {
                // Immediately activate plaza UI to avoid button disappearing
                activatePlazaMode(true);
                
                // 1. Switch to side view + scatter tree
                if (window.setSideView) window.setSideView();
                if (window.scatterTree) window.scatterTree();
                
                // 2. After camera moves, assemble tree (original opening animation)
                setTimeout(() => {
                    if (window.assembleTree) window.assembleTree();
                    
                    // 3. After tree assembles, play comet animation
                    setTimeout(() => {
                        playPlazaTransition(() => {
                            // Animation complete - UI already active
                        });
                    }, 1500);
                }, 500);
                return;
            }
            // Return to top view
            if (window.setTopView) window.setTopView();
            activatePlazaMode(false);
        }
        
        function activatePlazaMode(entering) {
            isPlazaMode = entering;
            const plazaBtn = document.getElementById('plaza-btn');
            const plaza = document.getElementById('gift-plaza');
            const plazaSendBtn = document.getElementById('plaza-send-btn');
            const mainBtns = document.getElementById('main-btns');
            const topBtns = document.getElementById('top-btns');
            const titleEl = document.getElementById('app-title');
            const subtitleEl = document.getElementById('app-subtitle');
            
            if (isPlazaMode) {
                plazaBtn.textContent = 'â†© Return';
                plaza.style.display = 'block';
                plazaSendBtn.style.display = 'flex';
                mainBtns.style.display = 'none';
                topBtns.style.display = 'none';
                // Hide title, show banner
                if (titleEl) titleEl.style.display = 'none';
                if (subtitleEl) subtitleEl.style.display = 'none';
                startSnowfall();
                // plaza-greeting removed
                renderPlaza();
            } else {
                plazaBtn.textContent = 'ðŸŽ„ Plaza Gift';
                plaza.style.display = 'none';
                plazaSendBtn.style.display = 'none';
                mainBtns.style.display = 'flex';
                topBtns.style.display = 'flex';
                // Show title
                if (titleEl) titleEl.style.display = 'block';
                if (subtitleEl) subtitleEl.style.display = 'block';
                stopSnowfall();
                // plaza-greeting removed
            }
        }

        // Auto-generate beautiful gift title
        function generateGiftTitle() {
            const titles = [
                'ðŸŽ„ Merry Christmas!',
                'âœ¨ Season\'s Greetings',
                'â„ï¸ Warm Winter Wishes',
                'ðŸŽ… Happy Holidays!',
                'ðŸŽ Christmas Blessings',
                'â­ Joy & Peace',
                'ðŸ”” Joyful Tidings',
                'ðŸ•¯ï¸ Light & Love',
                'ðŸŽŠ Festive Cheer',
                'ðŸ’« Magical Season'
            ];
            return titles[Math.floor(Math.random() * titles.length)];
        }
        
        // Modal functions
        function openGiftModal() { 
            document.getElementById('gift-modal').classList.add('visible');
            document.getElementById('gift-token').value = 'USDC';
            document.getElementById('gift-amount').value = '0.1';
            document.getElementById('gift-shares').value = '5';
            document.getElementById('plaza-custom-token-group').style.display = 'none';
            document.getElementById('plaza-token-ca').value = '';
            document.getElementById('require-code').checked = false;
            document.getElementById('gift-code').value = '';
            document.getElementById('code-input-row').style.display = 'none';
            document.getElementById('require-pro').checked = false;
            document.getElementById('min-score').value = '0';
            updatePreview();
        }
        function closeGiftModal() { document.getElementById('gift-modal').classList.remove('visible'); }
        function closeClaimModal() { document.getElementById('claim-modal').classList.remove('visible'); }
        function openClaimInput() { document.getElementById('claim-input-modal').classList.add('visible'); document.getElementById('gift-code-input').value = ''; }
        function closeClaimInput() { document.getElementById('claim-input-modal').classList.remove('visible'); }
        function showLoading(text) { document.getElementById('loading-text').textContent = text; document.getElementById('loading-modal').classList.add('visible'); }
        function hideLoading() { document.getElementById('loading-modal').classList.remove('visible'); }
        function closeSuccessModal() { 
            document.getElementById('success-modal').querySelector('.modal-box').style.display = 'none';
            // Keep tree scattered - user can zoom in/out
            // Tree will reassemble when user clicks goHome button
            if (window.scatterTree) window.scatterTree();
        }
        
        // Tip Author functions
        const AUTHOR_USERNAME = 'xqc';
        const AUTHOR_ADDRESS = '0x...'; // Replace with actual address
        const USDC_CA = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
        let authorInfo = null;
        
        async function fetchAuthorInfo() {
            if (authorInfo) return;
            try {
                const res = await fetch(`/api/neynar?action=search&q=${AUTHOR_USERNAME}&limit=1`);
                const data = await res.json();
                if (data.result?.users?.[0]) {
                    authorInfo = data.result.users[0];
                    document.getElementById('author-avatar').src = authorInfo.pfp_url || '';
                    document.getElementById('author-name').textContent = authorInfo.username;
                }
            } catch (e) { console.error('Failed to fetch author info:', e); }
        }
        
        function openTipModal() {
            document.getElementById('tip-modal').classList.add('visible');
            document.getElementById('tip-amount').value = '1';
            document.getElementById('tip-amounts').innerHTML = [1, 3, 5].map(amt => 
                `<button type="button" class="tip-amt-btn" onclick="setTipAmount(${amt})">${amt}</button>`
            ).join('');
            fetchAuthorInfo();
        }
        function closeTipModal() { document.getElementById('tip-modal').classList.remove('visible'); }
        function setTipAmount(amount) { document.getElementById('tip-amount').value = amount; }
        async function sendTip() {
            const token = document.getElementById('tip-token').value;
            const amount = document.getElementById('tip-amount').value;
            if (!amount || parseFloat(amount) <= 0) { alert('Enter valid amount'); return; }
            
            closeTipModal();
            showLoading('Sending tip...');
            
            // In production, integrate with wallet (ethers.js / wagmi)
            // For demo, just show success
            setTimeout(() => {
                hideLoading();
                alert(`Thank you for your tip! â¤ï¸\n\n${amount} ${token} to author`);
            }, 1500);
        }
        
        // Gift Record feature - show gifts sent and claimed
        function openRecordModal() {
            const myUsername = currentUser?.username || 'anonymous';
            const myFid = currentUser?.fid;
            const myAddress = window.connectedAddress?.toLowerCase();
            
            // Created cards (not yet on-chain, have aiImageFront)
            const createdCards = plazaGifts.filter(g => 
                g.aiImageFront && 
                !g.txHash && 
                !g.contractGiftId &&
                (g.sender?.username === myUsername || g.sender?.fid === myFid)
            );
            
            // On-chain gifts
            const onChainGifts = plazaGifts.filter(g => g.txHash || g.contractGiftId);
            
            // Gifts I sent (on-chain only)
            const sentGifts = onChainGifts.filter(g => 
                g.sender?.username === myUsername || 
                g.senderAddress?.toLowerCase() === myAddress
            );
            
            // Gifts I claimed (on-chain only)
            const claimedGifts = onChainGifts.filter(g => 
                g.claimedBy?.some(c => 
                    c.username === myUsername || 
                    c.fid === myFid ||
                    c.address?.toLowerCase() === myAddress
                )
            );
            
            const recordList = document.getElementById('record-list');
            let html = '';
            
            // If no records at all
            if (createdCards.length === 0 && sentGifts.length === 0 && claimedGifts.length === 0) {
                html = '<div style="text-align:center; color:rgba(255,255,255,0.5); padding:24px; font-size:0.9rem;">No records yet<br><span style="font-size:0.75rem; margin-top:8px; display:block;">Create or send a gift to see records here</span></div>';
                recordList.innerHTML = html;
                document.getElementById('record-modal').classList.add('visible');
                return;
            }
            
            // Created cards section (NEW)
            if (createdCards.length > 0) {
                html += '<div style="color:var(--gold); font-weight:bold; margin-bottom:8px;">ðŸŽ¨ My Created Cards</div>';
                html += createdCards.map(gift => {
                    const recipientName = gift.recipient?.username || 'Friend';
                    const shareUrl = location.origin + location.pathname + '?gift=' + gift.id;
                    return `
                        <div style="background:rgba(0,0,0,0.3); padding:12px; border-radius:8px; margin-bottom:10px; border:1px solid rgba(212,175,55,0.3);">
                            <div style="display:flex; gap:12px; align-items:start;">
                                <img src="${gift.aiImageFront}" style="width:60px; height:80px; object-fit:cover; border-radius:6px; border:1px solid var(--gold);" 
                                     onerror="this.src='https://i.imgur.com/HeIi0wU.png'">
                                <div style="flex:1;">
                                    <div style="color:var(--gold); font-weight:bold; margin-bottom:4px;">${gift.title || 'Christmas Card'}</div>
                                    <div style="font-size:0.8rem; color:rgba(255,255,255,0.7); margin-bottom:4px;">To: @${recipientName}</div>
                                    ${gift.amount ? `<div style="font-size:0.85rem; color:var(--gold);">ðŸŽ ${gift.amount} ${gift.token}</div>` : ''}
                                    <button onclick="window.open('${shareUrl}', '_blank')" style="margin-top:8px; padding:4px 12px; background:linear-gradient(135deg, var(--gold), #ffd700); border:none; border-radius:6px; color:#2c2c2c; font-size:0.75rem; font-weight:bold; cursor:pointer;">
                                        View Card
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Sent gifts section
            html += '<div style="color:var(--gold); font-weight:bold; margin-bottom:8px;">ðŸŽ Gifts I Sent</div>';
            if (sentGifts.length === 0) {
                html += '<div style="text-align:center; color:rgba(255,255,255,0.5); padding:12px; font-size:0.85rem;">No gifts sent yet</div>';
            } else {
                html += sentGifts.map(gift => {
                    const claimers = gift.claimedBy || [];
                    return `
                        <div style="background:rgba(0,0,0,0.3); padding:12px; border-radius:8px; margin-bottom:10px; border:1px solid rgba(212,175,55,0.3);">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <span style="color:var(--gold); font-weight:bold;">${gift.title}</span>
                                <span style="color:rgba(255,255,255,0.6); font-size:0.8rem;">${gift.claimed}/${gift.shares} claimed</span>
                            </div>
                            <div style="font-size:0.85rem; color:rgba(255,255,255,0.7);">${gift.amount} ${gift.token}</div>
                            ${claimers.length > 0 ? `
                                <div style="margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1);">
                                    <div style="font-size:0.75rem; color:rgba(255,255,255,0.5); margin-bottom:4px;">Claimed by:</div>
                                    ${claimers.map(c => `
                                        <div style="display:flex; align-items:center; gap:8px; padding:4px 0;">
                                            <img src="${c.pfp || 'https://i.imgur.com/HeIi0wU.png'}" style="width:24px; height:24px; border-radius:50%; border:1px solid var(--gold);" onerror="this.src='https://i.imgur.com/HeIi0wU.png'">
                                            <span style="font-size:0.8rem; color:rgba(255,255,255,0.8);">@${c.username || c.fid || 'anonymous'}</span>
                                            <span style="font-size:0.8rem; color:var(--gold); margin-left:auto;">${c.amount || '?'} ${gift.token}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<div style="font-size:0.75rem; color:rgba(255,255,255,0.4); margin-top:8px;">No claims yet</div>'}
                        </div>
                    `;
                }).join('');
            }
            
            // Claimed gifts section
            html += '<div style="color:var(--gold); font-weight:bold; margin:16px 0 8px;">ðŸ“¬ Gifts I Claimed</div>';
            if (claimedGifts.length === 0) {
                html += '<div style="text-align:center; color:rgba(255,255,255,0.5); padding:12px; font-size:0.85rem;">No gifts claimed yet</div>';
            } else {
                html += claimedGifts.map(gift => {
                    const myClaim = gift.claimedBy?.find(c => c.username === myUsername || c.fid === myFid);
                    return `
                        <div style="background:rgba(0,0,0,0.3); padding:12px; border-radius:8px; margin-bottom:10px; border:1px solid rgba(212,175,55,0.3);">
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                                <img src="${gift.sender?.pfp || 'https://i.imgur.com/HeIi0wU.png'}" style="width:28px; height:28px; border-radius:50%; border:1px solid var(--gold);" onerror="this.src='https://i.imgur.com/HeIi0wU.png'">
                                <div>
                                    <div style="color:var(--gold); font-weight:bold;">${gift.title}</div>
                                    <div style="font-size:0.75rem; color:rgba(255,255,255,0.5);">From @${gift.sender?.username || 'anonymous'}</div>
                                </div>
                            </div>
                            <div style="font-size:0.85rem; color:var(--gold);">Received: ${myClaim?.amount || '?'} ${gift.token}</div>
                        </div>
                    `;
                }).join('');
            }
            
            recordList.innerHTML = html;
            document.getElementById('record-modal').classList.add('visible');
        }
        
        function closeRecordModal() {
            document.getElementById('record-modal').classList.remove('visible');
        }
        
        // Show floating claim success message
        function showClaimSuccess(amount) {
            const msg = document.createElement('div');
            msg.style.cssText = `
                position: fixed;
                top: 50%; left: 50%;
                transform: translate(-50%, -50%) scale(0);
                background: rgba(0,0,0,0.8);
                border: 2px solid rgba(255,215,0,0.6);
                border-radius: 16px;
                padding: 24px 40px;
                text-align: center;
                z-index: 9999;
                animation: popIn 0.4s ease forwards, fadeOut 0.5s ease 2s forwards;
            `;
            msg.innerHTML = `
                <div style="font-size:3rem; margin-bottom:8px;">ðŸŽ‰</div>
                <div style="color:#ffd700; font-size:1.2rem; font-weight:bold;">Gift Claimed!</div>
                <div style="color:#fff; font-size:1.5rem; margin-top:8px;">ðŸ’° ${amount}</div>
            `;
            document.body.appendChild(msg);
            
            // Add animation styles if not exist
            if (!document.getElementById('claim-success-anim')) {
                const style = document.createElement('style');
                style.id = 'claim-success-anim';
                style.textContent = `
                    @keyframes popIn { to { transform: translate(-50%, -50%) scale(1); } }
                    @keyframes fadeOut { to { opacity: 0; transform: translate(-50%, -50%) scale(0.8); } }
                `;
                document.head.appendChild(style);
            }
            
            setTimeout(() => msg.remove(), 2500);
        }
        
        // Go back to home
        function goHome() {
            document.getElementById('success-modal').classList.remove('visible');
            document.getElementById('success-modal').querySelector('.modal-box').style.display = 'block';
            document.querySelector('.controls').style.display = 'flex';
            document.getElementById('gift-plaza').style.display = 'none';
            document.getElementById('plaza-btn').textContent = 'ðŸŽ„ Plaza Gift';
            document.getElementById('main-btns').style.display = 'flex';
            document.getElementById('top-btns').style.display = 'flex';
            document.getElementById('plaza-send-btn').style.display = 'none';
            document.getElementById('scatter-home-btn').style.display = 'none';
            isPlazaMode = false;
            // Reassemble tree when returning home
            if (window.assembleTree) window.assembleTree();
            if (window.setTopView) window.setTopView();
        }
        
        // Direct Gift (Send to Friends)
        let selectedRecipients = [];
        let searchTimeout = null;
        const MAX_RECIPIENTS = 5;
        
        // ===== STAMP SYSTEM =====
        let userStamps = {}; // Store user's owned stamps
        let stampEligibility = {}; // Store eligibility check results
        let eligibility = {}; // Global eligibility for progress bar
        let selectedStamp = null; // Currently selected stamp for generation
        let purchaseQuantities = { neynar: 1, farcaster: 1 }; // Purchase quantity selection
        
        // Open direct gift modal and load stamps inline
        async function openDirectGiftModal() {
            console.log('ðŸŽ Send Postcard button clicked');
            
            // Check if user is authenticated
            if (!window.currentUser?.fid) {
                // Wait briefly for SDK to initialize (if still loading)
                await new Promise(r => setTimeout(r, 500));
                
                // If still no user, show authentication required message
                if (!window.currentUser?.fid) {
                    alert('ðŸ” Authentication Required\n\nPlease open this app in the Farcaster mobile app to send postcards.\n\nThis feature requires a signed-in Farcaster account.');
                    return;
                }
            }
            
            // Reset selected stamp on modal open to ensure clean state
            selectedStamp = null;
            
            // Open modal first
            openOriginalDirectGiftModal();
            
            // Try to restore cached postcard from IndexedDB
            const userFid = window.currentUser.fid;
            loadAIPostcardCache(userFid).then(cache => {
                // Always restore cache if it exists (removed !isAIGenerated check)
                if (cache && cache.image) {
                    console.log('ðŸ“¦ Restoring cached postcard on modal open...');
                    currentAIImage = cache.image;
                    currentAIGreeting = cache.greeting;
                    currentAIScene = cache.scene;
                    isAIGenerated = true;
                    aiGenerationCount = cache.generationCount || 1;
                    
                    // Update UI
                    setTimeout(() => {
                        document.getElementById('ai-preview-front').src = `data:image/png;base64,${currentAIImage}`;
                        document.getElementById('ai-preview-greeting').textContent = currentAIGreeting;
                        document.getElementById('ai-generate-section').style.display = 'none';
                        document.getElementById('ai-preview-section').style.display = 'block';
                        
                        // Enable Send Gift button
                        updateSendGiftButtonState();
                    }, 100);
                } else {
                    // No cache or incomplete data - update button state
                    setTimeout(() => {
                        updateSendGiftButtonState();
                    }, 100);
                }
            }).catch(err => {
                console.error('Failed to load cache on modal open:', err);
                setTimeout(() => {
                    updateSendGiftButtonState();
                }, 100);
            });
            
            // Then load stamps inline
            await checkStampEligibilityInline();
        }
        
        // Clear fake Based stamp data from TEST_MODE (one-time cleanup)
        function clearFakeBasedStamp() {
            if (!window.currentUser?.fid) return;
            const userFid = getUserFid();
            const stampsKey = `stamps_${userFid}`;
            const stored = localStorage.getItem(stampsKey);
            
            if (stored) {
                const stamps = JSON.parse(stored);
                
                // If Based stamp exists but has no tx_hash, it's fake data
                if (stamps.based && !stamps.based.tx_hash) {
                    console.log('ðŸ§¹ Clearing fake Based stamp data from TEST_MODE');
                    delete stamps.based;
                    localStorage.setItem(stampsKey, JSON.stringify(stamps));
                    
                    // Update global state
                    if (userStamps.based && !userStamps.based.tx_hash) {
                        delete userStamps.based;
                    }
                }
            }
        }
        
        // Check if user owns Based NFT on-chain
        async function checkBasedNFTOwnership(userFid) {
            try {
                // Get user FID
                if (!userFid) {
                    if (!window.currentUser?.fid) return false;
                    userFid = getUserFid();
                }
                
                // First check if already unlocked via minting
                if (userStamps.based?.owned && userStamps.based?.tx_hash) {
                    console.log('âœ… Based stamp already unlocked via minting');
                    // Don't call renderStampGrid here - will be called later
                    return true;
                }
                
                // Get Farcaster SDK
                const sdk = window.farcasterSDK;
                if (!sdk) {
                    console.log('âš ï¸ SDK not available, skipping NFT check');
                    return false;
                }
                
                // Use timeout to prevent hanging
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout')), 3000)
                );
                
                const checkPromise = (async () => {
                    const provider = await sdk.wallet.getEthereumProvider();
                    if (!provider) return false;
                    
                    // Try to get accounts without triggering wallet popup
                    const accounts = await provider.request({ method: 'eth_accounts' });
                    if (!accounts || accounts.length === 0) {
                        console.log('âš ï¸ No wallet connected, skipping NFT check');
                        return false;
                    }
                    
                    const userAddress = accounts[0];
                    console.log('ðŸ” Checking NFT ownership for:', userAddress);
                    
                    // Check if user owns Based NFT
                    const BASED_CONTRACT = '0x6D3634AA13F3b719A6d1209036da056F6788cdd6';
                    const BASED_ABI = ['function balanceOf(address owner, uint256 tokenId) public view returns (uint256)'];
                    const ethersProvider = new ethers.BrowserProvider(provider);
                    const contract = new ethers.Contract(BASED_CONTRACT, BASED_ABI, ethersProvider);
                    
                    const balance = await contract.balanceOf(userAddress, 0); // Token ID 0
                    
                    console.log('NFT Balance:', balance.toString());
                    
                    if (balance > 0) {
                        console.log('âœ… User owns Based NFT! Unlocking stamp...');
                        // Auto-unlock Based stamp
                        userStamps.based = {
                            owned: true,
                            quantity: Infinity,
                            permanent: true,
                            acquired_method: 'claimed_onchain',
                            acquired_at: new Date().toISOString(),
                            nft_balance: balance.toString()
                        };
                        saveUserStamps(userFid);
                        // Don't call renderStampGrid here - will be called later
                        return true;
                    }
                    return false;
                })();
                
                return await Promise.race([checkPromise, timeoutPromise]);
                
            } catch (error) {
                if (error.message === 'Timeout') {
                    console.log('âš ï¸ NFT check timeout, skipping...');
                } else {
                    console.log('âš ï¸ Could not check Based NFT ownership:', error.message);
                }
            }
            return false;
        }
        
        // Check stamp eligibility inline (inside the modal)
        async function checkStampEligibilityInline() {
            // Clear fake data first
            clearFakeBasedStamp();
            
            const loadingDiv = document.getElementById('stamp-loading-inline');
            const stampGrid = document.getElementById('stamp-grid');
            const statusIndicator = document.getElementById('stamp-status-indicator');
            const loadingText = document.getElementById('stamp-loading-inline-text');
            const noStampWarning = document.getElementById('no-stamp-warning');
            
            // Verify DOM elements exist
            if (!loadingDiv || !stampGrid || !statusIndicator || !loadingText) {
                console.error('Missing DOM elements for stamp check');
                return;
            }
            
            // Show loading
            loadingDiv.style.display = 'block';
            stampGrid.style.display = 'none';
            if (noStampWarning) noStampWarning.style.display = 'none';
            statusIndicator.textContent = 'Checking...';
            
            try {
                if (!window.currentUser?.fid) {
                    throw new Error('Please sign in with Farcaster');
                }
                const userFid = getUserFid();
                
                // Load user stamps FIRST
                loadUserStamps(userFid);
                
                // Real API call with loading animation
                loadingText.textContent = 'Scanning Neynar Score...';
                await new Promise(r => setTimeout(r, 500));
                
                loadingText.textContent = 'Checking Power Badge...';
                await new Promise(r => setTimeout(r, 500));
                
                loadingText.textContent = 'Verifying Warplet NFT...';
                await new Promise(r => setTimeout(r, 500));
                
                loadingText.textContent = 'Checking Based NFT...';
                await checkBasedNFTOwnership(userFid);
                await new Promise(r => setTimeout(r, 500));
                
                const response = await fetch(`/api/neynar?action=check_stamps&fid=${userFid}`);
                    
                    if (!response.ok) {
                        throw new Error(`API returned ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.success || !data.stamps) {
                        throw new Error(data.message || 'Invalid API response');
                    }
                    
                stampEligibility = data.stamps;
                eligibility = data.stamps; // Store for progress bar
                
                // Auto-claim eligible stamps (if not already owned)
                let autoClaimedAny = false;
                const quantities = { neynar: 3, farcaster: 10, warplet: 5 };
                ['neynar', 'farcaster', 'warplet'].forEach(stampId => {
                    const isEligible = stampEligibility[stampId]?.eligible;
                    const notOwned = !userStamps[stampId]?.owned;
                    if (isEligible && notOwned) {
                        userStamps[stampId] = {
                            owned: true,
                            quantity: quantities[stampId] || 1,
                            acquired_method: 'free',
                            acquired_at: new Date().toISOString(),
                            first_free_claimed: true
                        };
                        autoClaimedAny = true;
                        console.log(`âœ… Auto-claimed ${stampId}: ${quantities[stampId]} stamps`);
                        
                        // Auto-select ONLY the first claimed stamp
                        if (!selectedStamp) {
                            selectedStamp = stampId;
                            console.log(`ðŸŽ¯ Auto-selected first stamp: ${stampId}`);
                        }
                    }
                });
                if (autoClaimedAny) {
                    saveUserStamps(userFid);
                }
                
                await new Promise(r => setTimeout(r, 400));
                
                // Hide loading, show stamps
                loadingDiv.style.display = 'none';
                stampGrid.style.display = 'grid';
                
                // Render stamp grid
                renderStampGrid();
                
                // Update status indicator
                const ownedCount = Object.keys(userStamps).filter(k => userStamps[k]?.owned).length;
                if (ownedCount === 0) {
                    statusIndicator.innerHTML = '<span style="color: #ff6b6b;">âš ï¸ No stamps</span>';
                    noStampWarning.style.display = 'block';
                } else if (ownedCount === 4) {
                    statusIndicator.innerHTML = '<span style="color: #ffd700;">âœ¨ Complete</span>';
                } else {
                    statusIndicator.innerHTML = `<span style="color: #4ade80;">âœ“ ${ownedCount} stamp${ownedCount > 1 ? 's' : ''}</span>`;
                }
                
            } catch (error) {
                console.error('Error checking stamps:', error);
                loadingDiv.style.display = 'none';
                statusIndicator.innerHTML = '<span style="color: #ff6b6b;">Error loading</span>';
                alert(`æ£€æŸ¥é‚®ç¥¨å¤±è´¥: ${error.message}\n\nè¯·ç¡®è®¤å·²ç™»å½•Farcasterè´¦å·ã€‚`);
            }
        }
        
        // Update generate button state based on stamp selection
        function updateGenerateButtonState() {
            const btn = document.getElementById('generate-ai-btn');
            const helpText = btn.parentElement.querySelector('div[style*="font-size:0.7rem"]');
            const hasStamp = selectedStamp && userStamps[selectedStamp]?.owned;
            
            if (hasStamp) {
                btn.disabled = false;
                btn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                btn.style.color = '#fff';
                btn.style.cursor = 'pointer';
                helpText.textContent = 'First generation free';
            } else {
                btn.disabled = true;
                btn.style.background = 'rgba(100,100,100,0.3)';
                btn.style.color = 'rgba(255,255,255,0.5)';
                btn.style.cursor = 'not-allowed';
                helpText.textContent = 'Select a stamp first';
            }
        }
        
        // Render stamp grid inline - FINAL REDESIGN
        function renderStampGrid() {
            console.log('ðŸŽ¨ renderStampGrid called, selectedStamp =', selectedStamp);
            console.log('ðŸ“¦ userStamps:', JSON.stringify(userStamps));
            
            const stampGrid = document.getElementById('stamp-grid');
            stampGrid.innerHTML = '';
            
            const stamps = [
                { id: 'neynar', name: 'Neynar', img: '/stamp/neynar-preview.png', price: '0.1', quantity: 3 },
                { id: 'farcaster', name: 'Farcaster', img: '/stamp/farcaster-preview.png', price: '0.37', quantity: 10 },
                { id: 'warplet', name: 'Warplet', img: '/stamp/warplet-preview.png', price: '0.5', quantity: 5 },
                { id: 'based', name: 'Based', img: '/stamp/based-preview.png', price: 'Free', quantity: 1 }
            ];
            
            stamps.forEach(stamp => {
                console.log(`ðŸ” Processing stamp: ${stamp.id}, selectedStamp === stamp.id? ${selectedStamp === stamp.id}`);
                
                const isOwned = userStamps[stamp.id]?.owned;
                const ownedQuantity = userStamps[stamp.id]?.quantity || 0;
                const eligibility = stampEligibility[stamp.id];
                const isEligible = eligibility?.eligible;
                const isUnlimited = stamp.id === 'based' && userStamps.based?.permanent;
                const canMintBased = stamp.id === 'based' && 
                    userStamps.neynar?.owned && 
                    userStamps.farcaster?.owned && 
                    userStamps.warplet?.owned;
                
                // Card wrapper
                const card = document.createElement('div');
                card.style.cssText = `
                    position: relative;
                    background: linear-gradient(135deg, rgba(0,0,0,0.4), rgba(0,0,0,0.2));
                    border: 2px solid ${selectedStamp === stamp.id ? 'var(--gold)' : 'rgba(212,175,55,0.3)'};
                    border-radius: 12px;
                    overflow: hidden;
                    cursor: ${isOwned ? 'pointer' : 'default'};
                    transition: all 0.3s ease;
                    box-shadow: ${selectedStamp === stamp.id ? '0 0 20px rgba(212,175,55,0.5)' : '0 2px 8px rgba(0,0,0,0.3)'};
                `;
                
                // Hover effect for owned stamps
                if (isOwned) {
                    card.onmouseover = () => {
                        if (selectedStamp !== stamp.id) {
                            card.style.borderColor = 'rgba(212,175,55,0.6)';
                            card.style.transform = 'translateY(-2px)';
                            card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.4)';
                        }
                    };
                    card.onmouseout = () => {
                        if (selectedStamp !== stamp.id) {
                            card.style.borderColor = 'rgba(212,175,55,0.3)';
                            card.style.transform = 'translateY(0)';
                            card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
                        }
                    };
                    card.onclick = () => {
                        // Only update if different stamp selected
                        if (selectedStamp !== stamp.id) {
                            // Update selected stamp variable
                            selectedStamp = stamp.id;
                            console.log('ðŸŽ¯ Stamp selected:', selectedStamp);
                            
                            // Re-render entire grid to update visual states
                            renderStampGrid();
                            updateGenerateButtonState();
                        }
                    };
                    
                }
                
                // Top-right badge (quantity or unlimited)
                if (isOwned) {
                    const badge = document.createElement('div');
                    badge.style.cssText = `
                        position: absolute;
                        top: 8px;
                        right: 8px;
                        background: ${isUnlimited ? 'linear-gradient(135deg, #ffd700, #ffed4e)' : 'linear-gradient(135deg, #4ade80, #22c55e)'};
                        color: ${isUnlimited ? '#2c2c2c' : 'white'};
                        padding: 4px 10px;
                        border-radius: 16px;
                        font-size: 0.7rem;
                        font-weight: bold;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        z-index: 10;
                    `;
                    badge.textContent = isUnlimited ? 'â™¾ï¸' : `ðŸŽ« ${ownedQuantity}`;
                    card.appendChild(badge);
                }
                
                // Image container (fixed height for alignment)
                const imageContainer = document.createElement('div');
                imageContainer.style.cssText = `
                    height: 100px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 10px;
                    background: rgba(255,255,255,0.02);
                `;
                
                const img = document.createElement('img');
                img.src = stamp.img;
                img.style.cssText = `
                    max-width: 100%;
                    max-height: 100%;
                    object-fit: contain;
                    opacity: ${isOwned ? '1' : '0.7'};
                    filter: ${isOwned ? 'none' : 'grayscale(20%)'};
                `;
                imageContainer.appendChild(img);
                card.appendChild(imageContainer);
                
                // Info section
                const infoSection = document.createElement('div');
                infoSection.style.cssText = `
                    padding: 8px 10px;
                    background: rgba(0,0,0,0.3);
                    border-top: 1px solid rgba(212,175,55,0.15);
                `;
                
                // Name
                const nameDiv = document.createElement('div');
                nameDiv.style.cssText = `
                    font-size: 0.8rem;
                    font-weight: bold;
                    color: var(--gold);
                    margin-bottom: 4px;
                    text-align: center;
                `;
                nameDiv.textContent = stamp.name;
                infoSection.appendChild(nameDiv);
                
                // Status (unified font size)
                const statusDiv = document.createElement('div');
                statusDiv.style.cssText = `
                    font-size: 0.65rem;
                    text-align: center;
                    padding: 4px 6px;
                    border-radius: 4px;
                    margin-bottom: 4px;
                    font-weight: 500;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                `;
                
                if (isOwned) {
                    statusDiv.style.background = 'linear-gradient(to right, rgba(74,222,128,0.2), rgba(34,197,94,0.2))';
                    statusDiv.style.border = '1px solid rgba(74,222,128,0.4)';
                    statusDiv.style.color = '#4ade80';
                    statusDiv.innerHTML = isUnlimited ? 'âœ… Owned (Unlimited)' : `âœ… Owned ${ownedQuantity} stamps`;
                } else if (stamp.id === 'based') {
                    if (canMintBased) {
                        statusDiv.style.background = 'linear-gradient(to right, rgba(255,215,0,0.2), rgba(255,237,78,0.2))';
                        statusDiv.style.border = '1px solid rgba(255,215,0,0.4)';
                        statusDiv.style.color = '#ffd700';
                        statusDiv.innerHTML = 'ðŸŽ Free Mint Unlocked';
                    } else {
                        statusDiv.style.background = 'rgba(100,100,100,0.2)';
                        statusDiv.style.border = '1px solid rgba(150,150,150,0.3)';
                        statusDiv.style.color = 'rgba(255,255,255,0.5)';
                        statusDiv.innerHTML = 'ðŸ”’ Locked - Need 3';
                    }
                } else if (isEligible) {
                    statusDiv.style.background = 'linear-gradient(to right, rgba(74,222,128,0.2), rgba(34,197,94,0.2))';
                    statusDiv.style.border = '1px solid rgba(74,222,128,0.4)';
                    statusDiv.style.color = '#4ade80';
                    statusDiv.style.fontWeight = 'bold';
                    statusDiv.innerHTML = 'ðŸŽ Ready to Claim!';
                } else if (stamp.id === 'warplet') {
                    statusDiv.style.background = 'rgba(255,107,107,0.15)';
                    statusDiv.style.border = '1px solid rgba(255,107,107,0.3)';
                    statusDiv.style.color = '#ff6b6b';
                    statusDiv.innerHTML = 'ðŸ”’ Warplet NFT Required';
                } else {
                    // Not eligible but can purchase - simplified
                    statusDiv.style.background = 'rgba(212,175,55,0.15)';
                    statusDiv.style.border = '1px solid rgba(212,175,55,0.3)';
                    statusDiv.style.color = '#ffd700';
                    statusDiv.innerHTML = 'ðŸ’° Available for Purchase';
                }
                
                infoSection.appendChild(statusDiv);
                
                // Action button (ALL states have buttons - unified style)
                const actionBtn = document.createElement('button');
                actionBtn.style.cssText = `
                    width: 100%;
                    padding: 6px 4px;
                    border: none;
                    border-radius: 4px;
                    font-size: 0.7rem;
                    font-weight: bold;
                    cursor: pointer;
                    transition: all 0.2s;
                    text-transform: none;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                `;
                
                if (isOwned) {
                    // Owned: Show "Details" button
                    actionBtn.style.background = 'linear-gradient(135deg, rgba(212,175,55,0.3), rgba(212,175,55,0.2))';
                    actionBtn.style.border = '1px solid rgba(212,175,55,0.5)';
                    actionBtn.style.color = 'var(--gold)';
                    actionBtn.textContent = 'ðŸ“‹ Details';
                    actionBtn.onclick = (e) => {
                        e.stopPropagation();
                        openStampDetailsModal(stamp.id, stamp.name);
                    };
                } else if (stamp.id === 'based') {
                    if (canMintBased) {
                        actionBtn.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
                        actionBtn.style.color = '#2c2c2c';
                        actionBtn.textContent = 'ðŸŽ Free Mint';
                        actionBtn.onclick = () => mintBasedNFTSimple();
                    } else {
                        actionBtn.style.background = 'rgba(100,100,100,0.3)';
                        actionBtn.style.color = 'rgba(255,255,255,0.4)';
                        actionBtn.style.cursor = 'not-allowed';
                        actionBtn.textContent = 'ðŸ”’ Collect 3 First';
                        actionBtn.disabled = true;
                    }
                } else if (isEligible) {
                    actionBtn.style.background = 'linear-gradient(135deg, #4ade80, #22c55e)';
                    actionBtn.style.color = 'white';
                    actionBtn.style.fontWeight = 'bold';
                    actionBtn.textContent = `ðŸŽ Claim`;
                    actionBtn.onclick = () => claimStampInline(stamp.id, stamp.name, stamp.quantity);
                } else if (stamp.id === 'warplet') {
                    actionBtn.style.background = 'rgba(100,100,100,0.3)';
                    actionBtn.style.color = 'rgba(255,255,255,0.4)';
                    actionBtn.style.cursor = 'not-allowed';
                    actionBtn.textContent = 'ðŸ”’ NFT Required';
                    actionBtn.onclick = (e) => {
                        e.stopPropagation();
                        alert('Warplet NFT Required\n\nYou need to hold a Warplet NFT to use this stamp.\n\nPurchase on OpenSea or Zora.');
                    };
                } else {
                    actionBtn.style.background = 'linear-gradient(135deg, #d4af37, #ffd700)';
                    actionBtn.style.color = '#2c2c2c';
                    actionBtn.textContent = `ðŸ’° Buy ${stamp.price}`;
                    actionBtn.onclick = () => openPurchaseModal(stamp.id, stamp.name, { price: stamp.price, quantity: stamp.quantity });
                }
                
                // Hover effect for active buttons
                if (!actionBtn.disabled) {
                    actionBtn.onmouseover = () => {
                        actionBtn.style.transform = 'translateY(-2px)';
                        actionBtn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.4)';
                    };
                    actionBtn.onmouseout = () => {
                        actionBtn.style.transform = 'translateY(0)';
                        actionBtn.style.boxShadow = 'none';
                    };
                }
                
                infoSection.appendChild(actionBtn);
                card.appendChild(infoSection);
                stampGrid.appendChild(card);
            });
            
            // Render Based progress
            renderBasedProgress();
            
            // Update generate button state
            updateGenerateButtonState();
        }
        
        // Render Based unlock progress
        function renderBasedProgress() {
            const progressDiv = document.getElementById('based-progress-inline');
            if (!progressDiv) return;
            
            const checks = [
                { id: 'neynar', label: 'Neynar', eligible: eligibility?.neynar?.eligible },
                { id: 'farcaster', label: 'Farcaster', eligible: eligibility?.farcaster?.eligible },
                { id: 'warplet', label: 'Warplet', eligible: eligibility?.warplet?.eligible }
            ];
            
            const completedCount = checks.filter(c => c.eligible).length;
            const allCompleted = completedCount === 3;
            
            progressDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 6px; font-size: 0.65rem;">
                    ${allCompleted ? 'âœ… Ready to Mint!' : `ðŸŽ¯ Progress: ${completedCount}/3`}
                </div>
                <div style="display: flex; gap: 3px; margin-bottom: 8px;">
                    ${checks.map(c => `
                        <div style="flex: 1; height: 5px; background: ${c.eligible ? 'linear-gradient(90deg, #4ade80, #22c55e)' : 'rgba(100,100,100,0.3)'}; border-radius: 2px;"></div>
                    `).join('')}
                </div>
                <div style="font-size: 0.55rem; color: rgba(255,255,255,0.7); line-height: 1.5;">
                    ${checks.map(c => `
                        <div style="margin-bottom: 2px;">
                            ${c.eligible ? 'âœ…' : 'âšª'} ${c.label}
                        </div>
                    `).join('')}
                </div>
                ${allCompleted ? `
                    <div style="margin-top: 6px; font-size: 0.5rem; color: #ffd700;">
                        ðŸŽ–ï¸ Mint NFT for â™¾ï¸ unlimited
                    </div>
                ` : `
                    <div style="margin-top: 6px; font-size: 0.5rem; color: rgba(255,255,255,0.5);">
                        Complete all 3 â†’ Mint Based NFT
                    </div>
                `}
            `;
        }
        
        // Claim stamp inline
        function claimStampInline(stampId, stampName, quantity) {
            if (!requireAuth('claim stamps')) return;
            const userFid = getUserFid();
            
            // Stamp quantities from config
            const quantities = {
                neynar: 3,
                farcaster: 10,
                warplet: 5
            };
            
            const claimQuantity = quantities[stampId] || quantity || 1;
            
            userStamps[stampId] = {
                owned: true,
                quantity: claimQuantity,
                acquired_method: 'free',
                acquired_at: new Date().toISOString(),
                first_free_claimed: true
            };
            saveUserStamps(userFid);
            
            // Show success message with celebration
            alert(`ðŸŽ‰ é¢†å–æˆåŠŸï¼Claimed Successfully!\n\nâœ… ${stampName}: +${claimQuantity} stamps\n\nðŸŽ Free reward unlocked!`);
            
            // Re-render
            renderStampGrid();
            updateGenerateButtonState();
            
            // Update status
            const ownedCount = Object.keys(userStamps).filter(k => userStamps[k]?.owned).length;
            const statusIndicator = document.getElementById('stamp-status-indicator');
            if (ownedCount === 4) {
                statusIndicator.innerHTML = '<span style="color: #ffd700;">âœ¨ Based Collector</span>';
            } else {
                statusIndicator.innerHTML = `<span style="color: #4ade80;">âœ“ ${ownedCount} stamp${ownedCount > 1 ? 's' : ''}</span>`;
            }
            document.getElementById('no-stamp-warning').style.display = 'none';
        }
        
        // Open purchase modal
        function openPurchaseModal(stampId, stampName, config) {
            const modal = document.createElement('div');
            modal.id = 'purchase-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.2s;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1a3a2e, #0d1f1a);
                border: 2px solid var(--gold);
                border-radius: 16px;
                padding: 32px;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            `;
            
            let quantity = 1;
            
            const updateDisplay = () => {
                const totalStamps = config.quantity * quantity;
                const totalPrice = (parseFloat(config.price) * quantity).toFixed(2);
                
                qtyText.textContent = `Ã—${quantity}`;
                totalStampsText.textContent = `${totalStamps} stamp${totalStamps > 1 ? 's' : ''} ðŸŽ«`;
                totalPriceText.textContent = `${totalPrice} USDC`;
            };
            
            modalContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--gold); margin-bottom: 8px;">
                        Purchase ${stampName} Stamps
                    </div>
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">
                        ${config.price} USDC = ${config.quantity} stamp${config.quantity > 1 ? 's' : ''}
                    </div>
                </div>
                
                <!-- Quantity Selector -->
                <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 24px;">
                    <button id="qty-minus" style="width: 48px; height: 48px; border: 2px solid var(--gold); background: rgba(212,175,55,0.2); color: var(--gold); border-radius: 8px; cursor: pointer; font-size: 1.5rem; font-weight: bold;">âˆ’</button>
                    <div id="qty-display" style="min-width: 60px; text-align: center; font-size: 2rem; color: var(--gold); font-weight: bold;">Ã—1</div>
                    <button id="qty-plus" style="width: 48px; height: 48px; border: 2px solid var(--gold); background: rgba(212,175,55,0.2); color: var(--gold); border-radius: 8px; cursor: pointer; font-size: 1.5rem; font-weight: bold;">+</button>
                </div>
                
                <!-- Total Display -->
                <div style="background: rgba(0,0,0,0.4); border: 1px solid rgba(212,175,55,0.3); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: rgba(255,255,255,0.7);">Total Stamps:</span>
                        <span id="total-stamps" style="color: #fff; font-weight: bold;">${config.quantity} stamp${config.quantity > 1 ? 's' : ''} ðŸŽ«</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: rgba(255,255,255,0.7);">Total Price:</span>
                        <span id="total-price" style="color: var(--gold); font-weight: bold; font-size: 1.1rem;">${config.price} USDC</span>
                    </div>
                </div>
                
                <!-- Usage Info -->
                <div style="background: rgba(212,175,55,0.1); border: 1px solid rgba(212,175,55,0.3); border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                    <div style="font-size: 0.75rem; font-weight: bold; color: var(--gold); margin-bottom: 8px;">ðŸ“® How Stamps Work:</div>
                    <div style="font-size: 0.7rem; color: rgba(255,255,255,0.7); line-height: 1.6;">
                        â€¢ 1 stamp consumed per friend ðŸŽ« â†’ ðŸ‘¤<br>
                        â€¢ Same postcard â†’ send to multiple people<br>
                        â€¢ Stamps don't expire
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px;">
                    <button id="cancel-purchase" style="flex: 1; padding: 14px; border: 2px solid rgba(212,175,55,0.5); background: transparent; color: var(--gold); border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: bold;">Cancel</button>
                    <button id="confirm-purchase" style="flex: 2; padding: 14px; border: none; background: linear-gradient(135deg, #d4af37, #ffd700); color: #2c2c2c; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: bold;">Purchase Now</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Get elements
            const qtyText = document.getElementById('qty-display');
            const totalStampsText = document.getElementById('total-stamps');
            const totalPriceText = document.getElementById('total-price');
            
            // Quantity controls
            document.getElementById('qty-minus').onclick = () => {
                if (quantity > 1) {
                    quantity--;
                    updateDisplay();
                }
            };
            
            document.getElementById('qty-plus').onclick = () => {
                if (quantity < 10) {
                    quantity++;
                    updateDisplay();
                }
            };
            
            // Cancel
            document.getElementById('cancel-purchase').onclick = () => {
                modal.remove();
            };
            
            // Close on backdrop click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            // Confirm purchase
            document.getElementById('confirm-purchase').onclick = () => {
                modal.remove();
                buyStampInline(stampId, quantity);
            };
        }
        
        // Buy stamp inline
        function buyStampInline(stampId, purchaseQty = 1) {
            const stampQuantities = {
                neynar: 1,  // stamps per purchase
                farcaster: 5,
                warplet: 5
            };
            
            const prices = {
                neynar: 0.1,
                farcaster: 0.37,
                warplet: 0.5
            };
            
            const stampsPerPurchase = stampQuantities[stampId] || 1;
            const pricePerUnit = prices[stampId] || 0.2;
            
            const totalStamps = stampsPerPurchase * purchaseQty;
            const totalPrice = (pricePerUnit * purchaseQty).toFixed(2);
            
            const confirmed = confirm(
                `ðŸ’° Purchase Confirmation\n\n` +
                `Quantity: Ã—${purchaseQty}\n` +
                `Total stamps: ${totalStamps} ðŸŽ«\n` +
                `Total price: ${totalPrice} USDC\n\n` +
                `Proceed with payment?`
            );
            
            if (!confirmed) return;
            
            if (!requireAuth('purchase stamps')) return;
            const userFid = getUserFid();
            
            // TODO: Implement real payment
            alert('è´­ä¹°åŠŸèƒ½å¼€å‘ä¸­...');
        }
        
        // Show stamp preview modal
        function showStampPreview(stampId, stampName, stampImg) {
            const isOwned = userStamps[stampId]?.owned;
            const eligibility = stampEligibility[stampId];
            const isEligible = eligibility?.eligible;
            
            // Set image (use preview version with dark green background)
            document.getElementById('stamp-preview-image').src = stampImg;
            
            // Set name
            document.getElementById('stamp-preview-name').textContent = `${stampName} Stamp`;
            
            // Set reason/eligibility info
            const reasonDiv = document.getElementById('stamp-preview-reason');
            if (isOwned) {
                reasonDiv.innerHTML = `
                    <div style="color: #4ade80; font-weight: bold; margin-bottom: 8px;">âœ“ You own this stamp</div>
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${eligibility?.reason || ''}</div>
                `;
            } else {
                reasonDiv.innerHTML = `
                    <div style="margin-bottom: 8px;">${eligibility?.reason || 'Loading eligibility info...'}</div>
                `;
            }
            
            // Set action button
            const actionDiv = document.getElementById('stamp-preview-action');
            if (isOwned) {
                // Already owned - no action button needed, or show "Use this stamp" button
                actionDiv.innerHTML = `
                    <button onclick="selectAndClosePreview('${stampId}')" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #d4af37, #ffd700); border: none; color: #2c2c2c; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem;">
                        âœ¨ Use This Stamp
                    </button>
                `;
            } else if (isEligible) {
                // Eligible for free claim
                actionDiv.innerHTML = `
                    <button onclick="claimFromPreview('${stampId}')" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #4ade80, #22c55e); border: none; color: white; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem;">
                        ðŸŽ ç¬¦åˆèµ„æ ¼ - å…è´¹é¢†å–
                    </button>
                `;
            } else {
                // Need to buy
                actionDiv.innerHTML = `
                    <button onclick="buyFromPreview('${stampId}')" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #d4af37, #ffd700); border: none; color: #2c2c2c; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem;">
                        ðŸ’° éœ€è¦ 0.2 USDC è´­ä¹°
                    </button>
                `;
            }
            
            // Show modal
            document.getElementById('stamp-preview-modal').classList.add('visible');
        }
        
        // Close stamp preview
        function closeStampPreview() {
            document.getElementById('stamp-preview-modal').classList.remove('visible');
        }
        
        // Select stamp and close preview
        function selectAndClosePreview(stampId) {
            selectedStamp = stampId;
            renderStampGrid();
            closeStampPreview();
        }
        
        // Claim from preview
        function claimFromPreview(stampId) {
            claimStampInline(stampId);
            closeStampPreview();
        }
        
        // Buy from preview
        function buyFromPreview(stampId) {
            buyStampInline(stampId);
            closeStampPreview();
        }
        
        // Open stamp details modal (for owned stamps)
        function openStampDetailsModal(stampId, stampName) {
            const stamp = userStamps[stampId];
            const quantity = stamp?.quantity || 0;
            const isBased = stampId === 'based' && stamp?.permanent;
            
            const modal = document.createElement('div');
            modal.id = 'stamp-details-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.2s;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: #001a10;
                border: 2px solid var(--gold);
                border-radius: 12px;
                padding: 20px 16px 14px 16px;
                max-width: 360px;
                width: 88%;
                box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            `;
            
            const stampPrices = {
                neynar: { price: '0.1', quantity: 3 },
                farcaster: { price: '0.37', quantity: 10 },
                warplet: { price: '0.5', quantity: 5 }
            };
            
            const config = stampPrices[stampId];
            
            // Get stamp image
            const stampImages = {
                neynar: 'stamp/neynar-preview.png',
                farcaster: 'stamp/farcaster-preview.png',
                warplet: 'stamp/warplet-preview.png',
                based: 'stamp/based-preview.png'
            };
            const stampImg = stampImages[stampId] || 'stamp/neynar-preview.png';
            
            // Get stamp requirements and pricing
            const stampRequirements = {
                neynar: { 
                    title: 'Neynar Stamp', 
                    condition: 'Neynar Score > 0.6',
                    freeQty: 3,
                    price: '0.1 USDC',
                    buyQty: 3
                },
                farcaster: { 
                    title: 'Farcaster 2025 Stamp', 
                    condition: 'Farcaster Pro',
                    freeQty: 10,
                    price: '0.37 USDC',
                    buyQty: 10
                },
                warplet: { 
                    title: 'Warplet Stamp', 
                    condition: 'Own Warplet NFT',
                    freeQty: 5,
                    cannotBuy: true  // Can only get by owning NFT
                },
                based: { 
                    title: 'Based Stamp', 
                    condition: 'All 3 stamps owned',
                    price: 'FREE (Gas Only)'
                }
            };
            const stampInfo = stampRequirements[stampId];
            
            modalContent.innerHTML = `
                <!-- Large Title -->
                <div style="text-align: center; margin-bottom: 14px;">
                    <div style="font-size: 1.35rem; font-weight: bold; color: var(--gold); text-transform: uppercase; letter-spacing: 0.08em; line-height: 1.2;">
                        ${stampInfo.title}
                    </div>
                </div>
                
                <!-- Compact Stamp Image -->
                <div style="text-align: center; margin-bottom: 10px;">
                    <img src="${stampImg}" style="width: 160px; height: auto; border-radius: 6px; box-shadow: 0 3px 10px rgba(0,0,0,0.4);">
                </div>
                
                ${!isBased ? `
                    <!-- Complete Info Box with Balance on right -->
                    <div style="background: rgba(212,175,55,0.08); border: 1px solid rgba(212,175,55,0.25); border-radius: 6px; padding: 10px; margin-bottom: 12px; display: flex; gap: 10px;">
                        <!-- Left: Info -->
                        <div style="flex: 1; font-size: 0.6rem; color: rgba(255,255,255,0.7); line-height: 1.6;">
                            <div style="color: rgba(74,222,128,0.9); margin-bottom: 3px;">âœ… Qualified: Get ${stampInfo.freeQty} stamps FREE</div>
                            <div style="color: rgba(255,215,0,0.9); margin-bottom: 3px;">ðŸŽ¯ Requirement: ${stampInfo.condition}</div>
                            ${stampInfo.cannotBuy 
                                ? `<div style="color: rgba(255,100,100,0.9); margin-bottom: 3px;">âš ï¸ Cannot purchase - NFT holders only</div>`
                                : `<div style="color: rgba(255,255,255,0.75); margin-bottom: 3px;">âŒ Not qualified: ${stampInfo.price} = ${stampInfo.buyQty} stamp${stampInfo.buyQty > 1 ? 's' : ''}</div>`
                            }
                            <div style="color: rgba(255,255,255,0.75);">ðŸ“¤ Use: 1 stamp per send</div>
                        </div>
                        
                        <!-- Right: Balance -->
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 65px; border-left: 1px solid rgba(212,175,55,0.2); padding-left: 10px;">
                            <div style="font-size: 0.55rem; color: rgba(255,255,255,0.5); margin-bottom: 2px;">Balance</div>
                            <div style="font-size: 1.6rem; color: #4ade80; font-weight: bold; line-height: 1;">${quantity}</div>
                            <div style="font-size: 0.9rem; line-height: 1;">ðŸŽ«</div>
                        </div>
                    </div>
                    
                    <!-- Purchase Section -->
                    ${config ? `
                        <div style="background: rgba(0,0,0,0.35); border: 1px solid rgba(212,175,55,0.25); border-radius: 6px; padding: 10px; margin-bottom: 12px;">
                            <div style="font-size: 0.6rem; color: rgba(255,255,255,0.45); margin-bottom: 10px; text-align: center;">
                                ${config.price} USDC = ${config.quantity} stamp${config.quantity > 1 ? 's' : ''}
                            </div>
                            
                            <!-- Quantity Selector -->
                            <div style="display: flex; align-items: center; justify-content: center; gap: 14px; margin-bottom: 10px;">
                                <button id="decrease-qty" style="width: 40px; height: 40px; border: 1.5px solid var(--gold); background: transparent; color: var(--gold); border-radius: 6px; cursor: pointer; font-size: 1.3rem; font-weight: bold; display: flex; align-items: center; justify-content: center;">âˆ’</button>
                                <div style="font-size: 1.15rem; color: #fff; min-width: 60px; text-align: center; font-weight: bold;">Ã—<span id="purchase-qty">1</span></div>
                                <button id="increase-qty" style="width: 40px; height: 40px; border: 1.5px solid var(--gold); background: transparent; color: var(--gold); border-radius: 6px; cursor: pointer; font-size: 1.3rem; font-weight: bold; display: flex; align-items: center; justify-content: center;">+</button>
                            </div>
                            
                            <!-- Total -->
                            <div style="background: rgba(0,0,0,0.3); padding: 5px; border-radius: 4px; margin-bottom: 8px; text-align: center;">
                                <div style="font-size: 0.58rem; color: rgba(255,255,255,0.5);">Total: <span id="total-stamps" style="color: #4ade80;">${config.quantity}</span> ðŸŽ« | <span id="total-price" style="color: var(--gold); font-weight: bold;">${config.price}</span> USDC</div>
                            </div>
                            
                            <button id="buy-more-stamps" style="width: 100%; padding: 10px; border: none; background: linear-gradient(135deg, #d4af37, #ffd700); color: #2c2c2c; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: bold; text-transform: uppercase;">
                                Purchase Now
                            </button>
                        </div>
                    ` : ''}
                ` : `
                    <!-- Based Status -->
                    <div style="text-align: center; margin-bottom: 12px;">
                        <div style="font-size: 0.6rem; color: rgba(255,255,255,0.4); margin-bottom: 3px;">Status</div>
                        <div style="font-size: 2rem; color: #4ade80; font-weight: bold; line-height: 1;">â™¾ï¸</div>
                        <div style="font-size: 0.75rem; color: #4ade80; margin-top: 4px; font-weight: bold;">Unlimited</div>
                    </div>
                    
                    <!-- Based Info Box -->
                    <div style="background: rgba(74,222,128,0.08); border: 1px solid rgba(74,222,128,0.3); border-radius: 6px; padding: 10px; margin-bottom: 12px;">
                        <div style="font-size: 0.6rem; color: rgba(255,255,255,0.7); line-height: 1.6;">
                            <div style="color: rgba(255,215,0,0.9); margin-bottom: 3px;">ðŸŽ¯ Requirement: ${stampInfo.condition}</div>
                            <div style="color: rgba(255,255,255,0.75); margin-bottom: 3px;">ðŸ’° Mint: ${stampInfo.price} (one-time)</div>
                            <div style="color: rgba(74,222,128,0.9); margin-bottom: 3px;">âœ… Benefit: Unlimited sends forever</div>
                            <div style="color: rgba(255,255,255,0.75);">ðŸŽ–ï¸ NFT Minted: ${stamp.acquired_at ? new Date(stamp.acquired_at).toLocaleDateString() : 'N/A'}</div>
                        </div>
                    </div>
                `}
                
                <!-- Close Button -->
                <button id="close-details" style="width: 100%; padding: 7px; border: 1.5px solid rgba(212,175,55,0.4); background: transparent; color: var(--gold); border-radius: 6px; cursor: pointer; font-size: 0.7rem; font-weight: bold;">Close</button>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close handlers
            document.getElementById('close-details').onclick = () => {
                modal.remove();
            };
            
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            // Quantity selector logic
            let purchaseQty = 1;
            const updatePurchaseTotal = () => {
                if (config) {
                    const totalStamps = purchaseQty * config.quantity;
                    const totalPrice = (purchaseQty * parseFloat(config.price)).toFixed(2);
                    document.getElementById('total-stamps').textContent = totalStamps;
                    document.getElementById('total-price').textContent = totalPrice;
                }
            };
            
            const decreaseBtn = document.getElementById('decrease-qty');
            const increaseBtn = document.getElementById('increase-qty');
            
            if (decreaseBtn) {
                decreaseBtn.onclick = () => {
                    if (purchaseQty > 1) {
                        purchaseQty--;
                        document.getElementById('purchase-qty').textContent = purchaseQty;
                        updatePurchaseTotal();
                    }
                };
            }
            
            if (increaseBtn) {
                increaseBtn.onclick = () => {
                    if (purchaseQty < 10) {
                        purchaseQty++;
                        document.getElementById('purchase-qty').textContent = purchaseQty;
                        updatePurchaseTotal();
                    }
                };
            }
            
            // Buy more button (inline purchase)
            const buyMoreBtn = document.getElementById('buy-more-stamps');
            if (buyMoreBtn) {
                buyMoreBtn.onclick = async () => {
                    const totalPrice = (purchaseQty * parseFloat(config.price)).toFixed(2);
                    const totalStamps = purchaseQty * config.quantity;
                    
                    if (TEST_MODE) {
                        // TEST MODE: Instant purchase
                        if (!requireAuth('purchase stamps')) return;
                        const userFid = getUserFid();
                        userStamps[stampId].quantity += totalStamps;
                        saveUserStamps(userFid);
                        
                        alert(`ðŸ§ª TEST MODE: Purchased ${totalStamps} stamps!\n\nNew balance: ${userStamps[stampId].quantity} stamps`);
                        modal.remove();
                        renderStampGrid();
                    } else {
                        // Real purchase flow
                        modal.remove();
                        openPurchaseModal(stampId, stampName, { ...config, quantity: totalStamps, price: totalPrice });
                    }
                };
            }
        }
        
        // Open Based Mint Modal
        function openBasedMintModal() {
            const modal = document.createElement('div');
            modal.id = 'based-mint-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.2s;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1a3a2e, #0d1f1a);
                border: 2px solid var(--gold);
                border-radius: 16px;
                padding: 32px;
                max-width: 450px;
                width: 90%;
                box-shadow: 0 8px 32px rgba(255,215,0,0.3);
            `;
            
            modalContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="font-size: 3rem; margin-bottom: 12px;">ðŸŽ</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--gold); margin-bottom: 8px;">
                        Free Mint Based NFT
                    </div>
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">
                        ðŸ† Reward for Collecting All 3 Stamps
                    </div>
                </div>
                
                <!-- Benefits -->
                <div style="background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <div style="font-size: 0.8rem; font-weight: bold; color: var(--gold); margin-bottom: 12px;">ðŸ’Ž What You Get:</div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.8); line-height: 1.8;">
                        â€¢ â™¾ï¸ Unlimited postcard sending forever<br>
                        â€¢ ðŸ† Exclusive Based collector status<br>
                        â€¢ ðŸ”— Permanent on-chain proof<br>
                        â€¢ ðŸ’Ž Your Farcaster journey immortalized
                    </div>
                </div>
                
                <!-- Price -->
                <div style="background: linear-gradient(135deg, rgba(74,222,128,0.15), rgba(34,197,94,0.15)); border: 1px solid rgba(74,222,128,0.4); border-radius: 8px; padding: 16px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 0.7rem; color: rgba(255,255,255,0.6); margin-bottom: 4px;">Mint Cost</div>
                    <div style="font-size: 2rem; color: #4ade80; font-weight: bold;">FREE</div>
                    <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5); margin-top: 4px;">(You only pay gas fee)</div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px;">
                    <button id="cancel-mint" style="flex: 1; padding: 14px; border: 2px solid rgba(212,175,55,0.5); background: transparent; color: var(--gold); border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: bold;">Cancel</button>
                    <button id="confirm-mint" style="flex: 2; padding: 14px; border: none; background: linear-gradient(135deg, #ffd700, #ffed4e); color: #2c2c2c; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: bold;">ðŸŽ Free Mint</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Cancel
            document.getElementById('cancel-mint').onclick = () => {
                modal.remove();
            };
            
            // Close on backdrop click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            // Confirm mint
            document.getElementById('confirm-mint').onclick = () => {
                modal.remove();
                mintBasedNFT();
            };
        }
        
        // Use EIP-1193 provider.request() - the Farcaster way
        async function mintBasedNFTSimple() {
            const loadingToast = showLoadingToast('Initializing...');
            
            try {
                console.log('ðŸŽ¯ Starting Based NFT claim with EIP-1193...');
                
                // Get Farcaster SDK
                const sdk = window.farcasterSDK;
                if (!sdk) {
                    if (document.body.contains(loadingToast)) {
                        document.body.removeChild(loadingToast);
                    }
                    alert('âŒ Farcaster SDK not loaded\n\nPlease refresh the page.');
                    return;
                }
                
                loadingToast.textContent = 'Getting wallet...';
                const provider = await sdk.wallet.getEthereumProvider();
                
                if (!provider) {
                    if (document.body.contains(loadingToast)) {
                        document.body.removeChild(loadingToast);
                    }
                    alert('âŒ Wallet not available\n\nPlease try again.');
                    return;
                }
                
                console.log('âœ… Provider:', provider);
                
                loadingToast.textContent = 'Getting address...';
                
                // Get user address using EIP-1193
                const accounts = await provider.request({ 
                    method: 'eth_requestAccounts' 
                });
                const userAddress = accounts[0];
                
                console.log('ðŸ” Wallet:', userAddress);
                
                const CONTRACT_ADDRESS = '0x6D3634AA13F3b719A6d1209036da056F6788cdd6';
                
                // Encode claim function data
                const iface = new ethers.Interface([
                    'function claim(address _receiver, uint256 _tokenId, uint256 _quantity, address _currency, uint256 _pricePerToken, tuple(bytes32[] proof, uint256 quantityLimitPerWallet, uint256 pricePerToken, address currency) _allowlistProof, bytes _data)'
                ]);
                
                const claimData = iface.encodeFunctionData('claim', [
                    userAddress,
                    0,
                    1,
                    '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE',
                    0,
                    {
                        proof: [],
                        quantityLimitPerWallet: 0,
                        pricePerToken: 0,
                        currency: '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE'
                    },
                    '0x'
                ]);
                
                console.log('ðŸ“ Encoded data:', claimData);
                
                loadingToast.textContent = 'Sending transaction...';
                
                // Send transaction using EIP-1193 provider.request()
                const txHash = await provider.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: userAddress,
                        to: CONTRACT_ADDRESS,
                        data: claimData,
                        value: '0x0'
                    }]
                });
                
                console.log('ðŸ“ Transaction sent:', txHash);
                
                // Remove loading toast immediately - don't wait for confirmation
                if (document.body.contains(loadingToast)) {
                    document.body.removeChild(loadingToast);
                }
                
                // Update stamps immediately
                const userFid = getUserFid();
                userStamps.based = {
                    owned: true,
                    quantity: Infinity,
                    permanent: true,
                    acquired_method: 'minted',
                    acquired_at: new Date().toISOString(),
                    tx_hash: txHash,
                    contract: CONTRACT_ADDRESS
                };
                
                saveUserStamps(userFid);
                
                // Check NFT ownership (will auto-detect after a few seconds)
                setTimeout(() => {
                    checkBasedNFTOwnership();
                }, 3000);
                
                renderStampGrid();
                showBasedMintSuccessToast();
                
            } catch (error) {
                console.error('âŒ Claim failed:', error);
                console.error('Full error:', JSON.stringify(error, null, 2));
                
                const toasts = document.querySelectorAll('body > div');
                toasts.forEach(toast => {
                    if (toast.textContent && toast.textContent.includes('...')) {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                    }
                });
                
                if (error.code === 'ACTION_REJECTED' || error.code === 4001) {
                    alert('âŒ Transaction Cancelled\n\nYou rejected the transaction.');
                } else {
                    alert(`âŒ Claim Failed\n\n${error.message || 'Unknown error'}\n\nPlease check console for details.`);
                }
            }
        }
        
        // Old complex mint function (backup)
        async function mintBasedNFT() {
            const loadingToast = showLoadingToast('Initializing...');
            
            try {
                console.log('ðŸŽ¯ Starting Based NFT mint...');
                
                // Get Farcaster SDK
                const sdk = window.farcasterSDK;
                console.log('SDK available?', !!sdk);
                
                if (!sdk) {
                    if (document.body.contains(loadingToast)) {
                        document.body.removeChild(loadingToast);
                    }
                    alert('âŒ Farcaster SDK not loaded\n\nPlease refresh the page.');
                    return;
                }
                
                loadingToast.textContent = 'Getting wallet provider...';
                console.log('ðŸ” Getting Ethereum provider...');
                
                // Get Ethereum provider from Farcaster SDK
                const provider = await sdk.wallet.getEthereumProvider();
                console.log('Provider received:', !!provider);
                
                if (!provider) {
                    if (document.body.contains(loadingToast)) {
                        document.body.removeChild(loadingToast);
                    }
                    alert('âŒ Wallet not available\n\nPlease try again.');
                    return;
                }
                
                loadingToast.textContent = 'Connecting to wallet...';
                console.log('ðŸ”— Creating ethers provider...');
                
                // Create ethers provider and signer
                const ethersProvider = new ethers.BrowserProvider(provider);
                const signer = await ethersProvider.getSigner();
                const userAddress = await signer.getAddress();
                
                console.log('ðŸ” Connected wallet:', userAddress);
                loadingToast.textContent = 'Wallet connected!';
                
                // Based NFT Contract Configuration (thirdweb Edition Drop)
                const BASED_NFT_CONTRACT = '0x6D3634AA13F3b719A6d1209036da056F6788cdd6';
                const BASED_NFT_ABI = [
                    'function claim(address _receiver, uint256 _tokenId, uint256 _quantity, address _currency, uint256 _pricePerToken, tuple(bytes32[] proof, uint256 quantityLimitPerWallet, uint256 pricePerToken, address currency) _allowlistProof, bytes _data) public payable',
                    'function balanceOf(address owner, uint256 tokenId) public view returns (uint256)',
                    'function totalSupply(uint256 tokenId) public view returns (uint256)'
                ];
                
                loadingToast.textContent = 'Preparing transaction...';
                console.log('ðŸ“ Contract:', BASED_NFT_CONTRACT);
                
                // Connect to contract
                const basedContract = new ethers.Contract(BASED_NFT_CONTRACT, BASED_NFT_ABI, signer);
                console.log('âœ… Contract instance created');
                
                loadingToast.textContent = 'Calling your wallet...';
                
                // Debug: Check network
                const network = await ethersProvider.getNetwork();
                console.log('ðŸ“¡ Network:', {
                    name: network.name,
                    chainId: Number(network.chainId)
                });
                
                // Debug: Check if contract exists
                const code = await ethersProvider.getCode(BASED_NFT_CONTRACT);
                console.log('ðŸ“„ Contract code exists:', code !== '0x');
                
                if (code === '0x') {
                    throw new Error('Contract not found on this network. Are you on Base mainnet?');
                }
                
                // thirdweb claim function with full parameters
                console.log('ðŸŽ¯ Calling claim() for thirdweb Edition Drop...');
                console.log('Contract:', BASED_NFT_CONTRACT);
                console.log('User:', userAddress);
                
                // Parameters for free claim
                const receiver = userAddress;
                const tokenId = 0; // Token ID (usually 0 for Edition Drop)
                const quantity = 1; // Claim 1 NFT
                const currency = '0x0000000000000000000000000000000000000000'; // ETH (but price is 0)
                const pricePerToken = 0; // Free mint
                const allowlistProof = {
                    proof: [],
                    quantityLimitPerWallet: 0,
                    pricePerToken: 0,
                    currency: '0x0000000000000000000000000000000000000000'
                };
                const data = '0x'; // Empty data
                
                console.log('ðŸ“ Claim parameters:', {
                    receiver,
                    tokenId,
                    quantity,
                    currency,
                    pricePerToken,
                    allowlistProof,
                    data
                });
                
                // Try to estimate gas first
                try {
                    const gasEstimate = await basedContract.claim.estimateGas(
                        receiver,
                        tokenId,
                        quantity,
                        currency,
                        pricePerToken,
                        allowlistProof,
                        data
                    );
                    console.log('â›½ Gas estimate:', gasEstimate.toString());
                } catch (gasError) {
                    console.error('âŒ Gas estimation failed:', gasError);
                    console.error('Gas error details:', {
                        message: gasError.message,
                        reason: gasError.reason,
                        code: gasError.code
                    });
                    throw new Error(`Gas estimation failed: ${gasError.reason || gasError.message}`);
                }
                
                // Call claim function with all parameters
                const tx = await basedContract.claim(
                    receiver,
                    tokenId,
                    quantity,
                    currency,
                    pricePerToken,
                    allowlistProof,
                    data,
                    { value: 0 } // No ETH payment
                );
                
                console.log('ðŸ“ Transaction sent:', tx.hash);
                loadingToast.textContent = 'Confirming transaction...';
                
                // Wait for confirmation
                const receipt = await tx.wait();
                console.log('âœ… Transaction confirmed:', receipt);
                
                // Remove loading
                if (document.body.contains(loadingToast)) {
                    document.body.removeChild(loadingToast);
                }
                
                // Update user stamps with transaction proof
                const userFid = getUserFid();
                userStamps.based = {
                    owned: true,
                    quantity: Infinity,
                    permanent: true,
                    acquired_method: 'minted',
                    acquired_at: new Date().toISOString(),
                    mint_price: 'free',
                    nft_minted: true,
                    tx_hash: tx.hash, // âœ… Transaction proof
                    contract: BASED_NFT_CONTRACT
                };
                
                saveUserStamps(userFid);
                renderStampGrid();
                showBasedMintSuccessToast();
                
                console.log('âœ… Based stamp minted successfully:', tx.hash);
                
            } catch (error) {
                console.error('âŒ Mint failed:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    data: error.data
                });
                
                // Remove loading toast
                const loadingToasts = document.querySelectorAll('body > div');
                loadingToasts.forEach(toast => {
                    if (toast.textContent && toast.textContent.includes('...')) {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                    }
                });
                
                // User rejected transaction
                if (error.code === 'ACTION_REJECTED' || error.code === 4001) {
                    alert('âŒ Transaction Cancelled\n\nYou rejected the transaction.');
                } else if (error.message && error.message.includes('user rejected')) {
                    alert('âŒ Transaction Cancelled\n\nYou rejected the transaction.');
                } else {
                    alert(`âŒ Mint Failed\n\n${error.message || 'Unknown error'}\n\nCheck console for details.`);
                }
            }
        }
        
        // Show loading toast
        function showLoadingToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.9);
                color: white;
                padding: 20px 30px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.5);
                z-index: 10000;
                text-align: center;
                font-size: 1rem;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            return toast;
        }
        
        // Show Based mint success toast
        function showBasedMintSuccessToast() {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #ffd700, #ffed4e);
                color: #2c2c2c;
                padding: 32px 40px;
                border-radius: 16px;
                box-shadow: 0 8px 32px rgba(255,215,0,0.4);
                z-index: 10000;
                text-align: center;
                animation: scaleIn 0.3s ease-out;
                max-width: 400px;
            `;
            
            toast.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 16px;">ðŸŽ–ï¸</div>
                <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 12px;">Based NFT Minted!</div>
                <div style="font-size: 1rem; margin-bottom: 8px; opacity: 0.8;">Congratulations!</div>
                <div style="font-size: 0.9rem; opacity: 0.7;">
                    You now have â™¾ï¸ unlimited postcard sending<br>
                    Your achievement is forever on-chain ðŸ”—
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'scaleOut 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // Show Based unlock toast (legacy - kept for backwards compatibility)
        function showBasedUnlockToast() {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #d4af37, #ffd700);
                color: #2c2c2c;
                padding: 16px 24px;
                border-radius: 12px;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(212,175,55,0.5);
                animation: slideDown 0.5s ease;
            `;
            toast.innerHTML = 'ðŸŽŠ BASED STAMP UNLOCKED! ðŸŒŸ';
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideUp 0.5s ease';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }
        
        // Load user's stamps from localStorage
        function loadUserStamps(fid) {
            const key = `stamps_${fid}`;
            const stored = localStorage.getItem(key);
            userStamps = stored ? JSON.parse(stored) : {
                neynar: { owned: false },
                farcaster: { owned: false },
                warplet: { owned: false },
                based: { owned: false }
            };
            
            // Migrate old data: Add quantity field if missing
            const defaultQuantities = {
                neynar: 1,
                farcaster: 5,
                warplet: 5
            };
            
            let needsSave = false;
            for (const stampId in userStamps) {
                if (userStamps[stampId]?.owned && userStamps[stampId].quantity === undefined) {
                    // Old data without quantity - add default
                    userStamps[stampId].quantity = defaultQuantities[stampId] || 1;
                    needsSave = true;
                }
            }
            
            if (needsSave) {
                localStorage.setItem(key, JSON.stringify(userStamps));
            }
            
            // Based is now mint-only, remove auto-unlock
            // (Users with Based from before keep it)
        }
        
        // Save user's stamps to localStorage
        function saveUserStamps(fid) {
            const key = `stamps_${fid}`;
            localStorage.setItem(key, JSON.stringify(userStamps));
        }
        
        // Original direct gift modal (renamed)
        function openOriginalDirectGiftModal() {
            document.getElementById('direct-gift-modal').classList.add('visible');
            selectedRecipients = [];
            document.getElementById('user-search').value = '';
            document.getElementById('selected-users').innerHTML = '';
            document.getElementById('user-results').style.display = 'none';
            document.getElementById('direct-gift-amount').value = '0.5';
            document.getElementById('direct-gift-token').value = 'USDC';
            document.getElementById('custom-token-group').style.display = 'none';
            
            // Reset AI generation state
            document.getElementById('ai-generate-section').style.display = 'block';
            document.getElementById('ai-preview-section').style.display = 'none';
            isAIGenerated = false;
            aiGenerationCount = 0;
            updateDirectPreview();
        }
        
        async function fetchTopFriends() {
            try {
                const loadingMsg = document.getElementById('selected-users');
                loadingMsg.innerHTML = '<div style="color:rgba(255,255,255,0.5);font-size:0.8rem;text-align:center;padding:12px;">ðŸ” Finding your best friends...</div>';
                
                // Use current user's fid
                const fid = currentUser?.fid;
                if (!fid) {
                    loadingMsg.innerHTML = '<div style="color:rgba(255,107,107,0.8);font-size:0.8rem;text-align:center;padding:12px;">è¯·å…ˆç™»å½•Farcasterè´¦å·</div>';
                    return;
                }
                
                // Call new best_friends API
                const res = await fetch(`/api/neynar?action=best_friends&fid=${fid}`);
                const data = await res.json();
                
                if (data.success && data.users?.length > 0) {
                    // Map to selectedRecipients format
                    selectedRecipients = data.users.map(u => ({
                        fid: u.fid,
                        username: u.username,
                        display_name: u.display_name,
                        pfp_url: u.pfp_url,
                        is_mutual: u.is_mutual,
                        friendship_score: u.friendship_score
                    }));
                    
                    renderSelectedUsers();
                    updateDirectPreview();
                    
                    // Show success message with interaction stats
                    const mutualCount = data.users.filter(u => u.is_mutual).length;
                    const topInteraction = data.top_interaction_type;
                    const userLabel = "Your";
                    setTimeout(() => {
                        const hint = document.createElement('div');
                        hint.style.cssText = 'font-size:0.7rem;color:#4ade80;text-align:center;margin-top:8px;';
                        hint.innerHTML = `âœ… ${userLabel} top ${data.users.length} friends with most interactions (${mutualCount} mutual)<br>
                            <span style="font-size:0.65rem;color:rgba(255,255,255,0.6);">
                                ðŸ’¬ ${topInteraction.replies || 0} replies Â· â¤ï¸ ${topInteraction.likes || 0} likes Â· ðŸ”„ ${topInteraction.recasts || 0} recasts
                            </span>`;
                        loadingMsg.appendChild(hint);
                        setTimeout(() => hint.remove(), 4000);
                    }, 100);
                } else {
                    loadingMsg.innerHTML = '<div style="color:#ff6b6b;font-size:0.75rem;text-align:center;padding:12px;">âš ï¸ No friends found. Try searching manually.</div>';
                    setTimeout(() => {
                        loadingMsg.innerHTML = '';
                    }, 3000);
                }
            } catch (e) { 
                console.error('Failed to fetch best friends:', e);
                document.getElementById('selected-users').innerHTML = '<div style="color:#ff6b6b;font-size:0.75rem;text-align:center;padding:12px;">âŒ Failed to load friends</div>';
                setTimeout(() => {
                    document.getElementById('selected-users').innerHTML = '';
                }, 3000);
            }
        }
        function closeDirectGiftModal() { 
            document.getElementById('direct-gift-modal').classList.remove('visible');
            
            // Reset AI generation state (but keep cache for next time)
            // Don't reset currentAIImage, currentAIGreeting, currentAIScene - keep them cached
            // But reset the generation flags so modal can reload properly next time
            isAIGenerated = false;
            aiGenerationCount = 0;
            
            // Reset UI state
            document.getElementById('ai-generate-section').style.display = 'block';
            document.getElementById('ai-preview-section').style.display = 'none';
        }
        
        async function searchUsers(query) {
            if (searchTimeout) clearTimeout(searchTimeout);
            const resultsDiv = document.getElementById('user-results');
            if (!query || query.length < 2) { resultsDiv.style.display = 'none'; return; }
            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`/api/neynar?action=search&q=${encodeURIComponent(query)}&limit=5`);
                    const data = await res.json();
                    if (data.result?.users?.length > 0) {
                        resultsDiv.innerHTML = data.result.users.map(u => `
                            <div class="user-result" onclick='selectUser(${JSON.stringify(u).replace(/'/g, "&#39;")})'>
                                <img src="${u.pfp_url || 'https://via.placeholder.com/32'}" onerror="this.src='https://via.placeholder.com/32'">
                                <div class="info"><div class="name">${u.display_name || u.username}</div><div class="username">@${u.username}</div></div>
                            </div>
                        `).join('');
                        resultsDiv.style.display = 'block';
                    } else { resultsDiv.style.display = 'none'; }
                } catch (e) { console.error(e); resultsDiv.style.display = 'none'; }
            }, 300);
        }

        async function searchUsersPlaza(query) {
            if (searchTimeout) clearTimeout(searchTimeout);
            const resultsDiv = document.getElementById('plaza-user-results');
            if (!query || query.length < 2) { resultsDiv.style.display = 'none'; return; }
            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`/api/neynar?action=search&q=${encodeURIComponent(query)}&limit=5`);
                    const data = await res.json();
                    if (data.result?.users?.length > 0) {
                        resultsDiv.innerHTML = data.result.users.map(u => `
                            <div class="user-result" onclick='selectUserPlaza(${JSON.stringify(u).replace(/'/g, "&#39;")})'>
                                <img src="${u.pfp_url || 'https://via.placeholder.com/32'}" onerror="this.src='https://via.placeholder.com/32'">
                                <div class="info"><div class="name">${u.display_name || u.username}</div><div class="username">@${u.username}</div></div>
                            </div>
                        `).join('');
                        resultsDiv.style.display = 'block';
                    } else { resultsDiv.style.display = 'none'; }
                } catch (e) { console.error(e); resultsDiv.style.display = 'none'; }
            }, 300);
        }

        function selectUserPlaza(user) {
            document.getElementById('gift-recipient').value = user.username;
            document.getElementById('plaza-user-results').style.display = 'none';
            document.getElementById('selected-user').innerHTML = `
                <div style="display:flex; align-items:center; gap:8px; margin-top:8px; padding:8px; background:rgba(212,175,55,0.1); border-radius:4px;">
                    <img src="${user.pfp_url || ''}" style="width:24px; height:24px; border-radius:50%;" onerror="this.src='https://via.placeholder.com/24'">
                    <span style="color:var(--gold);">@${user.username}</span>
                </div>
            `;
            window.selectedPlazaUser = user;
        }
        
        function selectUser(user) {
            if (selectedRecipients.find(r => r.fid === user.fid)) { alert('Already selected'); return; }
            if (selectedRecipients.length >= MAX_RECIPIENTS) { alert('Max ' + MAX_RECIPIENTS + ' recipients'); return; }
            selectedRecipients.push(user);
            document.getElementById('user-search').value = '';
            document.getElementById('user-results').style.display = 'none';
            renderSelectedUsers();
            updateDirectPreview();
        }
        
        function renderSelectedUsers() {
            const div = document.getElementById('selected-users');
            if (selectedRecipients.length === 0) { div.innerHTML = ''; return; }
            div.innerHTML = `<div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;">${selectedRecipients.map((u, i) => `
                <div class="selected-user-card" style="flex:none; padding:6px 10px;">
                    <img src="${u.pfp_url || 'https://via.placeholder.com/24'}" style="width:24px; height:24px;" onerror="this.src='https://via.placeholder.com/24'">
                    <span style="color:var(--gold); font-size:0.8rem;">@${u.username}</span>
                    <button class="remove-btn" onclick="removeUser(${i})" style="font-size:1rem; padding:2px;">Ã—</button>
                </div>
            `).join('')}</div><div style="font-size:0.7rem; color:rgba(255,255,255,0.4); margin-top:6px;">${selectedRecipients.length}/${MAX_RECIPIENTS}</div>`;
        }
        
        function removeUser(index) { selectedRecipients.splice(index, 1); renderSelectedUsers(); updateDirectPreview(); }
        
        function toggleGiftMoney() {
            const includeGift = document.getElementById('include-gift-money').checked;
            document.getElementById('gift-money-section').style.display = includeGift ? 'block' : 'none';
            updateDirectPreview();
        }
        
        function toggleCustomToken() {
            const token = document.getElementById('direct-gift-token').value;
            document.getElementById('custom-token-group').style.display = token === 'CUSTOM' ? 'block' : 'none';
            updateDirectPreview();
        }
        
        function validateDirectAmount() {
            const input = document.getElementById('direct-gift-amount');
            if (parseFloat(input.value) < 0.1) {
                input.value = '0.1';
            }
        }
        
        function updateDirectPreview() {
            const amount = document.getElementById('direct-gift-amount').value || '0';
            let token = document.getElementById('direct-gift-token').value;
            if (token === 'CUSTOM') token = 'TOKEN';
            
            // Only show "each" if 2+ recipients
            const recipientCount = selectedRecipients.length;
            const eachText = recipientCount > 1 ? ' each' : '';
            
            document.getElementById('direct-preview-amount').textContent = amount + ' ' + token + eachText;
            document.getElementById('direct-preview-info').textContent = recipientCount > 0 
                ? 'â†’ ' + selectedRecipients.map(u => '@' + u.username).join(', ')
                : 'Select recipient(s) above';
        }
        
        // Store generated AI postcard data
        let aiGenerationCount = 0;
        let currentAIImage = null;
        let currentAIGreeting = null;
        let currentAIScene = null;
        let isAIGenerated = false;
        const REGENERATE_COST = 0.1;
        const PAYMENT_ADDRESS = '0x0f540466695cf91203ed8cbca3065fe7232154b9';
        
        // ===== IndexedDB Cache System (supports large images) =====
        const DB_NAME = 'XmasTreeDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'postcards';
        
        // Check if IndexedDB is available (Farcaster Mini App / mobile compatibility)
        function isIndexedDBAvailable() {
            try {
                // Check if IndexedDB exists and is accessible
                if (!window.indexedDB) {
                    console.warn('âš ï¸ IndexedDB not found in this environment');
                    return false;
                }
                
                // Test if we can actually open a database (some iframe contexts block this)
                // This is important for Farcaster Mini Apps running in WebView
                return true;
            } catch (e) {
                console.warn('âš ï¸ IndexedDB check failed:', e.message);
                return false;
            }
        }
        
        // Log environment info on load (helpful for debugging Mini App issues)
        console.log('ðŸŽ¯ Environment:', {
            isFrame: window.self !== window.top,
            hasIndexedDB: !!window.indexedDB,
            isMiniApp: window.location.href.includes('vercel.app'),
            userAgent: navigator.userAgent.includes('Warpcast') ? 'Warpcast' : 'Other'
        });
        
        // Initialize IndexedDB
        function openDB() {
            return new Promise((resolve, reject) => {
                // Check availability first
                if (!isIndexedDBAvailable()) {
                    console.warn('âš ï¸ IndexedDB not available (privacy mode or unsupported browser)');
                    reject(new Error('IndexedDB not available'));
                    return;
                }
                
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('âŒ IndexedDB open failed:', request.error);
                    reject(request.error);
                };
                request.onsuccess = () => {
                    console.log('âœ… IndexedDB opened successfully');
                    resolve(request.result);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'fid' });
                        console.log('ðŸ“¦ Created IndexedDB object store');
                    }
                };
            });
        }
        
        // Save AI postcard to IndexedDB (supports large images)
        async function saveAIPostcardCache(fid) {
            try {
                const db = await openDB();
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                const cache = {
                    fid: fid,
                    image: currentAIImage,  // Now we can store large images!
                    greeting: currentAIGreeting,
                    scene: currentAIScene,
                    generatedAt: Date.now(),
                    stampUsed: selectedStamp,
                    generationCount: aiGenerationCount  // Save generation count
                };
                
                store.put(cache);
                
                await new Promise((resolve, reject) => {
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = () => reject(transaction.error);
                });
                
                console.log('ðŸ’¾ Cached postcard to IndexedDB (with image data)');
            } catch (e) {
                console.warn('âš ï¸ Failed to cache postcard to IndexedDB:', e.message);
                // Mobile/Privacy mode: Show helpful tip
                if (e.message && e.message.includes('IndexedDB not available')) {
                    console.info('ðŸ’¡ Tip: Exit private/incognito mode to enable caching');
                }
            }
        }
        
        // Load AI postcard from IndexedDB
        async function loadAIPostcardCache(fid) {
            try {
                const db = await openDB();
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(fid);
                
                const cache = await new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                
                if (!cache) return null;
                
                // Cache expires after 7 days
                const age = Date.now() - cache.generatedAt;
                if (age > 7 * 24 * 60 * 60 * 1000) {
                    await clearAIPostcardCache(fid);
                    return null;
                }
                
                return cache;
            } catch (e) {
                console.error('Failed to load AI cache from IndexedDB:', e);
                return null;
            }
        }
        
        // Clear AI postcard from IndexedDB
        async function clearAIPostcardCache(fid) {
            try {
                const db = await openDB();
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                store.delete(fid);
                
                await new Promise((resolve, reject) => {
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = () => reject(transaction.error);
                });
                
                console.log('ðŸ—‘ï¸ Cleared postcard cache from IndexedDB');
            } catch (e) {
                console.warn('âš ï¸ Failed to clear cache from IndexedDB:', e.message);
            }
        }
        
        // Update Send Gift button state
        function updateSendGiftButtonState() {
            const btn = document.getElementById('send-gift-btn');
            if (!btn) return;
            
            if (isAIGenerated && currentAIImage) {
                // Enable button
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.innerHTML = '<span>ðŸŽ Send Gift</span>';
            } else {
                // Disable button
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
                btn.innerHTML = '<span>ðŸŽ Send Gift</span><div style="font-size: 0.7rem; margin-top: 4px; color: rgba(255,255,255,0.7);">Generate AI postcard first</div>';
            }
        }
        
        async function generateAIPostcard() {
            // ===== STAMP VERIFICATION =====
            // Check if user has selected a stamp
            if (!selectedStamp) {
                alert('âš ï¸ Please select a stamp first!\n\nYou need at least one stamp to generate AI postcards.');
                return;
            }
            
            // Check if user owns the selected stamp
            if (!userStamps[selectedStamp]?.owned) {
                alert('âš ï¸ You don\'t own this stamp!\n\nPlease claim or buy a stamp first.');
                return;
            }
            
            // Check authentication first
            if (!requireAuth('generate AI postcards')) return;
            
            // ===== CHECK INDEXEDDB CACHE FIRST =====
            const userFid = getUserFid();
            const cache = await loadAIPostcardCache(userFid);
            
            if (cache && cache.image && !isAIGenerated) {
                // Found cached postcard with valid image - restore it
                console.log('ðŸ“¦ Loading cached AI postcard from IndexedDB...');
                currentAIImage = cache.image;
                currentAIGreeting = cache.greeting;
                currentAIScene = cache.scene;
                isAIGenerated = true;
                aiGenerationCount = 1;
                
                // Update UI with cached data
                document.getElementById('ai-preview-image').src = `data:image/png;base64,${currentAIImage}`;
                document.getElementById('ai-preview-greeting').textContent = currentAIGreeting;
                document.getElementById('ai-generate-section').style.display = 'none';
                document.getElementById('ai-preview-section').style.display = 'block';
                
                // Enable Send Gift button
                updateSendGiftButtonState();
                
                alert('ðŸ“¦ å·²åŠ è½½ä¹‹å‰ç”Ÿæˆçš„æ˜Žä¿¡ç‰‡ï¼\nLoaded your previous postcard!\n\nðŸ’¡ Click "ðŸ”„ Regenerate" to create a new one.');
                return;
            }
            
            // If already generated AND has valid image data
            if (isAIGenerated && currentAIImage) {
                // TEST MODE: Auto-clear cache for testing convenience
                if (TEST_MODE) {
                    console.log('ðŸ§ª TEST MODE: Auto-clearing cache and regenerating...');
                    isAIGenerated = false;
                    currentAIImage = null;
                    currentAIGreeting = '';
                    aiGenerationCount = 0;
                    const userFid = getUserFid();
                    clearAIPostcardCache(userFid);
                    // Continue with generation below
                } else {
                    // PRODUCTION: Prevent duplicate generation, guide to Regenerate button
                    alert('ðŸ“¦ å›¾ç‰‡å·²ç”Ÿæˆï¼\nPostcard already generated!\n\nðŸ’¡ Click "ðŸ”„ Regenerate" button below to create a new one.\n\nâœ¨ Your previous postcard is saved!');
                    // Show preview section
                    document.getElementById('ai-generate-section').style.display = 'none';
                    document.getElementById('ai-preview-section').style.display = 'block';
                    return;
                }
            }
            
            // If flag is set but no image data, reset state (corrupted state)
            if (isAIGenerated && !currentAIImage) {
                console.warn('âš ï¸ Corrupted state: isAIGenerated=true but no image data. Resetting...');
                isAIGenerated = false;
                aiGenerationCount = 0;
            }
            
            const btn = document.getElementById('generate-ai-btn');
            btn.disabled = true;
            btn.innerHTML = 'â³ Generating AI...';
            
            try {
                if (!requireAuth('generate AI postcards')) {
                    btn.disabled = false;
                    btn.innerHTML = '<span style="font-size:1.2rem;">ðŸŽ¨</span><span>Generate AI Postcard</span>';
                    return;
                }
                
                const senderAvatar = window.currentUser.pfp_url || 'https://i.imgur.com/HeIi0wU.png';
                const senderName = window.currentUser.username || 'You';
                
                // Get first recipient for personalization
                const firstRecipient = selectedRecipients.length > 0 ? selectedRecipients[0] : null;
                const recipientName = firstRecipient ? `@${firstRecipient.username}` : 'dear friend';
                
                // If Warplet stamp selected, fetch user's Warplet NFT to include in scene
                let warpletImageUrl = null;
                let warpletName = null;
                if (selectedStamp === 'warplet' && window.currentUser?.fid) {
                    console.log('ðŸŽ¨ Fetching Warplet NFT for scene generation...');
                    try {
                        const warpletRes = await fetch(`/api/warplet?fid=${window.currentUser.fid}`);
                        if (warpletRes.ok) {
                            const warpletData = await warpletRes.json();
                            if (warpletData.hasWarplet && warpletData.imageUrl) {
                                warpletImageUrl = warpletData.imageUrl;
                                warpletName = warpletData.name || 'Warplet';
                                console.log('âœ… Found Warplet NFT for scene:', warpletName, warpletImageUrl);
                            }
                        }
                    } catch (error) {
                        console.error('Failed to fetch Warplet NFT:', error);
                    }
                }
                
                console.log('Generating AI postcard with:', { senderAvatar, senderName, recipientName, warpletImageUrl, warpletName });
                
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generateCard',
                        senderAvatar,
                        senderName,
                        recipientName,
                        warpletImageUrl,
                        warpletName,
                        message: '' // No user message, AI generates everything
                    })
                });
                
                console.log('API response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API error response:', errorText);
                    throw new Error(`API returned ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('API response data:', data);
                console.log('ðŸŽ„ Greeting from API:', data.greeting);
                console.log('ðŸŽ„ Greeting length:', data.greeting?.length || 0);
                
                if (data.success && data.image) {
                    currentAIGreeting = data.greeting || 'Wishing you a wonderful Christmas season filled with joy, warmth, and beautiful moments with loved ones!';
                    console.log('ðŸŽ„ currentAIGreeting set to:', currentAIGreeting);
                    console.log('ðŸŽ„ currentAIGreeting length:', currentAIGreeting.length);
                    
                    currentAIScene = {
                        type: data.sceneType || 'general',
                        description: data.sceneDescription || 'holiday celebration'
                    };
                    isAIGenerated = true;
                    aiGenerationCount++;
                    
                    // Composite stamp onto AI image using Canvas
                    await compositeStampOnImage(data.image);
                    
                    // Save to cache for next time
                    saveAIPostcardCache(userFid);
                    console.log('ðŸ’¾ Saved AI postcard to cache');
                    
                    // Enable Send Gift button
                    updateSendGiftButtonState();
                } else {
                    throw new Error(data.error || 'Generation failed - no image returned');
                }
            } catch (error) {
                console.error('AI generation error:', error);
                const errorMsg = error.message || 'Unknown error';
                alert(`AI generation failed: ${errorMsg}\n\nPlease check console for details.`);
                btn.disabled = false;
                btn.innerHTML = '<span style="font-size:1.2rem;">ðŸŽ¨</span><span>Generate AI Postcard</span>';
            }
        }
        
        async function regenerateAIPostcard() {
            console.log('ðŸ”„ Regenerate button clicked');
            
            // Check if button element exists
            const btn = document.getElementById('regenerate-ai-btn');
            if (!btn) {
                console.error('âŒ Regenerate button not found in DOM');
                alert('Error: Regenerate button not found. Please refresh the page.');
                return;
            }
            
            console.log('âœ… Button element found');
            
            // Check authentication first
            if (!requireAuth('regenerate postcards')) {
                return;
            }
            
            console.log('âœ… User authenticated');
            
            // Payment confirmation
            const confirmResult = confirm(`Regeneration costs ${REGENERATE_COST} USDC\n\nâœ… Will call your wallet for payment\n\nContinue?`);
            console.log('ðŸ’¬ Confirm dialog result:', confirmResult);
            
            if (!confirmResult) {
                console.log('âš ï¸ User cancelled payment confirmation');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = 'ðŸ’° Calling wallet...';
            console.log('ðŸ’° About to call wallet...');
            
            try {
                // Use Farcaster built-in wallet (NOT Base Account)
                console.log('ðŸ’³ Calling Farcaster wallet...');
                
                const sdk = window.farcasterSDK;
                if (!sdk) {
                    throw new Error('Farcaster SDK not loaded. Please refresh the page.');
                }
                
                // Call Farcaster's built-in wallet to send USDC (sendToken method)
                const result = await sdk.actions.sendToken({
                    token: 'eip155:8453/erc20:0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913', // USDC on Base
                    amount: (REGENERATE_COST * 1000000).toString(), // 0.1 USDC = 100000 (6 decimals)
                    recipientAddress: PAYMENT_ADDRESS
                });
                
                console.log('âœ… Farcaster wallet result:', result);
                
                if (!result.transactionId) {
                    throw new Error('Transaction failed or was cancelled');
                }
                
                console.log('âœ… Payment successful:', result.transactionId);
                btn.innerHTML = 'â³ Regenerating...';
            } catch (error) {
                console.error('âŒ Payment failed:', error);
                alert(`âŒ Payment Failed\n\n${error.message || 'User cancelled or payment error'}`);
                btn.disabled = false;
                btn.innerHTML = 'ðŸ”„ REGENERATE (0.1 USDC)';
                return;
            }
            
            try {
                if (!requireAuth('regenerate AI postcards')) {
                    btn.disabled = false;
                    btn.innerHTML = 'ðŸ”„ REGENERATE (0.1 USDC)';
                    return;
                }
                
                const senderAvatar = window.currentUser.pfp_url || 'https://i.imgur.com/HeIi0wU.png';
                const senderName = window.currentUser.username || 'You';
                
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generateCard',
                        senderAvatar,
                        senderName,
                        message: ''
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.image) {
                    currentAIImage = data.image;
                    currentAIGreeting = data.greeting || 'Merry Christmas!';
                    currentAIScene = {
                        type: data.sceneType || 'general',
                        description: data.sceneDescription || 'holiday celebration'
                    };
                    aiGenerationCount++;
                    
                    // Update preview
                    document.getElementById('ai-preview-image').src = `data:image/png;base64,${currentAIImage}`;
                    document.getElementById('ai-preview-greeting').textContent = currentAIGreeting;
                    
                    // Save new generation to cache
                    const userFid = getUserFid();
                    saveAIPostcardCache(userFid);
                    console.log('ðŸ’¾ Saved regenerated postcard to cache');
                    
                    btn.disabled = false;
                    btn.innerHTML = 'ðŸ”„ REGENERATE (0.1 USDC)';
                } else {
                    throw new Error(data.error || 'Regeneration failed');
                }
            } catch (error) {
                console.error('AI regeneration error:', error);
                alert('âŒ Regeneration failed\n\nPlease try again');
                btn.disabled = false;
                btn.innerHTML = 'ðŸ”„ REGENERATE (0.1 USDC)';
            }
        }
        
        async function createDirectGift() {
            const title = generateGiftTitle(); // Auto-generate beautiful title
            const includeGift = document.getElementById('include-gift-money').checked;
            const token = includeGift ? document.getElementById('direct-gift-token').value : null;
            const amount = includeGift ? document.getElementById('direct-gift-amount').value : '0';
            
            if (includeGift && (!amount || parseFloat(amount) <= 0)) { alert('Enter valid amount'); return; }
            if (selectedRecipients.length === 0) { alert('Select at least one recipient'); return; }
            if (!isAIGenerated) { 
                alert('Please generate AI postcard first!'); 
                return; 
            }
            
            // ===== STAMP CONSUMPTION LOGIC =====
            // Check if user has selected a stamp and has enough quantity
            if (!selectedStamp) {
                alert('âš ï¸ Please select a stamp first!\n\nStamps are required to send postcards.');
                return;
            }
            
            const stamp = userStamps[selectedStamp];
            
            // Check if user owns this stamp
            if (!stamp || !stamp.owned) {
                alert('âš ï¸ You don\'t own this stamp!\n\nPlease claim or purchase stamps first.');
                return;
            }
            
            // Based stamp has unlimited quantity
            if (selectedStamp === 'based' && stamp.permanent) {
                // Unlimited - proceed without consumption
            } else {
                // Check quantity for regular stamps
                const requiredStamps = selectedRecipients.length; // 1 stamp per friend
                const availableStamps = stamp.quantity || 0;
                
                if (availableStamps < requiredStamps) {
                    alert(
                        `âš ï¸ Not enough stamps!\n\n` +
                        `Sending to ${requiredStamps} friend${requiredStamps > 1 ? 's' : ''} requires ${requiredStamps} stamp${requiredStamps > 1 ? 's' : ''} ðŸŽ«\n` +
                        `You have: ${availableStamps} stamp${availableStamps !== 1 ? 's' : ''}\n\n` +
                        `Please purchase more stamps or reduce recipients.`
                    );
                    return;
                }
                
                // Confirm consumption
                const confirmed = confirm(
                    `ðŸ“® Confirm Send\n\n` +
                    `Recipients: ${requiredStamps} friend${requiredStamps > 1 ? 's' : ''}\n` +
                    `Cost: ${requiredStamps} stamp${requiredStamps > 1 ? 's' : ''} ðŸŽ«\n` +
                    `Remaining after send: ${availableStamps - requiredStamps} stamp${availableStamps - requiredStamps !== 1 ? 's' : ''}\n\n` +
                    `Continue?`
                );
                
                if (!confirmed) return;
                
                // Consume stamps
                stamp.quantity -= requiredStamps;
                const userFid = getUserFid();
                saveUserStamps(userFid);
            }
            
            closeDirectGiftModal();
            showLoading('Creating personalized postcards...');
            
            // Generate personalized address side for each recipient
            const stampImage = new Image();
            stampImage.src = selectedStamp ? `/stamp/${selectedStamp}.png` : '/stamp/neynar.png';
            
            await new Promise((resolve) => {
                stampImage.onload = async () => {
                    const senderName = currentUser?.username || 'Anonymous';
                    
                    // Create a gift for each recipient with personalized address side
                    const links = [];
                    for (const r of selectedRecipients) {
                        // Generate personalized address side (just for this recipient)
                        const personalizedBack = await generateAddressSide(currentAIGreeting, senderName, r.username, stampImage);
                        
                        const giftId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                        const giftData = {
                            id: giftId,
                            title: title,
                            message: currentAIGreeting, // Use AI generated greeting
                            hasGift: includeGift, // Whether includes money
                            token: token,
                            amount: amount,
                            cover: selectedCover,
                            aiImage: currentAIImage, // Front side (picture)
                            aiImageBack: personalizedBack, // Personalized back side (address to this recipient)
                            sceneType: currentAIScene?.type || 'general', // Store scene for reply
                            sceneDescription: currentAIScene?.description || 'holiday celebration',
                            shares: 1, type: 'equal', mode: 'direct',
                            requirePro: false, minScore: 0,
                            claimed: 0, claimedBy: [],
                            recipient: { fid: r.fid, username: r.username, pfp: r.pfp_url },
                            sender: currentUser || { fid: 0, username: 'anonymous', pfp: '' },
                            createdAt: Date.now()
                        };
                        plazaGifts.push(giftData);
                        links.push({ username: r.username, url: location.origin + location.pathname + '?gift=' + giftId });
                    }
                    localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));
                    
                    showShareLinks(links, title, includeGift, amount, token);
                    resolve();
                };
                stampImage.onerror = () => resolve(); // Continue without stamp if loading fails
            });
            
            return; // Early return - all logic handled inside stamp.onload
        }
        
        // Helper function to show share links and reset state
        async function showShareLinks(links, title, includeGift, amount, token) {
            // Create share text
            let shareText;
            if (includeGift) {
                shareText = links.length === 1 
                    ? `ðŸŽ Gift for @${links[0].username}!\n\n${title}\nðŸ’° ${amount} ${token}\n\nðŸ”— ${links[0].url}`
                    : `ðŸŽ Christmas Gifts!\n\n${title}\nðŸ’° ${amount} ${token} each\n\n` + links.map(l => `â†’ @${l.username}: ${l.url}`).join('\n');
            } else {
                shareText = links.length === 1 
                    ? `ðŸ’Œ Christmas Card for @${links[0].username}!\n\n${title}\n\nðŸ”— ${links[0].url}`
                    : `ðŸ’Œ Christmas Cards!\n\n${title}\n\n` + links.map(l => `â†’ @${l.username}: ${l.url}`).join('\n');
            }
            
            hideLoading();
            if (navigator.clipboard) {
                await navigator.clipboard.writeText(shareText);
                alert(`Personalized postcard(s) created for ${links.length} friend(s)!\nEach will see their own name!\nLink(s) copied to clipboard!`);
            } else { alert(shareText); }
            
            // Reset UI state but KEEP the cached postcard (user might want to send to others)
            // DON'T clear IndexedDB cache - let user reuse the generated image
            console.log('âœ… Postcard sent! Image saved for reuse.');
            
            selectedRecipients = [];
            renderSelectedUsers();
            // Keep: isAIGenerated = true (so it shows on next open)
            // Keep: currentAIImage, currentAIGreeting, currentAIScene
            // Keep: aiGenerationCount
            // Keep preview section visible so user can regenerate or send to others
            // DON'T switch back to generate section - keep showing the generated postcard
            
            // Disable Send Gift button (no recipients selected)
            updateSendGiftButtonState();
        }
        
        // Claim by code/link
        let currentCardGift = null;
        
        function claimByCode() {
            const input = document.getElementById('gift-code-input').value.trim();
            if (!input) { alert('Please enter a gift code'); return; }
            
            // Extract gift ID from input (could be full URL or just ID)
            let giftId = input;
            if (input.includes('gift=')) {
                giftId = input.split('gift=')[1].split('&')[0];
            }
            
            // Check if gift exists in plaza
            const gift = plazaGifts.find(g => g.id === giftId);
            if (gift) {
                closeClaimInput();
                // Direct gift shows greeting card
                if (gift.mode === 'direct') {
                    showGreetingCard(gift);
                } else {
                    openClaimModal(giftId);
                }
            } else {
                alert('Gift not found!');
            }
        }
        
        // Check and show mailbox glow if there are gifts for user
        function checkMyGifts() {
            const myGifts = plazaGifts.filter(g => g.mode === 'direct' && g.claimed < g.shares);
            const mailboxBtn = document.getElementById('mailbox-button');
            if (myGifts.length > 0) {
                mailboxBtn.classList.add('has-gift');
            } else {
                mailboxBtn.classList.remove('has-gift');
            }
        }
        
        // Open first available gift
        function openMyGifts() {
            const myGifts = plazaGifts.filter(g => g.mode === 'direct' && g.claimed < g.shares);
            if (myGifts.length > 0) {
                showGreetingCard(myGifts[0]);
            } else {
                showToast('ðŸ“­ No gifts yet');
            }
        }
        
        function showToast(message) {
            const existing = document.querySelector('.toast-msg');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast-msg';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20%;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.8);
                color: #fff;
                padding: 12px 24px;
                border-radius: 20px;
                font-size: 14px;
                z-index: 9999;
                animation: toastFade 2s ease forwards;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }
        
        // Cover art content mapping
        const coverArt = { 1: '', 2: '', 3: '', 4: 'âœ¦', 5: '', 6: '' };
        let selectedCover = 1;
        
        function selectCover(num) {
            selectedCover = num;
            document.querySelectorAll('.cover-option').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-cover="${num}"]`).classList.add('selected');
        }
        
        // Show gift card cover
        function showGreetingCard(gift) {
            currentCardGift = gift;
            const senderName = gift.sender?.username || gift.sender?.displayName || 'Someone';
            const coverNum = gift.cover || 1;
            const coverEl = document.getElementById('card-cover-display');
            const container = document.getElementById('gift-card-container');
            
            // Reset state
            container.classList.remove('opened');
            document.getElementById('card-inside-loading').style.display = 'flex';
            document.getElementById('card-content-row').style.display = 'none';
            document.getElementById('card-inside-greeting').textContent = '';
            document.getElementById('gift-icon-wrapper').style.display = 'none';
            document.getElementById('gift-details-wrapper').style.display = 'none';
            
            // Set cover style
            coverEl.className = `card-cover card-cover-${coverNum}`;
            document.getElementById('cover-art').textContent = coverArt[coverNum] || '';
            document.getElementById('cover-title').textContent = gift.title || 'Merry Christmas!';
            document.getElementById('cover-from').textContent = `From @${senderName}`;
            
            // Set gift amount if present
            if (gift.hasGift) {
                document.getElementById('card-inside-amount').textContent = 'ðŸŽ ' + gift.amount + ' ' + gift.token;
            }
            
            document.getElementById('envelope-modal').classList.add('visible');
        }
        
        // Reveal gift amount and claim button
        function revealGift() {
            document.getElementById('gift-icon-wrapper').style.display = 'none';
            document.getElementById('gift-details-wrapper').style.display = 'block';
        }
        
        // Flip double-sided card in card view
        function flipCardPostcard() {
            const flipper = document.getElementById('card-postcard-flipper');
            const hint = document.getElementById('card-flip-hint');
            
            if (!window.isCardPostcardFlipped) {
                // Flip to back (message + stamp)
                flipper.style.transform = 'rotateY(180deg)';
                hint.textContent = 'ðŸ‘ˆ Click to see the cover';
                window.isCardPostcardFlipped = true;
            } else {
                // Flip back to front (cover)
                flipper.style.transform = 'rotateY(0deg)';
                hint.textContent = 'ðŸ‘‰ Click to see the message inside';
                window.isCardPostcardFlipped = false;
            }
        }
        
        // Open card with flip animation and show AI content
        async function openEnvelopeCard() {
            if (!currentCardGift) return;
            
            const container = document.getElementById('gift-card-container');
            
            // Flip the card open
            container.classList.add('opened');
            
            // Check if has AI image already generated
            if (currentCardGift.aiImage) {
                // Use pre-generated AI image and greeting
                document.getElementById('card-inside-loading').style.display = 'none';
                document.getElementById('card-inside-greeting').textContent = currentCardGift.message || 'Merry Christmas!';
                
                // Check if has personalized double-sided card
                if (currentCardGift.aiImageBack) {
                    // Show double-sided card (front cover first)
                    document.getElementById('card-postcard-preview').style.display = 'block';
                    document.getElementById('card-postcard-front').src = `data:image/png;base64,${currentCardGift.aiImage}`; // Front: AI illustration
                    document.getElementById('card-postcard-back').src = currentCardGift.aiImageBack; // Back: Letter + stamp
                    document.getElementById('card-postcard-flipper').style.transform = 'rotateY(0deg)';
                    document.getElementById('card-flip-hint').textContent = 'ðŸ‘‰ Click to see the message inside';
                    window.isCardPostcardFlipped = false;
                } else {
                    document.getElementById('card-postcard-preview').style.display = 'none';
                }
                
                // Show gift icon or details based on hasGift
                if (currentCardGift.hasGift) {
                    document.getElementById('card-inside-amount').textContent = 'ðŸŽ ' + currentCardGift.amount + ' ' + currentCardGift.token;
                    document.getElementById('gift-icon-wrapper').style.display = 'block';
                } else {
                    document.getElementById('gift-icon-wrapper').style.display = 'none';
                    document.getElementById('gift-details-wrapper').style.display = 'none';
                }
                
                // Show reply button (can reply to sender)
                document.getElementById('reply-card-btn').style.display = 'block';
                
                return;
            }
            
            // Legacy: Set amount for old gifts
            if (currentCardGift.hasGift) {
                document.getElementById('card-inside-amount').textContent = 'ðŸŽ ' + currentCardGift.amount + ' ' + currentCardGift.token;
            }
            
            // Get avatars for AI generation
            const senderAvatar = currentCardGift.sender?.pfp || 'https://i.imgur.com/HeIi0wU.png';
            const recipientAvatar = currentUser?.pfp_url || 'https://i.imgur.com/HeIi0wU.png';
            
            // Generate AI card
            try {
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generateCard',
                        senderName: currentCardGift.sender?.username || 'Friend',
                        senderAvatar: senderAvatar,
                        recipientName: currentUser?.username || 'Friend',
                        recipientAvatar: recipientAvatar,
                        message: currentCardGift.message || 'Merry Christmas!'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Hide loading
                    document.getElementById('card-inside-loading').style.display = 'none';
                    
                    // Show content row with image and greeting
                    document.getElementById('card-content-row').style.display = 'flex';
                    
                    // Set generated image
                    const imgEl = document.getElementById('card-inside-image');
                    if (data.image) {
                        imgEl.src = `data:image/png;base64,${data.image}`;
                    } else {
                        // Fallback: hide image if generation failed
                        imgEl.style.display = 'none';
                    }
                    
                    // Show greeting
                    document.getElementById('card-inside-greeting').textContent = data.greeting || currentCardGift.message || 'Merry Christmas!';
                } else {
                    throw new Error(data.error || 'Generation failed');
                }
            } catch (error) {
                console.error('AI card generation error:', error);
                // Fallback - show message only without image
                document.getElementById('card-inside-loading').style.display = 'none';
                document.getElementById('card-content-row').style.display = 'flex';
                document.getElementById('card-inside-image').style.display = 'none';
                document.getElementById('card-inside-greeting').innerHTML = `
                    <div style="text-align:center;">
                        <div style="font-size:2rem; margin-bottom:12px;">ðŸŽ„ðŸŽâ„ï¸</div>
                        <div>${currentCardGift.message || 'Wishing you a wonderful holiday season!'}</div>
                    </div>
                `;
            }
        }
        
        function closeCardModal() {
            document.getElementById('envelope-modal').classList.remove('visible');
            document.getElementById('gift-card-container').classList.remove('opened');
            currentCardGift = null;
        }
        

        
        function claimAICardGift() {
            if (!currentCardGift) return;
            
            // Launch confetti
            launchConfetti();
            
            showLoading('Claiming gift...');
            document.querySelector('.controls').style.display = 'none';
            
            // Close AI card modal
            document.getElementById('ai-card-modal').classList.remove('visible');
            
            // TODO: In production, call smart contract here
            currentCardGift.claimed = 1;
            currentCardGift.claimedBy.push(currentUser?.fid || 'guest');
            localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));
            
            setTimeout(() => {
                hideLoading();
                
                // Tree scatter effect
                if (window.scatterTree) window.scatterTree();
                
                // Show floating success message
                showClaimSuccess(currentCardGift.amount + ' ' + currentCardGift.token);
                
                // Show home button
                document.getElementById('scatter-home-btn').style.display = 'block';
                
                checkMyGifts();
                currentCardGift = null;
            }, 800);
        }
        
        // Legacy claim function (for fallback)
        function claimCardGift() {
            if (!currentCardGift) return;
            
            // Step 1: Play card opening animation
            const card = document.querySelector('.greeting-card');
            card.classList.add('opening');
            
            // Step 2: Launch confetti burst
            launchConfetti();
            
            // Step 3: After animation, process claim
            setTimeout(() => {
                document.getElementById('card-modal').classList.remove('visible');
                card.classList.remove('opening');
                
                showLoading('Claiming gift...');
                document.querySelector('.controls').style.display = 'none';
                
                // TODO: In production, call smart contract here
                currentCardGift.claimed = 1;
                currentCardGift.claimedBy.push(currentUser?.fid || 'guest');
                localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));
                
                setTimeout(() => {
                    hideLoading();
                    document.getElementById('success-amount').textContent = currentCardGift.amount + ' ' + currentCardGift.token;
                    document.getElementById('success-modal').classList.add('visible');
                    
                    checkMyGifts();
                    currentCardGift = null;
                }, 800);
            }, 1000);
        }
        
        // Christmas confetti burst effect
        function launchConfetti() {
            const container = document.createElement('div');
            container.className = 'confetti-container';
            document.body.appendChild(container);
            
            const colors = ['#D4AF37', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#ff7675', '#74b9ff'];
            const shapes = ['ðŸŽ„', 'â­', 'â„ï¸', 'ðŸŽ', 'ðŸ””', 'âœ¨'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-10px';
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                
                if (Math.random() > 0.5) {
                    confetti.textContent = shapes[Math.floor(Math.random() * shapes.length)];
                    confetti.style.fontSize = (12 + Math.random() * 12) + 'px';
                    confetti.style.width = 'auto';
                    confetti.style.height = 'auto';
                } else {
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                }
                
                container.appendChild(confetti);
            }
            
            setTimeout(() => container.remove(), 4000);
        }

        function toggleCodeInput() {
            const show = document.getElementById('require-code').checked;
            document.getElementById('code-input-row').style.display = show ? 'flex' : 'none';
            if (!show) document.getElementById('gift-code').value = '';
        }
        
        function togglePlazaCustomToken() {
            const token = document.getElementById('gift-token').value;
            document.getElementById('plaza-custom-token-group').style.display = token === 'CUSTOM' ? 'block' : 'none';
            updatePreview();
        }
        
        function validatePlazaAmount() {
            const input = document.getElementById('gift-amount');
            if (parseFloat(input.value) < 0.1) {
                input.value = '0.1';
            }
        }
        
        function selectGiftType(type) {
            giftType = type;
            document.querySelectorAll('.type-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (i === 0 && type === 'equal') || (i === 1 && type === 'lucky'));
            });
            updatePreview();
        }

        function updatePreview() {
            const amount = document.getElementById('gift-amount').value || '0';
            const token = document.getElementById('gift-token').value;
            const shares = document.getElementById('gift-shares').value || '1';
            document.getElementById('preview-amount').textContent = amount + ' ' + token;
            const perShare = shares > 0 ? (parseFloat(amount) / parseInt(shares)).toFixed(6) : '0';
            const requireCode = document.getElementById('require-code').checked;
            const requirePro = document.getElementById('require-pro').checked;
            const minScore = parseFloat(document.getElementById('min-score').value) || 0;
            let info = giftType === 'equal' ? `${shares} shares Ã— ${perShare} ${token}` : `${shares} lucky shares`;
            if (requireCode || requirePro || minScore > 0) {
                info += ' | Requires:';
                if (requireCode) info += ' ðŸ”‘Code';
                if (requirePro) info += ' FC Pro';
                if (minScore > 0) info += ` Scoreâ‰¥${minScore}`;
            }
            document.getElementById('preview-info').textContent = info;
        }

        // Create gift for plaza (with smart contract)
        async function createGift() {
            // Check if plaza is full
            const activeGifts = plazaGifts.filter(g => g.claimed < g.shares);
            if (activeGifts.length >= MAX_PLAZA_GIFTS) {
                alert('ðŸŽ„ Plaza Gift is full!\n\nMaximum 10 gifts can orbit the tree at once.\nPlease wait for some gifts to be claimed.');
                return;
            }
            
            const title = generateGiftTitle(); // Auto-generate beautiful title
            const token = document.getElementById('gift-token').value;
            const amount = document.getElementById('gift-amount').value;
            const shares = document.getElementById('gift-shares').value || '5';
            const requireCode = document.getElementById('require-code').checked;
            const giftCode = document.getElementById('gift-code').value.trim() || 'XMAS2024';
            const requirePro = document.getElementById('require-pro').checked;
            const minScore = parseFloat(document.getElementById('min-score').value) || 0;

            if (!amount || parseFloat(amount) <= 0) { alert('Enter valid amount'); return; }
            if (!shares || parseInt(shares) < 1) { alert('Enter valid shares'); return; }

            // Connect wallet if not connected
            if (!connectedAddress) {
                const connected = await connectWallet();
                if (!connected) return;
            }

            closeGiftModal();
            showLoading('Creating gift on blockchain...');

            try {
                const passwordHash = hashPassword(giftCode);
                const giftTypeEnum = giftType === 'equal' ? 0 : 1; // 0 = EQUAL, 1 = LUCKY
                const duration = 7 * 24 * 60 * 60; // 7 days
                let tx, receipt, contractGiftId;

                if (token === 'ETH') {
                    // Create ETH gift
                    const amountWei = ethers.parseEther(amount);
                    tx = await giftContract.createGiftETH(
                        parseInt(shares),
                        passwordHash,
                        giftTypeEnum,
                        requirePro,
                        title,
                        duration,
                        { value: amountWei }
                    );
                } else {
                    // Create token gift (USDC)
                    const tokenAddress = USDC_CA;
                    const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, web3Signer);
                    const decimals = await tokenContract.decimals();
                    const amountUnits = ethers.parseUnits(amount, decimals);
                    
                    // Check and approve
                    const allowance = await tokenContract.allowance(connectedAddress, CONTRACT_ADDRESS);
                    if (allowance < amountUnits) {
                        showLoading('Approving tokens...');
                        const approveTx = await tokenContract.approve(CONTRACT_ADDRESS, amountUnits);
                        await approveTx.wait();
                    }
                    
                    showLoading('Creating gift...');
                    tx = await giftContract.createGiftToken(
                        tokenAddress,
                        amountUnits,
                        parseInt(shares),
                        passwordHash,
                        giftTypeEnum,
                        requirePro,
                        title,
                        duration
                    );
                }

                showLoading('Confirming transaction...');
                receipt = await tx.wait();
                
                // Get gift ID from event
                const event = receipt.logs.find(log => {
                    try {
                        const parsed = giftContract.interface.parseLog(log);
                        return parsed.name === 'GiftCreated';
                    } catch { return false; }
                });
                
                if (event) {
                    const parsed = giftContract.interface.parseLog(event);
                    contractGiftId = parsed.args[0].toString();
                }

                // For demo/UI, also store locally
                const sender = currentUser || {
                    fid: Date.now(),
                    username: connectedAddress.slice(0, 8),
                    pfp_url: 'https://i.imgur.com/HeIi0wU.png'
                };

                const giftData = {
                    id: contractGiftId || Date.now().toString(),
                    contractId: contractGiftId,
                    title,
                    token,
                    amount,
                    shares: parseInt(shares),
                    type: giftType,
                    requireCode,
                    giftCode: giftCode,
                    requirePro,
                    minScore,
                    claimed: 0,
                    claimedBy: [],
                    sender: {
                        fid: sender.fid,
                        username: sender.username,
                        pfp: sender.pfp_url,
                        address: connectedAddress
                    },
                    createdAt: Date.now(),
                    txHash: receipt.hash
                };

                plazaGifts.push(giftData);
                localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));

                hideLoading();
                renderPlaza();
                alert(`ðŸŽ Gift created on blockchain!\n\nGift ID: ${contractGiftId}\nTx: ${receipt.hash.slice(0, 10)}...\n\nShare the code "${giftCode}" with friends!`);
            } catch (error) {
                hideLoading();
                console.error('Create gift error:', error);
                alert('Failed to create gift: ' + (error.reason || error.message));
            }
        }

        // Render orbiting avatars around the tree (optimized to reduce reflows)
        function renderPlaza() {
            const plaza = document.getElementById('gift-plaza');
            if (!plaza) return;
            
            // Only show plaza gifts, not direct gifts
            const activeGifts = plazaGifts.filter(g => g.claimed < g.shares && g.mode !== 'direct').slice(0, MAX_PLAZA_GIFTS);
            
            // Skip re-render if gift count hasn't changed (optimization)
            const currentGiftCount = plaza.children.length;
            if (currentGiftCount === activeGifts.length) return;
            
            // Responsive orbit radius based on viewport - closer to tree
            const baseRadius = Math.min(window.innerWidth, window.innerHeight) * 0.12;
            const positions = [
                { duration: 18, delay: 0, y: -100, radius: baseRadius * 0.9 },
                { duration: 22, delay: -3, y: -70, radius: baseRadius * 1.1 },
                { duration: 15, delay: -7, y: -35, radius: baseRadius * 0.85 },
                { duration: 20, delay: -2, y: 0, radius: baseRadius },
                { duration: 25, delay: -5, y: 35, radius: baseRadius * 1.15 },
                { duration: 17, delay: -8, y: -85, radius: baseRadius * 0.95 },
                { duration: 23, delay: -1, y: -50, radius: baseRadius * 1.05 },
                { duration: 19, delay: -6, y: 18, radius: baseRadius * 0.92 },
                { duration: 21, delay: -4, y: -18, radius: baseRadius * 1.1 },
                { duration: 16, delay: -9, y: 50, radius: baseRadius * 0.98 }
            ];
            
            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            activeGifts.forEach((gift, index) => {
                const pos = positions[index];
                const div = document.createElement('div');
                div.className = 'plaza-gift';
                div.style.cssText = `--orbit-duration: ${pos.duration}s; --orbit-delay: ${pos.delay}s; --orbit-radius: ${pos.radius}px; top: ${pos.y}px;`;
                div.onclick = () => openClaimModal(gift.id);
                div.title = `Click to claim mystery gift from @${gift.sender.username}`;
                
                const img = document.createElement('img');
                img.src = gift.sender.pfp || 'https://i.imgur.com/HeIi0wU.png';
                img.onerror = () => img.src = 'https://i.imgur.com/HeIi0wU.png';
                img.alt = gift.sender.username;
                
                const santa = document.createElement('div');
                santa.className = 'santa-emoji';
                santa.textContent = 'ðŸŽ…';
                
                div.appendChild(img);
                div.appendChild(santa);
                fragment.appendChild(div);
            });
            
            plaza.innerHTML = '';
            plaza.appendChild(fragment);
        }

        // Open claim modal for specific gift
        function openClaimModal(giftId) {
            const gift = plazaGifts.find(g => g.id === giftId);
            if (!gift) { alert('Gift not found'); return; }
            if (gift.claimed >= gift.shares) { alert('All shares claimed!'); return; }

            // Store current gift id for claiming
            document.getElementById('claim-modal').dataset.giftId = giftId;

            document.querySelector('#claim-modal .modal-title').textContent = 'ðŸŽ Mystery Gift';
            document.getElementById('claim-message').textContent = gift.title;
            document.getElementById('claim-remaining').textContent = '??? ' + gift.token;
            document.getElementById('claim-shares').textContent = gift.claimed + '/' + gift.shares + ' claimed';
            document.getElementById('claim-shares').parentElement.style.display = 'inline';

            // Show sender info
            const recipientDiv = document.getElementById('claim-recipient');
            recipientDiv.innerHTML = `
                <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:8px;">
                    <img src="${gift.sender.pfp || ''}" style="width:32px; height:32px; border-radius:50%; border:2px solid var(--gold);" onerror="this.style.display='none'">
                    <span style="color:var(--gold);">From @${gift.sender.username}</span>
                </div>
                ${gift.requirePro || gift.minScore > 0 ? `
                    <div style="font-size:0.75rem; color:rgba(255,255,255,0.5); margin-top:4px;">
                        Requirements: ${gift.requirePro ? 'â­ FC Pro ' : ''}${gift.minScore > 0 ? `Scoreâ‰¥${gift.minScore}` : ''}
                    </div>
                ` : ''}
            `;
            recipientDiv.style.display = 'block';

            // Show/hide code input based on gift requirements
            const codeGroup = document.querySelector('#claim-modal .form-group');
            if (gift.requireCode) {
                codeGroup.style.display = 'block';
                document.getElementById('claim-password').value = '';
            } else {
                codeGroup.style.display = 'none';
            }
            document.querySelector('#claim-modal .btn-gift').textContent = 'Claim Gift';

            document.getElementById('claim-modal').classList.add('visible');
        }

        // Claim gift (with smart contract)
        async function claimGift() {
            const giftId = document.getElementById('claim-modal').dataset.giftId;
            const gift = plazaGifts.find(g => g.id === giftId);
            
            if (!gift) { alert('Gift not found'); return; }
            if (gift.claimed >= gift.shares) { alert('All shares claimed!'); return; }

            // Get password
            const password = document.getElementById('claim-password').value.trim() || gift.giftCode || 'XMAS2024';

            // Verify code if required (for UI feedback)
            if (gift.requireCode && password !== gift.giftCode) {
                alert('Wrong code! Try again.');
                return;
            }

            // Connect wallet if not connected
            if (!connectedAddress) {
                const connected = await connectWallet();
                if (!connected) return;
            }

            // Check if already claimed on contract
            if (gift.contractId) {
                try {
                    const hasClaimed = await giftContract.hasUserClaimed(gift.contractId, connectedAddress);
                    if (hasClaimed) {
                        alert('You have already claimed this gift!');
                        return;
                    }
                } catch (e) {
                    console.log('Error checking claim status:', e);
                }
            }

            closeClaimModal();
            showLoading('Claiming gift...');
            
            // Hide plaza and controls
            document.getElementById('gift-plaza').style.display = 'none';
            document.querySelector('.controls').style.display = 'none';

            try {
                let claimAmount;
                
                // If gift has contract ID, claim from contract
                if (gift.contractId) {
                    const isPro = gift.requirePro ? true : false;
                    const tx = await giftContract.claimGift(gift.contractId, password, isPro);
                    showLoading('Confirming transaction...');
                    const receipt = await tx.wait();
                    
                    // Get claimed amount from event
                    const event = receipt.logs.find(log => {
                        try {
                            const parsed = giftContract.interface.parseLog(log);
                            return parsed.name === 'GiftClaimed';
                        } catch { return false; }
                    });
                    
                    if (event) {
                        const parsed = giftContract.interface.parseLog(event);
                        const amountWei = parsed.args[2];
                        if (gift.token === 'ETH') {
                            claimAmount = ethers.formatEther(amountWei);
                        } else {
                            claimAmount = ethers.formatUnits(amountWei, 6); // USDC has 6 decimals
                        }
                    } else {
                        claimAmount = (parseFloat(gift.amount) / gift.shares).toFixed(6);
                    }
                } else {
                    // Demo mode - calculate locally
                    if (gift.type === 'equal') {
                        claimAmount = (parseFloat(gift.amount) / gift.shares).toFixed(6);
                    } else {
                        const remaining = gift.shares - gift.claimed;
                        const remainingAmount = parseFloat(gift.amount) - gift.claimedBy.reduce((sum, c) => sum + parseFloat(c.amount || 0), 0);
                        const maxAmount = remaining > 1 ? (remainingAmount * 2 / remaining) : remainingAmount;
                        claimAmount = (Math.random() * maxAmount).toFixed(6);
                    }
                }

                // Update local gift data
                gift.claimed++;
                gift.claimedBy.push({
                    fid: currentUser?.fid || Date.now(),
                    username: currentUser?.username || connectedAddress?.slice(0, 8) || 'guest',
                    pfp: currentUser?.pfp || 'https://i.imgur.com/HeIi0wU.png',
                    address: connectedAddress,
                    amount: claimAmount,
                    at: Date.now()
                });
                localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));

                hideLoading();
                document.getElementById('success-amount').textContent = claimAmount + ' ' + gift.token;
                document.getElementById('success-modal').classList.add('visible');
                
                renderPlaza();
            } catch (error) {
                hideLoading();
                document.querySelector('.controls').style.display = '';
                console.error('Claim error:', error);
                alert('Failed to claim: ' + (error.reason || error.message));
            }
        }

        function startSnowfall() {
            const container = document.getElementById('snowfall-container');
            if (!container) return;
            
            // Generate snowflakes (GPU accelerated with will-change and translate3d)
            let snowflakes = '';
            const symbols = ['â„', 'â…', 'â†', 'âœ»', 'âœ¼', 'â€¢'];
            for (let i = 0; i < 50; i++) {
                const left = Math.random() * 100;
                const delay = Math.random() * 10;
                const duration = 8 + Math.random() * 12;
                const size = 10 + Math.random() * 16;
                const symbol = symbols[Math.floor(Math.random() * symbols.length)];
                snowflakes += `<span class="snow" style="left:${left}%; animation-delay:${delay}s; animation-duration:${duration}s; font-size:${size}px;">${symbol}</span>`;
            }
            
            container.innerHTML = snowflakes;
            container.classList.add('active');
        }
        
        function stopSnowfall() {
            const container = document.getElementById('snowfall-container');
            if (container) {
                container.classList.remove('active');
                container.innerHTML = '';
            }
        }
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            // Hide unused form fields
            const recipientGroup = document.getElementById('recipient-group');
            const passwordGroup = document.getElementById('password-group');
            const modeToggle = document.querySelector('.mode-toggle');
            const modeHint = document.getElementById('mode-hint');
            const plazaExplanation = document.getElementById('plaza-explanation');
            
            if (recipientGroup) recipientGroup.style.display = 'none';
            if (passwordGroup) passwordGroup.style.display = 'none';
            if (modeToggle) modeToggle.style.display = 'none';
            if (modeHint) modeHint.style.display = 'none';
            
            // Show Plaza explanation
            if (plazaExplanation) plazaExplanation.style.display = 'block';

            // Show shares and distribution
            document.getElementById('shares-group').style.display = 'block';
            document.getElementById('distribution-group').style.display = 'block';

            // Try to get Farcaster user
            import('https://esm.sh/@farcaster/miniapp-sdk').then(async ({ sdk }) => {
                try {
                    const context = await sdk.context;
                    if (context?.user) {
                        currentUser = context.user;
                        console.log('Farcaster user:', currentUser.username);
                    }
                } catch (e) { console.log('Not in Farcaster frame'); }
            }).catch(() => {});

            // Clear old demo data and load fresh
            const stored = localStorage.getItem('plaza_gifts');
            if (stored) {
                const parsed = JSON.parse(stored);
                // Filter out demo/test data
                plazaGifts = parsed.filter(g => !g.id.startsWith('demo') && !g.id.startsWith('test'));
                localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));
            }
            
            // Check if user has gifts
            checkMyGifts();
            
            // Check URL for gift parameter
            const urlParams = new URLSearchParams(window.location.search);
            const giftId = urlParams.get('gift');
            if (giftId) {
                setTimeout(() => {
                    const gift = plazaGifts.find(g => g.id === giftId);
                    if (gift && gift.mode === 'direct') {
                        showGreetingCard(gift);
                    } else if (gift) {
                        openClaimModal(giftId);
                    }
                }, 500);
            }
        });
        
        // ========== Reply Card Functions ==========
        
        let pendingReply = null;
        let generatedReplyText = '';
        
        async function openReplyModal() {
            if (!currentCardGift) return;
            
            pendingReply = {
                originalGift: currentCardGift,
                toUser: currentCardGift.sender
            };
            
            // Show modal and set context
            document.getElementById('reply-to-name').textContent = '@' + (currentCardGift.sender?.username || 'sender');
            document.getElementById('reply-original-message').textContent = currentCardGift.message || 'Merry Christmas!';
            document.getElementById('reply-generated-text').textContent = 'Generating your reply...';
            document.getElementById('reply-modal').classList.add('visible');
            
            // Generate AI reply
            await generateReplyText();
        }
        
        async function generateReplyText() {
            try {
                const sceneDesc = pendingReply.originalGift.sceneDescription || 'holiday celebration';
                const originalMsg = pendingReply.originalGift.message || 'Merry Christmas!';
                const replyFrom = currentUser?.username || 'You';
                const senderName = pendingReply.originalGift.sender?.username || 'friend';
                
                const replyPrompt = `You received a heartfelt Christmas postcard from @${senderName}. Their full message was:

"${originalMsg}"

Write a warm, grateful reply (80-150 words) as @${replyFrom} that:

Structure:
- Opening: Address them directly - "Dear @${senderName}," or "Hey @${senderName}!" followed by thank you
- Acknowledge & Respond (3-4 sentences): 
  * Thank them genuinely for the postcard
  * Respond specifically to what they mentioned in their message
  * If they mentioned skiing â†’ "Your mountain adventures sound absolutely amazing! Stay safe on those slopes!"
  * If they mentioned travel â†’ "The [destination] photos look incredible! I'm so jealous of those festive markets!"
  * If they mentioned family time â†’ "Family moments like those are so precious. Grandmother's recipes are always the best!"
  * If they mentioned pets â†’ "Your furry companion sounds adorable! Nothing beats cozy winter days with pets!"
  * If they mentioned being cozy â†’ "Your winter sanctuary sounds perfect! Hot cocoa by the fireplace is exactly what this season is about!"
  * If they mentioned city life â†’ "The city lights and holiday energy must be incredible! I'd love to experience that magic!"
  * If they mentioned nature â†’ "Those snow-covered forests sound peaceful and beautiful. Nature really puts things in perspective!"
- Share Your Own Update (2-3 sentences): Briefly share what you've been up to this holiday season
- Reciprocal Wishes (1 sentence): Send them warm holiday wishes back
- Closing: "With gratitude, ${replyFrom}" or "Warmest wishes, ${replyFrom}"

Tone: Warm, grateful, conversational (like replying to a friend's heartfelt letter)
Length: 80-150 words
Style: Natural, genuine, shows you actually read and care about their message

Write only the reply text, nothing else:`;

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + (window.GEMINI_API_KEY || 'YOUR_API_KEY'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: replyPrompt }] }],
                        generationConfig: { temperature: 0.8, maxOutputTokens: 200 }
                    })
                });
                
                const data = await response.json();
                
                if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                    generatedReplyText = data.candidates[0].content.parts[0].text.trim();
                    document.getElementById('reply-generated-text').textContent = generatedReplyText;
                } else {
                    throw new Error('Reply generation failed');
                }
            } catch (error) {
                console.error('Reply generation error:', error);
                generatedReplyText = `Thank you so much for the wonderful Christmas card! Wishing you joy and happiness this holiday season!\n\nWith gratitude,\n${currentUser?.username || 'Friend'}`;
                document.getElementById('reply-generated-text').textContent = generatedReplyText;
            }
        }
        
        async function regenerateReply() {
            document.getElementById('reply-generated-text').textContent = 'Regenerating...';
            await generateReplyText();
        }
        
        function closeReplyModal() {
            document.getElementById('reply-modal').classList.remove('visible');
            pendingReply = null;
            generatedReplyText = '';
        }
        
        // Postcard flip state
        let isPostcardFlipped = false;
        
        // Flip postcard animation
        function flipPostcard() {
            const flipper = document.getElementById('postcard-flipper');
            isPostcardFlipped = !isPostcardFlipped;
            
            if (isPostcardFlipped) {
                flipper.style.transform = 'rotateY(180deg)';
            } else {
                flipper.style.transform = 'rotateY(0deg)';
            }
        }
        
        // Generate letter content (back side) with stamp
        function generateAddressSide(greeting, senderName, recipientNames, stampImg) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Standard postcard size (9:16 ratio)
                canvas.width = 1080;
                canvas.height = 1920;
                
                // Load Christmas background image
                const bgImage = new Image();
                bgImage.crossOrigin = 'anonymous';
                bgImage.onload = () => {
                    // Draw background
                    ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
                    
                    // Stamp is already in the background image, no need to draw it separately
                    // "To:" removed - background already has postal elements
                    
                    // Letter content starts safely within border (avoid stamp area)
                    let yPos = 480;
                    
                    // Main greeting message (handwritten style, more content space)
                    const contentX = 110;
                    const contentWidth = canvas.width - 220;
                
                    // Greeting text (elegant pen handwriting style) - AI already includes "Dear XXX"
                    ctx.font = '48px "Brush Script MT", "Lucida Handwriting", "Segoe Script", "Apple Chancery", cursive';
                    ctx.fillStyle = '#2c1810';
                    ctx.textAlign = 'left';
                
                // Debug: log greeting content
                console.log('[generateAddressSide] Greeting:', greeting);
                console.log('[generateAddressSide] Greeting length:', greeting?.length || 0);
                
                    // Word wrap the greeting with better spacing for readability
                    const words = (greeting || 'Wishing you a wonderful Christmas season filled with joy and warmth!').split(' ');
                    let line = '';
                    const lineHeight = 75; // Increased from 64 to 75 for better readability
                    const paragraphSpacing = 95; // Extra spacing for paragraph breaks
                    const maxWidth = contentWidth;
                
                    for (let word of words) {
                        const testLine = line + word + ' ';
                        const metrics = ctx.measureText(testLine);
                        
                        // Check for paragraph break (double newline or single newline)
                        if (word.includes('\n')) {
                            // Draw current line
                            if (line.trim()) {
                                ctx.fillText(line.replace(/\n/g, ''), contentX, yPos);
                            }
                            line = '';
                            yPos += paragraphSpacing; // Extra spacing for new paragraph
                            if (yPos > canvas.height - 200) break; // Reserve space for signature
                        } else if (metrics.width > maxWidth && line !== '') {
                            ctx.fillText(line, contentX, yPos);
                            line = word + ' ';
                            yPos += lineHeight;
                            if (yPos > canvas.height - 200) break; // Reserve space for signature
                        } else {
                            line = testLine;
                        }
                    }
                    if (line.trim()) {
                        ctx.fillText(line, contentX, yPos);
                    }
                
                    // Sender signature (elegant pen style) - only one signature added here
                    yPos += 90; // Increased spacing before signature
                    ctx.font = 'italic 60px "Brush Script MT", "Lucida Handwriting", "Segoe Script", cursive';
                    ctx.fillStyle = '#2c1810';
                    ctx.textAlign = 'right';
                    ctx.fillText(`- ${senderName}`, canvas.width - contentX, yPos);
                    
                    // Convert to base64
                    resolve(canvas.toDataURL('image/png'));
                };
                
                // Background image URL (user provided Christmas letter background)
                bgImage.src = 'https://i.imgur.com/cvdz5mJ.jpeg';
                
                // Fallback if image fails to load
                bgImage.onerror = () => {
                    console.error('Failed to load background image, using fallback');
                    ctx.fillStyle = '#f4ead5';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw simple border
                    ctx.strokeStyle = '#b8342f';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(50, 50, canvas.width - 100, canvas.height - 100);
                    
                    resolve(canvas.toDataURL('image/png'));
                };
            });
        }
        
        // Add vintage greeting text to AI image bottom
        function addGreetingTextToImage(base64Image) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Use image original size
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // Draw original image
                    ctx.drawImage(img, 0, 0);
                    
                    // Add vintage greeting text at bottom
                    const greetingText = "Happy New Year & Merry Christmas!";
                    const subText = "Yuletide Greetings!";
                    
                    // Main text - elegant vintage script font
                    const mainTextY = canvas.height - 160;
                    ctx.font = '64px "Brush Script MT", "Lucida Calligraphy", cursive';
                    ctx.fillStyle = '#2c1810';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    // Subtle text shadow for depth
                    ctx.shadowColor = 'rgba(0,0,0,0.15)';
                    ctx.shadowBlur = 3;
                    ctx.shadowOffsetX = 1;
                    ctx.shadowOffsetY = 2;
                    
                    // Draw main text
                    ctx.fillText(greetingText, canvas.width / 2, mainTextY);
                    
                    // Sub text - smaller elegant font
                    const subTextY = canvas.height - 90;
                    ctx.font = '48px "Brush Script MT", "Lucida Calligraphy", cursive';
                    ctx.fillStyle = '#3d2817';
                    ctx.shadowBlur = 2;
                    
                    // Draw sub text
                    ctx.fillText(subText, canvas.width / 2, subTextY);
                    
                    resolve(canvas.toDataURL('image/png'));
                };
                img.src = base64Image;
            });
        }
        
        // Resize AI image to standard postcard size (1080x1920) with cover fit (no distortion)
        function resizeAIImage(base64Image) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Standard postcard size (9:16 ratio, same as back)
                    const targetWidth = 1080;
                    const targetHeight = 1920;
                    canvas.width = targetWidth;
                    canvas.height = targetHeight;
                    
                    // Calculate scale to cover (like CSS object-fit: cover)
                    const imgRatio = img.width / img.height;
                    const targetRatio = targetWidth / targetHeight;
                    
                    let drawWidth, drawHeight, offsetX, offsetY;
                    
                    if (imgRatio > targetRatio) {
                        // Image is wider - fit height, crop width
                        drawHeight = targetHeight;
                        drawWidth = img.width * (targetHeight / img.height);
                        offsetX = (targetWidth - drawWidth) / 2;
                        offsetY = 0;
                    } else {
                        // Image is taller - fit width, crop height
                        drawWidth = targetWidth;
                        drawHeight = img.height * (targetWidth / img.width);
                        offsetX = 0;
                        offsetY = (targetHeight - drawHeight) / 2;
                    }
                    
                    // Draw image centered and cropped (no distortion)
                    ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
                    
                    resolve(canvas.toDataURL('image/png'));
                };
                img.src = `data:image/png;base64,${base64Image}`;
            });
        }
        
        // Generate double-sided postcard (picture front + address back)
        async function compositeStampOnImage(base64Image) {
            return new Promise(async (resolve, reject) => {
                // Step 1: Resize AI image to match back side dimensions
                const resizedFrontImage = await resizeAIImage(base64Image);
                
                // Step 2: Add elegant greeting text to bottom
                const frontWithText = await addGreetingTextToImage(resizedFrontImage);
                currentAIImage = frontWithText;
                
                // Step 3: Load stamp image (or user's Warplet NFT if applicable)
                let stampImageSrc = selectedStamp ? `/stamp/${selectedStamp}.png` : '/stamp/neynar.png';
                
                // If Warplet stamp is selected, try to fetch user's actual Warplet NFT
                if (selectedStamp === 'warplet' && window.currentUser?.fid) {
                    console.log('[compositeStampOnImage] ðŸŽ¨ Fetching user Warplet NFT for FID:', window.currentUser.fid);
                    try {
                        const warpletRes = await fetch(`/api/warplet?fid=${window.currentUser.fid}`);
                        console.log('[compositeStampOnImage] ðŸŽ¨ Warplet API response status:', warpletRes.status);
                        
                        if (warpletRes.ok) {
                            const warpletData = await warpletRes.json();
                            console.log('[compositeStampOnImage] ðŸŽ¨ Warplet API data:', warpletData);
                            
                            if (warpletData.hasWarplet && warpletData.imageUrl) {
                                console.log('[compositeStampOnImage] âœ… Using user Warplet NFT:', warpletData.name, warpletData.imageUrl);
                                stampImageSrc = warpletData.imageUrl;
                            } else {
                                console.log('[compositeStampOnImage] âŒ No Warplet NFT found for user');
                                console.log('[compositeStampOnImage] Debug info:', warpletData.debug);
                                console.log('[compositeStampOnImage] Checked addresses:', warpletData.debug?.addresses);
                                console.log('[compositeStampOnImage] Contract:', warpletData.debug?.checkedContract);
                                console.log('[compositeStampOnImage] Using default Warplet stamp instead');
                            }
                        } else {
                            const errorText = await warpletRes.text();
                            console.error('[compositeStampOnImage] âŒ Warplet API error:', warpletRes.status, errorText);
                            console.log('[compositeStampOnImage] Using default Warplet stamp as fallback');
                        }
                    } catch (error) {
                        console.error('[compositeStampOnImage] âŒ Failed to fetch Warplet NFT:', error);
                    }
                } else if (selectedStamp === 'warplet') {
                    console.log('[compositeStampOnImage] âš ï¸ Warplet selected but no user FID found');
                }
                
                // Load stamp image for address side
                const stamp = new Image();
                stamp.crossOrigin = 'anonymous'; // Enable CORS for external NFT images
                stamp.onload = () => {
                    // Generate letter content (back) with stamp, greeting, and recipient names
                    const senderName = window.currentUser?.username || 'Anonymous';
                    const recipientNames = selectedRecipients.map(r => r.username);
                    
                    console.log('[compositeStampOnImage] currentAIGreeting:', currentAIGreeting);
                    console.log('[compositeStampOnImage] recipientNames:', recipientNames);
                    
                    generateAddressSide(currentAIGreeting, senderName, recipientNames, stamp).then(backImage => {
                        // Show double-sided card
                        document.getElementById('ai-generate-section').style.display = 'none';
                        document.getElementById('ai-preview-section').style.display = 'block';
                        
                        // Set both sides (both are now 1080x1920)
                        document.getElementById('ai-preview-front').src = frontWithText; // Front: AI illustration with elegant greeting text
                        document.getElementById('ai-preview-back').src = backImage; // Back: Letter content + stamp (flip to see)
                        
                        // Reset flip state (start with front cover)
                        isPostcardFlipped = false;
                        document.getElementById('postcard-flipper').style.transform = 'rotateY(0deg)';
                        
                        resolve();
                    });
                };
                    stamp.onerror = () => {
                        console.error('Failed to load stamp image');
                        // Fallback: show basic double-sided layout without stamp
                        const senderName = window.currentUser?.username || 'Anonymous';
                        const recipientNames = selectedRecipients.map(r => r.username);
                        
                        // Generate address side without stamp
                        generateAddressSide(currentAIGreeting, senderName, recipientNames, null).then(backImage => {
                            document.getElementById('ai-generate-section').style.display = 'none';
                            document.getElementById('ai-preview-section').style.display = 'block';
                            document.getElementById('ai-preview-back').src = backImage;
                            document.getElementById('ai-preview-front').src = frontWithText; // Use version with elegant text
                            isPostcardFlipped = false;
                            document.getElementById('postcard-flipper').style.transform = 'rotateY(0deg)';
                            resolve();
                        });
                    };
                // Load stamp image (or Warplet NFT)
                stamp.src = stampImageSrc;
            });
        }
        
        // Enlarge AI image (only for front picture)
        function enlargeAIImage(imageId) {
            const imgElement = document.getElementById(imageId);
            if (!imgElement || !imgElement.src) return;
            
            // Create fullscreen overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0,0,0,0.95);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: zoom-out;
            `;
            
            const img = document.createElement('img');
            img.src = imgElement.src;
            img.style.cssText = `
                max-width: 90vw;
                max-height: 90vh;
                object-fit: contain;
                border-radius: 12px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            `;
            
            overlay.appendChild(img);
            overlay.onclick = () => document.body.removeChild(overlay);
            document.body.appendChild(overlay);
        }
        
        async function confirmSendReply() {
            if (!pendingReply) return;
            
            closeReplyModal();
            closeCardModal();
            showLoading('Generating reply card...');
            
            const includeGift = document.getElementById('reply-include-gift').checked;
            const token = includeGift ? document.getElementById('reply-gift-token').value : null;
            const amount = includeGift ? document.getElementById('reply-gift-amount').value : '0';
            
            try {
                // Generate AI image for reply
                const replyAvatar = currentUser?.pfp_url || 'https://i.imgur.com/HeIi0wU.png';
                const replyName = currentUser?.username || 'You';
                
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generateCard',
                        senderAvatar: replyAvatar,
                        senderName: replyName,
                        message: ''
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.image) {
                    // Create reply gift
                    const giftId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                    const replyGiftData = {
                        id: giftId,
                        title: 'Christmas Reply Card',
                        message: generatedReplyText,
                        hasGift: includeGift,
                        token: token,
                        amount: amount,
                        cover: 1,
                        aiImage: data.image,
                        sceneType: data.sceneType || 'general',
                        sceneDescription: data.sceneDescription || 'holiday celebration',
                        shares: 1, type: 'equal', mode: 'direct',
                        requirePro: false, minScore: 0,
                        claimed: 0, claimedBy: [],
                        recipient: pendingReply.toUser,
                        sender: currentUser || { fid: 0, username: 'anonymous', pfp: '' },
                        isReply: true,
                        replyTo: pendingReply.originalGift.id,
                        createdAt: Date.now()
                    };
                    
                    plazaGifts.push(replyGiftData);
                    localStorage.setItem('plaza_gifts', JSON.stringify(plazaGifts));
                    
                    const replyUrl = location.origin + location.pathname + '?gift=' + giftId;
                    const shareText = includeGift
                        ? `ðŸ’Œ Reply Card with Gift!\n\n${generatedReplyText.substring(0, 50)}...\nðŸ’° ${amount} ${token}\n\nðŸ”— ${replyUrl}`
                        : `ðŸ’Œ Reply Card!\n\n${generatedReplyText.substring(0, 50)}...\n\nðŸ”— ${replyUrl}`;
                    
                    hideLoading();
                    
                    if (navigator.clipboard) {
                        await navigator.clipboard.writeText(shareText);
                        alert('âœ… Reply card created (FREE)!\n\nLink copied to clipboard!\nSend it to @' + (pendingReply.toUser.username || 'sender'));
                    } else {
                        alert(shareText);
                    }
                } else {
                    throw new Error('Reply image generation failed');
                }
            } catch (error) {
                console.error('Reply send error:', error);
                hideLoading();
                alert('Failed to generate reply card. Please try again.');
            }
            
            pendingReply = null;
            generatedReplyText = '';
        }
        
        // Toggle reply gift section
        document.getElementById('reply-include-gift')?.addEventListener('change', function() {
            document.getElementById('reply-gift-section').style.display = this.checked ? 'block' : 'none';
        });
    </script>
</body>
</html>