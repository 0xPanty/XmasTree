<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jingle Gift | Share the joy on Farcaster</title>
    
    <!-- Open Graph -->
    <meta property="og:title" content="Jingle Gift">
    <meta property="og:description" content="Interactive 3D Christmas Tree with Music">
    <meta property="og:image" content="https://xmas-tree-opal.vercel.app/preview.svg">
    
    <!-- Farcaster Mini App -->
    <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://xmas-tree-opal.vercel.app/preview.svg","button":{"title":"ðŸŽ Open","action":{"type":"launch_frame","name":"Jingle Gift","splashImageUrl":"https://xmas-tree-opal.vercel.app/icon.svg","splashBackgroundColor":"#0a1a0a"}}}' />
    
    <!-- Import Ethers.js for blockchain interaction -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;1,400&display=swap');

        :root {
            --emerald-dark: #001a10;
            --emerald: #023020;
            --gold: #D4AF37;
            --gold-light: #F7E7CE;
            --glass: rgba(20, 20, 20, 0.4);
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            font-family: 'Playfair Display', serif;
            color: var(--gold-light);
            overscroll-behavior: none;
        }

        /* Wallet Connection UI */
        .wallet-section {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            pointer-events: auto;
        }

        .wallet-btn {
            background: var(--glass);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 10px 20px;
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wallet-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }

        .wallet-btn.connected {
            background: rgba(212, 175, 55, 0.15);
            border-color: #4ade80;
            color: #4ade80;
        }

        .wallet-status {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            letter-spacing: 0.1em;
        }

        .chain-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.65rem;
        }

        .chain-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #0052ff;
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .wallet-section {
                top: 10px;
                right: 10px;
            }

            .wallet-btn {
                padding: 8px 16px;
                font-size: 0.7rem;
            }

            h1 {
                font-size: 1.8rem !important;
            }

            .subtitle {
                font-size: 0.75rem !important;
            }

            button, .file-btn {
                padding: 12px 24px !important;
                font-size: 0.75rem !important;
            }

            .modal-box {
                max-width: 95% !important;
                padding: 20px !important;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
        }

        /* Improved Modal Styles */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
            padding: 20px;
            box-sizing: border-box;
        }

        .custom-modal.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-box {
            background: linear-gradient(135deg, rgba(2, 48, 32, 0.98), rgba(0, 26, 16, 0.98));
            border: 2px solid var(--gold);
            border-radius: 16px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            box-shadow: 0 20px 60px rgba(212, 175, 55, 0.3);
            transform: scale(0.9);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-align: center;
            max-width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .custom-modal.visible .modal-box {
            transform: scale(1);
        }

        /* Smooth scrollbar */
        .modal-box::-webkit-scrollbar {
            width: 8px;
        }

        .modal-box::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .modal-box::-webkit-scrollbar-thumb {
            background: var(--gold);
            border-radius: 10px;
        }

        /* Enhanced Button Styles */
        .btn-gift {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #D4AF37, #FFD700, #D4AF37);
            background-size: 200% 200%;
            border: none;
            border-radius: 8px;
            color: var(--emerald-dark);
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            font-weight: bold;
            letter-spacing: 0.1em;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .btn-gift:hover {
            background-position: right center;
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.6);
            transform: translateY(-2px);
        }

        .btn-gift:active {
            transform: translateY(0);
        }

        .btn-gift:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid var(--gold);
            border-radius: 16px;
            padding: 24px 32px;
            z-index: 9999;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            animation: toastIn 0.3s ease forwards, toastOut 0.3s ease 2.5s forwards;
            max-width: 90%;
        }

        @keyframes toastIn {
            to { transform: translate(-50%, -50%) scale(1); }
        }

        @keyframes toastOut {
            to { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        .toast-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .toast-title {
            color: var(--gold);
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 8px;
            font-family: 'Cinzel', serif;
            letter-spacing: 0.1em;
        }

        .toast-message {
            color: #fff;
            font-size: 1rem;
            line-height: 1.4;
        }

        /* Transaction Status */
        .tx-status {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            border: 1px dashed rgba(212, 175, 55, 0.3);
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 8px;
        }

        .tx-link {
            color: var(--gold);
            text-decoration: none;
            transition: color 0.2s;
        }

        .tx-link:hover {
            color: #FFD700;
        }

        /* Improved Gift Form */
        .gift-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            text-align: left;
        }

        .form-group label {
            display: block;
            color: var(--gold);
            font-size: 0.8rem;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            color: var(--gold-light);
            font-family: inherit;
            font-size: 0.95rem;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--gold);
            background: rgba(0, 0, 0, 0.6);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        /* Network Status Badge */
        .network-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 82, 255, 0.1);
            border: 1px solid rgba(0, 82, 255, 0.3);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            color: #5dadec;
        }

        .network-badge .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #0052ff;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <!-- Wallet Connection Section -->
    <div class="wallet-section">
        <button id="wallet-connect-btn" class="wallet-btn" onclick="handleWalletConnect()">
            <span id="wallet-text">Connect Wallet</span>
        </button>
        <div id="wallet-info" class="wallet-status" style="display:none;">
            <div class="network-badge">
                <span class="dot"></span>
                <span>Base</span>
            </div>
        </div>
    </div>

    <script>
        // Blockchain Configuration
        const CONTRACT_ADDRESS = '0xYourContractAddress'; // TODO: Update after deployment
        const BASE_CHAIN_ID = 8453;
        const BASE_RPC_URL = 'https://mainnet.base.org';
        
        // Contract ABI
        const GIFT_CONTRACT_ABI = [
            "function createGiftETH(uint256 shares, bytes32 passwordHash, uint8 giftType, bool proOnly, string calldata title, uint256 duration) external payable returns (uint256)",
            "function createGiftToken(address token, uint256 amount, uint256 shares, bytes32 passwordHash, uint8 giftType, bool proOnly, string calldata title, uint256 duration) external returns (uint256)",
            "function claimGift(uint256 giftId, string calldata password, bool isPro) external",
            "function getGift(uint256 giftId) external view returns (address creator, address token, uint256 totalAmount, uint256 remainingAmount, uint256 totalShares, uint256 claimedShares, uint8 giftType, bool proOnly, string memory title, uint256 expireTime, bool active)",
            "function hasUserClaimed(uint256 giftId, address user) external view returns (bool)",
            "function getUserClaimedAmount(uint256 giftId, address user) external view returns (uint256)",
            "event GiftCreated(uint256 indexed giftId, address indexed creator, address token, uint256 totalAmount, uint256 shares, uint8 giftType, string title)",
            "event GiftClaimed(uint256 indexed giftId, address indexed claimer, uint256 amount)"
        ];

        // Global State
        let provider = null;
        let signer = null;
        let giftContract = null;
        let connectedAddress = null;
        let currentChainId = null;

        // Wallet Connection
        async function handleWalletConnect() {
            if (connectedAddress) {
                // Already connected, show disconnect option
                if (confirm('Disconnect wallet?')) {
                    disconnectWallet();
                }
            } else {
                await connectWallet();
            }
        }

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showToast('âš ï¸', 'Wallet Required', 'Please install MetaMask or use a Web3 browser');
                    return false;
                }

                showLoading('Connecting wallet...');
                
                // Request account access
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                connectedAddress = accounts[0];

                // Setup provider and signer
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                
                // Check chain
                const network = await provider.getNetwork();
                currentChainId = network.chainId;

                // Switch to Base if not on Base
                if (currentChainId !== BASE_CHAIN_ID) {
                    await switchToBase();
                }

                // Initialize contract
                giftContract = new ethers.Contract(CONTRACT_ADDRESS, GIFT_CONTRACT_ABI, signer);

                // Update UI
                updateWalletUI();
                hideLoading();
                
                showToast('âœ…', 'Wallet Connected', `${connectedAddress.slice(0, 6)}...${connectedAddress.slice(-4)}`);
                
                return true;
            } catch (error) {
                hideLoading();
                console.error('Wallet connection error:', error);
                showToast('âŒ', 'Connection Failed', error.message || 'Please try again');
                return false;
            }
        }

        async function switchToBase() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: `0x${BASE_CHAIN_ID.toString(16)}` }],
                });
                currentChainId = BASE_CHAIN_ID;
            } catch (switchError) {
                // Chain not added to wallet
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: `0x${BASE_CHAIN_ID.toString(16)}`,
                                chainName: 'Base',
                                nativeCurrency: {
                                    name: 'Ethereum',
                                    symbol: 'ETH',
                                    decimals: 18
                                },
                                rpcUrls: [BASE_RPC_URL],
                                blockExplorerUrls: ['https://basescan.org']
                            }],
                        });
                        currentChainId = BASE_CHAIN_ID;
                    } catch (addError) {
                        throw new Error('Failed to add Base network');
                    }
                } else {
                    throw switchError;
                }
            }
        }

        function disconnectWallet() {
            connectedAddress = null;
            provider = null;
            signer = null;
            giftContract = null;
            currentChainId = null;
            updateWalletUI();
            showToast('ðŸ‘‹', 'Disconnected', 'Wallet disconnected');
        }

        function updateWalletUI() {
            const btn = document.getElementById('wallet-connect-btn');
            const info = document.getElementById('wallet-info');
            const text = document.getElementById('wallet-text');

            if (connectedAddress) {
                btn.classList.add('connected');
                text.textContent = `${connectedAddress.slice(0, 6)}...${connectedAddress.slice(-4)}`;
                info.style.display = 'block';
            } else {
                btn.classList.remove('connected');
                text.textContent = 'Connect Wallet';
                info.style.display = 'none';
            }
        }

        // Listen for account/chain changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    disconnectWallet();
                } else if (accounts[0] !== connectedAddress) {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                window.location.reload();
            });
        }

        // Enhanced UI Functions
        function showToast(icon, title, message) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        function showLoading(message = 'Loading...') {
            const loadingEl = document.querySelector('.loading');
            if (loadingEl) {
                loadingEl.innerHTML = `
                    <div class="spinner"></div>
                    <div style="margin-top: 12px;">${message}</div>
                `;
                loadingEl.style.display = 'block';
            }
        }

        function hideLoading() {
            const loadingEl = document.querySelector('.loading');
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
        }

        // Auto-connect if previously connected
        window.addEventListener('DOMContentLoaded', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_accounts' 
                    });
                    if (accounts.length > 0) {
                        await connectWallet();
                    }
                } catch (error) {
                    console.log('Auto-connect failed:', error);
                }
            }
        });
    </script>
</body>
</html>
